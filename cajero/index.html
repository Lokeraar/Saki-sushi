<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>游 Panel del Cajero - Saki Sushi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #D32F2F; --secondary: #212121; --accent: #FF9800;
            --light: #F5F5F5; --dark: #121212; --warm: #FFC107;
            --success: #388E3C; --info: #1976D2; --warning: #F57C00; --danger: #ef4444;
            --shadow: rgba(0, 0, 0, 0.15); --transition: all 0.3s ease;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; padding: 20px; color: var(--secondary); }
        
        .tasa-bar { background: linear-gradient(135deg, #b91c1c, var(--primary)); padding: 1rem 2rem; margin: -20px -20px 20px -20px; display: flex; justify-content: center; align-items: center; gap: 2rem; flex-wrap: wrap; box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
        .tasa-display { display: flex; align-items: center; gap: 1rem; color: white; font-size: 1.1rem; }
        .tasa-value { font-size: 2rem; font-weight: 700; background: rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 0.5rem; }
        .tasa-input { width: 120px; padding: 0.5rem; border: 2px solid rgba(255,255,255,0.3); border-radius: 0.5rem; background: rgba(255,255,255,0.1); color: white; font-size: 1.1rem; font-weight: 600; text-align: center; }
        .btn-tasa { background: rgba(255,255,255,0.2); border: 2px solid white; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; font-weight: 600; transition: var(--transition); }
        .btn-tasa:hover { background: white; color: var(--primary); }
        
        .container { max-width: 1400px; margin: 0 auto; background: var(--light); border-radius: 15px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, var(--primary), #B71C1C); color: white; padding: 25px 30px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
        .header-left h1 { font-size: 2.5em; font-family: 'Montserrat', sans-serif; font-weight: 800; margin-bottom: 5px; }
        .header-left p { opacity: 0.9; font-size: 1.1em; }
        .header-right { display: flex; align-items: center; gap: 20px; }
        .sync-status { background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 25px; font-size: 0.9em; display: flex; align-items: center; gap: 10px; font-family: 'Montserrat', sans-serif; }
        .sync-status.online { background: rgba(56, 142, 60, 0.3); }
        .sync-status.offline { background: rgba(211, 47, 47, 0.3); }
        .sync-status.syncing { background: rgba(255, 152, 0, 0.3); }
        
        .nav-tabs { background: var(--secondary); display: flex; padding: 0 30px; gap: 10px; overflow-x: auto; }
        .nav-tab { background: transparent; color: white; border: none; padding: 20px 30px; font-size: 1em; cursor: pointer; transition: var(--transition); font-family: 'Montserrat', sans-serif; font-weight: 500; border-bottom: 3px solid transparent; white-space: nowrap; }
        .nav-tab:hover { background: rgba(255,255,255,0.1); }
        .nav-tab.active { border-bottom-color: var(--accent); color: var(--accent); }
        
        .content { padding: 30px; }
        .section { display: none; }
        .section.active { display: block; }
        .section-title { font-size: 2em; color: var(--secondary); margin-bottom: 25px; display: flex; align-items: center; gap: 15px; font-family: 'Montserrat', sans-serif; font-weight: 700; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        @media (max-width: 992px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 576px) { .stats-grid { grid-template-columns: 1fr; } }
        
        .stat-card { 
            background: white; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 5px 20px var(--shadow); 
            text-align: center; 
            transition: var(--transition); 
            border: 2px solid transparent;
            cursor: pointer;
        }
        .stat-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); 
            border-color: var(--accent); 
        }
        .stat-icon { 
            width: 60px; 
            height: 60px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin: 0 auto 15px; 
            font-size: 1.5em; 
            color: white; 
        }
        .stat-icon.pendientes { background: var(--warning); }
        .stat-icon.cobrados { background: var(--success); }
        .stat-icon.ventas { background: var(--info); }
        .stat-icon.platillos { background: var(--primary); }
        .stat-value { font-size: 2.5em; font-weight: 800; color: var(--secondary); font-family: 'Montserrat', sans-serif; }
        .stat-label { color: #666; margin-top: 5px; font-size: 0.95em; }
        
        .section-subtitle { 
            font-size: 1.3em; 
            color: var(--secondary); 
            margin: 30px 0 20px 0; 
            padding-bottom: 10px; 
            border-bottom: 2px solid var(--accent);
            display: flex; 
            align-items: center; 
            gap: 10px; 
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
        }
        
        .section-subtitle .count-badge {
            background: var(--primary);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .orders-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px; }
        @media (max-width: 1200px) { .orders-container { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .orders-container { grid-template-columns: 1fr; } }
        
        .order-column { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 20px var(--shadow); }
        .order-column-header { background: linear-gradient(135deg, var(--secondary), #424242); color: white; padding: 15px 20px; font-family: 'Montserrat', sans-serif; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .order-column-header.mesa { background: linear-gradient(135deg, var(--info), #1565C0); }
        .order-column-header.delivery { background: linear-gradient(135deg, var(--success), #2E7D32); }
        .order-column-header.reserva { background: linear-gradient(135deg, var(--warning), #F57C00); }
        .order-column-content { padding: 15px; min-height: 200px; max-height: 600px; overflow-y: auto; }
        
        .order-card { background: #f8f8f8; border-radius: 10px; padding: 15px; margin-bottom: 15px; border-left: 4px solid var(--primary); transition: var(--transition); }
        .order-card:hover { transform: translateX(5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .order-card.en-cocina { border-left-color: var(--warning); }
        .order-card.en-camino { border-left-color: var(--info); }
        .order-card.reserva-pendiente { border-left-color: #9c27b0; }
        .order-card.reserva-atendida { border-left-color: #ff5722; }
        
        .order-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .order-id { font-weight: 700; font-family: 'Montserrat', sans-serif; font-size: 0.9rem; }
        .order-time { font-size: 0.8rem; color: #666; }
        .order-details { font-size: 0.9rem; margin-bottom: 10px; }
        .order-detail-row { display: flex; justify-content: space-between; padding: 3px 0; }
        .order-total { font-weight: 700; color: var(--primary); font-size: 1.1rem; text-align: right; margin-top: 10px; padding-top: 10px; border-top: 2px dashed #ddd; }
        .order-actions { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        
        .btn { flex: 1; padding: 10px; border: none; border-radius: 8px; font-size: 0.9em; font-weight: 600; cursor: pointer; transition: var(--transition); display: flex; align-items: center; justify-content: center; gap: 8px; font-family: 'Montserrat', sans-serif; }
        .btn-cobrar { background: linear-gradient(135deg, var(--success), #2E7D32); color: white; }
        .btn-cobrar:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(56, 142, 60, 0.4); }
        .btn-cobrar:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-ver { background: #e0e0e0; color: var(--secondary); }
        .btn-ver:hover { background: #d0d0d0; }
        .btn-rechazar { background: linear-gradient(135deg, var(--danger), #B71C1C); color: white; }
        .btn-rechazar:disabled { background: #ccc; cursor: not-allowed; }
        .btn-entregar { background: linear-gradient(135deg, var(--success), #2E7D32); color: white; }
        .btn-entregar:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(56, 142, 60, 0.4); }
        .btn-entregar:disabled { background: #ccc; cursor: not-allowed; }
        .btn-enviar { background: linear-gradient(135deg, var(--info), #1565C0); color: white; }
        .btn-enviar:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(25, 118, 210, 0.4); }
        .btn-enviar:disabled { background: #ccc; cursor: not-allowed; }
        .btn-confirmar { background: linear-gradient(135deg, #9c27b0, #7b1fa2); color: white; }
        .btn-confirmar:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(156, 39, 176, 0.4); }
        .btn-confirmar:disabled { background: #ccc; cursor: not-allowed; }
        
        .status-badge { 
            display: inline-flex; 
            align-items: center; 
            gap: 5px; 
            padding: 5px 10px; 
            border-radius: 15px; 
            font-size: 0.75rem; 
            font-weight: 600;
            margin-bottom: 10px;
        }
        .status-en-cocina { background: #FFF3E0; color: var(--warning); }
        .status-en-camino { background: #E3F2FD; color: var(--info); }
        .status-reserva-pendiente { background: #F3E5F5; color: #9c27b0; }
        .status-reserva-atendida { background: #FBE9E7; color: #ff5722; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 3000; display: none; justify-content: center; align-items: center; padding: 20px; backdrop-filter: blur(5px); }
        .modal-overlay.show { display: flex; }
        .modal-content { background: white; border-radius: 20px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { background: linear-gradient(135deg, var(--success), #2E7D32); color: white; padding: 25px; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-family: 'Montserrat', sans-serif; font-size: 1.5rem; }
        .modal-close { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }
        .modal-body { padding: 25px; }
        .modal-footer { padding: 25px; border-top: 2px solid #f0f0f0; display: flex; gap: 15px; }
        
        .stats-detail-modal .modal-header { background: linear-gradient(135deg, var(--info), #1565C0); }
        .stats-detail-list { max-height: 400px; overflow-y: auto; }
        .stats-detail-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
        .stats-detail-item:last-child { border-bottom: none; }
        .stats-detail-item .pedido-id { font-weight: 600; color: var(--secondary); }
        .stats-detail-item .pedido-monto { font-weight: 700; color: var(--primary); }
        .stats-detail-item .pedido-mesa { font-size: 0.85rem; color: #666; }
        .stats-detail-item .pedido-hora { font-size: 0.8rem; color: #999; }
        
        .ranking-bar { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            padding: 8px; 
            border-bottom: 1px solid #eee; 
        }
        .ranking-position { 
            width: 30px; 
            height: 30px; 
            background: var(--accent); 
            color: white; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: 700; 
        }
        .ranking-info { flex: 1; }
        .ranking-name { font-weight: 600; }
        .ranking-cantidad { color: #666; font-size: 0.85rem; }
        .ranking-bar-container { 
            width: 100px; 
            height: 8px; 
            background: #e0e0e0; 
            border-radius: 4px; 
            overflow: hidden; 
        }
        .ranking-bar-fill { 
            height: 100%; 
            background: var(--primary); 
            border-radius: 4px; 
        }
        
        .comprobante-preview {
            margin-top: 15px;
            background: #f8f8f8;
            border: 2px solid var(--info);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .comprobante-img {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
        }
        .comprobante-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--info);
            font-weight: 600;
            margin-bottom: 5px;
        }
        .btn-ver-comprobante {
            background: var(--info);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
        }
        .btn-ver-comprobante:hover {
            background: #1565C0;
            transform: translateY(-2px);
        }
        
        .payment-mix-container { margin-bottom: 25px; }
        .payment-mix-item { 
            background: #f8f8f8; 
            border-radius: 12px; 
            padding: 15px; 
            margin-bottom: 15px; 
            border: 2px solid #e0e0e0;
            transition: var(--transition);
        }
        .payment-mix-item.active { border-color: var(--success); background: #E8F5E9; }
        .payment-mix-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 10px;
        }
        .payment-mix-title { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            font-weight: 600; 
            font-family: 'Montserrat', sans-serif;
        }
        .payment-mix-input { 
            width: 150px; 
            padding: 10px; 
            border: 2px solid #e0e0e0; 
            border-radius: 8px; 
            font-size: 1rem; 
            text-align: right;
            font-weight: 600;
        }
        .payment-mix-input:focus { outline: none; border-color: var(--success); }
        .payment-mix-input:disabled { background: #f0f0f0; color: #999; }
        
        .payment-mix-total {
            background: linear-gradient(135deg, var(--secondary), #424242);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .payment-mix-total-label { font-size: 1.1rem; }
        .payment-mix-total-value { font-size: 2rem; font-weight: 700; font-family: 'Montserrat', sans-serif; }
        
        .payment-mix-remaining {
            background: #FFF3E0;
            border: 2px solid var(--warning);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .payment-mix-remaining.paid { background: #E8F5E9; border-color: var(--success); }
        .payment-mix-remaining.overpaid { background: #FFEBEE; border-color: var(--danger); }
        
        .payment-mix-add {
            width: 100%;
            padding: 15px;
            border: 2px dashed var(--primary);
            border-radius: 12px;
            background: transparent;
            color: var(--primary);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .payment-mix-add:hover { background: rgba(211, 47, 47, 0.1); }
        .payment-mix-add:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .payment-mix-summary {
            background: #f8f8f8;
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
        }
        .payment-mix-summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        .payment-mix-summary-item:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--primary);
        }
        
        .btn-remove-payment {
            background: var(--danger);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        .btn-remove-payment:hover { transform: scale(1.1); }
        
        .payment-method-select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 10px;
        }
        .payment-method-select:focus { outline: none; border-color: var(--success); }
        
        .reference-input {
            margin-top: 10px;
        }
        .reference-input input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        
        .special-options { background: #FFF3E0; border: 2px solid var(--warning); border-radius: 12px; padding: 20px; margin: 20px 0; }
        .special-option { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .special-option input[type="radio"] { width: 20px; height: 20px; }
        .special-input { margin-top: 10px; display: none; }
        .special-input.show { display: block; }
        .btn-modal { flex: 1; padding: 15px; border: none; border-radius: 10px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: var(--transition); font-family: 'Montserrat', sans-serif; }
        .btn-modal.secondary { background: #f0f0f0; color: var(--secondary); }
        .btn-modal.primary { background: linear-gradient(135deg, var(--success), #2E7D32); color: white; }
        .btn-modal:disabled { background: #ccc; cursor: not-allowed; }
        
        .alert-modal .modal-content { max-width: 500px; text-align: center; }
        .alert-icon { font-size: 4rem; color: var(--warning); margin-bottom: 1rem; }
        .timer-badge { background: var(--warning); color: white; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; display: inline-flex; align-items: center; gap: 5px; }
        .timer-badge.urgent { background: var(--danger); animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 4000; color: white; }
        .loading-overlay.show { display: flex; }
        .spinner { width: 60px; height: 60px; border: 5px solid rgba(255,255,255,0.3); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .empty-state { text-align: center; padding: 40px; color: #888; }
        .empty-state i { font-size: 3em; margin-bottom: 15px; color: #ddd; }
        
        .notification { position: fixed; top: 80px; right: 20px; background: white; padding: 20px 25px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); display: none; align-items: center; gap: 15px; z-index: 5000; animation: slideIn 0.3s ease; border-left: 5px solid var(--success); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0%); opacity: 1; } }
        .notification.show { display: flex; }
        
        .menu-item-card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; gap: 15px; align-items: center; }
        .menu-item-img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; color: #999; }
        .menu-item-info { flex: 1; }
        .menu-item-name { font-weight: 700; font-family: 'Montserrat', sans-serif; margin-bottom: 5px; }
        .menu-item-desc { font-size: 0.875rem; color: #666; margin-bottom: 5px; }
        .menu-item-price { font-size: 1.25rem; font-weight: 700; color: var(--primary); }
        .badge { padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .badge-success { background: #E8F5E9; color: var(--success); }
        .badge-danger { background: #FFEBEE; color: var(--danger); }
        
        .confirm-modal .modal-header { background: linear-gradient(135deg, var(--info), #1565C0); }
        .confirm-modal .modal-header.entrega { background: linear-gradient(135deg, var(--success), #2E7D32); }
        .confirm-modal .modal-header.envio { background: linear-gradient(135deg, var(--info), #1565C0); }
        .confirm-modal .modal-header.reserva { background: linear-gradient(135deg, #9c27b0, #7b1fa2); }
        
        .info-box { background: #f8f8f8; border-radius: 10px; padding: 15px; margin: 15px 0; }
        .info-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e0e0e0; }
        .info-row:last-child { border-bottom: none; font-weight: 600; }
        
        .keyboard-hint { 
            background: #f0f0f0; 
            padding: 10px 15px; 
            border-radius: 8px; 
            font-size: 0.85rem; 
            color: #666;
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        .keyboard-hint kbd {
            background: white;
            padding: 3px 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-family: monospace;
        }
        
        .ingredient-discount {
            background: #E8F5E9;
            color: var(--success);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 5px;
        }
        
        .item-subtotal {
            font-weight: 600;
            color: var(--secondary);
        }
        
        .btn-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }
        
        @media (max-width: 768px) {
            .tasa-bar { flex-direction: column; gap: 1rem; padding: 1rem; }
            .header { flex-direction: column; text-align: center; }
            .payment-mix-header { flex-direction: column; gap: 10px; align-items: flex-start; }
            .payment-mix-input { width: 100%; }
            .keyboard-hint { flex-direction: column; gap: 5px; text-align: center; }
        }

        /* Detalles de estad칤sticas */
        .detalle-stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }
        .detalle-stat-item:last-child {
            border-bottom: none;
        }
        .detalle-stat-info {
            display: flex;
            flex-direction: column;
        }
        .detalle-stat-id {
            font-weight: 600;
            color: var(--secondary);
        }
        .detalle-stat-meta {
            display: flex;
            gap: 10px;
            margin-top: 4px;
            font-size: 0.8rem;
            color: #666;
        }
        .detalle-stat-total {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.1rem;
        }
        .detalle-stat-metodo {
            display: inline-block;
            padding: 2px 8px;
            background: #E8F5E9;
            color: var(--success);
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- Alert Modal para Tasa del D칤a (Cajero) -->
    <div class="modal-overlay alert-modal" id="alertTasaModal">
        <div class="modal-content">
            <div class="modal-body" style="padding: 2rem;">
                <div class="alert-icon"><i class="fas fa-exclamation-triangle"></i></div>
                <h2 style="margin-bottom: 1rem; color: var(--secondary);">춰Buenos d칤as!</h2>
                <p style="color: #666; margin-bottom: 1.5rem;">El administrador no ha establecido la <strong>tasa del d칩lar del d칤a</strong>. Por favor, introd칰cela para continuar.</p>
                <div style="background: #f8f8f8; padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--secondary);">Tasa del D칤a (Bs. por $1)</label>
                    <input type="number" step="0.01" id="tasaInicialInput" placeholder="0.00" style="width: 100%; padding: 1rem; font-size: 1.5rem; text-align: center; font-weight: 700; border: 2px solid var(--primary); border-radius: 0.5rem;">
                </div>
                <button class="btn-cobrar" onclick="guardarTasaInicial()" style="width: 100%; justify-content: center;">Guardar y Continuar</button>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div><h2>Cargando panel...</h2></div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <i class="fas fa-check-circle" style="color: var(--success); font-size: 1.5rem;"></i>
        <div><h4 style="margin: 0; color: var(--secondary);">칄xito</h4><p id="notificationText" style="margin: 0; color: #666;">Operaci칩n completada</p></div>
    </div>

    <!-- Modal de Confirmaci칩n de Entrega/Env칤o/Reserva -->
    <div class="modal-overlay confirm-modal" id="confirmEntregaModal">
        <div class="modal-content">
            <div class="modal-header" id="confirmEntregaHeader">
                <h2 id="confirmEntregaTitle"><i class="fas fa-check-circle"></i> Confirmar Entrega</h2>
                <button class="modal-close" onclick="cerrarModal('confirmEntregaModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="confirmEntregaBody">
                <!-- Contenido din치mico -->
            </div>
            <div class="modal-footer">
                <button class="btn-modal secondary" onclick="cerrarModal('confirmEntregaModal')">Cancelar (ESC)</button>
                <button class="btn-modal primary" id="btnConfirmarAccion" onclick="ejecutarConfirmacion()">Confirmar (ENTER)</button>
            </div>
        </div>
    </div>

    <!-- Modal de Visualizaci칩n de Comprobante -->
    <div class="modal-overlay" id="comprobanteModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--info), #1565C0);">
                <h2><i class="fas fa-receipt"></i> Comprobante de Pago</h2>
                <button class="modal-close" onclick="cerrarModal('comprobanteModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <div id="comprobanteImagenContainer" style="margin-bottom: 20px;"></div>
                <div id="comprobanteInfo" style="background: #f8f8f8; padding: 20px; border-radius: 10px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal secondary" onclick="cerrarModal('comprobanteModal')">Cerrar</button>
                <a id="comprobanteDownloadLink" class="btn-modal primary" download="comprobante.jpg" style="text-decoration: none; text-align: center;">
                    <i class="fas fa-download"></i> Descargar
                </a>
            </div>
        </div>
    </div>

    <!-- Modal de Detalle de Estad칤sticas - Mejorado con datos coherentes -->
    <div class="modal-overlay stats-detail-modal" id="statsDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="statsDetailTitle"><i class="fas fa-chart-bar"></i> Detalle</h2>
                <button class="modal-close" onclick="cerrarModal('statsDetailModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="statsDetailBody">
                <!-- Contenido din치mico -->
            </div>
            <div class="modal-footer">
                <button class="btn-modal primary" onclick="cerrarModal('statsDetailModal')">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Cobro con M칰ltiples M칠todos de Pago -->
    <div class="modal-overlay" id="cobroModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header"><h2><i class="fas fa-cash-register"></i> Procesar Cobro - Pago Mixto</h2><button class="modal-close" onclick="closeModal('cobroModal')"><i class="fas fa-times"></i></button></div>
            <div class="modal-body">
                <div id="cobroSummary" style="margin-bottom: 20px;"></div>
                
                <div class="payment-mix-total">
                    <span class="payment-mix-total-label">TOTAL A PAGAR:</span>
                    <span class="payment-mix-total-value" id="totalPagarDisplay">Bs. 0.00</span>
                </div>
                
                <div class="payment-mix-remaining" id="remainingDisplay">
                    <span>Pendiente por pagar:</span>
                    <span style="font-size: 1.5rem; font-weight: 700;" id="remainingAmount">Bs. 0.00</span>
                </div>
                
                <div class="payment-mix-container" id="paymentMixContainer"></div>
                
                <button class="payment-mix-add" id="btnAddPayment" onclick="agregarMetodoPago()">
                    <i class="fas fa-plus-circle"></i> Agregar M칠todo de Pago
                </button>
                
                <div class="payment-mix-summary" id="paymentSummary" style="display: none;">
                    <div class="payment-mix-summary-item">
                        <span>Total recibido:</span>
                        <span id="totalRecibido">Bs. 0.00</span>
                    </div>
                    <div class="payment-mix-summary-item" id="cambioRow" style="display: none;">
                        <span>Cambio a entregar:</span>
                        <span id="cambioAmount" style="color: var(--success);">Bs. 0.00</span>
                    </div>
                    <div class="payment-mix-summary-item" id="faltanteRow" style="display: none; color: var(--danger);">
                        <span>Faltante:</span>
                        <span id="faltanteAmount">Bs. 0.00</span>
                    </div>
                </div>
                
                <div class="special-options" id="specialOptions" style="display: none;">
                    <h3><i class="fas fa-exclamation-circle"></i> Opciones de Diferencia</h3>
                    <div class="special-option"><input type="radio" name="specialOption" id="optNormal" value="normal" checked onchange="toggleSpecialInput()"><label for="optNormal">Cobro exacto</label></div>
                    <div class="special-option"><input type="radio" name="specialOption" id="optAfavor" value="afavor" onchange="toggleSpecialInput()"><label for="optAfavor">A favor (cliente debe)</label></div>
                    <div class="special-input" id="inputAfavor"><label>Monto a favor:</label><input type="number" id="montoAfavor" placeholder="0.00" readonly></div>
                    <div class="special-option"><input type="radio" name="specialOption" id="optCondonacion" value="condonacion" onchange="toggleSpecialInput()"><label for="optCondonacion">Condonaci칩n (no cobrar diferencia)</label></div>
                    <div class="special-input" id="inputCondonacion"><label>Monto condonado:</label><input type="number" id="montoCondonacion" placeholder="0.00" readonly></div>
                    <div class="special-option"><input type="radio" name="specialOption" id="optCasa" value="casa" onchange="toggleSpecialInput()"><label for="optCasa">Por parte de la casa (invitaci칩n)</label></div>
                    <div class="special-input" id="inputCasa"><label>Nombre de quien invita:</label><input type="text" id="nombreInvita" placeholder="Nombre del empleado/admin"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal secondary" onclick="closeModal('cobroModal')">Cancelar</button>
                <button class="btn-modal primary" id="btnConfirmarCobro" onclick="confirmarCobro()" disabled>Confirmar Cobro</button>
            </div>
        </div>
    </div>

    <!-- Modal de Rechazo -->
    <div class="modal-overlay" id="rechazoModal">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--danger), #B71C1C);"><h2><i class="fas fa-times-circle"></i> Rechazar Pedido</h2><button class="modal-close" onclick="closeModal('rechazoModal')"><i class="fas fa-times"></i></button></div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; color: #666;">Selecciona la raz칩n del rechazo:</p>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <label style="display: flex; align-items: center; gap: 10px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer;"><input type="radio" name="rejectionReason" value="referencia_invalida" style="width: 20px; height: 20px;"><span>Referencia de pago inv치lida o falsa</span></label>
                    <label style="display: flex; align-items: center; gap: 10px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer;"><input type="radio" name="rejectionReason" value="monto_insuficiente" style="width: 20px; height: 20px;"><span>Monto insuficiente</span></label>
                    <label style="display: flex; align-items: center; gap: 10px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer;"><input type="radio" name="rejectionReason" value="datos_incorrectos" style="width: 20px; height: 20px;"><span>Datos de contacto/direcci칩n incorrectos</span></label>
                    <label style="display: flex; align-items: center; gap: 10px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer;"><input type="radio" name="rejectionReason" value="no_disponible" style="width: 20px; height: 20px;"><span>Producto no disponible</span></label>
                    <label style="display: flex; align-items: center; gap: 10px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer;"><input type="radio" name="rejectionReason" value="fuera_horario" style="width: 20px; height: 20px;"><span>Fuera de horario de delivery</span></label>
                </div>
            </div>
            <div class="modal-footer"><button class="btn-modal secondary" onclick="closeModal('rechazoModal')">Cancelar</button><button class="btn-modal primary" style="background: linear-gradient(135deg, var(--danger), #B71C1C);" onclick="confirmarRechazo()">Confirmar Rechazo</button></div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="header-left"><h1><i class="fas fa-cash-register"></i> Panel del Cajero</h1><p>Saki Sushi - Gesti칩n de pedidos y cobros</p></div>
            <div class="header-right"><div class="sync-status offline" id="syncStatus"><i class="fas fa-sync-alt"></i><span>Conectando...</span></div></div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('pedidos')"><i class="fas fa-clipboard-list"></i> Pedidos</button>
            <button class="nav-tab" onclick="showSection('menu')"><i class="fas fa-utensils"></i> Ver Men칰</button>
        </div>

        <div class="content">
            <!-- Secci칩n Pedidos -->
            <div class="section active" id="section-pedidos">
                <h2 class="section-title"><i class="fas fa-clipboard-list"></i> Pedidos del D칤a</h2>
                
                <!-- Estad칤sticas Interactivas - AHORA CON ENLACES COHERENTES -->
                <div class="stats-grid">
                    <div class="stat-card" onclick="verDetalleEstadistica('pendientes')">
                        <div class="stat-icon pendientes"><i class="fas fa-fire"></i></div>
                        <div class="stat-value" id="statPendientes">0</div>
                        <div class="stat-label">En Preparaci칩n</div>
                    </div>
                    <div class="stat-card" onclick="verDetalleEstadistica('cobrados')">
                        <div class="stat-icon cobrados"><i class="fas fa-check-circle"></i></div>
                        <div class="stat-value" id="statCobrados">0</div>
                        <div class="stat-label">Cobrados Hoy</div>
                    </div>
                    <div class="stat-card" onclick="verDetalleEstadistica('ventas')">
                        <div class="stat-icon ventas"><i class="fas fa-dollar-sign"></i></div>
                        <div class="stat-value" id="statVentas">Bs. 0</div>
                        <div class="stat-label">Ventas Totales</div>
                    </div>
                    <div class="stat-card" onclick="verDetalleEstadistica('platillos')">
                        <div class="stat-icon platillos"><i class="fas fa-utensils"></i></div>
                        <div class="stat-value" id="statPlatillos">0</div>
                        <div class="stat-label">Platillos Vendidos</div>
                    </div>
                </div>

                <!-- Pedidos Pendientes de Cobro (Originales) -->
                <div class="section-subtitle">
                    <i class="fas fa-clock"></i> 
                    Pedidos a cobrar y confirmar:
                    <span class="count-badge" id="badgePorCobrar">0</span>
                </div>
                
                <div class="orders-container" id="ordersPorCobrar">
                    <div class="order-column">
                        <div class="order-column-header mesa"><i class="fas fa-chair"></i> MESA</div>
                        <div class="order-column-content" id="colMesaPorCobrar"><div class="empty-state"><i class="fas fa-inbox"></i><p>No hay pedidos en mesa</p></div></div>
                    </div>
                    <div class="order-column">
                        <div class="order-column-header delivery"><i class="fas fa-motorcycle"></i> DELIVERY</div>
                        <div class="order-column-content" id="colDeliveryPorCobrar"><div class="empty-state"><i class="fas fa-inbox"></i><p>No hay pedidos delivery</p></div></div>
                    </div>
                    <div class="order-column">
                        <div class="order-column-header reserva"><i class="fas fa-calendar-check"></i> RESERVAS</div>
                        <div class="order-column-content" id="colReservaPorCobrar"><div class="empty-state"><i class="fas fa-inbox"></i><p>No hay reservas</p></div></div>
                    </div>
                </div>

                <!-- Pedidos en Preparaci칩n (Nueva secci칩n) -->
                <div class="section-subtitle">
                    <i class="fas fa-fire"></i> 
                    Pedidos en preparaci칩n:
                    <span class="count-badge" id="badgeEnPreparacion">0</span>
                </div>
                
                <div class="orders-container" id="ordersEnPreparacion">
                    <div class="order-column">
                        <div class="order-column-header mesa"><i class="fas fa-chair"></i> MESA - EN COCINA</div>
                        <div class="order-column-content" id="colMesaEnCocina"><div class="empty-state"><i class="fas fa-inbox"></i><p>No hay pedidos en cocina</p></div></div>
                    </div>
                    <div class="order-column">
                        <div class="order-column-header delivery"><i class="fas fa-motorcycle"></i> DELIVERY - EN CAMINO</div>
                        <div class="order-column-content" id="colDeliveryEnCamino"><div class="empty-state"><i class="fas fa-inbox"></i><p>No hay delivery en camino</p></div></div>
                    </div>
                    <div class="order-column">
                        <div class="order-column-header reserva"><i class="fas fa-calendar-check"></i> RESERVAS - PENDIENTES</div>
                        <div class="order-column-content" id="colReservaPendiente"><div class="empty-state"><i class="fas fa-inbox"></i><p>No hay reservas pendientes</p></div></div>
                    </div>
                </div>
            </div>

            <!-- Secci칩n Ver Men칰 -->
            <div class="section" id="section-menu">
                <h2 class="section-title"><i class="fas fa-utensils"></i> Men칰 Actual</h2>
                <div id="menuViewContainer"></div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURACI칍N JSONBin
        // ==========================================
        const JSONBIN_CONFIG = {
            BIN_ID: '69879d6e43b1c97be96d2b13',
            API_KEY: '$2a$10$.klBAMlOBlE9CoVh5iUFf.x3LEYKWiP6hhvvPETK9e8pyIuNB2F4K',
            BASE_URL: 'https://api.jsonbin.io/v3/b'
        };

        // ==========================================
        // SISTEMA DE BLOQUEO Y COLA DE OPERACIONES
        // ==========================================
        let isProcessing = false;
        let operationQueue = [];
        let processingTimeout = null;
        
        async function executeNextOperation() {
            if (isProcessing || operationQueue.length === 0) return;
            
            isProcessing = true;
            const operation = operationQueue.shift();
            
            try {
                await operation();
            } catch (error) {
                console.error('Error en operaci칩n:', error);
            } finally {
                processingTimeout = setTimeout(() => {
                    isProcessing = false;
                    executeNextOperation();
                }, 500);
            }
        }
        
        function queueOperation(operation) {
            operationQueue.push(operation);
            executeNextOperation();
        }
        
        function setButtonsDisabled(disabled) {
            document.querySelectorAll('.btn-cobrar, .btn-rechazar, .btn-entregar, .btn-enviar, .btn-confirmar, .btn-modal.primary').forEach(btn => {
                btn.disabled = disabled;
                if (disabled && !btn.querySelector('.btn-spinner')) {
                    const originalText = btn.innerHTML;
                    btn.setAttribute('data-original-text', originalText);
                    btn.innerHTML = '<span class="btn-spinner"></span>Procesando...';
                } else if (!disabled && btn.getAttribute('data-original-text')) {
                    btn.innerHTML = btn.getAttribute('data-original-text');
                    btn.removeAttribute('data-original-text');
                }
            });
        }

        let sistemaData = null;
        let syncInterval = null;
        let currentPedido = null;
        let pedidoRechazo = null;
        let pedidoConfirmacion = null;
        let tipoConfirmacion = null;
        
        let pagosMixtos = [];
        let totalPagar = 0;
        let tasaEfectiva = 400;

        // ==========================================
        // INICIALIZACI칍N
        // ==========================================
        document.addEventListener('DOMContentLoaded', async () => {
            await cargarDatos();
            verificarTasaDelDia();
            syncInterval = setInterval(cargarDatos, 10000);
            document.addEventListener('keydown', handleGlobalKeypress);
        });

        async function cargarDatos() {
            if (isProcessing) return;
            actualizarEstadoSync('syncing');
            
            try {
                const response = await fetch(`${JSONBIN_CONFIG.BASE_URL}/${JSONBIN_CONFIG.BIN_ID}/latest`, {
                    method: 'GET',
                    headers: { 'X-Master-Key': JSONBIN_CONFIG.API_KEY, 'X-Bin-Meta': 'false' }
                });
                
                if (!response.ok) throw new Error('Error al cargar datos');
                const data = await response.json();
                
                await new Promise(resolve => setTimeout(resolve, 100));
                sistemaData = data.record || data;
                limpiarPedidosDiaAnterior();
                
                actualizarEstadoSync('online');
                document.getElementById('loadingOverlay').style.display = 'none';
                actualizarVista();
                
            } catch (error) {
                console.error('Error cargando datos:', error);
                actualizarEstadoSync('offline');
            }
        }

        function limpiarPedidosDiaAnterior() {
            if (!sistemaData.pedidos) return;
            const hoy = new Date().toISOString().split('T')[0];
            const pedidosHoy = [];
            const pedidosArchivar = [];
            
            sistemaData.pedidos.forEach(p => {
                if (p.timestamp.startsWith(hoy)) pedidosHoy.push(p);
                else if (['cobrado', 'entregado', 'enviado', 'reserva_completada'].includes(p.estado)) pedidosArchivar.push(p);
            });
            
            if (pedidosArchivar.length > 0) {
                if (!sistemaData.ventas) sistemaData.ventas = { diarias: [], semanales: [], mensuales: [] };
                pedidosArchivar.forEach(p => {
                    sistemaData.ventas.diarias.push({ 
                        fecha: p.timestamp, 
                        pedidoId: p.id, 
                        total: p.total, 
                        items: p.items?.length || 0, 
                        metodoPago: p.metodoPago, 
                        tipo: p.tipo || 'mesa' 
                    });
                });
            }
            sistemaData.pedidos = pedidosHoy;
        }

        function calcularTasaEfectiva() {
            if (!sistemaData || !sistemaData.config) return 400;
            
            const tasaBase = sistemaData.config.tasaCambio || 400;
            const aumentoDiario = sistemaData.config.aumentoDiario || 0;
            const aumentoActivo = sistemaData.config.aumentoActivo || false;
            const aumentoDetenido = sistemaData.config.aumentoDetenido || false;
            const fechaInicio = sistemaData.config.fechaInicioAumento;
            
            if (aumentoActivo && !aumentoDetenido && aumentoDiario > 0 && fechaInicio) {
                const inicio = new Date(fechaInicio);
                const hoy = new Date();
                const diffTime = Math.abs(hoy - inicio);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const porcentajeTotal = aumentoDiario * diffDays;
                return tasaBase * (1 + (porcentajeTotal / 100));
            }
            return tasaBase;
        }

        function verificarTasaDelDia() {
            if (!sistemaData || !sistemaData.config) return;
            const hoy = new Date().toISOString().split('T')[0];
            const ultimaFecha = sistemaData.config.ultimaActualizacion ? sistemaData.config.ultimaActualizacion.split('T')[0] : null;
            
            if (ultimaFecha !== hoy || sistemaData.config.tasaCambio === 0) {
                document.getElementById('alertTasaModal').classList.add('show');
            } else {
                actualizarDisplayTasa();
            }
        }

        async function guardarTasaInicial() {
            const tasa = parseFloat(document.getElementById('tasaInicialInput').value);
            if (!tasa || tasa <= 0) { 
                mostrarNotificacion('Introduce una tasa v치lida', 'error'); 
                return; 
            }
            
            sistemaData.config.tasaCambio = tasa;
            sistemaData.config.ultimaActualizacion = new Date().toISOString();
            if (!sistemaData.config.fechaInicioAumento) sistemaData.config.fechaInicioAumento = new Date().toISOString();
            
            await guardarCambios();
            document.getElementById('alertTasaModal').classList.remove('show');
            actualizarDisplayTasa();
            actualizarVista();
            mostrarNotificacion('Tasa del d칤a guardada correctamente');
        }

        function actualizarDisplayTasa() {
            tasaEfectiva = calcularTasaEfectiva();
        }

        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`section-${sectionName}`).classList.add('active');
            event.target.classList.add('active');
            if (sectionName === 'pedidos') renderPedidos();
            if (sectionName === 'menu') renderMenuView();
        }

        function actualizarVista() {
            tasaEfectiva = calcularTasaEfectiva();
            renderPedidos();
            renderMenuView();
        }

        // ==========================================
        // ESTAD칈STICAS INTERACTIVAS - CORREGIDO CON DATOS COHERENTES
        // ==========================================
        function verDetalleEstadistica(tipo) {
            if (!sistemaData || !sistemaData.pedidos) return;
            
            const hoy = new Date().toISOString().split('T')[0];
            const pedidosHoy = sistemaData.pedidos.filter(p => p.timestamp.startsWith(hoy));
            
            let titulo = '';
            let contenido = '';
            let icono = '';
            
            switch(tipo) {
                // ========== PEDIDOS EN PREPARACI칍N ==========
                case 'pendientes':
                    titulo = 'Pedidos en Preparaci칩n';
                    icono = 'fa-fire';
                    
                    const enCocina = pedidosHoy.filter(p => p.estado === 'en_cocina');
                    const enCamino = pedidosHoy.filter(p => p.estado === 'en_camino');
                    const reservaPendiente = pedidosHoy.filter(p => p.estado === 'reserva_pendiente');
                    const reservaAtendida = pedidosHoy.filter(p => p.estado === 'reserva_atendida');
                    
                    const todosPendientes = [...enCocina, ...enCamino, ...reservaPendiente, ...reservaAtendida];
                    
                    contenido = `<p style="color: #666; margin-bottom: 15px;">Total: <strong>${todosPendientes.length}</strong> pedido(s) en preparaci칩n</p>`;
                    
                    if (todosPendientes.length === 0) {
                        contenido += '<div class="empty-state"><i class="fas fa-check-circle"></i><p>No hay pedidos en preparaci칩n</p></div>';
                    } else {
                        contenido += '<div class="stats-detail-list">';
                        todosPendientes.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(p => {
                            let estadoTexto = '';
                            let estadoColor = '';
                            
                            if (p.estado === 'en_cocina') { estadoTexto = '游녿꽳릜 En Cocina'; estadoColor = 'var(--warning)'; }
                            else if (p.estado === 'en_camino') { estadoTexto = '游띳 En Camino'; estadoColor = 'var(--info)'; }
                            else if (p.estado === 'reserva_pendiente') { estadoTexto = '游늰 Reserva Pendiente'; estadoColor = '#9c27b0'; }
                            else if (p.estado === 'reserva_atendida') { estadoTexto = '九 Cliente Atendido'; estadoColor = '#ff5722'; }
                            
                            contenido += `
                                <div class="detalle-stat-item">
                                    <div class="detalle-stat-info">
                                        <div class="detalle-stat-id">${p.id}</div>
                                        <div class="detalle-stat-meta">
                                            <span style="color: ${estadoColor};">${estadoTexto}</span>
                                            ${p.mesa ? `<span style="color: var(--info);"><i class="fas fa-chair"></i> Mesa #${p.mesa}</span>` : ''}
                                            ${p.telefono ? `<span style="color: var(--success);"><i class="fas fa-phone"></i> ${p.telefono}</span>` : ''}
                                        </div>
                                        <div style="font-size: 0.75rem; color: #999;">${new Date(p.timestamp).toLocaleTimeString()}</div>
                                    </div>
                                    <div class="detalle-stat-total">Bs. ${(p.total || 0).toFixed(2)}</div>
                                </div>
                            `;
                        });
                        contenido += '</div>';
                    }
                    break;
                    
                // ========== PEDIDOS COBRADOS HOY ==========
                case 'cobrados':
                    titulo = 'Pedidos Cobrados Hoy';
                    icono = 'fa-check-circle';
                    
                    const cobrados = pedidosHoy.filter(p => 
                        p.estado === 'cobrado' || 
                        p.estado === 'en_cocina' || 
                        p.estado === 'en_camino' || 
                        p.estado === 'reserva_pendiente' || 
                        p.estado === 'entregado' || 
                        p.estado === 'enviado' || 
                        p.estado === 'reserva_completada'
                    );
                    
                    const totalCobrado = cobrados.reduce((sum, p) => sum + (p.total || 0), 0);
                    
                    contenido = `<p style="color: #666; margin-bottom: 15px;">Total cobrado hoy: <strong style="color: var(--primary); font-size: 1.2rem;">Bs. ${totalCobrado.toFixed(2)}</strong></p>`;
                    
                    if (cobrados.length === 0) {
                        contenido += '<div class="empty-state"><i class="fas fa-inbox"></i><p>No hay cobros registrados hoy</p></div>';
                    } else {
                        contenido += '<div class="stats-detail-list">';
                        cobrados.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(p => {
                            let tipoPedido = '';
                            let colorTipo = '';
                            
                            if (p.tipo === 'mesa') { tipoPedido = 'Mesa'; colorTipo = 'var(--info)'; }
                            else if (p.tipo === 'delivery') { tipoPedido = 'Delivery'; colorTipo = 'var(--success)'; }
                            else if (p.tipo === 'reserva') { tipoPedido = 'Reserva'; colorTipo = '#9c27b0'; }
                            
                            contenido += `
                                <div class="detalle-stat-item">
                                    <div class="detalle-stat-info">
                                        <div class="detalle-stat-id">${p.id}</div>
                                        <div class="detalle-stat-meta">
                                            <span style="color: ${colorTipo};"><i class="fas fa-${p.tipo === 'mesa' ? 'chair' : p.tipo === 'delivery' ? 'motorcycle' : 'calendar-check'}"></i> ${tipoPedido}</span>
                                            <span class="detalle-stat-metodo">${p.metodoPago || 'Pago M칩vil'}</span>
                                        </div>
                                        <div style="font-size: 0.75rem; color: #999;">${new Date(p.timestamp).toLocaleTimeString()}</div>
                                    </div>
                                    <div class="detalle-stat-total">Bs. ${(p.total || 0).toFixed(2)}</div>
                                </div>
                            `;
                        });
                        contenido += '</div>';
                    }
                    break;
                    
                // ========== VENTAS TOTALES ==========
                case 'ventas':
                    titulo = 'Ventas Totales';
                    icono = 'fa-dollar-sign';
                    
                    const ventasDia = pedidosHoy.filter(p => 
                        p.estado !== 'pendiente' && 
                        p.estado !== 'rechazado' && 
                        p.estado !== 'cancelado_timeout'
                    );
                    
                    const totalVentas = ventasDia.reduce((sum, p) => sum + (p.total || 0), 0);
                    const totalItemsVendidos = ventasDia.reduce((sum, p) => sum + (p.items?.length || 0), 0);
                    
                    let porEfectivo = 0, porPM = 0, porPV = 0;
                    ventasDia.forEach(p => {
                        if (p.metodoPago === 'mixto' && p.pagosMixtos) {
                            p.pagosMixtos.forEach(pago => {
                                if (pago.metodo === 'efectivo_bs') porEfectivo += pago.monto;
                                else if (pago.metodo === 'efectivo_usd') porEfectivo += pago.monto * tasaEfectiva;
                                else if (pago.metodo === 'pago_movil') porPM += pago.monto;
                                else if (pago.metodo === 'punto_venta') porPV += pago.monto;
                            });
                        } else {
                            if (p.metodoPago === 'efectivo') porEfectivo += p.total;
                            else if (p.metodoPago === 'pago_movil') porPM += p.total;
                            else if (p.metodoPago === 'punto_venta') porPV += p.total;
                        }
                    });
                    
                    contenido = `
                        <p style="color: #666; margin-bottom: 15px;">
                            Ventas totales del d칤a: <strong style="color: var(--primary); font-size: 1.5rem;">Bs. ${totalVentas.toFixed(2)}</strong><br>
                            <span style="font-size: 0.9rem;">${totalItemsVendidos} productos vendidos</span>
                        </p>
                        
                        <div style="background: #f8f8f8; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                            <h4 style="margin-bottom: 15px; color: var(--secondary);"><i class="fas fa-chart-pie"></i> Desglose por m칠todo de pago:</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 1.5rem; color: var(--success); margin-bottom: 5px;"><i class="fas fa-money-bill-wave"></i></div>
                                    <div style="font-size: 0.85rem; color: #666;">Efectivo</div>
                                    <div style="font-weight: 700; font-size: 1.1rem;">Bs. ${porEfectivo.toFixed(2)}</div>
                                </div>
                                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 1.5rem; color: var(--info); margin-bottom: 5px;"><i class="fas fa-mobile-alt"></i></div>
                                    <div style="font-size: 0.85rem; color: #666;">Pago M칩vil</div>
                                    <div style="font-weight: 700; font-size: 1.1rem;">Bs. ${porPM.toFixed(2)}</div>
                                </div>
                                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; grid-column: span 2;">
                                    <div style="font-size: 1.5rem; color: var(--warning); margin-bottom: 5px;"><i class="fas fa-credit-card"></i></div>
                                    <div style="font-size: 0.85rem; color: #666;">Punto de Venta</div>
                                    <div style="font-weight: 700; font-size: 1.1rem;">Bs. ${porPV.toFixed(2)}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="max-height: 300px; overflow-y: auto;">
                            <h4 style="margin-bottom: 15px; color: var(--secondary);">칔ltimas transacciones:</h4>
                    `;
                    
                    ventasDia.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 10).forEach(p => {
                        let estadoIcon = '';
                        if (p.estado === 'cobrado') estadoIcon = '九';
                        else if (p.estado === 'en_cocina') estadoIcon = '游녿꽳릜';
                        else if (p.estado === 'en_camino') estadoIcon = '游띳';
                        else if (p.estado === 'entregado') estadoIcon = '游꽇勇';
                        
                        contenido += `
                            <div style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee;">
                                <div>
                                    <div style="font-weight: 600;">${p.id} ${estadoIcon}</div>
                                    <div style="font-size: 0.75rem; color: #666;">
                                        ${new Date(p.timestamp).toLocaleTimeString()} 
                                        ${p.mesa ? ` Mesa #${p.mesa}` : ''}
                                    </div>
                                </div>
                                <div style="font-weight: 700; color: var(--primary);">Bs. ${(p.total || 0).toFixed(2)}</div>
                            </div>
                        `;
                    });
                    contenido += '</div>';
                    break;
                    
                // ========== PLATILLOS M츼S VENDIDOS ==========
                case 'platillos':
                    titulo = 'Platillos M치s Vendidos';
                    icono = 'fa-utensils';
                    
                    const ventasPlatillos = pedidosHoy.filter(p => 
                        p.estado !== 'pendiente' && 
                        p.estado !== 'rechazado' && 
                        p.estado !== 'cancelado_timeout'
                    );
                    
                    const conteoPlatillos = {};
                    let totalPlatillosVendidos = 0;
                    
                    ventasPlatillos.forEach(p => {
                        p.items?.forEach(item => {
                            const cantidad = item.cantidad || 1;
                            conteoPlatillos[item.nombre] = (conteoPlatillos[item.nombre] || 0) + cantidad;
                            totalPlatillosVendidos += cantidad;
                        });
                    });
                    
                    const ranking = Object.entries(conteoPlatillos)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 10);
                    
                    const maxVentas = ranking.length > 0 ? ranking[0][1] : 0;
                    
                    contenido = `<p style="color: #666; margin-bottom: 15px;">Total platillos vendidos hoy: <strong style="color: var(--primary); font-size: 1.2rem;">${totalPlatillosVendidos}</strong></p>`;
                    
                    if (ranking.length === 0) {
                        contenido += '<div class="empty-state"><i class="fas fa-utensils"></i><p>No hay ventas registradas hoy</p></div>';
                    } else {
                        contenido += '<div style="max-height: 400px; overflow-y: auto;">';
                        ranking.forEach(([nombre, cantidad], index) => {
                            const porcentaje = maxVentas > 0 ? (cantidad / maxVentas) * 100 : 0;
                            contenido += `
                                <div class="ranking-bar">
                                    <div class="ranking-position">${index + 1}</div>
                                    <div class="ranking-info">
                                        <div class="ranking-name">${nombre}</div>
                                        <div class="ranking-cantidad">${cantidad} vendido(s)</div>
                                    </div>
                                    <div class="ranking-bar-container">
                                        <div class="ranking-bar-fill" style="width: ${porcentaje}%;"></div>
                                    </div>
                                </div>
                            `;
                        });
                        contenido += '</div>';
                    }
                    break;
            }
            
            document.getElementById('statsDetailTitle').innerHTML = `<i class="fas ${icono}"></i> ${titulo}`;
            document.getElementById('statsDetailBody').innerHTML = contenido;
            document.getElementById('statsDetailModal').classList.add('show');
        }

        // ==========================================
        // RENDERIZADO DE PEDIDOS
        // ==========================================
        function renderPedidos() {
            if (!sistemaData) return;
            const pedidos = sistemaData.pedidos || [];
            const hoy = new Date().toISOString().split('T')[0];
            const pedidosHoy = pedidos.filter(p => p.timestamp.startsWith(hoy));
            
            const pendientes = pedidosHoy.filter(p => p.estado === 'pendiente');
            const cobrados = pedidosHoy.filter(p => p.estado === 'cobrado');
            const enCocina = pedidosHoy.filter(p => p.estado === 'en_cocina');
            const enCamino = pedidosHoy.filter(p => p.estado === 'en_camino');
            const reservaPendiente = pedidosHoy.filter(p => p.estado === 'reserva_pendiente');
            const reservaAtendida = pedidosHoy.filter(p => p.estado === 'reserva_atendida');
            
            const totalEnPreparacion = enCocina.length + enCamino.length + reservaPendiente.length + reservaAtendida.length;
            const totalCobrados = cobrados.length + enCocina.length + enCamino.length + reservaAtendida.length;
            
            document.getElementById('statPendientes').textContent = totalEnPreparacion;
            document.getElementById('statCobrados').textContent = totalCobrados;
            
            const totalVentas = pedidosHoy
                .filter(p => ['cobrado', 'en_cocina', 'en_camino', 'entregado', 'enviado', 'reserva_atendida', 'reserva_completada'].includes(p.estado))
                .reduce((sum, p) => sum + (p.total || 0), 0);
            document.getElementById('statVentas').textContent = `Bs. ${totalVentas.toFixed(2)}`;
            
            const totalPlatillos = pedidosHoy
                .filter(p => ['cobrado', 'en_cocina', 'en_camino', 'entregado', 'enviado', 'reserva_atendida', 'reserva_completada'].includes(p.estado))
                .reduce((sum, p) => sum + (p.items?.reduce((itemSum, item) => itemSum + (item.cantidad || 1), 0) || 0), 0);
            document.getElementById('statPlatillos').textContent = totalPlatillos;
            
            document.getElementById('badgePorCobrar').textContent = pendientes.length;
            document.getElementById('badgeEnPreparacion').textContent = totalEnPreparacion;
            
            renderColumnaPorCobrar('colMesaPorCobrar', pendientes.filter(p => p.tipo === 'mesa' || !p.tipo), 'mesa');
            renderColumnaPorCobrar('colDeliveryPorCobrar', pendientes.filter(p => p.tipo === 'delivery'), 'delivery');
            renderColumnaPorCobrar('colReservaPorCobrar', pendientes.filter(p => p.tipo === 'reserva'), 'reserva');
            
            renderColumnaEnPreparacion('colMesaEnCocina', enCocina, 'mesa');
            renderColumnaEnPreparacion('colDeliveryEnCamino', enCamino, 'delivery');
            renderColumnaEnPreparacion('colReservaPendiente', reservaPendiente.concat(reservaAtendida), 'reserva');
        }

        function renderColumnaPorCobrar(columnId, pedidos, tipo) {
            const col = document.getElementById(columnId);
            if (pedidos.length === 0) {
                col.innerHTML = `<div class="empty-state"><i class="fas fa-inbox"></i><p>No hay pedidos ${tipo} por cobrar</p></div>`;
                return;
            }
            col.innerHTML = pedidos.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).map(p => crearCardPedidoPorCobrar(p, tipo)).join('');
        }

        function renderColumnaEnPreparacion(columnId, pedidos, tipo) {
            const col = document.getElementById(columnId);
            if (pedidos.length === 0) {
                col.innerHTML = `<div class="empty-state"><i class="fas fa-inbox"></i><p>No hay pedidos en esta secci칩n</p></div>`;
                return;
            }
            col.innerHTML = pedidos.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).map(p => crearCardPedidoEnPreparacion(p, tipo)).join('');
        }

        function crearCardPedidoPorCobrar(pedido, tipo) {
            const fecha = new Date(pedido.timestamp);
            const hora = fecha.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            const minutosTranscurridos = Math.floor((new Date() - fecha) / 60000);
            
            let timerText = '';
            if (pedido.tipo === 'delivery' || pedido.tipo === 'reserva') {
                const minutosRestantes = 20 - minutosTranscurridos;
                timerText = minutosRestantes > 0 ? `<div class="timer-badge ${minutosRestantes <= 5 ? 'urgent' : ''}"><i class="fas fa-clock"></i> ${minutosRestantes}min restantes</div>` : '<div class="timer-badge urgent"><i class="fas fa-clock"></i> Tiempo agotado</div>';
            }
            
            let totalMostrar = pedido.total || 0;
            
            const itemsHtml = (pedido.items || []).map(item => {
                const personalizacion = item.personalizacion?.length > 0 ? ` <small style="color: #666;">(Sin ${item.personalizacion.join(', ')})</small>` : '';
                
                let descuentoTexto = '';
                if (item.descuentoPorIngredientes && item.descuentoPorIngredientes > 0) {
                    descuentoTexto = `<span class="ingredient-discount">-${item.descuentoPorIngredientes.toFixed(2)} Bs</span>`;
                }
                
                let subtotal = item.subtotal || 0;
                
                return `<div class="order-detail-row">
                    <span>${item.cantidad || 1}x ${item.nombre}${personalizacion} ${descuentoTexto}</span>
                    <span class="item-subtotal">Bs. ${subtotal.toFixed(2)}</span>
                </div>`;
            }).join('');
            
            let extraInfo = '';
            if (pedido.tipo === 'delivery') {
                extraInfo = `<div style="background: #E3F2FD; border: 2px solid var(--info); border-radius: 8px; padding: 10px; margin-bottom: 10px; font-size: 0.85rem;">
                    <div><i class="fas fa-map-marker-alt"></i> ${pedido.direccion}</div>
                    <div><i class="fas fa-phone"></i> ${pedido.telefono}</div>
                    ${pedido.referencia ? `<div><i class="fas fa-receipt"></i> Ref: ${pedido.referencia}</div>` : ''}
                </div>${timerText}`;
                
                if (pedido.tieneComprobante) {
                    extraInfo += `
                        <div class="comprobante-preview">
                            <span class="comprobante-label"><i class="fas fa-file-image"></i> Comprobante de Pago</span>
                            <button class="btn-ver-comprobante" onclick="solicitarComprobante('${pedido.id}')">
                                <i class="fas fa-search-plus"></i> Ver Comprobante
                            </button>
                        </div>
                    `;
                }
            } else if (pedido.tipo === 'reserva') {
                extraInfo = `<div style="background: #E3F2FD; border: 2px solid var(--info); border-radius: 8px; padding: 10px; margin-bottom: 10px; font-size: 0.85rem;">
                    <div><i class="fas fa-user"></i> ${pedido.clienteNombre || 'No especificado'}</div>
                    <div><i class="fas fa-calendar"></i> ${pedido.fechaReserva ? new Date(pedido.fechaReserva).toLocaleDateString() : 'No especificada'}</div>
                    ${pedido.referencia ? `<div><i class="fas fa-receipt"></i> Ref: ${pedido.referencia}</div>` : ''}
                </div>${timerText}`;
                
                if (pedido.tieneComprobante) {
                    extraInfo += `
                        <div class="comprobante-preview">
                            <span class="comprobante-label"><i class="fas fa-file-image"></i> Comprobante de Pago</span>
                            <button class="btn-ver-comprobante" onclick="solicitarComprobante('${pedido.id}')">
                                <i class="fas fa-search-plus"></i> Ver Comprobante
                            </button>
                        </div>
                    `;
                }
            } else {
                extraInfo = `<div style="margin-bottom: 10px; font-weight: 700; color: var(--info);"><i class="fas fa-chair"></i> Mesa #${pedido.mesa || '--'}</div>`;
            }
            
            const botonesRechazo = (pedido.tipo === 'delivery' || pedido.tipo === 'reserva') ? `<button class="btn btn-rechazar" onclick="mostrarRechazo('${pedido.id}')" id="btn-rechazar-${pedido.id}"><i class="fas fa-times"></i> Rechazar</button>` : '';
            
            return `<div class="order-card" id="card-${pedido.id}">
                <div class="order-card-header">
                    <span class="order-id">${pedido.id}</span>
                    <span class="order-time"><i class="fas fa-clock"></i> ${hora}</span>
                </div>
                ${extraInfo}
                <div class="order-details">${itemsHtml}</div>
                <div class="order-total">Total: Bs. ${totalMostrar.toFixed(2)}</div>
                <div class="order-actions">
                    <button class="btn btn-cobrar" onclick="mostrarCobro('${pedido.id}')" id="btn-cobrar-${pedido.id}">
                        <i class="fas fa-check"></i> Cobrar
                    </button>
                    ${botonesRechazo}
                </div>
            </div>`;
        }

        function solicitarComprobante(pedidoId) {
            const comprobantes = JSON.parse(localStorage.getItem('sakiComprobantes') || '{}');
            const comprobante = comprobantes[pedidoId];
            
            if (!comprobante) {
                mostrarNotificacion('No se encontr칩 comprobante en el almacenamiento local del navegador. El cliente debe enviarlo por WhatsApp.', 'error');
                return null;
            }
            
            if (!comprobante.disponible) {
                mostrarNotificacion('El comprobante era muy grande y no se guard칩. Solicitar por WhatsApp.', 'warning');
                return null;
            }
            
            const modal = document.getElementById('comprobanteModal');
            const imgContainer = document.getElementById('comprobanteImagenContainer');
            const infoContainer = document.getElementById('comprobanteInfo');
            const downloadLink = document.getElementById('comprobanteDownloadLink');
            
            imgContainer.innerHTML = `<img src="${comprobante.base64}" style="max-width: 100%; max-height: 400px; border-radius: 8px; border: 1px solid #ddd;" alt="Comprobante de pago">`;
            
            const pedido = sistemaData.pedidos.find(p => p.id === pedidoId);
            let infoHtml = `<h4 style="margin-bottom: 15px; color: var(--secondary);">Detalles del Comprobante</h4>`;
            infoHtml += `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">`;
            infoHtml += `<div><strong>Pedido:</strong> ${pedidoId}</div>`;
            infoHtml += `<div><strong>Tipo:</strong> ${pedido?.tipo === 'delivery' ? 'Delivery' : 'Reserva'}</div>`;
            if (pedido?.tipo === 'delivery') {
                infoHtml += `<div><strong>Tel칠fono:</strong> ${pedido.telefono}</div>`;
                infoHtml += `<div><strong>Direcci칩n:</strong> ${pedido.direccion}</div>`;
            } else {
                infoHtml += `<div><strong>Cliente:</strong> ${pedido.clienteNombre}</div>`;
                infoHtml += `<div><strong>Fecha Reserva:</strong> ${new Date(pedido.fechaReserva).toLocaleDateString()}</div>`;
            }
            infoHtml += `<div><strong>Referencia:</strong> ${pedido.referencia}</div>`;
            infoHtml += `<div><strong>Total:</strong> $${pedido.total?.toFixed(2)}</div>`;
            infoHtml += `<div><strong>Archivo:</strong> ${comprobante.nombre || 'comprobante.jpg'}</div>`;
            infoHtml += `</div>`;
            
            infoContainer.innerHTML = infoHtml;
            downloadLink.href = comprobante.base64;
            downloadLink.download = comprobante.nombre || 'comprobante.jpg';
            
            modal.classList.add('show');
            return comprobante;
        }

        function crearCardPedidoEnPreparacion(pedido, tipo) {
            const fecha = new Date(pedido.timestamp);
            const hora = fecha.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            
            let totalMostrar = pedido.total || 0;
            
            const itemsHtml = (pedido.items || []).map(item => {
                const personalizacion = item.personalizacion?.length > 0 ? ` <small style="color: #666;">(Sin ${item.personalizacion.join(', ')})</small>` : '';
                
                let descuentoTexto = '';
                if (item.descuentoPorIngredientes && item.descuentoPorIngredientes > 0) {
                    descuentoTexto = `<span class="ingredient-discount">-${item.descuentoPorIngredientes.toFixed(2)} Bs</span>`;
                }
                
                let subtotal = item.subtotal || 0;
                
                return `<div class="order-detail-row">
                    <span>${item.cantidad || 1}x ${item.nombre}${personalizacion} ${descuentoTexto}</span>
                    <span class="item-subtotal">Bs. ${subtotal.toFixed(2)}</span>
                </div>`;
            }).join('');
            
            let estadoClass = '';
            let estadoBadge = '';
            let botonAccion = '';
            let cardClass = '';
            let btnId = '';
            
            switch(pedido.estado) {
                case 'en_cocina':
                    estadoClass = 'status-en-cocina';
                    estadoBadge = '<span class="status-badge status-en-cocina"><i class="fas fa-fire"></i> En Cocina</span>';
                    btnId = `btn-entregar-${pedido.id}`;
                    botonAccion = `<button class="btn btn-entregar" onclick="mostrarConfirmacionEntrega('${pedido.id}', 'entrega')" id="${btnId}"><i class="fas fa-check"></i> Pedido Entregado</button>`;
                    cardClass = 'en-cocina';
                    break;
                case 'en_camino':
                    estadoClass = 'status-en-camino';
                    estadoBadge = '<span class="status-badge status-en-camino"><i class="fas fa-motorcycle"></i> En Camino</span>';
                    btnId = `btn-enviar-${pedido.id}`;
                    botonAccion = `<button class="btn btn-enviar" onclick="mostrarConfirmacionEntrega('${pedido.id}', 'envio')" id="${btnId}"><i class="fas fa-check"></i> Pedido Enviado</button>`;
                    cardClass = 'en-camino';
                    break;
                case 'reserva_pendiente':
                    estadoClass = 'status-reserva-pendiente';
                    estadoBadge = '<span class="status-badge status-reserva-pendiente"><i class="fas fa-calendar"></i> Reserva Pendiente</span>';
                    btnId = `btn-confirmar-${pedido.id}`;
                    botonAccion = `<button class="btn btn-confirmar" onclick="mostrarConfirmacionEntrega('${pedido.id}', 'reserva')" id="${btnId}"><i class="fas fa-user-check"></i> Cliente Confirmado</button>`;
                    cardClass = 'reserva-pendiente';
                    break;
                case 'reserva_atendida':
                    estadoClass = 'status-reserva-atendida';
                    estadoBadge = '<span class="status-badge status-reserva-atendida"><i class="fas fa-utensils"></i> Cliente Atendido</span>';
                    btnId = `btn-entregar-reserva-${pedido.id}`;
                    botonAccion = `<button class="btn btn-entregar" onclick="mostrarConfirmacionEntrega('${pedido.id}', 'reserva_entrega')" id="${btnId}"><i class="fas fa-check"></i> Pedido Entregado</button>`;
                    cardClass = 'reserva-atendida';
                    break;
            }
            
            let extraInfo = '';
            if (pedido.tipo === 'delivery') {
                extraInfo = `<div style="background: #E3F2FD; border: 2px solid var(--info); border-radius: 8px; padding: 10px; margin: 10px 0; font-size: 0.85rem;">
                    <div><strong><i class="fas fa-map-marker-alt"></i> Direcci칩n:</strong> ${pedido.direccion}</div>
                    <div><strong><i class="fas fa-phone"></i> Tel칠fono:</strong> ${pedido.telefono}</div>
                    ${pedido.referencia ? `<div><strong><i class="fas fa-receipt"></i> Referencia:</strong> ${pedido.referencia}</div>` : ''}
                </div>`;
                
                if (pedido.tieneComprobante) {
                    extraInfo += `
                        <div class="comprobante-preview" style="margin-top: 10px;">
                            <span class="comprobante-label"><i class="fas fa-file-image"></i> Comprobante de Pago</span>
                            <button class="btn-ver-comprobante" onclick="solicitarComprobante('${pedido.id}')">
                                <i class="fas fa-search-plus"></i> Ver Completo
                            </button>
                        </div>
                    `;
                }
            } else if (pedido.tipo === 'reserva') {
                const fechaReserva = pedido.fechaReserva ? new Date(pedido.fechaReserva) : null;
                const hoy = new Date();
                const esHoy = fechaReserva && fechaReserva.toDateString() === hoy.toDateString();
                
                extraInfo = `<div style="background: #F3E5F5; border: 2px solid #9c27b0; border-radius: 8px; padding: 10px; margin: 10px 0; font-size: 0.85rem;">
                    <div><strong><i class="fas fa-user"></i> Cliente:</strong> ${pedido.clienteNombre || 'No especificado'}</div>
                    <div><strong><i class="fas fa-calendar"></i> Fecha Reserva:</strong> ${fechaReserva ? fechaReserva.toLocaleDateString() : 'No especificada'} ${esHoy ? '<span style="color: #9c27b0; font-weight: bold;">(HOY)</span>' : ''}</div>
                    ${pedido.referencia ? `<div><strong><i class="fas fa-receipt"></i> Referencia:</strong> ${pedido.referencia}</div>` : ''}
                </div>`;
                
                if (pedido.tieneComprobante) {
                    extraInfo += `
                        <div class="comprobante-preview" style="margin-top: 10px;">
                            <span class="comprobante-label"><i class="fas fa-file-image"></i> Comprobante de Pago</span>
                            <button class="btn-ver-comprobante" onclick="solicitarComprobante('${pedido.id}')">
                                <i class="fas fa-search-plus"></i> Ver Completo
                            </button>
                        </div>
                    `;
                }
            } else {
                extraInfo = `<div style="margin: 10px 0; font-weight: 700; color: var(--info); background: #E3F2FD; padding: 10px; border-radius: 8px;"><i class="fas fa-chair"></i> Mesa #${pedido.mesa || '--'}</div>`;
            }
            
            return `<div class="order-card ${cardClass}" id="card-prep-${pedido.id}">
                <div class="order-card-header">
                    <span class="order-id">${pedido.id}</span>
                    <span class="order-time"><i class="fas fa-clock"></i> ${hora}</span>
                </div>
                ${estadoBadge}
                <div class="order-details">${itemsHtml}</div>
                <div class="order-total">Total: Bs. ${totalMostrar.toFixed(2)}</div>
                ${extraInfo}
                <div class="order-actions">${botonAccion}</div>
            </div>`;
        }

        // ==========================================
        // CONFIRMACI칍N DE ENTREGA/ENV칈O/RESERVA
        // ==========================================
        function mostrarConfirmacionEntrega(pedidoId, tipo) {
            if (isProcessing) return;
            
            pedidoConfirmacion = sistemaData.pedidos.find(p => p.id === pedidoId);
            if (!pedidoConfirmacion) return;
            
            tipoConfirmacion = tipo;
            const modal = document.getElementById('confirmEntregaModal');
            const header = document.getElementById('confirmEntregaHeader');
            const title = document.getElementById('confirmEntregaTitle');
            const body = document.getElementById('confirmEntregaBody');
            
            const total = pedidoConfirmacion.total || 0;
            
            let titulo = '';
            let mensaje = '';
            let icono = '';
            let notificacionCliente = { titulo: '', texto: '' };
            
            switch(tipo) {
                case 'entrega':
                    titulo = 'Confirmar Entrega en Mesa';
                    mensaje = '쮺onfirmas que el pedido ha sido entregado al cliente en la mesa?';
                    icono = 'fa-check-circle';
                    header.className = 'modal-header entrega';
                    notificacionCliente = {
                        titulo: '游꽇勇 춰Que aproveche!',
                        texto: 'Tu pedido ha sido entregado en tu mesa. Esperamos que disfrutes cada bocado. 춰Gracias por elegir Saki Sushi!'
                    };
                    break;
                case 'envio':
                    titulo = 'Confirmar Env칤o a Delivery';
                    mensaje = '쮺onfirmas que el pedido ha sido enviado al repartidor?';
                    icono = 'fa-motorcycle';
                    header.className = 'modal-header envio';
                    notificacionCliente = {
                        titulo: 'Tu delivery va en camino!',
                        texto: 'El repartidor ya sali칩 con tu pedido. Prep치rate para disfrutar de tu comida.'
                    };
                    break;
                case 'reserva':
                    titulo = 'Confirmar Asistencia a Reserva';
                    mensaje = '쮺onfirmas que el cliente ha llegado y est치 siendo atendido?';
                    icono = 'fa-user-check';
                    header.className = 'modal-header reserva';
                    notificacionCliente = {
                        titulo: '九 춰Cliente confirmado!',
                        texto: 'Has llegado y est치s siendo atendido. Por favor, espera en tu mesa asignada.'
                    };
                    break;
                case 'reserva_entrega':
                    titulo = 'Confirmar Entrega de Reserva';
                    mensaje = '쮺onfirmas que el pedido ha sido servido al cliente reservado?';
                    icono = 'fa-utensils';
                    header.className = 'modal-header entrega';
                    notificacionCliente = {
                        titulo: '游꽇勇 춰Que aproveche!',
                        texto: 'Tu pedido de reserva ha sido servido. Esperamos que disfrutes tu experiencia en Saki Sushi.'
                    };
                    break;
            }
            
            title.innerHTML = `<i class="fas ${icono}"></i> ${titulo}`;
            
            let detallesExtras = '';
            if (pedidoConfirmacion.tipo === 'delivery') {
                detallesExtras = `<div class="info-row"><span>Direcci칩n:</span><span>${pedidoConfirmacion.direccion}</span></div>
                    <div class="info-row"><span>Tel칠fono:</span><span>${pedidoConfirmacion.telefono}</span></div>`;
            } else if (pedidoConfirmacion.tipo === 'reserva') {
                detallesExtras = `<div class="info-row"><span>Cliente:</span><span>${pedidoConfirmacion.clienteNombre || 'No especificado'}</span></div>
                    <div class="info-row"><span>Fecha Reserva:</span><span>${pedidoConfirmacion.fechaReserva ? new Date(pedidoConfirmacion.fechaReserva).toLocaleDateString() : 'No especificada'}</span></div>`;
            } else {
                detallesExtras = `<div class="info-row"><span>Mesa:</span><span>#${pedidoConfirmacion.mesa || '--'}</span></div>`;
            }
            
            body.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <i class="fas ${icono}" style="font-size: 3rem; color: var(--primary); margin-bottom: 10px;"></i>
                    <p style="font-size: 1.1rem; color: #666;">${mensaje}</p>
                </div>
                <div class="info-box">
                    <div class="info-row"><span>Pedido:</span><span>${pedidoConfirmacion.id}</span></div>
                    <div class="info-row"><span>Items:</span><span>${pedidoConfirmacion.items?.length || 0}</span></div>
                    ${detallesExtras}
                    <div class="info-row"><span>Total:</span><span>Bs. ${total.toFixed(2)}</span></div>
                </div>
                <div style="background: #E8F5E9; border-left: 4px solid var(--success); padding: 15px; margin-top: 15px; border-radius: 8px;">
                    <i class="fas fa-bell"></i> <strong>Notificaci칩n al cliente:</strong><br>
                    <span style="color: var(--success);">${notificacionCliente.titulo}</span><br>
                    <span style="font-size: 0.9rem; color: #666;">${notificacionCliente.texto}</span>
                </div>
                <div class="keyboard-hint">
                    <span><kbd>ENTER</kbd> para confirmar</span>
                    <span><kbd>ESC</kbd> para cancelar</span>
                </div>
            `;
            
            modal.classList.add('show');
            setTimeout(() => document.getElementById('btnConfirmarAccion').focus(), 100);
        }

        async function ejecutarConfirmacion() {
            if (isProcessing || !pedidoConfirmacion || !tipoConfirmacion) return;
            
            setButtonsDisabled(true);
            
            queueOperation(async () => {
                try {
                    const pedidoActual = sistemaData.pedidos.find(p => p.id === pedidoConfirmacion.id);
                    if (!pedidoActual) {
                        mostrarNotificacion('Pedido no encontrado', 'error');
                        return;
                    }
                    
                    let mensajeNotificacion = { titulo: '', texto: '', tipo: 'approved' };
                    
                    switch(tipoConfirmacion) {
                        case 'entrega':
                            pedidoActual.estado = 'entregado';
                            pedidoActual.fechaEntrega = new Date().toISOString();
                            mensajeNotificacion = {
                                titulo: '游꽇勇 춰Que aproveche!',
                                texto: 'Tu pedido ha sido entregado en tu mesa. Esperamos que disfrutes cada bocado. 춰Gracias por elegir Saki Sushi!',
                                tipo: 'approved'
                            };
                            break;
                        case 'envio':
                            pedidoActual.estado = 'enviado';
                            pedidoActual.fechaEnvio = new Date().toISOString();
                            mensajeNotificacion = {
                                titulo: 'Tu delivery va en camino!',
                                texto: 'El repartidor ya sali칩 con tu pedido. Prep치rate para disfrutar de tu comida.',
                                tipo: 'approved'
                            };
                            break;
                        case 'reserva':
                            pedidoActual.estado = 'reserva_atendida';
                            pedidoActual.fechaAsistencia = new Date().toISOString();
                            mensajeNotificacion = {
                                titulo: '九 춰Cliente confirmado!',
                                texto: 'Has llegado y est치s siendo atendido. Por favor, espera en tu mesa asignada.',
                                tipo: 'approved'
                            };
                            break;
                        case 'reserva_entrega':
                            pedidoActual.estado = 'reserva_completada';
                            pedidoActual.fechaCompletado = new Date().toISOString();
                            mensajeNotificacion = {
                                titulo: '游꽇勇 춰Que aproveche!',
                                texto: 'Tu pedido de reserva ha sido servido. Esperamos que disfrutes tu experiencia en Saki Sushi.',
                                tipo: 'approved'
                            };
                            break;
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 200));
                    await guardarCambios();
                    await new Promise(resolve => setTimeout(resolve, 300));
                    
                    agregarNotificacionCliente(
                        pedidoActual.id, 
                        mensajeNotificacion.tipo, 
                        mensajeNotificacion.titulo, 
                        mensajeNotificacion.texto
                    );
                    
                    cerrarModal('confirmEntregaModal');
                    mostrarNotificacion('Estado actualizado. Cliente notificado.');
                    
                    await new Promise(resolve => setTimeout(resolve, 200));
                    renderPedidos();
                    
                } catch (error) {
                    console.error('Error en confirmaci칩n:', error);
                    mostrarNotificacion('Error al procesar. Intente nuevamente.', 'error');
                } finally {
                    pedidoConfirmacion = null;
                    tipoConfirmacion = null;
                    setButtonsDisabled(false);
                }
            });
        }

        function agregarNotificacionCliente(pedidoId, tipo, titulo, mensaje) {
            try {
                const notificacion = {
                    id: Date.now(),
                    pedidoId: pedidoId,
                    tipo: tipo,
                    titulo: titulo,
                    mensaje: mensaje,
                    timestamp: new Date().toISOString(),
                    leida: false
                };
                
                let notificaciones = JSON.parse(localStorage.getItem('sakiNotificaciones') || '[]');
                notificaciones.unshift(notificacion);
                localStorage.setItem('sakiNotificaciones', JSON.stringify(notificaciones));
                
                console.log('游닓 Notificaci칩n enviada al cliente:', notificacion);
            } catch (e) {
                console.error('Error guardando notificaci칩n:', e);
            }
        }

        function handleGlobalKeypress(e) {
            const modalConfirmacion = document.getElementById('confirmEntregaModal');
            if (modalConfirmacion.classList.contains('show')) {
                if (e.key === 'Enter') { e.preventDefault(); ejecutarConfirmacion(); }
                else if (e.key === 'Escape') { e.preventDefault(); cerrarModal('confirmEntregaModal'); pedidoConfirmacion = null; tipoConfirmacion = null; }
                return;
            }
            
            const modalCobro = document.getElementById('cobroModal');
            if (modalCobro.classList.contains('show')) {
                if (e.key === 'Escape') closeModal('cobroModal');
                return;
            }
            
            const modalRechazo = document.getElementById('rechazoModal');
            if (modalRechazo.classList.contains('show')) {
                if (e.key === 'Escape') closeModal('rechazoModal');
                return;
            }
            
            const modalComprobante = document.getElementById('comprobanteModal');
            if (modalComprobante.classList.contains('show')) {
                if (e.key === 'Escape') cerrarModal('comprobanteModal');
                return;
            }
        }

        // ==========================================
        // COBRO - CON DESCUENTO DE INVENTARIO (춰CORREGIDO!)
        // ==========================================
        function mostrarCobro(pedidoId) {
            if (isProcessing) return;
            
            currentPedido = sistemaData.pedidos.find(p => p.id === pedidoId);
            if (!currentPedido) return;
            
            const summary = document.getElementById('cobroSummary');
            
            let itemsHtml = (currentPedido.items || []).map(item => {
                const personalizacion = item.personalizacion?.length > 0 ? ` <small style="color: #666;">(Sin ${item.personalizacion.join(', ')})</small>` : '';
                
                let descuentoTexto = '';
                let descuentoDetalle = '';
                
                if (item.descuentoPorIngredientes && item.descuentoPorIngredientes > 0) {
                    descuentoTexto = `<span class="ingredient-discount">-${item.descuentoPorIngredientes.toFixed(2)} Bs</span>`;
                    descuentoDetalle = `<div style="font-size: 0.8rem; color: var(--success); margin-top: 2px;">
                        <i class="fas fa-tag"></i> Descuento por ingredientes removidos: -Bs. ${item.descuentoPorIngredientes.toFixed(2)}
                    </div>`;
                }
                
                let subtotal = item.subtotal || 0;
                
                return `<div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                    <div>
                        <span>${item.cantidad || 1}x ${item.nombre}${personalizacion} ${descuentoTexto}</span>
                        ${descuentoDetalle}
                    </div>
                    <span style="font-weight: 600;">Bs. ${subtotal.toFixed(2)}</span>
                </div>`;
            }).join('');
            
            totalPagar = currentPedido.total || 0;
            
            summary.innerHTML = `<div style="background: #f8f8f8; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                <h4 style="margin-bottom: 10px; color: var(--secondary);">Detalle del Pedido:</h4>
                ${itemsHtml}
            </div>`;
            
            document.getElementById('totalPagarDisplay').textContent = `Bs. ${totalPagar.toFixed(2)}`;
            
            pagosMixtos = [];
            renderPagosMixtos();
            actualizarResumenPago();
            
            document.getElementById('specialOptions').style.display = 'none';
            document.getElementById('btnConfirmarCobro').disabled = true;
            
            document.getElementById('cobroModal').classList.add('show');
        }

        function agregarMetodoPago() {
            if (pagosMixtos.length >= 4) {
                mostrarNotificacion('M치ximo 4 m칠todos de pago', 'error');
                return;
            }
            
            const metodosDisponibles = [
                { id: 'efectivo_bs', nombre: 'Efectivo Bs', icono: 'fa-money-bill-wave' },
                { id: 'efectivo_usd', nombre: 'Efectivo $', icono: 'fa-dollar-sign' },
                { id: 'pago_movil', nombre: 'Pago M칩vil', icono: 'fa-mobile-alt' },
                { id: 'punto_venta', nombre: 'Punto de Venta', icono: 'fa-credit-card' }
            ];
            
            const usados = pagosMixtos.map(p => p.metodo);
            const disponibles = metodosDisponibles.filter(m => !usados.includes(m.id));
            
            if (disponibles.length === 0) {
                mostrarNotificacion('Todos los m칠todos de pago ya fueron agregados', 'error');
                return;
            }
            
            pagosMixtos.push({
                id: Date.now(),
                metodo: disponibles[0].id,
                monto: 0,
                referencia: ''
            });
            
            renderPagosMixtos();
            actualizarResumenPago();
        }

        function renderPagosMixtos() {
            const container = document.getElementById('paymentMixContainer');
            
            if (pagosMixtos.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Agrega un m칠todo de pago para comenzar</p>';
                document.getElementById('btnAddPayment').disabled = false;
                return;
            }
            
            const metodosOptions = [
                { id: 'efectivo_bs', nombre: 'Efectivo Bs' },
                { id: 'efectivo_usd', nombre: 'Efectivo $' },
                { id: 'pago_movil', nombre: 'Pago M칩vil' },
                { id: 'punto_venta', nombre: 'Punto de Venta' }
            ];
            
            container.innerHTML = pagosMixtos.map((pago, index) => {
                const usados = pagosMixtos.map(p => p.metodo);
                const options = metodosOptions.map(m => 
                    `<option value="${m.id}" ${pago.metodo === m.id ? 'selected' : ''} ${usados.includes(m.id) && pago.metodo !== m.id ? 'disabled' : ''}>${m.nombre}</option>`
                ).join('');
                
                const showReferencia = pago.metodo === 'pago_movil';
                const isUsd = pago.metodo === 'efectivo_usd';
                
                return `
                    <div class="payment-mix-item" id="pago-${pago.id}">
                        <div class="payment-mix-header">
                            <div class="payment-mix-title">
                                <i class="fas fa-${getIconoMetodo(pago.metodo)}"></i>
                                <select class="payment-method-select" onchange="cambiarMetodoPago(${pago.id}, this.value)">
                                    ${options}
                                </select>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-weight: 600; color: var(--secondary);">${isUsd ? '$' : 'Bs.'}</span>
                                <input type="number" step="0.01" class="payment-mix-input" 
                                    value="${pago.monto > 0 ? pago.monto : ''}" 
                                    placeholder="0.00" 
                                    oninput="actualizarMontoPago(${pago.id}, this.value)"
                                    onkeypress="handlePaymentKeypress(event)">
                                ${pagosMixtos.length > 1 ? `<button class="btn-remove-payment" onclick="eliminarMetodoPago(${pago.id})"><i class="fas fa-times"></i></button>` : ''}
                            </div>
                        </div>
                        ${showReferencia ? `
                            <div class="reference-input">
                                <label style="font-size: 0.85rem; color: #666; display: block; margin-bottom: 5px;">칔ltimos 6 d칤gitos de referencia:</label>
                                <input type="text" maxlength="6" placeholder="000000" value="${pago.referencia}" oninput="actualizarReferencia(${pago.id}, this.value)">
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            document.getElementById('btnAddPayment').disabled = pagosMixtos.length >= 4;
        }

        function getIconoMetodo(metodo) {
            const iconos = {
                'efectivo_bs': 'money-bill-wave',
                'efectivo_usd': 'dollar-sign',
                'pago_movil': 'mobile-alt',
                'punto_venta': 'credit-card'
            };
            return iconos[metodo] || 'money-bill';
        }

        function cambiarMetodoPago(id, nuevoMetodo) {
            const pago = pagosMixtos.find(p => p.id === id);
            if (pago) {
                pago.metodo = nuevoMetodo;
                pago.monto = 0;
                pago.referencia = '';
                renderPagosMixtos();
                actualizarResumenPago();
            }
        }

        function actualizarMontoPago(id, monto) {
            const pago = pagosMixtos.find(p => p.id === id);
            if (pago) {
                pago.monto = parseFloat(monto) || 0;
                actualizarResumenPago();
            }
        }

        function actualizarReferencia(id, referencia) {
            const pago = pagosMixtos.find(p => p.id === id);
            if (pago) {
                pago.referencia = referencia;
            }
        }

        function eliminarMetodoPago(id) {
            pagosMixtos = pagosMixtos.filter(p => p.id !== id);
            renderPagosMixtos();
            actualizarResumenPago();
        }

        function handlePaymentKeypress(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const totalRecibido = pagosMixtos.reduce((sum, p) => sum + convertirAMontoReal(p), 0);
                const pendiente = totalPagar - totalRecibido;
                
                if (pendiente > 0 && pagosMixtos.length < 4) {
                    agregarMetodoPago();
                }
            }
        }

        function convertirAMontoReal(pago) {
            if (pago.metodo === 'efectivo_usd') {
                return pago.monto * tasaEfectiva;
            }
            return pago.monto;
        }

        function actualizarResumenPago() {
            let totalRecibido = 0;
            let totalRecibidoUsd = 0;
            let totalRecibidoBs = 0;
            
            pagosMixtos.forEach(pago => {
                if (pago.metodo === 'efectivo_usd') {
                    totalRecibidoUsd += pago.monto;
                    totalRecibido += pago.monto * tasaEfectiva;
                } else {
                    totalRecibidoBs += pago.monto;
                    totalRecibido += pago.monto;
                }
            });
            
            const pendiente = totalPagar - totalRecibido;
            const cambio = totalRecibido > totalPagar ? totalRecibido - totalPagar : 0;
            const faltante = totalRecibido < totalPagar ? totalPagar - totalRecibido : 0;
            
            const remainingDisplay = document.getElementById('remainingDisplay');
            const remainingAmount = document.getElementById('remainingAmount');
            
            if (pendiente > 0) {
                remainingDisplay.className = 'payment-mix-remaining';
                remainingAmount.textContent = `Bs. ${pendiente.toFixed(2)}`;
                remainingAmount.style.color = 'var(--warning)';
            } else if (pendiente === 0) {
                remainingDisplay.className = 'payment-mix-remaining paid';
                remainingAmount.textContent = '춰PAGO COMPLETO!';
                remainingAmount.style.color = 'var(--success)';
            } else {
                remainingDisplay.className = 'payment-mix-remaining overpaid';
                remainingAmount.textContent = `Bs. ${Math.abs(pendiente).toFixed(2)} (excedente)`;
                remainingAmount.style.color = 'var(--danger)';
            }
            
            const summaryDiv = document.getElementById('paymentSummary');
            if (pagosMixtos.length > 0 && pagosMixtos.some(p => p.monto > 0)) {
                summaryDiv.style.display = 'block';
                
                let resumenTexto = `Total recibido: Bs. ${totalRecibido.toFixed(2)}`;
                if (totalRecibidoUsd > 0) {
                    resumenTexto += ` ($${totalRecibidoUsd.toFixed(2)} 칑 ${tasaEfectiva.toFixed(2)})`;
                }
                document.getElementById('totalRecibido').textContent = resumenTexto;
                
                if (cambio > 0) {
                    document.getElementById('cambioRow').style.display = 'flex';
                    document.getElementById('cambioAmount').textContent = `Bs. ${cambio.toFixed(2)}`;
                } else {
                    document.getElementById('cambioRow').style.display = 'none';
                }
                
                if (faltante > 0) {
                    document.getElementById('faltanteRow').style.display = 'flex';
                    document.getElementById('faltanteAmount').textContent = `Bs. ${faltante.toFixed(2)}`;
                    document.getElementById('montoAfavor').value = faltante.toFixed(2);
                    document.getElementById('montoCondonacion').value = faltante.toFixed(2);
                    document.getElementById('specialOptions').style.display = 'block';
                } else {
                    document.getElementById('faltanteRow').style.display = 'none';
                    document.getElementById('specialOptions').style.display = 'none';
                    document.getElementById('optNormal').checked = true;
                    toggleSpecialInput();
                }
            } else {
                summaryDiv.style.display = 'none';
            }
            
            const btnConfirmar = document.getElementById('btnConfirmarCobro');
            const hayMontoValido = pagosMixtos.some(p => p.monto > 0);
            const hayReferenciaValida = pagosMixtos.every(p => {
                if (p.metodo === 'pago_movil') {
                    return p.referencia && p.referencia.length === 6;
                }
                return true;
            });
            
            btnConfirmar.disabled = !hayMontoValido || !hayReferenciaValida;
        }

        function toggleSpecialInput() {
            const selected = document.querySelector('input[name="specialOption"]:checked')?.value || 'normal';
            document.getElementById('inputAfavor').classList.toggle('show', selected === 'afavor');
            document.getElementById('inputCondonacion').classList.toggle('show', selected === 'condonacion');
            document.getElementById('inputCasa').classList.toggle('show', selected === 'casa');
        }

        // ==========================================
        // CONFIRMAR COBRO - DESCUENTA STOCK REAL (춰CORREGIDO!)
        // ==========================================
        async function confirmarCobro() {
            if (isProcessing || !currentPedido || pagosMixtos.length === 0) return;
            
            const btnConfirmar = document.getElementById('btnConfirmarCobro');
            btnConfirmar.disabled = true;
            
            queueOperation(async () => {
                try {
                    let totalRecibido = 0;
                    let totalRecibidoUsd = 0;
                    
                    pagosMixtos.forEach(pago => {
                        if (pago.metodo === 'efectivo_usd') {
                            totalRecibidoUsd += pago.monto;
                            totalRecibido += pago.monto * tasaEfectiva;
                        } else {
                            totalRecibido += pago.monto;
                        }
                    });
                    
                    const diferencia = totalRecibido - totalPagar;
                    const specialOption = document.querySelector('input[name="specialOption"]:checked')?.value || 'normal';
                    
                    const pedidoActual = sistemaData.pedidos.find(p => p.id === currentPedido.id);
                    if (!pedidoActual) {
                        mostrarNotificacion('Pedido no encontrado', 'error');
                        return;
                    }
                    
                    // 九 PASO 1: DESCONTAR STOCK DEL INVENTARIO REAL (SOLO AHORA, AL COBRAR)
                    if (pedidoActual.items) {
                        pedidoActual.items.forEach(item => {
                            const platillo = sistemaData.menu.find(p => p.id === item.platilloId);
                            if (platillo && platillo.ingredientes) {
                                Object.entries(platillo.ingredientes).forEach(([ingKey, ingData]) => {
                                    // SOLO descontar si el ingrediente NO fue removido
                                    if (!item.personalizacion?.includes(ingKey)) {
                                        if (sistemaData.inventario[ingKey]) {
                                            const cantidadNecesaria = convertirUnidad(
                                                ingData.cantidad * (item.cantidad || 1),
                                                ingData.unidad || 'unidades',
                                                sistemaData.inventario[ingKey].unidad || 'unidades'
                                            );
                                            sistemaData.inventario[ingKey].stock = Math.max(
                                                0, 
                                                (sistemaData.inventario[ingKey].stock || 0) - cantidadNecesaria
                                            );
                                            console.log(`游댃 Descontando ${cantidadNecesaria.toFixed(3)} de ${sistemaData.inventario[ingKey].nombre}. Stock restante: ${sistemaData.inventario[ingKey].stock.toFixed(3)}`);
                                        }
                                    }
                                });
                            }
                        });
                    }
                    
                    // 九 PASO 2: DESCONTAR STOCK DE PLATILLOS
                    pedidoActual.items?.forEach(item => {
                        const platillo = sistemaData.menu.find(p => p.id === item.platilloId);
                        if (platillo) {
                            platillo.stock = Math.max(0, (platillo.stock || 0) - (item.cantidad || 1));
                            platillo.stockMaximo = platillo.stock;
                            console.log(`游닍 Stock de ${platillo.nombre}: ${platillo.stock + (item.cantidad || 1)}  ${platillo.stock}`);
                        }
                    });
                    
                    // 九 PASO 3: ACTUALIZAR ESTADO DEL PEDIDO
                    if (pedidoActual.tipo === 'delivery') {
                        pedidoActual.estado = 'en_camino';
                    } else if (pedidoActual.tipo === 'reserva') {
                        pedidoActual.estado = 'reserva_pendiente';
                    } else {
                        pedidoActual.estado = 'en_cocina';
                    }
                    
                    pedidoActual.cajero = 'Cajero Principal';
                    pedidoActual.fechaCobro = new Date().toISOString();
                    pedidoActual.pagosMixtos = pagosMixtos.map(p => ({
                        metodo: p.metodo,
                        monto: p.monto,
                        montoBs: p.metodo === 'efectivo_usd' ? p.monto * tasaEfectiva : p.monto,
                        referencia: p.referencia
                    }));
                    
                    pedidoActual.metodoPago = 'mixto';
                    pedidoActual.montoRecibido = totalRecibido;
                    pedidoActual.montoRecibidoUsd = totalRecibidoUsd;
                    pedidoActual.tasaAplicada = tasaEfectiva;
                    
                    if (diferencia < 0) {
                        pedidoActual.diferencia = Math.abs(diferencia);
                        pedidoActual.tipoDiferencia = specialOption;
                        if (specialOption === 'casa') pedidoActual.invitadoPor = document.getElementById('nombreInvita').value;
                    } else if (diferencia > 0) {
                        pedidoActual.cambio = diferencia;
                    }
                    
                    // 九 PASO 4: ENVIAR NOTIFICACI칍N AL CLIENTE
                    let mensajeNotificacion = {
                        titulo: '游꿀 춰Pago confirmado!',
                        texto: '',
                        tipo: 'approved'
                    };
                    
                    if (pedidoActual.tipo === 'delivery') {
                        mensajeNotificacion.texto = 'Tu pago ha sido verificado. El repartidor saldr치 pronto con tu pedido. 춰Gracias por elegir Saki Sushi!';
                    } else if (pedidoActual.tipo === 'reserva') {
                        mensajeNotificacion.texto = 'Tu pago ha sido verificado. Tu reserva est치 confirmada. 춰Te esperamos en la fecha acordada!';
                    } else {
                        mensajeNotificacion.texto = 'Tu pago ha sido verificado. Nuestros chefs comenzar치n a preparar tu pedido inmediatamente.';
                    }
                    
                    agregarNotificacionCliente(pedidoActual.id, mensajeNotificacion.tipo, mensajeNotificacion.titulo, mensajeNotificacion.texto);
                    
                    await new Promise(resolve => setTimeout(resolve, 200));
                    await guardarCambios();
                    await new Promise(resolve => setTimeout(resolve, 300));
                    
                    closeModal('cobroModal');
                    mostrarNotificacion('九 Cobro procesado. Stock descontado. Cliente notificado.');
                    
                    await new Promise(resolve => setTimeout(resolve, 200));
                    renderPedidos();
                    
                } catch (error) {
                    console.error('Error en cobro:', error);
                    mostrarNotificacion('Error al procesar cobro. Intente nuevamente.', 'error');
                    btnConfirmar.disabled = false;
                }
            });
        }

        function convertirUnidad(valor, desde, hacia) {
            if (desde === hacia) return valor;
            
            let enBase = valor;
            if (desde === 'kilogramos') enBase = valor * 1000;
            else if (desde === 'litros') enBase = valor * 1000;
            
            if (hacia === 'kilogramos') return enBase / 1000;
            else if (hacia === 'litros') return enBase / 1000;
            
            return enBase;
        }

        // ==========================================
        // RECHAZO
        // ==========================================
        function mostrarRechazo(pedidoId) {
            if (isProcessing) return;
            pedidoRechazo = sistemaData.pedidos.find(p => p.id === pedidoId);
            if (pedidoRechazo) {
                document.getElementById('rechazoModal').classList.add('show');
            }
        }

        async function confirmarRechazo() {
            if (isProcessing || !pedidoRechazo) return;
            
            const razon = document.querySelector('input[name="rejectionReason"]:checked')?.value;
            if (!razon) { 
                alert('Selecciona una raz칩n de rechazo'); 
                return; 
            }
            
            setButtonsDisabled(true);
            
            queueOperation(async () => {
                try {
                    const pedidoActual = sistemaData.pedidos.find(p => p.id === pedidoRechazo.id);
                    if (!pedidoActual) {
                        mostrarNotificacion('Pedido no encontrado', 'error');
                        return;
                    }
                    
                    pedidoActual.estado = 'rechazado';
                    pedidoActual.razonRechazo = razon;
                    pedidoActual.fechaRechazo = new Date().toISOString();
                    
                    agregarNotificacionCliente(
                        pedidoActual.id,
                        'rejected',
                        '丘멆잺 Pedido rechazado',
                        `Motivo: ${traducirRazon(razon)}. Por favor, contacta al restaurante para m치s informaci칩n.`
                    );
                    
                    await new Promise(resolve => setTimeout(resolve, 200));
                    await guardarCambios();
                    await new Promise(resolve => setTimeout(resolve, 300));
                    
                    closeModal('rechazoModal');
                    mostrarNotificacion('Pedido rechazado. Cliente notificado.');
                    
                    await new Promise(resolve => setTimeout(resolve, 200));
                    renderPedidos();
                    
                } catch (error) {
                    console.error('Error en rechazo:', error);
                    mostrarNotificacion('Error al procesar rechazo. Intente nuevamente.', 'error');
                } finally {
                    pedidoRechazo = null;
                    setButtonsDisabled(false);
                }
            });
        }

        function traducirRazon(razon) {
            const razones = {
                'referencia_invalida': 'Referencia de pago inv치lida o falsa',
                'monto_insuficiente': 'Monto insuficiente',
                'datos_incorrectos': 'Datos de contacto/direcci칩n incorrectos',
                'no_disponible': 'Producto no disponible',
                'fuera_horario': 'Fuera de horario de delivery'
            };
            return razones[razon] || razon;
        }

        // ==========================================
        // MEN칔
        // ==========================================
        function renderMenuView() {
            const container = document.getElementById('menuViewContainer');
            if (!sistemaData || !sistemaData.menu) return;
            
            container.innerHTML = sistemaData.menu.map(item => {
                const precioBs = ((item.precio || 0) * tasaEfectiva).toFixed(2);
                
                let disponible = item.disponible;
                let stockReal = item.stock || 0;
                
                if (disponible && item.ingredientes) {
                    let maxPlatillos = Infinity;
                    Object.entries(item.ingredientes).forEach(([ingId, data]) => {
                        const ing = sistemaData.inventario[ingId];
                        if (ing) {
                            const disponibleIng = Math.floor(ing.stock / (data.cantidad || 1));
                            maxPlatillos = Math.min(maxPlatillos, disponibleIng);
                        } else {
                            maxPlatillos = 0;
                        }
                    });
                    if (maxPlatillos === Infinity || maxPlatillos < 0) maxPlatillos = 0;
                    stockReal = maxPlatillos;
                    disponible = maxPlatillos > 0 && item.disponible;
                }
                
                return `
                    <div class="menu-item-card">
                        ${item.imagen ? `<img src="${item.imagen}" class="menu-item-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'"><div class="menu-item-img" style="display: none;"><i class="fas fa-image"></i></div>` : '<div class="menu-item-img"><i class="fas fa-image"></i></div>'}
                        <div class="menu-item-info">
                            <div class="menu-item-name">${item.nombre}</div>
                            <div class="menu-item-desc">${item.descripcion || 'Sin descripci칩n'}</div>
                            <span class="badge ${disponible ? 'badge-success' : 'badge-danger'}">${disponible ? 'Disponible' : 'No disponible'}${disponible ? ` (${stockReal} unidades)` : ''}</span>
                        </div>
                        <div class="menu-item-price">Bs. ${precioBs}<br><small style="color: #666; font-size: 0.75rem;">$${(item.precio || 0).toFixed(2)}</small></div>
                    </div>
                `;
            }).join('');
        }

        // ==========================================
        // UTILIDADES
        // ==========================================
        function closeModal(modalId) { 
            document.getElementById(modalId).classList.remove('show'); 
        }
        
        function cerrarModal(modalId) { 
            document.getElementById(modalId).classList.remove('show'); 
        }
        
        function mostrarNotificacion(mensaje, tipo = 'success') {
            const notif = document.getElementById('notification');
            document.getElementById('notificationText').textContent = mensaje;
            notif.style.borderLeftColor = tipo === 'error' ? 'var(--danger)' : 'var(--success)';
            notif.classList.add('show');
            setTimeout(() => notif.classList.remove('show'), 3000);
        }
        
        function actualizarEstadoSync(estado) {
            const statusEl = document.getElementById('syncStatus');
            const iconEl = statusEl.querySelector('i');
            const textEl = statusEl.querySelector('span');
            statusEl.className = `sync-status ${estado}`;
            switch(estado) {
                case 'online': iconEl.className = 'fas fa-check-circle'; textEl.textContent = 'Sincronizado'; break;
                case 'syncing': iconEl.className = 'fas fa-sync-alt fa-spin'; textEl.textContent = 'Sincronizando...'; break;
                case 'offline': iconEl.className = 'fas fa-exclamation-triangle'; textEl.textContent = 'Sin conexi칩n'; break;
            }
        }
        
        async function guardarCambios() {
            try {
                const response = await fetch(`${JSONBIN_CONFIG.BASE_URL}/${JSONBIN_CONFIG.BIN_ID}`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'X-Master-Key': JSONBIN_CONFIG.API_KEY 
                    },
                    body: JSON.stringify(sistemaData)
                });
                
                if (!response.ok) throw new Error('Error al guardar');
                await new Promise(resolve => setTimeout(resolve, 100));
                
            } catch (error) { 
                console.error('Error guardando:', error);
                throw error;
            }
        }
        
        window.addEventListener('beforeunload', () => { 
            if (syncInterval) clearInterval(syncInterval); 
            if (processingTimeout) clearTimeout(processingTimeout);
        });
    </script>
</body>
</html>
