<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ь Panel del Cajero - Saki Sushi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #D32F2F; --secondary: #212121; --accent: #FF9800;
            --light: #F5F5F5; --dark: #121212; --warm: #FFC107;
            --success: #388E3C; --info: #1976D2; --warning: #F57C00; --danger: #ef4444;
            --shadow: rgba(0, 0, 0, 0.15); --transition: all 0.3s ease;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; padding: 20px; color: var(--secondary); }
        
        .tasa-bar { background: linear-gradient(135deg, #b91c1c, var(--primary)); padding: 1rem 2rem; margin: -20px -20px 20px -20px; display: flex; justify-content: center; align-items: center; gap: 2rem; flex-wrap: wrap; box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
        .tasa-display { display: flex; align-items: center; gap: 1rem; color: white; font-size: 1.1rem; }
        .tasa-value { font-size: 2rem; font-weight: 700; background: rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 0.5rem; }
        .tasa-input { width: 120px; padding: 0.5rem; border: 2px solid rgba(255,255,255,0.3); border-radius: 0.5rem; background: rgba(255,255,255,0.1); color: white; font-size: 1.1rem; font-weight: 600; text-align: center; }
        .btn-tasa { background: rgba(255,255,255,0.2); border: 2px solid white; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; font-weight: 600; transition: var(--transition); }
        .btn-tasa:hover { background: white; color: var(--primary); }
        
        .container { max-width: 1400px; margin: 0 auto; background: var(--light); border-radius: 15px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, var(--primary), #B71C1C); color: white; padding: 25px 30px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
        .header-left h1 { font-size: 2.5em; font-family: 'Montserrat', sans-serif; font-weight: 800; margin-bottom: 5px; }
        .header-left p { opacity: 0.9; font-size: 1.1em; }
        .header-right { display: flex; align-items: center; gap: 20px; }
        .sync-status { background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 25px; font-size: 0.9em; display: flex; align-items: center; gap: 10px; font-family: 'Montserrat', sans-serif; }
        .sync-status.online { background: rgba(56, 142, 60, 0.3); }
        .sync-status.offline { background: rgba(211, 47, 47, 0.3); }
        .sync-status.syncing { background: rgba(255, 152, 0, 0.3); }
        
        .nav-tabs { background: var(--secondary); display: flex; padding: 0 30px; gap: 10px; overflow-x: auto; }
        .nav-tab { background: transparent; color: white; border: none; padding: 20px 30px; font-size: 1em; cursor: pointer; transition: var(--transition); font-family: 'Montserrat', sans-serif; font-weight: 500; border-bottom: 3px solid transparent; white-space: nowrap; }
        .nav-tab:hover { background: rgba(255,255,255,0.1); }
        .nav-tab.active { border-bottom-color: var(--accent); color: var(--accent); }
        
        .content { padding: 30px; }
        .section { display: none; }
        .section.active { display: block; }
        .section-title { font-size: 2em; color: var(--secondary); margin-bottom: 25px; display: flex; align-items: center; gap: 15px; font-family: 'Montserrat', sans-serif; font-weight: 700; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        @media (max-width: 992px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 576px) { .stats-grid { grid-template-columns: 1fr; } }
        
        .stat-card { 
            background: white; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 5px 20px var(--shadow); 
            text-align: center; 
            transition: var(--transition); 
            border: 2px solid transparent;
            cursor: pointer;
        }
        .stat-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); 
            border-color: var(--accent); 
        }
        .stat-icon { 
            width: 60px; 
            height: 60px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin: 0 auto 15px; 
            font-size: 1.5em; 
            color: white; 
        }
        .stat-icon.pendientes { background: var(--warning); }
        .stat-icon.cobrados { background: var(--success); }
        .stat-icon.ventas { background: var(--info); }
        .stat-icon.platillos { background: var(--primary); }
        .stat-value { font-size: 2.5em; font-weight: 800; color: var(--secondary); font-family: 'Montserrat', sans-serif; }
        .stat-label { color: #666; margin-top: 5px; font-size: 0.95em; }
        
        .section-subtitle { 
            font-size: 1.3em; 
            color: var(--secondary); 
            margin: 30px 0 20px 0; 
            padding-bottom: 10px; 
            border-bottom: 2px solid var(--accent);
            display: flex; 
            align-items: center; 
            gap: 10px; 
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
        }
        
        .section-subtitle .count-badge {
            background: var(--primary);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .orders-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px; }
        @media (max-width: 1200px) { .orders-container { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .orders-container { grid-template-columns: 1fr; } }
        
        .order-column { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 20px var(--shadow); }
        .order-column-header { background: linear-gradient(135deg, var(--secondary), #424242); color: white; padding: 15px 20px; font-family: 'Montserrat', sans-serif; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .order-column-header.mesa { background: linear-gradient(135deg, var(--info), #1565C0); }
        .order-column-header.delivery { background: linear-gradient(135deg, var(--success), #2E7D32); }
        .order-column-header.reserva { background: linear-gradient(135deg, var(--warning), #F57C00); }
        .order-column-content { padding: 15px; min-height: 200px; max-height: 600px; overflow-y: auto; }
        
        .order-card { background: #f8f8f8; border-radius: 10px; padding: 15px; margin-bottom: 15px; border-left: 4px solid var(--primary); transition: var(--transition); }
        .order-card:hover { transform: translateX(5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .order-card.en-cocina { border-left-color: var(--warning); }
        .order-card.en-camino { border-left-color: var(--info); }
        .order-card.reserva-pendiente { border-left-color: #9c27b0; }
        .order-card.reserva-atendida { border-left-color: #ff5722; }
        
        .order-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .order-id { font-weight: 700; font-family: 'Montserrat', sans-serif; font-size: 0.9rem; display: none; }
        .order-time { font-size: 0.9rem; color: #555; font-weight: 600; background: #f0f0f0; padding: 5px 12px; border-radius: 20px; display: inline-flex; align-items: center; gap: 6px; }
        .order-details { font-size: 0.9rem; margin-bottom: 10px; }
        .order-detail-row { display: flex; justify-content: space-between; padding: 3px 0; }
        .order-total { font-weight: 700; color: var(--primary); font-size: 1.1rem; text-align: right; margin-top: 10px; padding-top: 10px; border-top: 2px dashed #ddd; }
        .order-actions { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        
        .btn { flex: 1; padding: 10px; border: none; border-radius: 8px; font-size: 0.9em; font-weight: 600; cursor: pointer; transition: var(--transition); display: flex; align-items: center; justify-content: center; gap: 8px; font-family: 'Montserrat', sans-serif; }
        .btn-cobrar { background: linear-gradient(135deg, var(--success), #2E7D32); color: white; }
        .btn-cobrar:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(56, 142, 60, 0.4); }
        .btn-cobrar:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-ver { background: #e0e0e0; color: var(--secondary); }
        .btn-ver:hover { background: #d0d0d0; }
        .btn-rechazar { background: linear-gradient(135deg, var(--danger), #B71C1C); color: white; }
        .btn-rechazar:disabled { background: #ccc; cursor: not-allowed; }
        .btn-entregar { background: linear-gradient(135deg, var(--success), #2E7D32); color: white; }
        .btn-entregar:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(56, 142, 60, 0.4); }
        .btn-entregar:disabled { background: #ccc; cursor: not-allowed; }
        .btn-enviar { background: linear-gradient(135deg, var(--info), #1565C0); color: white; }
        .btn-enviar:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(25, 118, 210, 0.4); }
        .btn-enviar:disabled { background: #ccc; cursor: not-allowed; }
        .btn-confirmar { background: linear-gradient(135deg, #9c27b0, #7b1fa2); color: white; }
        .btn-confirmar:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(156, 39, 176, 0.4); }
        .btn-confirmar:disabled { background: #ccc; cursor: not-allowed; }
        
        .status-badge { 
            display: inline-flex; 
            align-items: center; 
            gap: 5px; 
            padding: 5px 10px; 
            border-radius: 15px; 
            font-size: 0.75rem; 
            font-weight: 600;
            margin-bottom: 10px;
        }
        .status-en-cocina { background: #FFF3E0; color: var(--warning); }
        .status-en-camino { background: #E3F2FD; color: var(--info); }
        .status-reserva-pendiente { background: #F3E5F5; color: #9c27b0; }
        .status-reserva-atendida { background: #FBE9E7; color: #ff5722; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 3000; display: none; justify-content: center; align-items: center; padding: 20px; backdrop-filter: blur(5px); }
        .modal-overlay.show { display: flex; }
        .modal-content { background: white; border-radius: 20px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { background: linear-gradient(135deg, var(--success), #2E7D32); color: white; padding: 25px; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-family: 'Montserrat', sans-serif; font-size: 1.5rem; }
        .modal-close { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }
        .modal-body { padding: 25px; }
        .modal-footer { padding: 25px; border-top: 2px solid #f0f0f0; display: flex; gap: 15px; }
        
        .stats-detail-modal .modal-header { background: linear-gradient(135deg, var(--info), #1565C0); }
        .stats-detail-list { max-height: 400px; overflow-y: auto; }
        .stats-detail-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            padding: 16px; 
            border-bottom: 1px solid #eee; 
            background: white;
            margin-bottom: 8px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .stats-detail-item:last-child { border-bottom: none; }
        .stats-detail-info { flex: 1; }
        .stats-detail-id { 
            font-weight: 700; 
            color: var(--secondary); 
            font-size: 0.9rem;
            display: none;
        }
        .stats-detail-platillos { 
            font-size: 0.9rem; 
            color: #333;
            margin: 8px 0 5px 0;
            background: #f9f9f9;
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 3px solid var(--primary);
        }
        .stats-detail-platillo-item {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            border-bottom: 1px dashed #eee;
        }
        .stats-detail-platillo-item:last-child { border-bottom: none; }
        .stats-detail-mesa, .stats-detail-direccion, .stats-detail-telefono, .stats-detail-cliente, .stats-detail-parroquia {
            font-size: 0.85rem;
            color: #555;
            margin: 4px 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .stats-detail-metodos-pago {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }
        .metodo-pago-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #e8f5e9;
            color: var(--success);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid #a5d6a7;
        }
        .stats-detail-total { 
            font-weight: 700; 
            color: var(--primary); 
            font-size: 1.2rem;
            min-width: 100px;
            text-align: right;
        }
        .stats-detail-metodo { 
            display: inline-block; 
            padding: 2px 8px; 
            background: #E8F5E9; 
            color: var(--success); 
            border-radius: 12px; 
            font-size: 0.7rem; 
            font-weight: 600; 
        }
        
        .ranking-bar { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            padding: 8px; 
            border-bottom: 1px solid #eee; 
        }
        .ranking-position { 
            width: 30px; 
            height: 30px; 
            background: var(--accent); 
            color: white; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: 700; 
        }
        .ranking-info { flex: 1; }
        .ranking-name { font-weight: 600; }
        .ranking-cantidad { color: #666; font-size: 0.85rem; }
        .ranking-bar-container { 
            width: 100px; 
            height: 8px; 
            background: #e0e0e0; 
            border-radius: 4px; 
            overflow: hidden; 
        }
        .ranking-bar-fill { 
            height: 100%; 
            background: var(--primary); 
            border-radius: 4px; 
        }
        
        .comprobante-preview {
            margin-top: 15px;
            background: #f8f8f8;
            border: 2px solid var(--info);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .comprobante-img {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
        }
        .comprobante-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--info);
            font-weight: 600;
            margin-bottom: 5px;
        }
        .btn-ver-comprobante {
            background: var(--info);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
        }
        .btn-ver-comprobante:hover {
            background: #1565C0;
            transform: translateY(-2px);
        }
        
        .payment-mix-container { margin-bottom: 25px; }
        .payment-mix-item { 
            background: #f8f8f8; 
            border-radius: 12px; 
            padding: 15px; 
            margin-bottom: 15px; 
            border: 2px solid #e0e0e0;
            transition: var(--transition);
        }
        .payment-mix-item.active { border-color: var(--success); background: #E8F5E9; }
        .payment-mix-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 10px;
        }
        .payment-mix-title { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            font-weight: 600; 
            font-family: 'Montserrat', sans-serif;
        }
        .payment-mix-input { 
            width: 150px; 
            padding: 10px; 
            border: 2px solid #e0e0e0; 
            border-radius: 8px; 
            font-size: 1rem; 
            text-align: right;
            font-weight: 600;
        }
        .payment-mix-input:focus { outline: none; border-color: var(--success); }
        .payment-mix-input:disabled { background: #f0f0f0; color: #999; }
        
        .payment-mix-total {
            background: linear-gradient(135deg, var(--secondary), #424242);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .payment-mix-total-label { font-size: 1.1rem; }
        .payment-mix-total-value { font-size: 2rem; font-weight: 700; font-family: 'Montserrat', sans-serif; }
        
        .payment-mix-remaining {
            background: #FFF3E0;
            border: 2px solid var(--warning);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .payment-mix-remaining.paid { background: #E8F5E9; border-color: var(--success); }
        .payment-mix-remaining.faltante { background: #FFEBEE; border-color: var(--danger); }
        .payment-mix-remaining.excedente { background: #FFF3E0; border-color: var(--warning); }
        
        .payment-mix-add {
            width: 100%;
            padding: 15px;
            border: 2px dashed var(--primary);
            border-radius: 12px;
            background: transparent;
            color: var(--primary);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .payment-mix-add:hover { background: rgba(211, 47, 47, 0.1); }
        .payment-mix-add:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .payment-mix-summary {
            background: #f8f8f8;
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
        }
        .payment-mix-summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        .payment-mix-summary-item:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--primary);
        }
        
        .btn-remove-payment {
            background: var(--danger);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        .btn-remove-payment:hover { transform: scale(1.1); }
        
        .payment-method-select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 10px;
        }
        .payment-method-select:focus { outline: none; border-color: var(--success); }
        
        .reference-input {
            margin-top: 10px;
        }
        .reference-input input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        
        .special-options { 
            background: #FFF3E0; 
            border: 2px solid var(--warning); 
            border-radius: 12px; 
            padding: 20px; 
            margin: 20px 0; 
        }
        .special-option { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            margin-bottom: 10px; 
        }
        .special-option input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .special-input { 
            margin-top: 10px; 
            display: none; 
        }
        .special-input.show { 
            display: block; 
        }
        .btn-modal { 
            flex: 1; 
            padding: 15px; 
            border: none; 
            border-radius: 10px; 
            font-size: 1rem; 
            font-weight: 700; 
            cursor: pointer; 
            transition: var(--transition); 
            font-family: 'Montserrat', sans-serif; 
        }
        .btn-modal.secondary { 
            background: #f0f0f0; 
            color: var(--secondary); 
        }
        .btn-modal.primary { 
            background: linear-gradient(135deg, var(--success), #2E7D32); 
            color: white; 
        }
        .btn-modal:disabled { 
            background: #ccc; 
            cursor: not-allowed; 
        }
        
        .alert-modal .modal-content { 
            max-width: 500px; 
            text-align: center; 
        }
        .alert-icon { 
            font-size: 4rem; 
            color: var(--warning); 
            margin-bottom: 1rem; 
        }
        .timer-badge { 
            background: var(--warning); 
            color: white; 
            padding: 5px 10px; 
            border-radius: 20px; 
            font-size: 0.8rem; 
            font-weight: 700; 
            display: inline-flex; 
            align-items: center; 
            gap: 5px; 
        }
        .timer-badge.urgent { 
            background: var(--danger); 
            animation: pulse 1s infinite; 
        }
        @keyframes pulse { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.7; } 
        }
        
        .loading-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(0,0,0,0.8); 
            display: none; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            z-index: 4000; 
            color: white; 
        }
        .loading-overlay.show { 
            display: flex; 
        }
        .spinner { 
            width: 60px; 
            height: 60px; 
            border: 5px solid rgba(255,255,255,0.3); 
            border-top-color: var(--accent); 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
            margin-bottom: 20px; 
        }
        @keyframes spin { 
            to { transform: rotate(360deg); } 
        }
        
        .empty-state { 
            text-align: center; 
            padding: 40px; 
            color: #888; 
        }
        .empty-state i { 
            font-size: 3em; 
            margin-bottom: 15px; 
            color: #ddd; 
        }
        
        .notification { 
            position: fixed; 
            top: 80px; 
            right: 20px; 
            background: white; 
            padding: 20px 25px; 
            border-radius: 12px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); 
            display: none; 
            align-items: center; 
            gap: 15px; 
            z-index: 5000; 
            animation: slideIn 0.3s ease; 
            border-left: 5px solid var(--success); 
        }
        @keyframes slideIn { 
            from { transform: translateX(100%); opacity: 0; } 
            to { transform: translateX(0%); opacity: 1; } 
        }
        .notification.show { 
            display: flex; 
        }
        
        .menu-item-card { 
            background: white; 
            border-radius: 12px; 
            padding: 20px; 
            margin-bottom: 15px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
            display: flex; 
            gap: 15px; 
            align-items: center; 
        }
        .menu-item-img { 
            width: 80px; 
            height: 80px; 
            object-fit: cover; 
            border-radius: 8px; 
            background: #f0f0f0; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: #999; 
        }
        .menu-item-info { 
            flex: 1; 
        }
        .menu-item-name { 
            font-weight: 700; 
            font-family: 'Montserrat', sans-serif; 
            margin-bottom: 5px; 
        }
        .menu-item-desc { 
            font-size: 0.875rem; 
            color: #666; 
            margin-bottom: 5px; 
        }
        .menu-item-price { 
            font-size: 1.25rem; 
            font-weight: 700; 
            color: var(--primary); 
        }
        .badge { 
            padding: 5px 12px; 
            border-radius: 20px; 
            font-size: 0.75rem; 
            font-weight: 600; 
        }
        .badge-success { 
            background: #E8F5E9; 
            color: var(--success); 
        }
        .badge-danger { 
            background: #FFEBEE; 
            color: var(--danger); 
        }
        
        .confirm-modal .modal-header { 
            background: linear-gradient(135deg, var(--info), #1565C0); 
        }
        .confirm-modal .modal-header.entrega { 
            background: linear-gradient(135deg, var(--success), #2E7D32); 
        }
        .confirm-modal .modal-header.envio { 
            background: linear-gradient(135deg, var(--info), #1565C0); 
        }
        .confirm-modal .modal-header.reserva { 
            background: linear-gradient(135deg, #9c27b0, #7b1fa2); 
        }
        
        .info-box { 
            background: #f8f8f8; 
            border-radius: 10px; 
            padding: 15px; 
            margin: 15px 0; 
        }
        .info-row { 
            display: flex; 
            justify-content: space-between; 
            padding: 8px 0; 
            border-bottom: 1px solid #e0e0e0; 
        }
        .info-row:last-child { 
            border-bottom: none; 
            font-weight: 600; 
        }
        
        .keyboard-hint { 
            background: #f0f0f0; 
            padding: 10px 15px; 
            border-radius: 8px; 
            font-size: 0.85rem; 
            color: #666;
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        .keyboard-hint kbd {
            background: white;
            padding: 3px 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-family: monospace;
        }
        
        .ingredient-discount {
            background: #E8F5E9;
            color: var(--success);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 5px;
        }
        
        .item-subtotal {
            font-weight: 600;
            color: var(--secondary);
        }
        
        .btn-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }

        .vuelto-section {
            background: #FFF3E0;
            border: 2px solid var(--warning);
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .vuelto-section .vuelto-label {
            font-weight: 600;
            color: var(--secondary);
        }
        .vuelto-input {
            width: 150px;
            padding: 8px 12px;
            border: 2px solid var(--warning);
            border-radius: 8px;
            font-size: 1rem;
            text-align: right;
            font-weight: 600;
            color: var(--secondary);
        }
        .vuelto-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
        }
        .vuelto-confirm-btn {
            background: var(--warning);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-left: 10px;
        }
        .vuelto-confirm-btn:hover {
            background: #F57C00;
            transform: scale(1.05);
        }
        .vuelto-confirm-btn.undo {
            background: var(--info);
        }
        
        .condonacion-checkbox {
            background: #f0f0f0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 2px solid var(--success);
        }
        
        .moneda-prefijo {
            font-size: 1rem;
            font-weight: 600;
            color: var(--secondary);
            min-width: 35px;
            text-align: right;
            padding-right: 5px;
        }

        .sync-manual-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid white;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: var(--transition);
            font-family: 'Montserrat', sans-serif;
            font-weight: 500;
        }
        .sync-manual-btn:hover {
            background: white;
            color: var(--primary);
            transform: scale(1.05);
        }
        .sync-manual-btn.syncing {
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body>
    <div class="modal-overlay alert-modal" id="alertTasaModal">
        <div class="modal-content">
            <div class="modal-body" style="padding: 2rem;">
                <div class="alert-icon"><i class="fas fa-exclamation-triangle"></i></div>
                <h2 style="margin-bottom: 1rem; color: var(--secondary);">隆Buenos d铆as!</h2>
                <p style="color: #666; margin-bottom: 1.5rem;">El administrador no ha establecido la <strong>tasa del d贸lar del d铆a</strong>. Por favor, introd煤cela para continuar.</p>
                <div style="background: #f8f8f8; padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--secondary);">Tasa del D铆a (Bs. por $1)</label>
                    <input type="number" step="0.01" id="tasaInicialInput" placeholder="0.00" style="width: 100%; padding: 1rem; font-size: 1.5rem; text-align: center; font-weight: 700; border: 2px solid var(--primary); border-radius: 0.5rem;">
                </div>
                <button class="btn-cobrar" onclick="guardarTasaInicial()" style="width: 100%; justify-content: center;">Guardar y Continuar</button>
            </div>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div><h2>Cargando panel...</h2></div>

    <div class="notification" id="notification">
        <i class="fas fa-check-circle" style="color: var(--success); font-size: 1.5rem;"></i>
        <div><h4 style="margin: 0; color: var(--secondary);">xito</h4><p id="notificationText" style="margin: 0; color: #666;">Operaci贸n completada</p></div>
    </div>

    <div class="modal-overlay confirm-modal" id="confirmEntregaModal">
        <div class="modal-content">
            <div class="modal-header" id="confirmEntregaHeader">
                <h2 id="confirmEntregaTitle"><i class="fas fa-check-circle"></i> Confirmar Entrega</h2>
                <button class="modal-close" onclick="cerrarModal('confirmEntregaModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="confirmEntregaBody">
            </div>
            <div class="modal-footer">
                <button class="btn-modal secondary" onclick="cerrarModal('confirmEntregaModal')">Cancelar (ESC)</button>
                <button class="btn-modal primary" id="btnConfirmarAccion" onclick="ejecutarConfirmacion()">Confirmar (ENTER)</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="comprobanteModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--info), #1565C0);">
                <h2><i class="fas fa-receipt"></i> Comprobante de Pago</h2>
                <button class="modal-close" onclick="cerrarModal('comprobanteModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <div id="comprobanteImagenContainer" style="margin-bottom: 20px;"></div>
                <div id="comprobanteInfo" style="background: #f8f8f8; padding: 20px; border-radius: 10px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal secondary" onclick="cerrarModal('comprobanteModal')">Cerrar</button>
                <a id="comprobanteDownloadLink" class="btn-modal primary" download="comprobante.jpg" style="text-decoration: none; text-align: center;">
                    <i class="fas fa-download"></i> Descargar
                </a>
            </div>
        </div>
    </div>

    <div class="modal-overlay stats-detail-modal" id="statsDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="statsDetailTitle"><i class="fas fa-chart-bar"></i> Detalle</h2>
                <button class="modal-close" onclick="cerrarModal('statsDetailModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="statsDetailBody">
            </div>
            <div class="modal-footer">
                <button class="btn-modal primary" onclick="cerrarModal('statsDetailModal')">Cerrar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="cobroModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header"><h2><i class="fas fa-cash-register"></i> Procesar cobro</h2><button class="modal-close" onclick="closeModal('cobroModal')"><i class="fas fa-times"></i></button></div>
            <div class="modal-body">
                <div id="cobroSummary" style="margin-bottom: 20px;"></div>
                
                <div class="payment-mix-total">
                    <span class="payment-mix-total-label">TOTAL A PAGAR:</span>
                    <span class="payment-mix-total-value" id="totalPagarDisplay">Bs. 0.00</span>
                </div>
                
                <div class="payment-mix-remaining" id="remainingDisplay">
                    <span id="remainingLabel">Monto a cobrar:</span>
                    <span style="font-size: 1.5rem; font-weight: 700;" id="remainingAmount">Bs. 0.00</span>
                </div>
                
                <div class="payment-mix-container" id="paymentMixContainer"></div>
                
                <button class="payment-mix-add" id="btnAddPayment" onclick="agregarMetodoPago()">
                    <i class="fas fa-plus-circle"></i> Agregar M茅todo de Pago
                </button>

                <div class="invitacion-checkbox" id="invitacionContainer" style="display: flex;">
                    <input type="checkbox" id="invitacionCheckbox" onchange="toggleInvitacion()">
                    <label for="invitacionCheckbox"><strong>Por parte de la casa (invitaci贸n)</strong> - El cliente no paga, total a $0</label>
                </div>
                
                <div class="payment-mix-summary" id="paymentSummary" style="display: none;">
                    <div class="payment-mix-summary-item">
                        <span>Total recibido:</span>
                        <span id="totalRecibido">Bs. 0.00</span>
                    </div>
                    <div class="payment-mix-summary-item" id="faltanteRow" style="display: none;">
                        <span>Pendiente por cobrar:</span>
                        <span id="faltanteAmount" style="color: var(--danger);">Bs. 0.00</span>
                    </div>
                    <div class="payment-mix-summary-item" id="excedenteRow" style="display: none;">
                        <span>Vuelto a entregar:</span>
                        <span id="excedenteAmount" style="color: var(--warning);">Bs. 0.00</span>
                    </div>
                </div>
                
                <!-- SECCIN PARA VUELTO (CUANDO SOBRA DINERO) -->
                <div class="vuelto-section" id="vueltoSection" style="display: none;">
                    <span class="vuelto-label"><i class="fas fa-hand-holding-usd"></i> Vuelto a entregar:</span>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="number" step="0.01" class="vuelto-input" id="vueltoInput" placeholder="0.00" value="0.00" oninput="actualizarVueltoEnTiempoReal()">
                        <button class="vuelto-confirm-btn" id="confirmarVueltoBtn" onclick="confirmarVuelto()">Confirmar Vuelto</button>
                        <button class="vuelto-confirm-btn undo" id="deshacerVueltoBtn" style="display: none;" onclick="deshacerVuelto()">Deshacer</button>
                    </div>
                </div>

                <!-- CHECKBOX PARA CONDONACIN (CUANDO FALTA DINERO) -->
                <div class="condonacion-checkbox" id="condonacionCheckbox" style="display: none;">
                    <input type="checkbox" id="condonacionInput" onchange="toggleCondonacion()">
                    <label for="condonacionInput">
                        <strong>Monto a condonar:</strong>
                        <span id="condonacionMontoDisplay" style="margin-left: 10px; color: var(--success); font-weight: 600;"></span>
                    </label>
                </div>

                <!-- CHECKBOX PARA A FAVOR DE CAJA (CUANDO SOBRA DINERO Y NO SE DEVUELVE TODO) -->
                <div class="condonacion-checkbox" id="afavorCajaCheckbox" style="display: none;">
                    <input type="checkbox" id="afavorCajaInput" onchange="toggleAfavorCaja()">
                    <label for="afavorCajaInput">
                        <strong>A favor de caja:</strong>
                        <span id="afavorCajaMontoDisplay" style="margin-left: 10px; color: var(--warning); font-weight: 600;"></span>
                    </label>
                </div>

                <div class="special-options" id="specialOptions" style="display: none;">
                    <h3><i class="fas fa-exclamation-circle"></i> Opciones de Diferencia</h3>
                    <div class="special-option">
                        <input type="checkbox" id="optCondonacion" value="condonacion" onchange="sincronizarCondonacion()">
                        <label for="optCondonacion">Condonaci贸n (cliente no paga lo que falta)</label>
                    </div>
                    <div class="special-option">
                        <input type="checkbox" id="optAfavorCaja" value="afavor_caja" onchange="sincronizarAfavorCaja()">
                        <label for="optAfavorCaja">A favor de caja (sobrante no devuelto)</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal secondary" onclick="closeModal('cobroModal')">Cancelar</button>
                <button class="btn-modal primary" id="btnConfirmarCobro" onclick="confirmarCobro()" disabled>Confirmar Cobro</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="rechazoModal">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--danger), #B71C1C);"><h2><i class="fas fa-times-circle"></i> Rechazar Pedido</h2><button class="modal-close" onclick="closeModal('rechazoModal')"><i class="fas fa-times"></i></button></div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; color: #666;">Selecciona la raz贸n del rechazo:</p>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <label style="display: flex; align-items: center; gap: 10px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer;"><input type="radio" name="rejectionReason" value="referencia_invalida" style="width: 20px; height: 20px;"><span>Referencia de pago inv谩lida o falsa</span></label>
                    <label style="display: flex; align-items: center; gap: 10px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer;"><input type="radio" name="rejectionReason" value="monto_insuficiente" style="width: 20px; height: 20px;"><span>Monto insuficiente</span></label>
                    <label style="display: flex; align-items: center; gap: 10px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer;"><input type="radio" name="rejectionReason" value="datos_incorrectos" style="width: 20px; height: 20px;"><span>Datos de contacto/direcci贸n incorrectos</span></label>
                    <label style="display: flex; align-items: center; gap: 10px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer;"><input type="radio" name="rejectionReason" value="no_disponible" style="width: 20px; height: 20px;"><span>Producto no disponible</span></label>
                    <label style="display: flex; align-items: center; gap: 10px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer;"><input type="radio" name="rejectionReason" value="fuera_horario" style="width: 20px; height: 20px;"><span>Fuera de horario de delivery</span></label>
                </div>
            </div>
            <div class="modal-footer"><button class="btn-modal secondary" onclick="closeModal('rechazoModal')">Cancelar</button><button class="btn-modal primary" style="background: linear-gradient(135deg, var(--danger), #B71C1C);" onclick="confirmarRechazo()">Confirmar Rechazo</button></div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="header-left"><h1><i class="fas fa-cash-register"></i> Panel del Cajero</h1><p>Saki Sushi - Gesti贸n de pedidos y cobros</p></div>
            <div class="header-right">
                <div class="sync-manual-btn" onclick="sincronizarManual()" title="Sincronizar con servidor">
                    <i class="fas fa-sync-alt" id="manualSyncIcon"></i>
                    <span>JSONbin</span>
                </div>
                <div class="sync-status offline" id="syncStatus">
                    <i class="fas fa-sync-alt"></i>
                    <span>Conectando...</span>
                </div>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('pedidos')"><i class="fas fa-clipboard-list"></i> Pedidos</button>
            <button class="nav-tab" onclick="showSection('menu')"><i class="fas fa-utensils"></i> Ver Men煤</button>
        </div>

        <div class="content">
            <div class="section active" id="section-pedidos">
                <h2 class="section-title"><i class="fas fa-clipboard-list"></i> Pedidos del D铆a</h2>
                
                <div class="stats-grid">
                    <div class="stat-card" onclick="verDetalleEstadistica('pendientes')">
                        <div class="stat-icon pendientes"><i class="fas fa-fire"></i></div>
                        <div class="stat-value" id="statPendientes">0</div>
                        <div class="stat-label">En Preparaci贸n</div>
                    </div>
                    <div class="stat-card" onclick="verDetalleEstadistica('cobrados')">
                        <div class="stat-icon cobrados"><i class="fas fa-check-circle"></i></div>
                        <div class="stat-value" id="statCobrados">0</div>
                        <div class="stat-label">Cobrados Hoy</div>
                    </div>
                    <div class="stat-card" onclick="verDetalleEstadistica('ventas')">
                        <div class="stat-icon ventas"><i class="fas fa-dollar-sign"></i></div>
                        <div class="stat-value" id="statVentas">Bs. 0</div>
                        <div class="stat-label">Ventas Totales</div>
                    </div>
                    <div class="stat-card" onclick="verDetalleEstadistica('platillos')">
                        <div class="stat-icon platillos"><i class="fas fa-utensils"></i></div>
                        <div class="stat-value" id="statPlatillos">0</div>
                        <div class="stat-label">Platillos Vendidos</div>
                    </div>
                </div>

                <div class="section-subtitle">
                    <i class="fas fa-clock"></i> 
                    Pedidos a cobrar y confirmar:
                    <span class="count-badge" id="badgePorCobrar">0</span>
                </div>
                
                <div class="orders-container" id="ordersPorCobrar">
                    <div class="order-column">
                        <div class="order-column-header mesa"><i class="fas fa-chair"></i> MESA</div>
                        <div class="order-column-content" id="colMesaPorCobrar"><div class="empty-state"><i class="fas fa-inbox"></i><p>No hay pedidos en mesa</p></div></div>
                    </div>
                    <div class="order-column">
                        <div class="order-column-header delivery"><i class="fas fa-motorcycle"></i> DELIVERY</div>
                        <div class="order-column-content" id="colDeliveryPorCobrar"><div class="empty-state"><i class="fas fa-inbox"></i><p>No hay pedidos delivery</p></div></div>
                    </div>
                    <div class="order-column">
                        <div class="order-column-header reserva"><i class="fas fa-calendar-check"></i> RESERVAS</div>
                        <div class="order-column-content" id="colReservaPorCobrar"><div class="empty-state"><i class="fas fa-inbox"></i><p>No hay reservas</p></div></div>
                    </div>
                </div>

                <div class="section-subtitle">
                    <i class="fas fa-fire"></i> 
                    Pedidos en preparaci贸n:
                    <span class="count-badge" id="badgeEnPreparacion">0</span>
                </div>
                
                <div class="orders-container" id="ordersEnPreparacion">
                    <div class="order-column">
                        <div class="order-column-header mesa"><i class="fas fa-chair"></i> MESA - EN COCINA</div>
                        <div class="order-column-content" id="colMesaEnCocina"><div class="empty-state"><i class="fas fa-inbox"></i><p>No hay pedidos en cocina</p></div></div>
                    </div>
                    <div class="order-column">
                        <div class="order-column-header delivery"><i class="fas fa-motorcycle"></i> DELIVERY - EN CAMINO</div>
                        <div class="order-column-content" id="colDeliveryEnCamino"><div class="empty-state"><i class="fas fa-inbox"></i><p>No hay delivery en camino</p></div></div>
                    </div>
                    <div class="order-column">
                        <div class="order-column-header reserva"><i class="fas fa-calendar-check"></i> RESERVAS - PENDIENTES</div>
                        <div class="order-column-content" id="colReservaPendiente"><div class="empty-state"><i class="fas fa-inbox"></i><p>No hay reservas pendientes</p></div></div>
                    </div>
                </div>
            </div>

            <div class="section" id="section-menu">
                <h2 class="section-title"><i class="fas fa-utensils"></i> Men煤 Actual</h2>
                <div id="menuViewContainer"></div>
            </div>
        </div>
    </div>

    <script>
        const JSONBIN_CONFIG = {
            BIN_ID: '69879d6e43b1c97be96d2b13',
            API_KEY: '$2a$10$.klBAMlOBlE9CoVh5iUFf.x3LEYKWiP6hhvvPETK9e8pyIuNB2F4K',
            BASE_URL: 'https://api.jsonbin.io/v3/b'
        };

        let isProcessing = false;
        let operationQueue = [];
        let processingTimeout = null;
        let syncIntervalId = null;
        let isManualSyncing = false;
        
        let sistemaData = null;
        let currentPedido = null;
        let pedidoRechazo = null;
        let pedidoConfirmacion = null;
        let tipoConfirmacion = null;
        
        let pagosMixtos = [];
        let totalPagar = 0;
        let tasaEfectiva = 400;
        
        let lastSyncTime = 0;
        const SYNC_COOLDOWN = 60000;

        let invitacionActiva = false;
        let vueltoConfirmado = false;
        let vueltoValor = 0;
        let condonacionActiva = false;
        let afavorCajaActiva = false;
        let pagosConMonto = false;

        document.addEventListener('DOMContentLoaded', async () => {
            await cargarDatos();
            verificarTasaDelDia();
            syncIntervalId = setInterval(() => {
                sincronizarAutomatica();
            }, 180000);
            document.addEventListener('keydown', handleGlobalKeypress);
        });

        async function executeNextOperation() {
            if (isProcessing || operationQueue.length === 0) return;
            isProcessing = true;
            const operation = operationQueue.shift();
            try {
                await operation();
            } catch (error) {
                console.error('Error en operaci贸n:', error);
            } finally {
                processingTimeout = setTimeout(() => {
                    isProcessing = false;
                    executeNextOperation();
                }, 500);
            }
        }
        
        function queueOperation(operation) {
            operationQueue.push(operation);
            executeNextOperation();
        }
        
        function setButtonsDisabled(disabled) {
            document.querySelectorAll('.btn-cobrar, .btn-rechazar, .btn-entregar, .btn-enviar, .btn-confirmar, .btn-modal.primary').forEach(btn => {
                btn.disabled = disabled;
                if (disabled && !btn.querySelector('.btn-spinner')) {
                    const originalText = btn.innerHTML;
                    btn.setAttribute('data-original-text', originalText);
                    btn.innerHTML = '<span class="btn-spinner"></span>Procesando...';
                } else if (!disabled && btn.getAttribute('data-original-text')) {
                    btn.innerHTML = btn.getAttribute('data-original-text');
                    btn.removeAttribute('data-original-text');
                }
            });
        }

        async function cargarDatos(skipCooldown = false) {
            if (isProcessing && !skipCooldown) return;
            const ahora = Date.now();
            if (!skipCooldown && (ahora - lastSyncTime < SYNC_COOLDOWN)) {
                console.log('Carga omitida - en cooldown');
                return false;
            }
            
            actualizarEstadoSync('syncing');
            
            try {
                const response = await fetch(`${JSONBIN_CONFIG.BASE_URL}/${JSONBIN_CONFIG.BIN_ID}/latest`, {
                    method: 'GET',
                    headers: { 'X-Master-Key': JSONBIN_CONFIG.API_KEY, 'X-Bin-Meta': 'false' }
                });
                
                if (!response.ok) throw new Error('Error al cargar datos');
                const data = await response.json();
                
                const currentPedidoGuardado = currentPedido;
                const pagosMixtosGuardados = [...pagosMixtos];
                
                await new Promise(resolve => setTimeout(resolve, 100));
                sistemaData = data.record || data;
                limpiarPedidosDiaAnterior();
                
                actualizarEstadoSync('online');
                document.getElementById('loadingOverlay').style.display = 'none';
                actualizarVista();
                
                if (currentPedidoGuardado) {
                    currentPedido = sistemaData.pedidos?.find(p => p.id === currentPedidoGuardado.id) || null;
                }
                pagosMixtos = pagosMixtosGuardados;
                
                lastSyncTime = ahora;
                return true;
                
            } catch (error) {
                console.error('Error cargando datos:', error);
                actualizarEstadoSync('offline');
                return false;
            }
        }

        async function sincronizarAutomatica() {
            if (isManualSyncing) return;
            await cargarDatos(true);
        }

        async function sincronizarManual() {
            if (isManualSyncing) {
                mostrarNotificacion('Ya hay una sincronizaci贸n en curso...', 'info');
                return;
            }
            
            isManualSyncing = true;
            const syncIcon = document.getElementById('manualSyncIcon');
            const originalClass = syncIcon.className;
            syncIcon.className = 'fas fa-sync-alt fa-spin';
            document.querySelector('.sync-manual-btn').classList.add('syncing');
            
            mostrarNotificacion('Sincronizando con servidor...', 'success');
            
            const sincronizado = await cargarDatos(true);
            
            if (sincronizado) {
                mostrarNotificacion('Datos sincronizados', 'success');
            } else {
                mostrarNotificacion('Error al sincronizar. Modo offline.', 'error');
            }
            
            syncIcon.className = originalClass;
            document.querySelector('.sync-manual-btn').classList.remove('syncing');
            isManualSyncing = false;
        }

        function limpiarPedidosDiaAnterior() {
            if (!sistemaData.pedidos) return;
            const hoy = new Date().toISOString().split('T')[0];
            const pedidosHoy = [];
            const pedidosArchivar = [];
            
            sistemaData.pedidos.forEach(p => {
                if (p.timestamp.startsWith(hoy)) pedidosHoy.push(p);
                else if (['cobrado', 'entregado', 'enviado', 'reserva_completada'].includes(p.estado)) pedidosArchivar.push(p);
            });
            
            if (pedidosArchivar.length > 0) {
                if (!sistemaData.ventas) sistemaData.ventas = { diarias: [], semanales: [], mensuales: [] };
                pedidosArchivar.forEach(p => {
                    sistemaData.ventas.diarias.push({ 
                        fecha: p.timestamp, 
                        pedidoId: p.id, 
                        total: p.total, 
                        items: p.items?.length || 0, 
                        metodoPago: p.metodoPago, 
                        tipo: p.tipo || 'mesa' 
                    });
                });
            }
            sistemaData.pedidos = pedidosHoy;
        }

        function calcularTasaEfectiva() {
            if (!sistemaData || !sistemaData.config) return 400;
            
            const tasaBase = sistemaData.config.tasaCambio || 400;
            const aumentoDiario = sistemaData.config.aumentoDiario || 0;
            const aumentoActivo = sistemaData.config.aumentoActivo || false;
            const aumentoDetenido = sistemaData.config.aumentoDetenido || false;
            const fechaInicio = sistemaData.config.fechaInicioAumento;
            
            if (aumentoActivo && !aumentoDetenido && aumentoDiario > 0 && fechaInicio) {
                const inicio = new Date(fechaInicio);
                const hoy = new Date();
                const diffTime = Math.abs(hoy - inicio);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const porcentajeTotal = aumentoDiario * diffDays;
                return tasaBase * (1 + (porcentajeTotal / 100));
            }
            return tasaBase;
        }

        function verificarTasaDelDia() {
            if (!sistemaData || !sistemaData.config) return;
            const hoy = new Date().toISOString().split('T')[0];
            const ultimaFecha = sistemaData.config.ultimaActualizacion ? sistemaData.config.ultimaActualizacion.split('T')[0] : null;
            
            if (ultimaFecha !== hoy || sistemaData.config.tasaCambio === 0) {
                document.getElementById('alertTasaModal').classList.add('show');
            } else {
                actualizarDisplayTasa();
            }
        }

        async function guardarTasaInicial() {
            const tasa = parseFloat(document.getElementById('tasaInicialInput').value);
            if (!tasa || tasa <= 0) { 
                mostrarNotificacion('Introduce una tasa v谩lida', 'error'); 
                return; 
            }
            
            sistemaData.config.tasaCambio = tasa;
            sistemaData.config.ultimaActualizacion = new Date().toISOString();
            if (!sistemaData.config.fechaInicioAumento) sistemaData.config.fechaInicioAumento = new Date().toISOString();
            
            await guardarCambios();
            document.getElementById('alertTasaModal').classList.remove('show');
            actualizarDisplayTasa();
            actualizarVista();
            mostrarNotificacion('Tasa del d铆a guardada correctamente');
        }

        function actualizarDisplayTasa() {
            tasaEfectiva = calcularTasaEfectiva();
        }

        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`section-${sectionName}`).classList.add('active');
            event.target.classList.add('active');
            if (sectionName === 'pedidos') renderPedidos();
            if (sectionName === 'menu') renderMenuView();
        }

        function actualizarVista() {
            tasaEfectiva = calcularTasaEfectiva();
            renderPedidos();
            renderMenuView();
        }

        function renderPedidos() {
            if (!sistemaData) return;
            const pedidos = sistemaData.pedidos || [];
            const hoy = new Date().toISOString().split('T')[0];
            const pedidosHoy = pedidos.filter(p => p.timestamp.startsWith(hoy));
            
            const pendientes = pedidosHoy.filter(p => p.estado === 'pendiente');
            const cobrados = pedidosHoy.filter(p => p.estado === 'cobrado');
            const enCocina = pedidosHoy.filter(p => p.estado === 'en_cocina');
            const enCamino = pedidosHoy.filter(p => p.estado === 'en_camino');
            const reservaPendiente = pedidosHoy.filter(p => p.estado === 'reserva_pendiente');
            const reservaAtendida = pedidosHoy.filter(p => p.estado === 'reserva_atendida');
            
            const totalEnPreparacion = enCocina.length + enCamino.length + reservaPendiente.length + reservaAtendida.length;
            const totalCobrados = cobrados.length + enCocina.length + enCamino.length + reservaAtendida.length;
            
            document.getElementById('statPendientes').textContent = totalEnPreparacion;
            document.getElementById('statCobrados').textContent = totalCobrados;
            
            const totalVentas = pedidosHoy
                .filter(p => ['cobrado', 'en_cocina', 'en_camino', 'entregado', 'enviado', 'reserva_atendida', 'reserva_completada'].includes(p.estado))
                .reduce((sum, p) => sum + (p.total || 0), 0);
            document.getElementById('statVentas').textContent = `Bs. ${totalVentas.toFixed(2)}`;
            
            const totalPlatillos = pedidosHoy
                .filter(p => ['cobrado', 'en_cocina', 'en_camino', 'entregado', 'enviado', 'reserva_atendida', 'reserva_completada'].includes(p.estado))
                .reduce((sum, p) => sum + (p.items?.reduce((itemSum, item) => itemSum + (item.cantidad || 1), 0) || 0), 0);
            document.getElementById('statPlatillos').textContent = totalPlatillos;
            
            document.getElementById('badgePorCobrar').textContent = pendientes.length;
            document.getElementById('badgeEnPreparacion').textContent = totalEnPreparacion;
            
            renderColumnaPorCobrar('colMesaPorCobrar', pendientes.filter(p => p.tipo === 'mesa' || !p.tipo), 'mesa');
            renderColumnaPorCobrar('colDeliveryPorCobrar', pendientes.filter(p => p.tipo === 'delivery'), 'delivery');
            renderColumnaPorCobrar('colReservaPorCobrar', pendientes.filter(p => p.tipo === 'reserva'), 'reserva');
            
            renderColumnaEnPreparacion('colMesaEnCocina', enCocina, 'mesa');
            renderColumnaEnPreparacion('colDeliveryEnCamino', enCamino, 'delivery');
            renderColumnaEnPreparacion('colReservaPendiente', reservaPendiente.concat(reservaAtendida), 'reserva');
        }

        function renderColumnaPorCobrar(columnId, pedidos, tipo) {
            const col = document.getElementById(columnId);
            if (pedidos.length === 0) {
                col.innerHTML = `<div class="empty-state"><i class="fas fa-inbox"></i><p>No hay pedidos ${tipo} por cobrar</p></div>`;
                return;
            }
            col.innerHTML = pedidos.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).map(p => crearCardPedidoPorCobrar(p, tipo)).join('');
        }

        function renderColumnaEnPreparacion(columnId, pedidos, tipo) {
            const col = document.getElementById(columnId);
            if (pedidos.length === 0) {
                col.innerHTML = `<div class="empty-state"><i class="fas fa-inbox"></i><p>No hay pedidos en esta secci贸n</p></div>`;
                return;
            }
            col.innerHTML = pedidos.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).map(p => crearCardPedidoEnPreparacion(p, tipo)).join('');
        }

        function crearCardPedidoPorCobrar(pedido, tipo) {
            const fecha = new Date(pedido.timestamp);
            const hora = fecha.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            const minutosTranscurridos = Math.floor((new Date() - fecha) / 60000);
            
            let timerText = '';
            if (pedido.tipo === 'delivery' || pedido.tipo === 'reserva') {
                const minutosRestantes = 20 - minutosTranscurridos;
                timerText = minutosRestantes > 0 ? `<div class="timer-badge ${minutosRestantes <= 5 ? 'urgent' : ''}"><i class="fas fa-clock"></i> ${minutosRestantes}min restantes</div>` : '<div class="timer-badge urgent"><i class="fas fa-clock"></i> Tiempo agotado</div>';
            }
            
            let totalMostrar = pedido.total || 0;
            
            const itemsHtml = (pedido.items || []).map(item => {
                const personalizacion = item.personalizacion?.length > 0 ? ` <small style="color: #666;">(Sin ${item.personalizacion.join(', ')})</small>` : '';
                
                let descuentoTexto = '';
                if (item.descuentoPorIngredientes && item.descuentoPorIngredientes > 0) {
                    descuentoTexto = `<span class="ingredient-discount">-${item.descuentoPorIngredientes.toFixed(2)} Bs</span>`;
                }
                
                let subtotal = item.subtotal || 0;
                
                return `<div class="order-detail-row">
                    <span>${item.cantidad || 1}x ${item.nombre}${personalizacion} ${descuentoTexto}</span>
                    <span class="item-subtotal">Bs. ${subtotal.toFixed(2)}</span>
                </div>`;
            }).join('');
            
            let extraInfo = '';
            if (pedido.tipo === 'delivery') {
                extraInfo = `<div style="background: #E3F2FD; border: 2px solid var(--info); border-radius: 8px; padding: 10px; margin-bottom: 10px; font-size: 0.85rem;">
                    <div><i class="fas fa-map-marker-alt"></i> ${pedido.direccion}</div>
                    <div><i class="fas fa-phone"></i> ${pedido.telefono}</div>
                    ${pedido.parroquia ? `<div><i class="fas fa-building"></i> Parroquia: ${pedido.parroquia}</div>` : ''}
                    ${pedido.costoDelivery ? `<div><i class="fas fa-truck"></i> Delivery: Bs. ${pedido.costoDelivery.toFixed(2)}</div>` : ''}
                    ${pedido.referencia ? `<div><i class="fas fa-receipt"></i> Ref: ${pedido.referencia}</div>` : ''}
                </div>${timerText}`;
                
                if (pedido.tieneComprobante) {
                    extraInfo += `
                        <div class="comprobante-preview">
                            <span class="comprobante-label"><i class="fas fa-file-image"></i> Comprobante de Pago</span>
                            <button class="btn-ver-comprobante" onclick="solicitarComprobante('${pedido.id}')">
                                <i class="fas fa-search-plus"></i> Ver Comprobante
                            </button>
                        </div>
                    `;
                }
            } else if (pedido.tipo === 'reserva') {
                extraInfo = `<div style="background: #E3F2FD; border: 2px solid var(--info); border-radius: 8px; padding: 10px; margin-bottom: 10px; font-size: 0.85rem;">
                    <div><i class="fas fa-user"></i> ${pedido.clienteNombre || 'No especificado'}</div>
                    <div><i class="fas fa-calendar"></i> ${pedido.fechaReserva ? new Date(pedido.fechaReserva).toLocaleDateString() : 'No especificada'}</div>
                    ${pedido.referencia ? `<div><i class="fas fa-receipt"></i> Ref: ${pedido.referencia}</div>` : ''}
                </div>${timerText}`;
                
                if (pedido.tieneComprobante) {
                    extraInfo += `
                        <div class="comprobante-preview">
                            <span class="comprobante-label"><i class="fas fa-file-image"></i> Comprobante de Pago</span>
                            <button class="btn-ver-comprobante" onclick="solicitarComprobante('${pedido.id}')">
                                <i class="fas fa-search-plus"></i> Ver Comprobante
                            </button>
                        </div>
                    `;
                }
            } else {
                extraInfo = `<div style="margin-bottom: 10px; font-weight: 700; color: var(--info);"><i class="fas fa-chair"></i> Mesa #${pedido.mesa || '--'}</div>`;
            }
            
            const botonesRechazo = (pedido.tipo === 'delivery' || pedido.tipo === 'reserva') ? `<button class="btn btn-rechazar" onclick="mostrarRechazo('${pedido.id}')" id="btn-rechazar-${pedido.id}"><i class="fas fa-times"></i> Rechazar</button>` : '';
            
            return `<div class="order-card" id="card-${pedido.id}">
                <div class="order-card-header">
                    <span class="order-time"><i class="far fa-clock"></i> Pedido realizado a las: ${hora} ${hora.includes('p.m.') ? 'p.m.' : 'a.m.'}</span>
                </div>
                ${extraInfo}
                <div class="order-details">${itemsHtml}</div>
                <div class="order-total">Total: Bs. ${totalMostrar.toFixed(2)}</div>
                <div class="order-actions">
                    <button class="btn btn-cobrar" onclick="mostrarCobro('${pedido.id}')" id="btn-cobrar-${pedido.id}">
                        <i class="fas fa-check"></i> Cobrar
                    </button>
                    ${botonesRechazo}
                </div>
            </div>`;
        }

        function solicitarComprobante(pedidoId) {
            const comprobantes = JSON.parse(localStorage.getItem('sakiComprobantes') || '{}');
            const comprobante = comprobantes[pedidoId];
            
            if (!comprobante) {
                mostrarNotificacion('No se encontr贸 comprobante en el almacenamiento local del navegador. El cliente debe enviarlo por WhatsApp.', 'error');
                return null;
            }
            
            if (!comprobante.disponible) {
                mostrarNotificacion('El comprobante era muy grande y no se guard贸. Solicitar por WhatsApp.', 'warning');
                return null;
            }
            
            const modal = document.getElementById('comprobanteModal');
            const imgContainer = document.getElementById('comprobanteImagenContainer');
            const infoContainer = document.getElementById('comprobanteInfo');
            const downloadLink = document.getElementById('comprobanteDownloadLink');
            
            imgContainer.innerHTML = `<img src="${comprobante.base64}" style="max-width: 100%; max-height: 400px; border-radius: 8px; border: 1px solid #ddd;" alt="Comprobante de pago">`;
            
            const pedido = sistemaData.pedidos.find(p => p.id === pedidoId);
            let infoHtml = `<h4 style="margin-bottom: 15px; color: var(--secondary);">Detalles del Comprobante</h4>`;
            infoHtml += `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">`;
            infoHtml += `<div><strong>Pedido:</strong> ${pedidoId}</div>`;
            infoHtml += `<div><strong>Tipo:</strong> ${pedido?.tipo === 'delivery' ? 'Delivery' : 'Reserva'}</div>`;
            if (pedido?.tipo === 'delivery') {
                infoHtml += `<div><strong>Tel茅fono:</strong> ${pedido.telefono}</div>`;
                infoHtml += `<div><strong>Direcci贸n:</strong> ${pedido.direccion}</div>`;
                infoHtml += `<div><strong>Parroquia:</strong> ${pedido.parroquia || 'N/A'}</div>`;
            } else {
                infoHtml += `<div><strong>Cliente:</strong> ${pedido.clienteNombre}</div>`;
                infoHtml += `<div><strong>Fecha Reserva:</strong> ${new Date(pedido.fechaReserva).toLocaleDateString()}</div>`;
            }
            infoHtml += `<div><strong>Referencia:</strong> ${pedido.referencia}</div>`;
            infoHtml += `<div><strong>Total:</strong> Bs. ${pedido.total?.toFixed(2)}</div>`;
            infoHtml += `<div><strong>Archivo:</strong> ${comprobante.nombre || 'comprobante.jpg'}</div>`;
            infoHtml += `</div>`;
            
            infoContainer.innerHTML = infoHtml;
            downloadLink.href = comprobante.base64;
            downloadLink.download = comprobante.nombre || 'comprobante.jpg';
            
            modal.classList.add('show');
            return comprobante;
        }

        function crearCardPedidoEnPreparacion(pedido, tipo) {
            const fecha = new Date(pedido.timestamp);
            const hora = fecha.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            
            let totalMostrar = pedido.total || 0;
            
            const itemsHtml = (pedido.items || []).map(item => {
                const personalizacion = item.personalizacion?.length > 0 ? ` <small style="color: #666;">(Sin ${item.personalizacion.join(', ')})</small>` : '';
                
                let descuentoTexto = '';
                if (item.descuentoPorIngredientes && item.descuentoPorIngredientes > 0) {
                    descuentoTexto = `<span class="ingredient-discount">-${item.descuentoPorIngredientes.toFixed(2)} Bs</span>`;
                }
                
                let subtotal = item.subtotal || 0;
                
                return `<div class="order-detail-row">
                    <span>${item.cantidad || 1}x ${item.nombre}${personalizacion} ${descuentoTexto}</span>
                    <span class="item-subtotal">Bs. ${subtotal.toFixed(2)}</span>
                </div>`;
            }).join('');
            
            let estadoClass = '';
            let estadoBadge = '';
            let botonAccion = '';
            let cardClass = '';
            let btnId = '';
            
            switch(pedido.estado) {
                case 'en_cocina':
                    estadoClass = 'status-en-cocina';
                    estadoBadge = '<span class="status-badge status-en-cocina"><i class="fas fa-fire"></i> En Cocina</span>';
                    btnId = `btn-entregar-${pedido.id}`;
                    botonAccion = `<button class="btn btn-entregar" onclick="mostrarConfirmacionEntrega('${pedido.id}', 'entrega')" id="${btnId}"><i class="fas fa-check"></i> Pedido Entregado</button>`;
                    cardClass = 'en-cocina';
                    break;
                case 'en_camino':
                    estadoClass = 'status-en-camino';
                    estadoBadge = '<span class="status-badge status-en-camino"><i class="fas fa-motorcycle"></i> En Camino</span>';
                    btnId = `btn-enviar-${pedido.id}`;
                    botonAccion = `<button class="btn btn-enviar" onclick="mostrarConfirmacionEntrega('${pedido.id}', 'envio')" id="${btnId}"><i class="fas fa-check"></i> Pedido Enviado</button>`;
                    cardClass = 'en-camino';
                    break;
                case 'reserva_pendiente':
                    estadoClass = 'status-reserva-pendiente';
                    estadoBadge = '<span class="status-badge status-reserva-pendiente"><i class="fas fa-calendar"></i> Reserva Pendiente</span>';
                    btnId = `btn-confirmar-${pedido.id}`;
                    botonAccion = `<button class="btn btn-confirmar" onclick="mostrarConfirmacionEntrega('${pedido.id}', 'reserva')" id="${btnId}"><i class="fas fa-user-check"></i> Cliente Confirmado</button>`;
                    cardClass = 'reserva-pendiente';
                    break;
                case 'reserva_atendida':
                    estadoClass = 'status-reserva-atendida';
                    estadoBadge = '<span class="status-badge status-reserva-atendida"><i class="fas fa-utensils"></i> Cliente Atendido</span>';
                    btnId = `btn-entregar-reserva-${pedido.id}`;
                    botonAccion = `<button class="btn btn-entregar" onclick="mostrarConfirmacionEntrega('${pedido.id}', 'reserva_entrega')" id="${btnId}"><i class="fas fa-check"></i> Pedido Entregado</button>`;
                    cardClass = 'reserva-atendida';
                    break;
            }
            
            let extraInfo = '';
            if (pedido.tipo === 'delivery') {
                extraInfo = `<div style="background: #E3F2FD; border: 2px solid var(--info); border-radius: 8px; padding: 10px; margin: 10px 0; font-size: 0.85rem;">
                    <div><strong><i class="fas fa-map-marker-alt"></i> Direcci贸n:</strong> ${pedido.direccion}</div>
                    <div><strong><i class="fas fa-phone"></i> Tel茅fono:</strong> ${pedido.telefono}</div>
                    ${pedido.parroquia ? `<div><strong><i class="fas fa-building"></i> Parroquia:</strong> ${pedido.parroquia}</div>` : ''}
                    ${pedido.costoDelivery ? `<div><strong><i class="fas fa-truck"></i> Delivery:</strong> Bs. ${pedido.costoDelivery.toFixed(2)}</div>` : ''}
                    ${pedido.referencia ? `<div><strong><i class="fas fa-receipt"></i> Referencia:</strong> ${pedido.referencia}</div>` : ''}
                </div>`;
                
                if (pedido.tieneComprobante) {
                    extraInfo += `
                        <div class="comprobante-preview" style="margin-top: 10px;">
                            <span class="comprobante-label"><i class="fas fa-file-image"></i> Comprobante de Pago</span>
                            <button class="btn-ver-comprobante" onclick="solicitarComprobante('${pedido.id}')">
                                <i class="fas fa-search-plus"></i> Ver Completo
                            </button>
                        </div>
                    `;
                }
            } else if (pedido.tipo === 'reserva') {
                const fechaReserva = pedido.fechaReserva ? new Date(pedido.fechaReserva) : null;
                const hoy = new Date();
                const esHoy = fechaReserva && fechaReserva.toDateString() === hoy.toDateString();
                
                extraInfo = `<div style="background: #F3E5F5; border: 2px solid #9c27b0; border-radius: 8px; padding: 10px; margin: 10px 0; font-size: 0.85rem;">
                    <div><strong><i class="fas fa-user"></i> Cliente:</strong> ${pedido.clienteNombre || 'No especificado'}</div>
                    <div><strong><i class="fas fa-calendar"></i> Fecha Reserva:</strong> ${fechaReserva ? fechaReserva.toLocaleDateString() : 'No especificada'} ${esHoy ? '<span style="color: #9c27b0; font-weight: bold;">(HOY)</span>' : ''}</div>
                    ${pedido.referencia ? `<div><strong><i class="fas fa-receipt"></i> Referencia:</strong> ${pedido.referencia}</div>` : ''}
                </div>`;
                
                if (pedido.tieneComprobante) {
                    extraInfo += `
                        <div class="comprobante-preview" style="margin-top: 10px;">
                            <span class="comprobante-label"><i class="fas fa-file-image"></i> Comprobante de Pago</span>
                            <button class="btn-ver-comprobante" onclick="solicitarComprobante('${pedido.id}')">
                                <i class="fas fa-search-plus"></i> Ver Completo
                            </button>
                        </div>
                    `;
                }
            } else {
                extraInfo = `<div style="margin: 10px 0; font-weight: 700; color: var(--info); background: #E3F2FD; padding: 10px; border-radius: 8px;"><i class="fas fa-chair"></i> Mesa #${pedido.mesa || '--'}</div>`;
            }
            
            return `<div class="order-card ${cardClass}" id="card-prep-${pedido.id}">
                <div class="order-card-header">
                    <span class="order-time"><i class="far fa-clock"></i> Pedido realizado a las: ${hora} ${hora.includes('p.m.') ? 'p.m.' : 'a.m.'}</span>
                </div>
                ${estadoBadge}
                <div class="order-details">${itemsHtml}</div>
                <div class="order-total">Total: Bs. ${totalMostrar.toFixed(2)}</div>
                ${extraInfo}
                <div class="order-actions">${botonAccion}</div>
            </div>`;
        }

        function mostrarConfirmacionEntrega(pedidoId, tipo) {
            if (isProcessing) return;
            
            pedidoConfirmacion = sistemaData.pedidos.find(p => p.id === pedidoId);
            if (!pedidoConfirmacion) return;
            
            tipoConfirmacion = tipo;
            const modal = document.getElementById('confirmEntregaModal');
            const header = document.getElementById('confirmEntregaHeader');
            const title = document.getElementById('confirmEntregaTitle');
            const body = document.getElementById('confirmEntregaBody');
            
            const total = pedidoConfirmacion.total || 0;
            
            let titulo = '';
            let mensaje = '';
            let icono = '';
            let notificacionCliente = { titulo: '', texto: '' };
            
            switch(tipo) {
                case 'entrega':
                    titulo = 'Confirmar Entrega en Mesa';
                    mensaje = '驴Confirmas que el pedido ha sido entregado al cliente en la mesa?';
                    icono = 'fa-check-circle';
                    header.className = 'modal-header entrega';
                    notificacionCliente = {
                        titulo: '斤 隆Que aproveche!',
                        texto: 'Tu pedido ha sido entregado en tu mesa. Esperamos que disfrutes cada bocado. 隆Gracias por elegir Saki Sushi!'
                    };
                    break;
                case 'envio':
                    titulo = 'Confirmar Env铆o a Delivery';
                    mensaje = '驴Confirmas que el pedido ha sido enviado al repartidor?';
                    icono = 'fa-motorcycle';
                    header.className = 'modal-header envio';
                    notificacionCliente = {
                        titulo: 'Tu delivery va en camino!',
                        texto: 'El repartidor ya sali贸 con tu pedido. Prep谩rate para disfrutar de tu comida.'
                    };
                    break;
                case 'reserva':
                    titulo = 'Confirmar Asistencia a Reserva';
                    mensaje = '驴Confirmas que el cliente ha llegado y est谩 siendo atendido?';
                    icono = 'fa-user-check';
                    header.className = 'modal-header reserva';
                    notificacionCliente = {
                        titulo: ' 隆Cliente confirmado!',
                        texto: 'Has llegado y est谩s siendo atendido. Por favor, espera en tu mesa asignada.'
                    };
                    break;
                case 'reserva_entrega':
                    titulo = 'Confirmar Entrega de Reserva';
                    mensaje = '驴Confirmas que el pedido ha sido servido al cliente reservado?';
                    icono = 'fa-utensils';
                    header.className = 'modal-header entrega';
                    notificacionCliente = {
                        titulo: '斤 隆Que aproveche!',
                        texto: 'Tu pedido de reserva ha sido servido. Esperamos que disfrutes tu experiencia en Saki Sushi.'
                    };
                    break;
            }
            
            title.innerHTML = `<i class="fas ${icono}"></i> ${titulo}`;
            
            const itemsHtml = (pedidoConfirmacion.items || []).map(item => {
                const personalizacion = item.personalizacion?.length > 0 ? ` (Sin ${item.personalizacion.join(', ')})` : '';
                return `<div class="info-row"><span>${item.cantidad || 1}x ${item.nombre}${personalizacion}</span><span>Bs. ${(item.subtotal || 0).toFixed(2)}</span></div>`;
            }).join('');
            
            let detallesExtras = '';
            if (pedidoConfirmacion.tipo === 'delivery') {
                detallesExtras = `<div class="info-row"><span>Direcci贸n:</span><span>${pedidoConfirmacion.direccion}</span></div>
                    <div class="info-row"><span>Tel茅fono:</span><span>${pedidoConfirmacion.telefono}</span></div>
                    ${pedidoConfirmacion.parroquia ? `<div class="info-row"><span>Parroquia:</span><span>${pedidoConfirmacion.parroquia}</span></div>` : ''}
                    ${pedidoConfirmacion.costoDelivery ? `<div class="info-row"><span>Costo Delivery:</span><span>Bs. ${pedidoConfirmacion.costoDelivery.toFixed(2)}</span></div>` : ''}`;
            } else if (pedidoConfirmacion.tipo === 'reserva') {
                detallesExtras = `<div class="info-row"><span>Cliente:</span><span>${pedidoConfirmacion.clienteNombre || 'No especificado'}</span></div>
                    <div class="info-row"><span>Fecha Reserva:</span><span>${pedidoConfirmacion.fechaReserva ? new Date(pedidoConfirmacion.fechaReserva).toLocaleDateString() : 'No especificada'}</span></div>`;
            } else {
                detallesExtras = `<div class="info-row"><span>Mesa:</span><span>#${pedidoConfirmacion.mesa || '--'}</span></div>`;
            }
            
            body.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <i class="fas ${icono}" style="font-size: 3rem; color: var(--primary); margin-bottom: 10px;"></i>
                    <p style="font-size: 1.1rem; color: #666;">${mensaje}</p>
                </div>
                <div class="info-box">
                    <h4 style="margin-bottom: 10px; color: var(--secondary);">Detalles del Pedido:</h4>
                    ${itemsHtml}
                    ${detallesExtras}
                    <div class="info-row" style="font-size: 1.1rem; margin-top: 10px; border-top: 2px dashed #ddd; padding-top: 10px;">
                        <span><strong>TOTAL</strong></span>
                        <span><strong>Bs. ${total.toFixed(2)}</strong></span>
                    </div>
                </div>
                <div style="background: #E8F5E9; border-left: 4px solid var(--success); padding: 15px; margin-top: 15px; border-radius: 8px;">
                    <i class="fas fa-bell"></i> <strong>Notificaci贸n al cliente:</strong><br>
                    <span style="color: var(--success);">${notificacionCliente.titulo}</span><br>
                    <span style="font-size: 0.9rem; color: #666;">${notificacionCliente.texto}</span>
                </div>
                <div class="keyboard-hint">
                    <span><kbd>ENTER</kbd> para confirmar</span>
                    <span><kbd>ESC</kbd> para cancelar</span>
                </div>
            `;
            
            modal.classList.add('show');
            setTimeout(() => document.getElementById('btnConfirmarAccion').focus(), 100);
        }

        async function ejecutarConfirmacion() {
            if (isProcessing || !pedidoConfirmacion || !tipoConfirmacion) return;
            
            setButtonsDisabled(true);
            
            queueOperation(async () => {
                try {
                    const pedidoActual = sistemaData.pedidos.find(p => p.id === pedidoConfirmacion.id);
                    if (!pedidoActual) {
                        mostrarNotificacion('Pedido no encontrado', 'error');
                        return;
                    }
                    
                    let mensajeNotificacion = { titulo: '', texto: '', tipo: 'approved' };
                    
                    switch(tipoConfirmacion) {
                        case 'entrega':
                            pedidoActual.estado = 'entregado';
                            pedidoActual.fechaEntrega = new Date().toISOString();
                            mensajeNotificacion = {
                                titulo: '斤 隆Que aproveche!',
                                texto: 'Tu pedido ha sido entregado en tu mesa. Esperamos que disfrutes cada bocado. 隆Gracias por elegir Saki Sushi!',
                                tipo: 'approved'
                            };
                            break;
                        case 'envio':
                            pedidoActual.estado = 'enviado';
                            pedidoActual.fechaEnvio = new Date().toISOString();
                            mensajeNotificacion = {
                                titulo: 'Tu delivery va en camino!',
                                texto: 'El repartidor ya sali贸 con tu pedido. Prep谩rate para disfrutar de tu comida.',
                                tipo: 'approved'
                            };
                            break;
                        case 'reserva':
                            pedidoActual.estado = 'reserva_atendida';
                            pedidoActual.fechaAsistencia = new Date().toISOString();
                            mensajeNotificacion = {
                                titulo: ' 隆Cliente confirmado!',
                                texto: 'Has llegado y est谩s siendo atendido. Por favor, espera en tu mesa asignada.',
                                tipo: 'approved'
                            };
                            break;
                        case 'reserva_entrega':
                            pedidoActual.estado = 'reserva_completada';
                            pedidoActual.fechaCompletado = new Date().toISOString();
                            mensajeNotificacion = {
                                titulo: '斤 隆Que aproveche!',
                                texto: 'Tu pedido de reserva ha sido servido. Esperamos que disfrutes tu experiencia en Saki Sushi.',
                                tipo: 'approved'
                            };
                            break;
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 200));
                    await guardarCambios();
                    await new Promise(resolve => setTimeout(resolve, 300));
                    
                    agregarNotificacionCliente(
                        pedidoActual.id, 
                        mensajeNotificacion.tipo, 
                        mensajeNotificacion.titulo, 
                        mensajeNotificacion.texto
                    );
                    
                    cerrarModal('confirmEntregaModal');
                    mostrarNotificacion('Estado actualizado. Cliente notificado.');
                    
                    await new Promise(resolve => setTimeout(resolve, 200));
                    renderPedidos();
                    
                } catch (error) {
                    console.error('Error en confirmaci贸n:', error);
                    mostrarNotificacion('Error al procesar. Intente nuevamente.', 'error');
                } finally {
                    pedidoConfirmacion = null;
                    tipoConfirmacion = null;
                    setButtonsDisabled(false);
                }
            });
        }

        function agregarNotificacionCliente(pedidoId, tipo, titulo, mensaje) {
            try {
                const notificacion = {
                    id: Date.now(),
                    pedidoId: pedidoId,
                    tipo: tipo,
                    titulo: titulo,
                    mensaje: mensaje,
                    timestamp: new Date().toISOString(),
                    leida: false
                };
                
                let notificaciones = JSON.parse(localStorage.getItem('sakiNotificaciones') || '[]');
                notificaciones.unshift(notificacion);
                localStorage.setItem('sakiNotificaciones', JSON.stringify(notificaciones));
                
                console.log(' Notificaci贸n enviada al cliente:', notificacion);
            } catch (e) {
                console.error('Error guardando notificaci贸n:', e);
            }
        }

        function handleGlobalKeypress(e) {
            const modalConfirmacion = document.getElementById('confirmEntregaModal');
            if (modalConfirmacion.classList.contains('show')) {
                if (e.key === 'Enter') { e.preventDefault(); ejecutarConfirmacion(); }
                else if (e.key === 'Escape') { e.preventDefault(); cerrarModal('confirmEntregaModal'); pedidoConfirmacion = null; tipoConfirmacion = null; }
                return;
            }
            
            const modalCobro = document.getElementById('cobroModal');
            if (modalCobro.classList.contains('show')) {
                if (e.key === 'Escape') closeModal('cobroModal');
                return;
            }
            
            const modalRechazo = document.getElementById('rechazoModal');
            if (modalRechazo.classList.contains('show')) {
                if (e.key === 'Escape') closeModal('rechazoModal');
                return;
            }
            
            const modalComprobante = document.getElementById('comprobanteModal');
            if (modalComprobante.classList.contains('show')) {
                if (e.key === 'Escape') cerrarModal('comprobanteModal');
                return;
            }
        }

        function mostrarCobro(pedidoId) {
            if (isProcessing) return;
            
            currentPedido = sistemaData.pedidos.find(p => p.id === pedidoId);
            if (!currentPedido) return;
            
            invitacionActiva = false;
            vueltoConfirmado = false;
            condonacionActiva = false;
            afavorCajaActiva = false;
            pagosConMonto = false;
            document.getElementById('invitacionCheckbox').checked = false;
            document.getElementById('invitacionContainer').style.display = 'flex';
            document.getElementById('vueltoSection').style.display = 'none';
            document.getElementById('condonacionCheckbox').style.display = 'none';
            document.getElementById('afavorCajaCheckbox').style.display = 'none';
            document.getElementById('condonacionInput').checked = false;
            document.getElementById('afavorCajaInput').checked = false;
            document.getElementById('condonacionMontoDisplay').style.display = 'none';
            document.getElementById('afavorCajaMontoDisplay').style.display = 'none';
            document.getElementById('optCondonacion').checked = false;
            document.getElementById('optAfavorCaja').checked = false;
            
            const summary = document.getElementById('cobroSummary');
            
            let itemsHtml = (currentPedido.items || []).map(item => {
                const personalizacion = item.personalizacion?.length > 0 ? ` <small style="color: #666;">(Sin ${item.personalizacion.join(', ')})</small>` : '';
                
                let descuentoTexto = '';
                let descuentoDetalle = '';
                
                if (item.descuentoPorIngredientes && item.descuentoPorIngredientes > 0) {
                    descuentoTexto = `<span class="ingredient-discount">-${item.descuentoPorIngredientes.toFixed(2)} Bs</span>`;
                    descuentoDetalle = `<div style="font-size: 0.8rem; color: var(--success); margin-top: 2px;">
                        <i class="fas fa-tag"></i> Descuento por ingredientes removidos: -Bs. ${item.descuentoPorIngredientes.toFixed(2)}
                    </div>`;
                }
                
                let subtotal = item.subtotal || 0;
                
                return `<div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                    <div>
                        <span>${item.cantidad || 1}x ${item.nombre}${personalizacion} ${descuentoTexto}</span>
                        ${descuentoDetalle}
                    </div>
                    <span style="font-weight: 600;">Bs. ${subtotal.toFixed(2)}</span>
                </div>`;
            }).join('');
            
            totalPagar = currentPedido.total || 0;
            
            summary.innerHTML = `<div style="background: #f8f8f8; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                <h4 style="margin-bottom: 10px; color: var(--secondary);">Detalle del Pedido:</h4>
                ${itemsHtml}
            </div>`;
            
            document.getElementById('totalPagarDisplay').textContent = `Bs. ${totalPagar.toFixed(2)}`;
            document.getElementById('remainingLabel').textContent = 'Monto a cobrar:';
            document.getElementById('remainingAmount').textContent = `Bs. ${totalPagar.toFixed(2)}`;
            
            pagosMixtos = [];
            renderPagosMixtos();
            actualizarResumenPago();
            
            document.getElementById('specialOptions').style.display = 'none';
            document.getElementById('btnConfirmarCobro').disabled = true;
            
            document.getElementById('cobroModal').classList.add('show');
        }

        function toggleInvitacion() {
            invitacionActiva = document.getElementById('invitacionCheckbox').checked;
            
            if (invitacionActiva) {
                totalPagar = 0;
                document.getElementById('totalPagarDisplay').textContent = `Bs. 0.00`;
                document.getElementById('btnConfirmarCobro').disabled = false;
                document.querySelectorAll('.payment-mix-add, .payment-mix-item, .payment-mix-summary').forEach(el => {
                    if (el) el.style.opacity = '0.5';
                });
                document.getElementById('btnAddPayment').disabled = true;
            } else {
                totalPagar = currentPedido.total || 0;
                document.getElementById('totalPagarDisplay').textContent = `Bs. ${totalPagar.toFixed(2)}`;
                document.querySelectorAll('.payment-mix-add, .payment-mix-item, .payment-mix-summary').forEach(el => {
                    if (el) el.style.opacity = '1';
                });
                document.getElementById('btnAddPayment').disabled = false;
                actualizarResumenPago();
            }
        }

        function agregarMetodoPago() {
            if (pagosMixtos.length >= 10) {
                mostrarNotificacion('M谩ximo 10 m茅todos de pago', 'error');
                return;
            }
            
            const metodosDisponibles = [
                { id: 'pago_movil', nombre: 'Pago M贸vil', icono: 'fa-mobile-alt' },
                { id: 'efectivo_bs', nombre: 'Efectivo Bs', icono: 'fa-money-bill-wave' },
                { id: 'efectivo_usd', nombre: 'Efectivo $', icono: 'fa-dollar-sign' },
                { id: 'punto_venta', nombre: 'Punto de Venta', icono: 'fa-credit-card' }
            ];
            
            pagosMixtos.push({
                id: Date.now() + Math.random(),
                metodo: 'pago_movil',
                monto: 0,
                referencia: ''
            });
            
            renderPagosMixtos();
            actualizarResumenPago();
        }

        function renderPagosMixtos() {
            const container = document.getElementById('paymentMixContainer');
            
            if (pagosMixtos.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Agrega un m茅todo de pago para comenzar</p>';
                document.getElementById('btnAddPayment').disabled = false;
                return;
            }
            
            const metodosOptions = [
                { id: 'pago_movil', nombre: 'Pago M贸vil' },
                { id: 'efectivo_bs', nombre: 'Efectivo Bs' },
                { id: 'efectivo_usd', nombre: 'Efectivo $' },
                { id: 'punto_venta', nombre: 'Punto de Venta' }
            ];
            
            container.innerHTML = pagosMixtos.map((pago, index) => {
                const options = metodosOptions.map(m => 
                    `<option value="${m.id}" ${pago.metodo === m.id ? 'selected' : ''}>${m.nombre}</option>`
                ).join('');
                
                const showReferencia = pago.metodo === 'pago_movil';
                const placeholderTexto = 'Referencia (6 d铆gitos)';
                const monedaPrefijo = pago.metodo === 'efectivo_usd' ? '$' : 'Bs.';
                
                return `
                    <div class="payment-mix-item" id="pago-${pago.id}">
                        <div class="payment-mix-header">
                            <div class="payment-mix-title">
                                <i class="fas fa-${getIconoMetodo(pago.metodo)}"></i>
                                <select class="payment-method-select" onchange="cambiarMetodoPago(${pago.id}, this.value)">
                                    ${options}
                                </select>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span class="moneda-prefijo">${monedaPrefijo}</span>
                                <input type="number" step="0.01" class="payment-mix-input" 
                                    value="${pago.monto > 0 ? pago.monto : ''}" 
                                    placeholder="0.00" 
                                    oninput="actualizarMontoPago(${pago.id}, this.value)"
                                    onkeypress="handlePaymentKeypress(event)">
                                ${pagosMixtos.length > 1 ? `<button class="btn-remove-payment" onclick="eliminarMetodoPago(${pago.id})"><i class="fas fa-times"></i></button>` : ''}
                            </div>
                        </div>
                        ${showReferencia ? `
                            <div class="reference-input">
                                <label style="font-size: 0.85rem; color: #666; display: block; margin-bottom: 5px;">${placeholderTexto}:</label>
                                <input type="text" maxlength="6" placeholder="${placeholderTexto}" value="${pago.referencia}" oninput="actualizarReferencia(${pago.id}, this.value)">
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            document.getElementById('btnAddPayment').disabled = pagosMixtos.length >= 10;
        }

        function getIconoMetodo(metodo) {
            const iconos = {
                'efectivo_bs': 'money-bill-wave',
                'efectivo_usd': 'dollar-sign',
                'pago_movil': 'mobile-alt',
                'punto_venta': 'credit-card'
            };
            return iconos[metodo] || 'money-bill';
        }

        function cambiarMetodoPago(id, nuevoMetodo) {
            const pago = pagosMixtos.find(p => p.id === id);
            if (pago) {
                pago.metodo = nuevoMetodo;
                pago.referencia = '';
                renderPagosMixtos();
                actualizarResumenPago();
            }
        }

        function actualizarMontoPago(id, monto) {
            const pago = pagosMixtos.find(p => p.id === id);
            if (pago) {
                pago.monto = parseFloat(monto) || 0;
                
                pagosConMonto = pagosMixtos.some(p => p.monto > 0);
                const invitacionContainer = document.getElementById('invitacionContainer');
                if (pagosConMonto) {
                    invitacionContainer.style.display = 'none';
                } else {
                    invitacionContainer.style.display = 'flex';
                }
                
                actualizarResumenPago();
            }
        }

        function actualizarReferencia(id, referencia) {
            const pago = pagosMixtos.find(p => p.id === id);
            if (pago) {
                pago.referencia = referencia;
                actualizarResumenPago();
            }
        }

        function eliminarMetodoPago(id) {
            pagosMixtos = pagosMixtos.filter(p => p.id !== id);
            
            pagosConMonto = pagosMixtos.some(p => p.monto > 0);
            const invitacionContainer = document.getElementById('invitacionContainer');
            if (pagosConMonto) {
                invitacionContainer.style.display = 'none';
            } else {
                invitacionContainer.style.display = 'flex';
            }
            
            renderPagosMixtos();
            actualizarResumenPago();
        }

        function handlePaymentKeypress(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const totalRecibido = pagosMixtos.reduce((sum, p) => sum + convertirAMontoReal(p), 0);
                const pendiente = totalPagar - totalRecibido;
                
                if (pendiente > 0 && pagosMixtos.length < 10) {
                    agregarMetodoPago();
                }
            }
        }

        function convertirAMontoReal(pago) {
            if (pago.metodo === 'efectivo_usd') {
                return pago.monto * tasaEfectiva;
            }
            return pago.monto;
        }

        function actualizarResumenPago() {
            if (invitacionActiva) return;
            
            let totalRecibido = 0;
            let totalRecibidoUsd = 0;
            
            pagosMixtos.forEach(pago => {
                if (pago.metodo === 'efectivo_usd') {
                    totalRecibidoUsd += pago.monto;
                    totalRecibido += pago.monto * tasaEfectiva;
                } else {
                    totalRecibido += pago.monto;
                }
            });
            
            const diferencia = totalRecibido - totalPagar; // Negativo = falta, Positivo = sobra
            
            const remainingDisplay = document.getElementById('remainingDisplay');
            const remainingAmount = document.getElementById('remainingAmount');
            const remainingLabel = document.getElementById('remainingLabel');
            
            // Actualizar labels seg煤n la situaci贸n
            if (diferencia < 0) {
                // FALTA DINERO
                remainingDisplay.className = 'payment-mix-remaining faltante';
                remainingLabel.textContent = 'Pendiente por cobrar:';
                remainingAmount.textContent = `Bs. ${Math.abs(diferencia).toFixed(2)}`;
                remainingAmount.style.color = 'var(--danger)';
                
                // Ocultar secci贸n de vuelto y mostrar checkbox de condonaci贸n
                document.getElementById('vueltoSection').style.display = 'none';
                document.getElementById('condonacionCheckbox').style.display = 'flex';
                document.getElementById('condonacionMontoDisplay').textContent = `Bs. ${Math.abs(diferencia).toFixed(2)}`;
                document.getElementById('condonacionMontoDisplay').style.display = 'inline';
                document.getElementById('afavorCajaCheckbox').style.display = 'none';
                
                // Deshabilitar confirmar cobro hasta que se active condonaci贸n
                if (!condonacionActiva) {
                    document.getElementById('btnConfirmarCobro').disabled = true;
                }
                
            } else if (diferencia > 0) {
                // SOBRA DINERO
                remainingDisplay.className = 'payment-mix-remaining excedente';
                remainingLabel.textContent = 'Vuelto a entregar:';
                remainingAmount.textContent = `Bs. ${diferencia.toFixed(2)}`;
                remainingAmount.style.color = 'var(--warning)';
                
                // Mostrar secci贸n de vuelto
                document.getElementById('vueltoSection').style.display = 'flex';
                document.getElementById('vueltoInput').value = diferencia.toFixed(2);
                document.getElementById('vueltoInput').disabled = false;
                document.getElementById('confirmarVueltoBtn').style.display = 'inline-block';
                document.getElementById('deshacerVueltoBtn').style.display = 'none';
                document.getElementById('condonacionCheckbox').style.display = 'none';
                
                // Si hay vuelto pendiente y no est谩 confirmado, deshabilitar confirmar cobro
                if (!vueltoConfirmado) {
                    document.getElementById('btnConfirmarCobro').disabled = true;
                }
                
                // Calcular vuelto restante despu茅s de lo ingresado en el campo
                const vueltoIngresado = parseFloat(document.getElementById('vueltoInput').value) || 0;
                const vueltoRestante = diferencia - vueltoIngresado;
                
                if (vueltoRestante > 0) {
                    // A煤n falta devolver vuelto
                    document.getElementById('afavorCajaCheckbox').style.display = 'flex';
                    document.getElementById('afavorCajaMontoDisplay').textContent = `Bs. ${vueltoRestante.toFixed(2)}`;
                    document.getElementById('afavorCajaMontoDisplay').style.display = 'inline';
                } else if (vueltoRestante === 0) {
                    // Vuelto exacto
                    document.getElementById('afavorCajaCheckbox').style.display = 'none';
                } else {
                    // Se pas贸 de vuelto (ahora falta dinero)
                    document.getElementById('afavorCajaCheckbox').style.display = 'none';
                    document.getElementById('condonacionCheckbox').style.display = 'flex';
                    document.getElementById('condonacionMontoDisplay').textContent = `Bs. ${Math.abs(vueltoRestante).toFixed(2)}`;
                }
                
            } else {
                // PAGO EXACTO
                remainingDisplay.className = 'payment-mix-remaining paid';
                remainingLabel.textContent = 'Pendiente por pagar:';
                remainingAmount.textContent = '隆PAGO COMPLETO!';
                remainingAmount.style.color = 'var(--success)';
                
                document.getElementById('vueltoSection').style.display = 'none';
                document.getElementById('condonacionCheckbox').style.display = 'none';
                document.getElementById('afavorCajaCheckbox').style.display = 'none';
                document.getElementById('btnConfirmarCobro').disabled = false;
            }
            
            const summaryDiv = document.getElementById('paymentSummary');
            if (pagosMixtos.length > 0 && pagosMixtos.some(p => p.monto > 0)) {
                summaryDiv.style.display = 'block';
                
                let resumenTexto = `Total recibido: Bs. ${totalRecibido.toFixed(2)}`;
                if (totalRecibidoUsd > 0) {
                    resumenTexto += ` ($${totalRecibidoUsd.toFixed(2)}  ${tasaEfectiva.toFixed(2)})`;
                }
                document.getElementById('totalRecibido').textContent = resumenTexto;
                
                if (diferencia < 0) {
                    document.getElementById('faltanteRow').style.display = 'flex';
                    document.getElementById('faltanteAmount').textContent = `Bs. ${Math.abs(diferencia).toFixed(2)}`;
                    document.getElementById('excedenteRow').style.display = 'none';
                } else if (diferencia > 0) {
                    document.getElementById('excedenteRow').style.display = 'flex';
                    document.getElementById('excedenteAmount').textContent = `Bs. ${diferencia.toFixed(2)}`;
                    document.getElementById('faltanteRow').style.display = 'none';
                } else {
                    document.getElementById('faltanteRow').style.display = 'none';
                    document.getElementById('excedenteRow').style.display = 'none';
                }
            } else {
                summaryDiv.style.display = 'none';
            }
            
            const btnConfirmar = document.getElementById('btnConfirmarCobro');
            if (invitacionActiva) {
                btnConfirmar.disabled = false;
                return;
            }
            
            const hayMontoValido = pagosMixtos.some(p => p.monto > 0);
            
            const hayReferenciaValida = pagosMixtos.every(p => {
                if (p.monto <= 0) return true;
                if (p.metodo === 'pago_movil') {
                    return p.referencia && p.referencia.length === 6;
                }
                return true;
            });
            
            // L贸gica para habilitar confirmar cobro
            if (diferencia === 0) {
                btnConfirmar.disabled = false;
            } else if (diferencia < 0 && condonacionActiva) {
                btnConfirmar.disabled = false;
            } else if (diferencia > 0 && vueltoConfirmado && (afavorCajaActiva || document.getElementById('vueltoInput').value == diferencia)) {
                btnConfirmar.disabled = false;
            } else {
                btnConfirmar.disabled = !(hayMontoValido && hayReferenciaValida);
            }
        }

        function actualizarVueltoEnTiempoReal() {
            const vueltoIngresado = parseFloat(document.getElementById('vueltoInput').value) || 0;
            const totalRecibido = pagosMixtos.reduce((sum, p) => sum + convertirAMontoReal(p), 0);
            const excedente = totalRecibido - totalPagar;
            
            const vueltoRestante = excedente - vueltoIngresado;
            
            if (vueltoRestante > 0) {
                // A煤n falta devolver vuelto
                document.getElementById('remainingLabel').textContent = 'Restante por devolver:';
                document.getElementById('remainingAmount').textContent = `Bs. ${vueltoRestante.toFixed(2)}`;
                document.getElementById('afavorCajaCheckbox').style.display = 'flex';
                document.getElementById('afavorCajaMontoDisplay').textContent = `Bs. ${vueltoRestante.toFixed(2)}`;
            } else if (vueltoRestante === 0) {
                // Vuelto exacto
                document.getElementById('remainingLabel').textContent = 'Vuelto a entregar:';
                document.getElementById('remainingAmount').textContent = `Bs. 0.00 (completo)`;
                document.getElementById('afavorCajaCheckbox').style.display = 'none';
            } else {
                // Se pas贸 de vuelto (ahora falta dinero)
                document.getElementById('remainingDisplay').className = 'payment-mix-remaining faltante';
                document.getElementById('remainingLabel').textContent = 'Pendiente por cobrar:';
                document.getElementById('remainingAmount').textContent = `Bs. ${Math.abs(vueltoRestante).toFixed(2)}`;
                document.getElementById('afavorCajaCheckbox').style.display = 'none';
                document.getElementById('condonacionCheckbox').style.display = 'flex';
                document.getElementById('condonacionMontoDisplay').textContent = `Bs. ${Math.abs(vueltoRestante).toFixed(2)}`;
            }
        }

        function confirmarVuelto() {
            const vueltoIngresado = parseFloat(document.getElementById('vueltoInput').value) || 0;
            const totalRecibido = pagosMixtos.reduce((sum, p) => sum + convertirAMontoReal(p), 0);
            const excedente = totalRecibido - totalPagar;
            
            if (vueltoIngresado > excedente) {
                mostrarNotificacion('El vuelto no puede ser mayor al excedente', 'error');
                return;
            }
            
            vueltoConfirmado = true;
            vueltoValor = vueltoIngresado;
            document.getElementById('confirmarVueltoBtn').style.display = 'none';
            document.getElementById('deshacerVueltoBtn').style.display = 'inline-block';
            document.getElementById('vueltoInput').disabled = true;
            
            // Verificar si con este vuelto se completa el pago
            const vueltoRestante = excedente - vueltoIngresado;
            if (vueltoRestante === 0) {
                document.getElementById('remainingDisplay').className = 'payment-mix-remaining paid';
                document.getElementById('remainingLabel').textContent = 'Pendiente por pagar:';
                document.getElementById('remainingAmount').textContent = '隆PAGO COMPLETO!';
                document.getElementById('btnConfirmarCobro').disabled = false;
            }
            
            mostrarNotificacion(`Vuelto de Bs. ${vueltoIngresado.toFixed(2)} confirmado`, 'success');
        }

        function deshacerVuelto() {
            vueltoConfirmado = false;
            document.getElementById('confirmarVueltoBtn').style.display = 'inline-block';
            document.getElementById('deshacerVueltoBtn').style.display = 'none';
            document.getElementById('vueltoInput').disabled = false;
            actualizarResumenPago();
        }

        function toggleCondonacion() {
            condonacionActiva = document.getElementById('condonacionInput').checked;
            
            if (condonacionActiva) {
                const totalRecibido = pagosMixtos.reduce((sum, p) => sum + convertirAMontoReal(p), 0);
                const pendiente = totalPagar - totalRecibido;
                document.getElementById('remainingDisplay').className = 'payment-mix-remaining paid';
                document.getElementById('remainingLabel').textContent = 'Monto condonado:';
                document.getElementById('remainingAmount').textContent = `Bs. ${pendiente.toFixed(2)}`;
                document.getElementById('btnConfirmarCobro').disabled = false;
            } else {
                actualizarResumenPago();
            }
            
            document.getElementById('optCondonacion').checked = condonacionActiva;
        }

        function toggleAfavorCaja() {
            afavorCajaActiva = document.getElementById('afavorCajaInput').checked;
            
            if (afavorCajaActiva) {
                const totalRecibido = pagosMixtos.reduce((sum, p) => sum + convertirAMontoReal(p), 0);
                const excedente = totalRecibido - totalPagar;
                const vueltoIngresado = parseFloat(document.getElementById('vueltoInput').value) || 0;
                const restante = excedente - vueltoIngresado;
                
                document.getElementById('remainingDisplay').className = 'payment-mix-remaining paid';
                document.getElementById('remainingLabel').textContent = 'A favor de caja:';
                document.getElementById('remainingAmount').textContent = `Bs. ${restante.toFixed(2)}`;
                document.getElementById('btnConfirmarCobro').disabled = false;
            } else {
                actualizarResumenPago();
            }
            
            document.getElementById('optAfavorCaja').checked = afavorCajaActiva;
        }

        function sincronizarCondonacion() {
            document.getElementById('condonacionInput').checked = document.getElementById('optCondonacion').checked;
            toggleCondonacion();
        }

        function sincronizarAfavorCaja() {
            document.getElementById('afavorCajaInput').checked = document.getElementById('optAfavorCaja').checked;
            toggleAfavorCaja();
        }

        async function confirmarCobro() {
            if (isProcessing || (!currentPedido && !invitacionActiva) || (pagosMixtos.length === 0 && !invitacionActiva)) return;
            
            const btnConfirmar = document.getElementById('btnConfirmarCobro');
            btnConfirmar.disabled = true;
            
            queueOperation(async () => {
                try {
                    if (invitacionActiva) {
                        const pedidoActual = sistemaData.pedidos.find(p => p.id === currentPedido.id);
                        if (!pedidoActual) {
                            mostrarNotificacion('Pedido no encontrado', 'error');
                            return;
                        }
                        
                        pedidoActual.estado = 'en_cocina';
                        pedidoActual.cajero = 'Cajero Principal';
                        pedidoActual.fechaCobro = new Date().toISOString();
                        pedidoActual.metodoPago = 'invitacion';
                        pedidoActual.pagosMixtos = [{ metodo: 'invitacion', monto: 0, montoBs: 0 }];
                        
                        agregarNotificacionCliente(
                            pedidoActual.id,
                            'approved',
                            ' 隆Invitaci贸n de la casa!',
                            'Tu pedido es por cuenta de la casa. 隆Disfruta tu comida!'
                        );
                        
                        await guardarCambios();
                        closeModal('cobroModal');
                        mostrarNotificacion(' Pedido procesado como invitaci贸n');
                        renderPedidos();
                        return;
                    }
                    
                    let totalRecibido = 0;
                    let totalRecibidoUsd = 0;
                    
                    pagosMixtos.forEach(pago => {
                        if (pago.metodo === 'efectivo_usd') {
                            totalRecibidoUsd += pago.monto;
                            totalRecibido += pago.monto * tasaEfectiva;
                        } else {
                            totalRecibido += pago.monto;
                        }
                    });
                    
                    const diferencia = totalRecibido - totalPagar;
                    
                    const pedidoActual = sistemaData.pedidos.find(p => p.id === currentPedido.id);
                    if (!pedidoActual) {
                        mostrarNotificacion('Pedido no encontrado', 'error');
                        return;
                    }
                    
                    if (pedidoActual.items) {
                        pedidoActual.items.forEach(item => {
                            const platillo = sistemaData.menu.find(p => p.id === item.platilloId);
                            if (platillo && platillo.ingredientes) {
                                Object.entries(platillo.ingredientes).forEach(([ingKey, ingData]) => {
                                    if (!item.personalizacion?.includes(ingKey)) {
                                        if (sistemaData.inventario[ingKey]) {
                                            const cantidadNecesaria = convertirUnidad(
                                                ingData.cantidad * (item.cantidad || 1),
                                                ingData.unidad || 'unidades',
                                                sistemaData.inventario[ingKey].unidad || 'unidades'
                                            );
                                            sistemaData.inventario[ingKey].stock = Math.max(
                                                0, 
                                                (sistemaData.inventario[ingKey].stock || 0) - cantidadNecesaria
                                            );
                                        }
                                    }
                                });
                            }
                        });
                    }
                    
                    pedidoActual.items?.forEach(item => {
                        const platillo = sistemaData.menu.find(p => p.id === item.platilloId);
                        if (platillo) {
                            platillo.stock = Math.max(0, (platillo.stock || 0) - (item.cantidad || 1));
                            platillo.stockMaximo = platillo.stock;
                        }
                    });
                    
                    if (pedidoActual.tipo === 'delivery') {
                        pedidoActual.estado = 'en_camino';
                    } else if (pedidoActual.tipo === 'reserva') {
                        pedidoActual.estado = 'reserva_pendiente';
                    } else {
                        pedidoActual.estado = 'en_cocina';
                    }
                    
                    pedidoActual.cajero = 'Cajero Principal';
                    pedidoActual.fechaCobro = new Date().toISOString();
                    
                    pedidoActual.pagosMixtos = pagosMixtos.map(p => ({
                        metodo: p.metodo,
                        monto: p.monto,
                        montoBs: p.metodo === 'efectivo_usd' ? p.monto * tasaEfectiva : p.monto,
                        referencia: p.referencia || null
                    }));
                    
                    // Registrar acciones especiales
                    if (diferencia < 0 && condonacionActiva) {
                        pedidoActual.condonado = Math.abs(diferencia);
                    } else if (diferencia > 0 && vueltoConfirmado) {
                        pedidoActual.vueltoEntregado = vueltoValor;
                        if (afavorCajaActiva) {
                            const vueltoIngresado = parseFloat(document.getElementById('vueltoInput').value) || 0;
                            const restante = diferencia - vueltoIngresado;
                            pedidoActual.aFavorCaja = restante;
                        }
                    }
                    
                    if (pagosMixtos.length === 1) {
                        const pago = pagosMixtos[0];
                        if (pago.metodo === 'efectivo_bs') pedidoActual.metodoPago = 'efectivo';
                        else if (pago.metodo === 'efectivo_usd') pedidoActual.metodoPago = 'efectivo_usd';
                        else if (pago.metodo === 'pago_movil') pedidoActual.metodoPago = 'pago_movil';
                        else if (pago.metodo === 'punto_venta') pedidoActual.metodoPago = 'punto_venta';
                    } else {
                        pedidoActual.metodoPago = 'mixto';
                    }
                    
                    pedidoActual.montoRecibido = totalRecibido;
                    pedidoActual.montoRecibidoUsd = totalRecibidoUsd;
                    pedidoActual.tasaAplicada = tasaEfectiva;
                    
                    let mensajeNotificacion = {
                        titulo: ' 隆Pago confirmado!',
                        texto: '',
                        tipo: 'approved'
                    };
                    
                    if (pedidoActual.tipo === 'delivery') {
                        mensajeNotificacion.texto = 'Tu pago ha sido verificado. El repartidor saldr谩 pronto con tu pedido. 隆Gracias por elegir Saki Sushi!';
                    } else if (pedidoActual.tipo === 'reserva') {
                        mensajeNotificacion.texto = 'Tu pago ha sido verificado. Tu reserva est谩 confirmada. 隆Te esperamos en la fecha acordada!';
                    } else {
                        mensajeNotificacion.texto = 'Tu pago ha sido verificado. Nuestros chefs comenzar谩n a preparar tu pedido inmediatamente.';
                    }
                    
                    agregarNotificacionCliente(pedidoActual.id, mensajeNotificacion.tipo, mensajeNotificacion.titulo, mensajeNotificacion.texto);
                    
                    await guardarCambios();
                    
                    closeModal('cobroModal');
                    mostrarNotificacion(' Cobro procesado. Stock descontado. Cliente notificado.');
                    
                    renderPedidos();
                    
                } catch (error) {
                    console.error('Error en cobro:', error);
                    mostrarNotificacion('Error al procesar cobro. Intente nuevamente.', 'error');
                    btnConfirmar.disabled = false;
                }
            });
        }

        function convertirUnidad(valor, desde, hacia) {
            if (desde === hacia) return valor;
            
            let enBase = valor;
            if (desde === 'kilogramos') enBase = valor * 1000;
            else if (desde === 'litros') enBase = valor * 1000;
            
            if (hacia === 'kilogramos') return enBase / 1000;
            else if (hacia === 'litros') return enBase / 1000;
            
            return enBase;
        }

        function mostrarRechazo(pedidoId) {
            if (isProcessing) return;
            pedidoRechazo = sistemaData.pedidos.find(p => p.id === pedidoId);
            if (pedidoRechazo) {
                document.getElementById('rechazoModal').classList.add('show');
            }
        }

        async function confirmarRechazo() {
            if (isProcessing || !pedidoRechazo) return;
            
            const razon = document.querySelector('input[name="rejectionReason"]:checked')?.value;
            if (!razon) { 
                alert('Selecciona una raz贸n de rechazo'); 
                return; 
            }
            
            setButtonsDisabled(true);
            
            queueOperation(async () => {
                try {
                    const pedidoActual = sistemaData.pedidos.find(p => p.id === pedidoRechazo.id);
                    if (!pedidoActual) {
                        mostrarNotificacion('Pedido no encontrado', 'error');
                        return;
                    }
                    
                    pedidoActual.estado = 'rechazado';
                    pedidoActual.razonRechazo = razon;
                    pedidoActual.fechaRechazo = new Date().toISOString();
                    
                    agregarNotificacionCliente(
                        pedidoActual.id,
                        'rejected',
                        '锔 Pedido rechazado',
                        `Motivo: ${traducirRazon(razon)}. Por favor, contacta al restaurante para m谩s informaci贸n.`
                    );
                    
                    await guardarCambios();
                    
                    closeModal('rechazoModal');
                    mostrarNotificacion('Pedido rechazado. Cliente notificado.');
                    
                    renderPedidos();
                    
                } catch (error) {
                    console.error('Error en rechazo:', error);
                    mostrarNotificacion('Error al procesar rechazo. Intente nuevamente.', 'error');
                } finally {
                    pedidoRechazo = null;
                    setButtonsDisabled(false);
                }
            });
        }

        function traducirRazon(razon) {
            const razones = {
                'referencia_invalida': 'Referencia de pago inv谩lida o falsa',
                'monto_insuficiente': 'Monto insuficiente',
                'datos_incorrectos': 'Datos de contacto/direcci贸n incorrectos',
                'no_disponible': 'Producto no disponible',
                'fuera_horario': 'Fuera de horario de delivery'
            };
            return razones[razon] || razon;
        }

        function renderMenuView() {
            const container = document.getElementById('menuViewContainer');
            if (!sistemaData || !sistemaData.menu) return;
            
            container.innerHTML = sistemaData.menu.map(item => {
                const precioBs = ((item.precio || 0) * tasaEfectiva).toFixed(2);
                
                let disponible = item.disponible;
                let stockReal = item.stock || 0;
                
                if (disponible && item.ingredientes) {
                    let maxPlatillos = Infinity;
                    Object.entries(item.ingredientes).forEach(([ingId, data]) => {
                        const ing = sistemaData.inventario[ingId];
                        if (ing) {
                            const disponibleIng = Math.floor(ing.stock / (data.cantidad || 1));
                            maxPlatillos = Math.min(maxPlatillos, disponibleIng);
                        } else {
                            maxPlatillos = 0;
                        }
                    });
                    if (maxPlatillos === Infinity || maxPlatillos < 0) maxPlatillos = 0;
                    stockReal = maxPlatillos;
                    disponible = maxPlatillos > 0 && item.disponible;
                }
                
                return `
                    <div class="menu-item-card">
                        ${item.imagen ? `<img src="${item.imagen}" class="menu-item-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'"><div class="menu-item-img" style="display: none;"><i class="fas fa-image"></i></div>` : '<div class="menu-item-img"><i class="fas fa-image"></i></div>'}
                        <div class="menu-item-info">
                            <div class="menu-item-name">${item.nombre}</div>
                            <div class="menu-item-desc">${item.descripcion || 'Sin descripci贸n'}</div>
                            <span class="badge ${disponible ? 'badge-success' : 'badge-danger'}">${disponible ? 'Disponible' : 'AGOTADO'}${disponible ? ` (${stockReal} unidades)` : ''}</span>
                        </div>
                        <div class="menu-item-price">Bs. ${precioBs}<br><small style="color: #666; font-size: 0.75rem;">$${(item.precio || 0).toFixed(2)}</small></div>
                    </div>
                `;
            }).join('');
        }

        function closeModal(modalId) { 
            document.getElementById(modalId).classList.remove('show'); 
        }
        
        function cerrarModal(modalId) { 
            document.getElementById(modalId).classList.remove('show'); 
        }
        
        function mostrarNotificacion(mensaje, tipo = 'success') {
            const notif = document.getElementById('notification');
            document.getElementById('notificationText').textContent = mensaje;
            notif.style.borderLeftColor = tipo === 'error' ? 'var(--danger)' : 'var(--success)';
            notif.classList.add('show');
            setTimeout(() => notif.classList.remove('show'), 3000);
        }
        
        function actualizarEstadoSync(estado) {
            const statusEl = document.getElementById('syncStatus');
            const iconEl = statusEl.querySelector('i');
            const textEl = statusEl.querySelector('span');
            statusEl.className = `sync-status ${estado}`;
            switch(estado) {
                case 'online': iconEl.className = 'fas fa-check-circle'; textEl.textContent = 'Sincronizado'; break;
                case 'syncing': iconEl.className = 'fas fa-sync-alt fa-spin'; textEl.textContent = 'Sincronizando...'; break;
                case 'offline': iconEl.className = 'fas fa-exclamation-triangle'; textEl.textContent = 'Sin conexi贸n'; break;
            }
        }
        
        async function guardarCambios() {
            try {
                const response = await fetch(`${JSONBIN_CONFIG.BASE_URL}/${JSONBIN_CONFIG.BIN_ID}`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'X-Master-Key': JSONBIN_CONFIG.API_KEY 
                    },
                    body: JSON.stringify(sistemaData)
                });
                
                if (!response.ok) throw new Error('Error al guardar');
                await new Promise(resolve => setTimeout(resolve, 100));
                
                lastSyncTime = Date.now();
                
            } catch (error) { 
                console.error('Error guardando:', error);
                throw error;
            }
        }
        
        window.addEventListener('beforeunload', () => { 
            if (syncIntervalId) clearInterval(syncIntervalId); 
            if (processingTimeout) clearTimeout(processingTimeout);
        });
    </script>
</body>
</html>
