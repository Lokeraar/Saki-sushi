<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üç£ Saki Sushi - Men√∫</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #D32F2F;
            --secondary: #212121;
            --accent: #FF9800;
            --light: #F5F5F5;
            --dark: #121212;
            --warm: #FFC107;
            --success: #388E3C;
            --info: #1976D2;
            --warning: #F57C00;
            --danger: #ef4444;
            --shadow: rgba(0, 0, 0, 0.15);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.8)), 
                        url('https://images.unsplash.com/photo-1565299624946-b28f40a0ca4b?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
            min-height: 100vh;
            color: var(--secondary);
        }

        /* Location Check Overlay */
        .location-check {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
        }

        .location-check.hidden {
            display: none;
        }

        .location-check h2 {
            color: white;
            font-size: 2rem;
            margin-bottom: 1rem;
            font-family: 'Montserrat', sans-serif;
        }

        .location-check p {
            color: #ccc;
            font-size: 1.2rem;
            max-width: 600px;
            margin-bottom: 2rem;
        }

        .location-error {
            background: var(--primary);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            max-width: 600px;
            display: none;
        }

        .location-error.show {
            display: block;
        }

        .btn-location {
            background: var(--accent);
            color: var(--secondary);
            border: none;
            padding: 1rem 2rem;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            font-family: 'Montserrat', sans-serif;
        }

        .btn-location:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(255, 152, 0, 0.4);
        }

        /* Header con men√∫ hamburguesa y notificaciones */
        .main-header {
            background: linear-gradient(135deg, var(--primary), #B71C1C);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        .menu-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            padding: 0.5rem;
            transition: var(--transition);
        }

        .menu-toggle:hover {
            transform: scale(1.1);
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-logo img {
            height: 50px;
            border-radius: 10px;
        }

        .header-title {
            color: white;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5rem;
            font-weight: 800;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .notification-badge {
            position: relative;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: var(--transition);
            color: white;
            font-size: 1.5rem;
        }

        .notification-badge:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }

        .notification-badge.has-unread {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .badge-count {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--accent);
            color: var(--secondary);
            font-size: 0.75rem;
            font-weight: 700;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .table-badge {
            background: var(--accent);
            color: var(--secondary);
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-weight: 700;
            font-family: 'Montserrat', sans-serif;
        }

        /* Sidebar Menu */
        .sidebar {
            position: fixed;
            top: 0;
            left: -350px;
            width: 350px;
            height: 100vh;
            background: var(--secondary);
            z-index: 2000;
            transition: left 0.3s ease;
            overflow-y: auto;
            box-shadow: 5px 0 30px rgba(0,0,0,0.5);
        }

        .sidebar.open {
            left: 0;
        }

        .sidebar-header {
            background: linear-gradient(135deg, var(--primary), #B71C1C);
            padding: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h2 {
            color: white;
            font-family: 'Montserrat', sans-serif;
        }

        .close-sidebar {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .sidebar-content {
            padding: 1rem;
        }

        .category-item {
            margin-bottom: 0.5rem;
        }

        .category-btn {
            width: 100%;
            padding: 1rem;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            text-align: left;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-btn:hover, .category-btn.active {
            background: var(--accent);
            color: var(--secondary);
        }

        .subcategory-list {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            padding-left: 1rem;
        }

        .subcategory-list.open {
            max-height: 500px;
        }

        .subcategory-btn {
            width: 100%;
            padding: 0.75rem;
            background: rgba(255,255,255,0.05);
            border: none;
            color: #ccc;
            text-align: left;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 0.5rem;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        .subcategory-btn:hover {
            background: rgba(255,255,255,0.15);
            color: white;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1500;
            display: none;
            backdrop-filter: blur(5px);
        }

        .overlay.show {
            display: block;
        }

        /* Notifications Panel */
        .notifications-panel {
            position: fixed;
            top: 70px;
            right: 20px;
            width: 350px;
            max-height: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 2500;
            display: none;
            overflow: hidden;
            border: 2px solid var(--primary);
        }

        .notifications-panel.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .notifications-header {
            background: linear-gradient(135deg, var(--primary), #B71C1C);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notifications-header h3 {
            font-family: 'Montserrat', sans-serif;
            margin: 0;
        }

        .notifications-list {
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem;
        }

        .notification-item {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: var(--transition);
        }

        .notification-item:hover {
            background: #f5f5f5;
        }

        .notification-item.approved {
            border-left: 4px solid var(--success);
            background: #E8F5E9;
        }

        .notification-item.rejected {
            border-left: 4px solid var(--danger);
            background: #FFEBEE;
        }

        .notification-item.pending {
            border-left: 4px solid var(--warning);
            background: #FFF8E1;
        }

        .notification-time {
            font-size: 0.75rem;
            color: #666;
            margin-top: 0.25rem;
        }

        .notification-status {
            font-weight: 700;
            font-size: 0.875rem;
        }

        .notification-status.approved { color: var(--success); }
        .notification-status.rejected { color: var(--danger); }
        .notification-status.pending { color: var(--warning); }

        .empty-notifications {
            text-align: center;
            padding: 2rem;
            color: #888;
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--light);
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
            overflow: hidden;
            margin-top: 2rem;
            margin-bottom: 2rem;
        }

        .header {
            background: linear-gradient(135deg, var(--primary), #B71C1C);
            color: white;
            padding: 25px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('https://images.unsplash.com/photo-1579584425555-c3ce17fd4351?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80');
            background-size: cover;
            opacity: 0.2;
        }

        .logo-container {
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .logo {
            max-width: 180px;
            height: auto;
            filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.4));
            border-radius: 10px;
        }

        h1 {
            font-size: 3.2em;
            margin-bottom: 5px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.4);
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            position: relative;
            z-index: 1;
            color: white;
            letter-spacing: 1px;
        }

        .subtitle {
            font-size: 1.4em;
            opacity: 0.95;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
            color: var(--warm);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-family: 'Montserrat', sans-serif;
        }

        .tagline {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            position: relative;
            z-index: 1;
            flex-wrap: wrap;
        }

        .tagline-item {
            background: rgba(255, 255, 255, 0.25);
            padding: 8px 15px;
            border-radius: 50px;
            font-size: 0.85em;
            backdrop-filter: blur(5px);
            font-family: 'Montserrat', sans-serif;
            font-weight: 500;
        }

        .sync-status {
            position: fixed;
            top: 80px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9em;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Montserrat', sans-serif;
        }

        .sync-status.online { border: 2px solid var(--success); }
        .sync-status.offline { border: 2px solid var(--primary); }
        .sync-status.syncing { border: 2px solid var(--accent); }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
            padding: 40px 30px;
        }

        @media (max-width: 992px) {
            .menu-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .menu-grid {
                grid-template-columns: 1fr;
            }
            .sidebar {
                width: 100%;
                left: -100%;
            }
            .notifications-panel {
                width: 90%;
                right: 5%;
            }
        }

        .menu-item {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 40px var(--shadow);
            transition: var(--transition);
            border: 2px solid transparent;
            position: relative;
        }

        .menu-item:hover {
            transform: translateY(-10px);
            border-color: var(--accent);
            box-shadow: 0 20px 50px rgba(255, 152, 0, 0.2);
        }

        /* ESTADO AGOTADO */
        .menu-item.agotado {
            opacity: 0.6;
            pointer-events: none;
        }

        .menu-item.agotado .item-image {
            filter: grayscale(100%) brightness(0.5);
        }

        .menu-item.agotado::after {
            content: 'AGOTADO';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--secondary);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-weight: bold;
            font-family: 'Montserrat', sans-serif;
            z-index: 10;
            font-size: 1.2rem;
            letter-spacing: 2px;
        }

        .menu-item.disabled {
            opacity: 0.6;
            pointer-events: none;
            filter: grayscale(0.8);
        }

        .menu-item.disabled::after {
            content: 'NO DISPONIBLE';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--primary);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-weight: bold;
            font-family: 'Montserrat', sans-serif;
            z-index: 10;
        }

        .item-image {
            height: 250px;
            width: 100%;
            background-size: cover;
            background-position: center;
            position: relative;
            transition: var(--transition);
        }

        .item-image::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(transparent, rgba(0,0,0,0.5));
        }

        .image-sashimi { background-image: url('https://images.unsplash.com/photo-1579584425555-c3ce17fd4351?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80'); }
        .image-coquitos { background-image: url('https://images.unsplash.com/photo-1553621042-f6e147245754?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80'); }
        .image-langostinos { background-image: url('https://images.unsplash.com/photo-1621996346565-e3dbc353d2af?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80'); }
        .image-sushi-pizza { background-image: url('https://images.unsplash.com/photo-1579584425555-c3ce17fd4351?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80'); }
        .image-ceviche { background-image: url('https://images.unsplash.com/photo-1551503759-5c9c09a53f8e?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80'); }
        .image-ceviche-mixto { background-image: url('https://images.unsplash.com/photo-1551503759-5c9c09a53f8e?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80'); }
        .image-tiradito { background-image: url('https://images.unsplash.com/photo-1579584425555-c3ce17fd4351?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80'); }
        .image-maguro { background-image: url('https://images.unsplash.com/photo-1611143669185-af224c5e3252?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80'); }
        .image-sushi-deluxe { background-image: url('https://images.unsplash.com/photo-1579584425555-c3ce17fd4351?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80'); }
        .image-margarita { background-image: url('https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80'); }

        .item-header {
            padding: 25px;
            background: linear-gradient(to right, var(--secondary), #424242);
            color: white;
        }

        .item-name {
            font-size: 1.8em;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Montserrat', sans-serif;
        }

        .item-price {
            font-size: 1.8em;
            color: var(--warm);
            font-weight: 700;
        }

        .item-description {
            color: #E0E0E0;
            font-size: 0.95em;
            line-height: 1.5;
            opacity: 0.9;
            font-family: 'Roboto', sans-serif;
        }

        .item-content {
            padding: 25px;
        }

        .quantity-section {
            background: #F8F8F8;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #E0E0E0;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
        }

        .qty-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, var(--primary), #B71C1C);
            color: white;
            font-size: 1.8em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            box-shadow: 0 5px 15px rgba(211, 47, 47, 0.3);
        }

        .qty-btn:hover:not(:disabled) {
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(211, 47, 47, 0.4);
        }

        .qty-btn:disabled {
            background: #BDBDBD;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .item-quantity {
            font-size: 2.5em;
            font-weight: 700;
            color: var(--secondary);
            min-width: 70px;
            text-align: center;
            font-family: 'Montserrat', sans-serif;
        }

        .item-stock {
            text-align: center;
            font-size: 0.95em;
            padding: 12px;
            border-radius: 10px;
            background: white;
            border: 2px solid;
            font-weight: 600;
            font-family: 'Roboto', sans-serif;
        }

        .available { border-color: var(--success); color: var(--success); }
        .low { border-color: var(--accent); color: var(--accent); }
        .sold-out { border-color: var(--primary); color: var(--primary); }

        .ingredients-section {
            background: #F8F8F8;
            border-radius: 12px;
            padding: 25px;
            margin-top: 15px;
            border: 2px solid #E0E0E0;
            max-height: 800px;
            overflow: hidden;
            transition: max-height 0.5s ease, opacity 0.3s ease, padding 0.3s ease, margin 0.3s ease;
        }

        .ingredients-section.hidden {
            max-height: 0;
            opacity: 0;
            padding: 0;
            margin-top: 0;
            border-width: 0;
        }

        .ingredients-title {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--accent);
        }

        .ingredients-title i {
            color: var(--primary);
            font-size: 1.5em;
        }

        .ingredients-title h3 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            color: var(--secondary);
        }

        .ingredient-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .ingredient-options::-webkit-scrollbar {
            width: 8px;
        }

        .ingredient-options::-webkit-scrollbar-track {
            background: #F0F0F0;
            border-radius: 4px;
        }

        .ingredient-options::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        .ingredient-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            background: white;
            border: 2px solid #E0E0E0;
        }

        .ingredient-option:hover {
            border-color: var(--primary);
            transform: translateX(5px);
        }

        .ingredient-option.complete-option {
            background: linear-gradient(135deg, #E8F5E9, #C8E6C9);
            border: 2px solid var(--success);
        }

        .ingredient-option.complete-option:hover {
            background: linear-gradient(135deg, #C8E6C9, #A5D6A7);
        }

        .ingredient-option.complete-option.selected {
            background: linear-gradient(135deg, var(--success), #2E7D32);
            color: white;
        }

        .ingredient-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid var(--primary);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: var(--transition);
            cursor: pointer;
            position: relative;
        }

        .ingredient-checkbox.checked {
            background: var(--primary);
            border-color: var(--primary);
        }

        .ingredient-checkbox.checked::after {
            content: '‚úì';
            color: white;
            font-size: 14px;
            font-weight: bold;
            position: absolute;
        }

        .ingredient-icon {
            font-size: 1.3em;
            width: 30px;
            text-align: center;
        }

        .ingredient-name {
            font-weight: 500;
            color: var(--secondary);
            font-family: 'Roboto', sans-serif;
        }

        .joke-notice {
            background: linear-gradient(135deg, #FFF3E0, #FFE0B2);
            border: 2px solid var(--warm);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            text-align: center;
            display: none;
            animation: fadeIn 0.5s ease;
            font-family: 'Roboto', sans-serif;
            font-size: 0.9rem;
            color: var(--secondary);
        }

        .joke-notice.show {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .ingredient-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid #E0E0E0;
        }

        .confirm-btn {
            flex: 1;
            padding: 18px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: var(--transition);
            background: linear-gradient(135deg, var(--primary), #B71C1C);
            color: white;
            box-shadow: 0 5px 15px rgba(211, 47, 47, 0.3);
            font-family: 'Montserrat', sans-serif;
        }

        .confirm-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(211, 47, 47, 0.4);
        }

        .confirm-btn:disabled {
            background: #BDBDBD;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .price-adjustment {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #FFF8E1, #FFECB3);
            border-radius: 10px;
            text-align: center;
            border: 2px solid var(--warm);
            display: none;
            animation: pulse 2s infinite;
            font-family: 'Roboto', sans-serif;
        }

        .price-adjustment.show {
            display: block;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.3); }
            50% { box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); }
        }

        .stock-warning {
            background: linear-gradient(135deg, #FFF3E0, #FFE0B2);
            border: 2px solid var(--warning);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            display: none;
            font-family: 'Roboto', sans-serif;
            font-size: 0.9rem;
        }

        .stock-warning.show {
            display: block;
        }

        /* Order Summary - Centered and half width on desktop */
        .order-summary-section {
            background: #F8F8F8;
            padding: 40px 30px;
            margin: 30px auto;
            border-radius: 15px;
            box-shadow: 0 10px 40px var(--shadow);
            border: 3px solid var(--primary);
            max-width: 700px;
            width: 90%;
        }

        .summary-title {
            font-size: 2em;
            color: var(--secondary);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            padding-bottom: 20px;
            border-bottom: 4px solid var(--accent);
            justify-content: center;
        }

        .order-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .order-item-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 5px solid var(--primary);
            transition: var(--transition);
        }

        .order-item-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .delete-item {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--primary);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .delete-item:hover {
            background: #B71C1C;
            transform: scale(1.1);
        }

        .instance-number {
            position: absolute;
            top: 10px;
            left: 10px;
            background: var(--accent);
            color: var(--secondary);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .item-instance {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px dashed #E0E0E0;
        }

        .item-instance:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .order-item-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding-left: 40px;
        }

        .order-item-name {
            font-size: 1.2em;
            color: var(--secondary);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Montserrat', sans-serif;
        }

        .order-item-modifiers {
            font-size: 0.85em;
            color: #616161;
            margin-top: 5px;
            padding: 8px;
            background: #F5F5F5;
            border-radius: 8px;
            border-left: 3px solid var(--accent);
            font-family: 'Roboto', sans-serif;
        }

        .order-item-price {
            font-size: 1.3em;
            font-weight: 700;
            color: var(--primary);
            min-width: 80px;
            text-align: right;
            font-family: 'Montserrat', sans-serif;
        }

        .summary-total-items {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            padding-top: 25px;
            border-top: 4px solid var(--accent);
            font-size: 1.1em;
            font-weight: 600;
            font-family: 'Montserrat', sans-serif;
        }

        .items-total {
            color: var(--primary);
            font-size: 1.5em;
            font-weight: 700;
        }

        /* Order Options for Online Orders */
        .order-options {
            display: none;
            gap: 20px;
            justify-content: center;
            margin: 30px;
            flex-wrap: wrap;
        }

        .order-options.show {
            display: flex;
        }

        .order-option-btn {
            padding: 20px 40px;
            border: none;
            border-radius: 15px;
            font-size: 1.2em;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 15px;
            font-family: 'Montserrat', sans-serif;
            min-width: 250px;
            justify-content: center;
        }

        .order-option-btn.delivery {
            background: linear-gradient(135deg, var(--info), #1565C0);
            color: white;
        }

        .order-option-btn.reserva {
            background: linear-gradient(135deg, var(--success), #2E7D32);
            color: white;
        }

        .order-option-btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        /* Standard Order Button */
        .order-section {
            padding: 40px;
            text-align: center;
            background: linear-gradient(135deg, var(--secondary), #424242);
            margin: 30px;
            border-radius: 15px;
            display: none;
        }

        .order-section.show {
            display: block;
        }

        .order-btn {
            background: linear-gradient(135deg, var(--primary), #B71C1C);
            color: white;
            border: none;
            padding: 25px 80px;
            font-size: 1.6em;
            font-weight: 700;
            border-radius: 50px;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 10px 30px rgba(211, 47, 47, 0.4);
            font-family: 'Montserrat', sans-serif;
        }

        .order-btn:hover:not(:disabled) {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 40px rgba(211, 47, 47, 0.5);
        }

        .order-btn:disabled {
            background: #BDBDBD;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Footer - 3 columns */
        .footer {
            background: var(--secondary);
            color: white;
            padding: 40px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .footer {
                grid-template-columns: 1fr;
            }
        }

        .footer-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .footer-logo {
            max-width: 120px;
            height: auto;
            margin-bottom: 10px;
            filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.4));
            border-radius: 10px;
        }

        .footer-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            color: var(--warm);
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .footer-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            font-size: 0.95em;
        }

        .footer-item strong {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            color: var(--accent);
        }

        .footer-item a {
            color: white;
            text-decoration: none;
            transition: var(--transition);
        }

        .footer-item a:hover {
            color: var(--accent);
            text-decoration: underline;
        }

        .social-media {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }

        .social-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: white;
            transition: var(--transition);
            text-decoration: none;
        }

        .social-icon:hover {
            background: var(--accent);
            transform: translateY(-5px) scale(1.1);
            color: var(--secondary);
        }

        .whatsapp-link {
            color: #25D366;
            font-weight: 600;
            font-size: 1.1em;
            font-family: 'Montserrat', sans-serif;
        }

        .whatsapp-link:hover {
            color: #1da851;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary), #B71C1C);
            color: white;
            padding: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--secondary);
            font-family: 'Montserrat', sans-serif;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #E0E0E0;
            border-radius: 10px;
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-group .error {
            color: var(--primary);
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
        }

        .form-group .error.show {
            display: block;
        }

        .payment-info {
            background: #F5F5F5;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid var(--accent);
        }

        .payment-info h3 {
            font-family: 'Montserrat', sans-serif;
            margin-bottom: 15px;
            color: var(--secondary);
        }

        .payment-detail {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #ccc;
        }

        .payment-detail:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--primary);
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: block;
            padding: 15px;
            background: #F5F5F5;
            border: 2px dashed var(--primary);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .file-input-label:hover {
            background: #FFEBEE;
        }

        .file-input-label.has-file {
            background: #E8F5E9;
            border-color: var(--success);
        }

        .modal-footer {
            padding: 25px;
            border-top: 2px solid #F0F0F0;
            display: flex;
            gap: 15px;
        }

        .btn-modal {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            font-family: 'Montserrat', sans-serif;
        }

        .btn-modal.secondary {
            background: #F5F5F5;
            color: var(--secondary);
        }

        .btn-modal.primary {
            background: linear-gradient(135deg, var(--primary), #B71C1C);
            color: white;
        }

        .btn-modal:disabled {
            background: #BDBDBD;
            cursor: not-allowed;
        }

        .btn-modal:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* Calendar Styles */
        .calendar-container {
            margin: 20px 0;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .calendar-header button {
            background: var(--primary);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .calendar-header h3 {
            font-family: 'Montserrat', sans-serif;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 700;
            color: var(--secondary);
            padding: 10px;
            font-size: 0.9rem;
            font-family: 'Montserrat', sans-serif;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            border: 2px solid transparent;
        }

        .calendar-day:hover:not(.disabled) {
            background: #F5F5F5;
            border-color: var(--primary);
        }

        .calendar-day.selected {
            background: var(--primary);
            color: white;
        }

        .calendar-day.disabled {
            color: #ccc;
            cursor: not-allowed;
            background: #F5F5F5;
        }

        .calendar-day.today {
            border-color: var(--accent);
        }

        /* Confirmation Modal */
        .confirmation-modal .order-review {
            background: #F8F8F8;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .review-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #E0E0E0;
        }

        .review-item:last-child {
            border-bottom: none;
        }

        .review-total {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            background: var(--secondary);
            color: white;
            border-radius: 10px;
            margin-top: 15px;
            font-weight: 700;
            font-size: 1.2rem;
        }

        /* Timer */
        .payment-timer {
            background: linear-gradient(135deg, var(--warning), #F57C00);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            font-family: 'Montserrat', sans-serif;
        }

        .timer-display {
            font-size: 2rem;
            font-weight: 700;
            margin-top: 10px;
        }

        /* Success Message */
        .thank-you {
            background: linear-gradient(135deg, var(--success), #2E7D32);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-top: 30px;
            text-align: center;
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .thank-you.show {
            display: block;
        }

        .thank-you h3 {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .thank-you p {
            font-size: 1.2rem;
            margin-bottom: 15px;
        }

        .thank-you .japanese {
            font-size: 1.5rem;
            color: var(--warm);
            font-weight: 700;
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 4000;
            color: white;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--secondary);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 5000;
            display: none;
            animation: slideUp 0.3s ease;
            font-family: 'Montserrat', sans-serif;
        }

        .toast.show {
            display: block;
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--primary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            h1 { font-size: 2rem; }
            .menu-grid { padding: 20px; grid-template-columns: 1fr; }
            .item-name { font-size: 1.3em; flex-direction: column; align-items: flex-start; }
            .order-summary-section { width: 95%; padding: 20px; }
            .order-option-btn { min-width: 100%; }
            .modal-content { margin: 10px; }
        }
    </style>
</head>
<body>
    <!-- Location Check -->
    <div class="location-check" id="locationCheck">
        <h2>Verificando ubicaci√≥n...</h2>
        <p>Por favor, permite el acceso a tu ubicaci√≥n para verificar si estamos en tu zona de cobertura.</p>
        <button class="btn-location" onclick="checkLocation()">Verificar Ubicaci√≥n</button>
        <div class="location-error" id="locationError">
            <h3>‚ö†Ô∏è Fuera de zona de cobertura</h3>
            <p>Lo sentimos, los pedidos solo est√°n disponibles en la Gran Caracas. Su solicitud no ser√° procesada.</p>
        </div>
    </div>

    <!-- Loading -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="spinner"></div>
        <h2>Procesando...</h2>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Sidebar Overlay -->
    <div class="overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <!-- Sidebar Menu -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>üç£ Categor√≠as</h2>
            <button class="close-sidebar" onclick="closeSidebar()"><i class="fas fa-times"></i></button>
        </div>
        <div class="sidebar-content" id="sidebarContent">
            <!-- Categories loaded dynamically -->
        </div>
    </div>

    <!-- Notifications Panel -->
    <div class="notifications-panel" id="notificationsPanel">
        <div class="notifications-header">
            <h3><i class="fas fa-bell"></i> Mis Pedidos</h3>
            <button class="close-sidebar" onclick="toggleNotifications()" style="background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="notifications-list" id="notificationsList">
            <div class="empty-notifications">
                <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                <p>No tienes pedidos pendientes</p>
            </div>
        </div>
    </div>

    <!-- Main Header -->
    <header class="main-header">
        <button class="menu-toggle" onclick="openSidebar()"><i class="fas fa-bars"></i></button>
        <div class="header-logo">
            <img src="https://lh3.googleusercontent.com/pw/AP1GczPrZAoWxmsOGRD9xl1hO5Q65JXuwUZzoR6gUk-cw5lVmarxQe_-lwqpA60tTKLlXfpvIjAJlKC6jFls-xETJOPkebLIIPhbGlUkknmhrRbdhMUll2UViGSUj3WmHKg2YEsZlAfxBPPTjIHhScjD0jfe=w1439-h1439-s-no-gm" alt="Saki Sushi">
            <span class="header-title">Saki Sushi</span>
        </div>
        <div class="header-actions">
            <div class="notification-badge" id="notificationBadge" onclick="toggleNotifications()">
                <i class="fas fa-bell"></i>
                <span class="badge-count" id="badgeCount" style="display: none;">0</span>
            </div>
            <div class="table-badge" id="tableBadge" style="display: none;">Mesa #<span id="tableNumber">--</span></div>
        </div>
    </header>

    <!-- Sync Status -->
    <div class="sync-status offline" id="syncStatus">
        <i class="fas fa-sync-alt"></i>
        <span>Sincronizando...</span>
    </div>

    <!-- Main Container -->
    <div class="container" id="mainContainer" style="display: none;">
        <div class="header">
            <div class="logo-container">
                <img src="https://lh3.googleusercontent.com/pw/AP1GczPrZAoWxmsOGRD9xl1hO5Q65JXuwUZzoR6gUk-cw5lVmarxQe_-lwqpA60tTKLlXfpvIjAJlKC6jFls-xETJOPkebLIIPhbGlUkknmhrRbdhMUll2UViGSUj3WmHKg2YEsZlAfxBPPTjIHhScjD0jfe=w1439-h1439-s-no-gm" alt="Saki Sushi Logo" class="logo">
            </div>
            <h1>Saki Sushi</h1>
            <p class="subtitle">Adictos al universo saki</p>
            <div class="tagline">
                <div class="tagline-item">üêü Fresco del d√≠a</div>
                <div class="tagline-item">üéå Tradicional</div>
                <div class="tagline-item">üë®‚Äçüç≥ Chef experto</div>
            </div>
        </div>

        <div class="menu-grid" id="menuGrid">
        </div>

        <div class="order-summary-section">
            <div class="summary-title">
                <i class="fas fa-shopping-cart"></i>
                Tu pedido
            </div>
            
            <div id="orderSummaryContent">
                <div class="empty-summary" style="text-align: center; padding: 40px; color: #888; font-style: italic;">
                    <i class="fas fa-utensils" style="font-size: 3em; margin-bottom: 20px; color: var(--primary);"></i>
                    <p style="font-size: 1.2em;">A√∫n no has seleccionado ning√∫n platillo</p>
                    <p style="margin-top: 10px;">Usa los botones + para comenzar tu pedido</p>
                </div>
            </div>
        </div>

        <!-- Online Order Options -->
        <div class="order-options" id="onlineOrderOptions">
            <button class="order-option-btn delivery" onclick="showDeliveryModal()">
                <i class="fas fa-motorcycle"></i>
                Pedir Delivery
            </button>
            <button class="order-option-btn reserva" onclick="showReservaModal()">
                <i class="fas fa-calendar-check"></i>
                Pedir Reserva
            </button>
        </div>

        <!-- In-Restaurant Order Button -->
        <div class="order-section" id="restaurantOrderSection">
            <button class="order-btn" id="orderBtn" onclick="showConfirmationModal()" disabled>
                <i class="fas fa-check-circle"></i>
                CONFIRMAR PEDIDO
            </button>
        </div>

        <div class="thank-you" id="thankYouMessage">
            <h3><i class="fas fa-check-circle"></i> ¬°Pedido Confirmado!</h3>
            <p>Tu pedido ha sido procesado, estar√° listo lo antes posible</p>
            <p class="japanese">Gok≈çny≈´ arigat≈ç gozaimasu</p>
            <p style="font-size: 1rem; margin-top: 10px;">Por favor, pasa a caja a realizar tu pago</p>
            <div class="payment-timer" style="margin-top: 20px;">
                <p>Tiempo restante para pagar:</p>
                <div class="timer-display" id="paymentTimer">20:00</div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <div class="footer-column">
                <h3 class="footer-title">Horario</h3>
                <div class="footer-item">
                    <i class="fas fa-clock" style="font-size: 1.5rem; color: var(--accent); margin-bottom: 10px;"></i>
                    <strong>Abierto:</strong>
                    <span>11:30am a 10:00pm</span>
                </div>
            </div>
            
            <div class="footer-column">
                <h3 class="footer-title">Av Universidad</h3>
                <div class="footer-item">
                    <i class="fas fa-map-marker-alt" style="font-size: 1.5rem; color: var(--accent); margin-bottom: 10px;"></i>
                    <strong>Caracas</strong>
                    <a href="https://wa.me/5804242884773" class="whatsapp-link" target="_blank">+58 0424-2884773</a>
                    <a href="https://wa.me/5804242884772" class="whatsapp-link" target="_blank">+58 0424-2884772</a>
                </div>
            </div>
            
            <div class="footer-column">
                <h3 class="footer-title">San Bernardino</h3>
                <div class="footer-item">
                    <i class="fas fa-map-marker-alt" style="font-size: 1.5rem; color: var(--accent); margin-bottom: 10px;"></i>
                    <strong>Caracas</strong>
                    <a href="https://wa.me/5804241722322" class="whatsapp-link" target="_blank">+58 0424-1722322</a>
                    <a href="https://wa.me/5804241722339" class="whatsapp-link" target="_blank">+58 0424-1722339</a>
                </div>
            </div>
        </div>

        <div class="footer" style="background: #1a1a1a; padding: 20px;">
            <div class="social-media" style="grid-column: 1 / -1; justify-content: center;">
                <a href="https://www.tiktok.com/@sakisushiccs" class="social-icon" target="_blank">
                    <i class="fab fa-tiktok"></i>
                </a>
                <a href="https://www.instagram.com/sakisushiccs" class="social-icon" target="_blank">
                    <i class="fab fa-instagram"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Delivery Modal -->
    <div class="modal-overlay" id="deliveryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-motorcycle"></i> Pedir Delivery</h2>
                <button class="modal-close" onclick="closeModal('deliveryModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="payment-info">
                    <h3>Datos de Pago - Pago M√≥vil</h3>
                    <div class="payment-detail"><span>Banco:</span> <strong>Banco de Venezuela</strong></div>
                    <div class="payment-detail"><span>Tel√©fono:</span> <strong>0424-1232703</strong></div>
                    <div class="payment-detail"><span>C√©dula:</span> <strong>V-24203422</strong></div>
                    <div class="payment-detail"><span>Monto:</span> <strong id="deliveryMonto">Bs. 0,00</strong></div>
                </div>
                
                <p style="color: var(--primary); font-weight: 600; margin-bottom: 20px; text-align: center;">
                    <i class="fas fa-exclamation-circle"></i> Solo se aceptan pagos por Pago M√≥vil
                </p>
                
                <p style="color: #666; font-size: 0.9rem; margin-bottom: 20px; font-style: italic;">
                    <i class="fas fa-info-circle"></i> Si introduce mal la direcci√≥n y/o el n√∫mero de contacto, la empresa no se hace responsable de que su pedido no llegue.
                </p>

                <div class="form-group">
                    <label>Direcci√≥n completa *</label>
                    <textarea id="deliveryDireccion" rows="3" placeholder="Introduce tu direcci√≥n completa (m√≠nimo 20 caracteres)" oninput="validateDeliveryForm()"></textarea>
                    <div class="error" id="direccionError">La direcci√≥n debe tener al menos 20 caracteres</div>
                </div>

                <div class="form-group">
                    <label>N√∫mero de contacto *</label>
                    <input type="tel" id="deliveryTelefono" placeholder="Ej: 0412-1234567" oninput="validateDeliveryForm()">
                    <div class="error" id="telefonoError">El n√∫mero debe tener entre 11 y 14 caracteres</div>
                </div>

                <div class="form-group">
                    <label>Referencia de pago *</label>
                    <input type="text" id="deliveryReferencia" placeholder="N√∫mero de referencia (4-12 caracteres)" minlength="4" maxlength="12" oninput="validateDeliveryForm()">
                    <div class="error" id="referenciaError">La referencia debe tener entre 4 y 12 caracteres</div>
                </div>

                <div class="form-group">
                    <label>Comprobante de pago *</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="deliveryComprobante" accept="image/*" onchange="handleFileSelect(this, 'deliveryFileLabel')">
                        <label for="deliveryComprobante" class="file-input-label" id="deliveryFileLabel">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: var(--primary); margin-bottom: 10px; display: block;"></i>
                            Haz clic para subir el comprobante de pago
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal secondary" onclick="closeModal('deliveryModal')">Cancelar</button>
                <button class="btn-modal primary" id="btnConfirmDelivery" onclick="confirmDelivery()" disabled>
                    Confirmar Pedido
                </button>
            </div>
        </div>
    </div>

    <!-- Reserva Modal -->
    <div class="modal-overlay" id="reservaModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-calendar-check"></i> Pedir Reserva</h2>
                <button class="modal-close" onclick="closeModal('reservaModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="payment-info">
                    <h3>Datos de Pago - Pago M√≥vil</h3>
                    <div class="payment-detail"><span>Banco:</span> <strong>Banco de Venezuela</strong></div>
                    <div class="payment-detail"><span>Tel√©fono:</span> <strong>0424-1232703</strong></div>
                    <div class="payment-detail"><span>C√©dula:</span> <strong>V-24203422</strong></div>
                    <div class="payment-detail"><span>Monto:</span> <strong id="reservaMonto">Bs. 0,00</strong></div>
                </div>
                
                <p style="color: var(--primary); font-weight: 600; margin-bottom: 20px; text-align: center;">
                    <i class="fas fa-exclamation-circle"></i> Solo se aceptan pagos por Pago M√≥vil
                </p>

                <div class="form-group">
                    <label>Selecciona la fecha de reserva *</label>
                    <div class="calendar-container" id="calendarContainer">
                        <!-- Calendar generated by JS -->
                    </div>
                </div>

                <div class="form-group">
                    <label>Nombre y apellido *</label>
                    <input type="text" id="reservaNombre" placeholder="Tu nombre completo" oninput="validateReservaForm()">
                </div>

                <div class="form-group">
                    <label>Referencia de pago *</label>
                    <input type="text" id="reservaReferencia" placeholder="N√∫mero de referencia (4-12 caracteres)" minlength="4" maxlength="12" oninput="validateReservaForm()">
                    <div class="error" id="referenciaReservaError">La referencia debe tener entre 4 y 12 caracteres</div>
                </div>

                <div class="form-group">
                    <label>Comprobante de pago *</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="reservaComprobante" accept="image/*" onchange="handleFileSelect(this, 'reservaFileLabel')">
                        <label for="reservaComprobante" class="file-input-label" id="reservaFileLabel">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: var(--primary); margin-bottom: 10px; display: block;"></i>
                            Haz clic para subir el comprobante de pago
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal secondary" onclick="closeModal('reservaModal')">Cancelar</button>
                <button class="btn-modal primary" id="btnConfirmReserva" onclick="confirmReserva()" disabled>
                    Confirmar Reserva
                </button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal-overlay confirmation-modal" id="confirmationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-clipboard-check"></i> Confirmar Pedido</h2>
                <button class="modal-close" onclick="closeModal('confirmationModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; color: #666;">Por favor, revisa tu pedido antes de confirmar:</p>
                
                <div class="order-review" id="orderReview">
                    <!-- Order items loaded dynamically -->
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <label>Tu nombre (opcional)</label>
                    <input type="text" id="customerName" placeholder="¬øC√≥mo te llamas?">
                </div>

                <p style="color: var(--primary); font-weight: 600; margin-top: 20px; text-align: center;">
                    <i class="fas fa-info-circle"></i> El pedido ser√° llevado a la <span id="confirmTableNumber">Mesa #--</span>
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn-modal secondary" onclick="closeModal('confirmationModal')">Volver</button>
                <button class="btn-modal primary" onclick="finalConfirmOrder()">
                    Confirmar Pedido
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURACI√ìN JSONBIN.IO
        // ==========================================
        const JSONBIN_CONFIG = {
            BIN_ID: '69879d6e43b1c97be96d2b13',
            API_KEY: '$2a$10$.klBAMlOBlE9CoVh5iUFf.x3LEYKWiP6hhvvPETK9e8pyIuNB2F4K',
            BASE_URL: 'https://api.jsonbin.io/v3/b'
        };

        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let sistemaData = null;
        let menuItems = [];
        let currentCategory = 'todos';
        let currentSubcategory = null;
        let pedidoActual = [];
        let syncInterval = null;
        let isInRestaurant = false;
        let tableNumber = null;
        let selectedDate = null;
        let paymentTimer = null;
        let sessionId = null;
        let pedidosCliente = [];
        let notificacionesInterval = null;

        // ==========================================
        // VERIFICACI√ìN DE UBICACI√ìN CON SESI√ìN
        // ==========================================
        function checkLocation() {
            // Verificar si hay sesi√≥n activa v√°lida (30 minutos)
            const sessionData = localStorage.getItem('sakiSession');
            if (sessionData) {
                const session = JSON.parse(sessionData);
                const ahora = new Date().getTime();
                const tiempoTranscurrido = ahora - session.timestamp;
                
                // Si han pasado menos de 30 minutos (1800000 ms)
                if (tiempoTranscurrido < 1800000) {
                    // Restaurar sesi√≥n
                    sessionId = session.id;
                    isInRestaurant = session.isInRestaurant;
                    tableNumber = session.tableNumber;
                    
                    if (isInRestaurant && tableNumber) {
                        document.getElementById('tableNumber').textContent = tableNumber;
                        document.getElementById('tableBadge').style.display = 'block';
                        document.getElementById('confirmTableNumber').textContent = `Mesa #${tableNumber}`;
                    }
                    
                    document.getElementById('locationCheck').classList.add('hidden');
                    document.getElementById('mainContainer').style.display = 'block';
                    initApp();
                    return;
                }
            }
            
            // Si no hay sesi√≥n o expir√≥, proceder con verificaci√≥n normal
            verifyLocation();
        }

        async function verifyLocation() {
            const btn = document.querySelector('.btn-location');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando...';
            btn.disabled = true;

            try {
                // Primero verificar si hay par√°metro de mesa en URL (QR escaneado)
                const urlParams = new URLSearchParams(window.location.search);
                const mesa = urlParams.get('mesa');
                
                if (mesa) {
                    isInRestaurant = true;
                    tableNumber = mesa;
                    
                    // Crear sesi√≥n
                    crearSesion();
                    
                    document.getElementById('tableNumber').textContent = mesa;
                    document.getElementById('tableBadge').style.display = 'block';
                    document.getElementById('confirmTableNumber').textContent = `Mesa #${mesa}`;
                    document.getElementById('locationCheck').classList.add('hidden');
                    document.getElementById('mainContainer').style.display = 'block';
                    initApp();
                    return;
                }

                // Si no hay mesa, verificar ubicaci√≥n para online
                if (!navigator.geolocation) {
                    showLocationError();
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        // Gran Caracas aproximadamente: 10.4¬∞N a 10.6¬∞N, -66.8¬∞W a -67.0¬∞W
                        const inCaracas = (
                            latitude >= 10.4 && latitude <= 10.6 &&
                            longitude >= -67.0 && longitude <= -66.8
                        );
                        
                        if (inCaracas) {
                            // Crear sesi√≥n
                            crearSesion();
                            
                            document.getElementById('locationCheck').classList.add('hidden');
                            document.getElementById('mainContainer').style.display = 'block';
                            document.getElementById('onlineOrderOptions').classList.add('show');
                            initApp();
                        } else {
                            showLocationError();
                        }
                    },
                    () => {
                        showLocationError();
                    }
                );
            } catch (error) {
                showLocationError();
            }
        }

        function crearSesion() {
            sessionId = 'SES-' + Date.now();
            const sessionData = {
                id: sessionId,
                timestamp: new Date().getTime(),
                isInRestaurant: isInRestaurant,
                tableNumber: tableNumber
            };
            localStorage.setItem('sakiSession', JSON.stringify(sessionData));
        }

        function showLocationError() {
            document.getElementById('locationError').classList.add('show');
            document.querySelector('.btn-location').style.display = 'none';
        }

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        async function initApp() {
            showLoading();
            await cargarDatos();
            renderSidebar();
            renderMenu();
            initCalendar();
            
            // Iniciar polling de notificaciones
            iniciarPollingNotificaciones();
            
            hideLoading();
            
            // Auto-refresh cada 30 segundos - NO borra el pedido actual
            syncInterval = setInterval(async () => {
                await cargarDatos();
                // Solo renderizar el men√∫, no tocar el pedido actual
                renderMenu();
                // Actualizar el resumen del pedido para reflejar cambios de stock si es necesario
                updateOrderSummary();
            }, 30000);
        }

        async function cargarDatos() {
            actualizarEstadoSync('syncing');
            
            try {
                const response = await fetch(`${JSONBIN_CONFIG.BASE_URL}/${JSONBIN_CONFIG.BIN_ID}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': JSONBIN_CONFIG.API_KEY,
                        'X-Bin-Meta': 'false'
                    }
                });
                
                if (!response.ok) throw new Error('Error al cargar datos');
                
                const data = await response.json();
                sistemaData = data.record || data;
                
                sincronizarMenuLocal();
                actualizarEstadoSync('online');
                
            } catch (error) {
                console.error('Error cargando datos:', error);
                actualizarEstadoSync('offline');
            }
        }

        function sincronizarMenuLocal() {
            if (!sistemaData.menu) return;
            
            // Guardar el estado actual del pedido antes de sincronizar
            const pedidoGuardado = JSON.parse(JSON.stringify(menuItems.filter(item => item.instances && item.instances.length > 0)));
            
            menuItems = sistemaData.menu.map(item => {
                // Buscar si este item ya estaba en el pedido
                const itemEnPedido = pedidoGuardado.find(p => p.id === item.id);
                
                return {
                    id: item.id,
                    name: item.nombre,
                    category: item.categoria,
                    subcategory: item.subcategoria,
                    basePrice: item.precio,
                    description: item.descripcion,
                    ingredients: item.ingredientes || {},
                    stock: item.stockMaximo || item.stock || 0,
                    stockMaximo: item.stockMaximo || item.stock || 0,
                    disponible: item.disponible,
                    imageClass: item.imagen,
                    // Restaurar cantidad e instancias si exist√≠an en el pedido
                    quantity: itemEnPedido ? itemEnPedido.quantity : 0,
                    instances: itemEnPedido ? itemEnPedido.instances : [],
                    totalOrdered: itemEnPedido ? itemEnPedido.totalOrdered : 0,
                    currentSelections: itemEnPedido ? new Set(itemEnPedido.currentSelections) : new Set(),
                    order: menuItems.length + 1,
                    selectionType: itemEnPedido ? itemEnPedido.selectionType : "completo"
                };
            });
        }

        // ==========================================
        // SISTEMA DE NOTIFICACIONES
        // ==========================================
        function iniciarPollingNotificaciones() {
            // Verificar inmediatamente
            verificarNotificaciones();
            
            // Y cada 10 segundos
            notificacionesInterval = setInterval(verificarNotificaciones, 10000);
        }

        async function verificarNotificaciones() {
            if (!sessionId || pedidosCliente.length === 0) return;
            
            try {
                await cargarDatos();
                
                let hayCambios = false;
                
                pedidosCliente.forEach(pedidoCliente => {
                    const pedidoActualizado = sistemaData.pedidos.find(p => p.id === pedidoCliente.id);
                    
                    if (pedidoActualizado && pedidoActualizado.estado !== pedidoCliente.estado) {
                        // Actualizar estado local
                        pedidoCliente.estado = pedidoActualizado.estado;
                        pedidoCliente.razonRechazo = pedidoActualizado.razonRechazo;
                        pedidoCliente.metodoPago = pedidoActualizado.metodoPago;
                        
                        // Mostrar notificaci√≥n
                        if (pedidoActualizado.estado === 'cobrado') {
                            agregarNotificacion(pedidoCliente.id, 'approved', '¬°Pedido aprobado!', 'Tu pedido ha sido cobrado y est√° en preparaci√≥n.');
                        } else if (pedidoActualizado.estado === 'rechazado') {
                            const razon = pedidoActualizado.razonRechazo || 'Sin especificar';
                            agregarNotificacion(pedidoCliente.id, 'rejected', 'Pedido rechazado', `Motivo: ${traducirRazon(razon)}`);
                        }
                        
                        hayCambios = true;
                    }
                });
                
                if (hayCambios) {
                    actualizarBadgeNotificaciones();
                    renderizarNotificaciones();
                }
                
            } catch (error) {
                console.error('Error verificando notificaciones:', error);
            }
        }

        function traducirRazon(razon) {
            const razones = {
                'referencia_invalida': 'Referencia de pago inv√°lida',
                'monto_insuficiente': 'Monto insuficiente',
                'datos_incorrectos': 'Datos de contacto/direcci√≥n incorrectos',
                'no_disponible': 'Producto no disponible',
                'fuera_horario': 'Fuera de horario de delivery'
            };
            return razones[razon] || razon;
        }

        function agregarNotificacion(pedidoId, tipo, titulo, mensaje) {
            const notificacion = {
                id: Date.now(),
                pedidoId: pedidoId,
                tipo: tipo,
                titulo: titulo,
                mensaje: mensaje,
                timestamp: new Date().toISOString(),
                leida: false
            };
            
            // Guardar en localStorage
            let notificaciones = JSON.parse(localStorage.getItem('sakiNotificaciones') || '[]');
            notificaciones.unshift(notificacion);
            localStorage.setItem('sakiNotificaciones', JSON.stringify(notificaciones));
            
            // Actualizar UI
            actualizarBadgeNotificaciones();
            renderizarNotificaciones();
            
            // Mostrar toast
            showToast(`${titulo}: ${mensaje}`, tipo === 'approved' ? 'success' : 'error');
        }

        function actualizarBadgeNotificaciones() {
            const notificaciones = JSON.parse(localStorage.getItem('sakiNotificaciones') || '[]');
            const noLeidas = notificaciones.filter(n => !n.leida).length;
            
            const badge = document.getElementById('badgeCount');
            const badgeElement = document.getElementById('notificationBadge');
            
            if (noLeidas > 0) {
                badge.textContent = noLeidas;
                badge.style.display = 'flex';
                badgeElement.classList.add('has-unread');
            } else {
                badge.style.display = 'none';
                badgeElement.classList.remove('has-unread');
            }
        }

        function renderizarNotificaciones() {
            const container = document.getElementById('notificationsList');
            const notificaciones = JSON.parse(localStorage.getItem('sakiNotificaciones') || '[]');
            
            if (notificaciones.length === 0) {
                container.innerHTML = `
                    <div class="empty-notifications">
                        <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                        <p>No tienes notificaciones</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = notificaciones.map(notif => `
                <div class="notification-item ${notif.tipo} ${notif.leida ? '' : 'unread'}" 
                     style="${notif.leida ? 'opacity: 0.7;' : 'font-weight: 600;'}"
                     onclick="marcarNotificacionLeida(${notif.id})">
                    <div>
                        <div class="notification-status ${notif.tipo}">
                            <i class="fas fa-${notif.tipo === 'approved' ? 'check-circle' : notif.tipo === 'rejected' ? 'times-circle' : 'clock'}"></i>
                            ${notif.titulo}
                        </div>
                        <div style="font-size: 0.875rem; margin-top: 4px;">${notif.mensaje}</div>
                        <div class="notification-time">
                            ${new Date(notif.timestamp).toLocaleString()}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function marcarNotificacionLeida(id) {
            let notificaciones = JSON.parse(localStorage.getItem('sakiNotificaciones') || '[]');
            notificaciones = notificaciones.map(n => {
                if (n.id === id) n.leida = true;
                return n;
            });
            localStorage.setItem('sakiNotificaciones', JSON.stringify(notificaciones));
            actualizarBadgeNotificaciones();
            renderizarNotificaciones();
        }

        function toggleNotifications() {
            const panel = document.getElementById('notificationsPanel');
            panel.classList.toggle('show');
            
            if (panel.classList.contains('show')) {
                renderizarNotificaciones();
            }
        }

        // ==========================================
        // SIDEBAR
        // ==========================================
        function openSidebar() {
            document.getElementById('sidebar').classList.add('open');
            document.getElementById('sidebarOverlay').classList.add('show');
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.remove('show');
        }

        function renderSidebar() {
            const categories = [
                { id: 'todos', name: 'üçΩÔ∏è Todos', subcategories: [] },
                { id: 'entradas', name: 'ü•¢ Entradas', subcategories: [] },
                { id: 'sushi', name: 'üç£ Sushi', subcategories: [] },
                { id: 'rolls', name: 'üç± Rolls', subcategories: [
                    { id: 'rolls-frios', name: 'Rolls Fr√≠os (10 pzas)' },
                    { id: 'rolls-tempura', name: 'Rolls Tempura (12 pzas)' }
                ]},
                { id: 'tragos', name: 'üçπ Tragos', subcategories: [] },
                { id: 'pokes', name: 'ü•ó Pokes', subcategories: [] },
                { id: 'ensaladas', name: 'ü•¨ Ensaladas', subcategories: [] },
                { id: 'china', name: 'ü•° Comida China', subcategories: [
                    { id: 'arroz-chino', name: 'Arroz Chino' },
                    { id: 'arroz-cantones', name: 'Arroz Cantones' },
                    { id: 'chopsuey', name: 'Chopsuey' },
                    { id: 'lomey', name: 'Lomey' },
                    { id: 'chow-mein', name: 'Chow Mein' },
                    { id: 'fideos-arroz', name: 'Fideos de Arroz' },
                    { id: 'tallarines-cantones', name: 'Tallarines Cantones' },
                    { id: 'mariscos', name: 'Mariscos' },
                    { id: 'foo-yung', name: 'Foo Yong' },
                    { id: 'sopas', name: 'Sopas' },
                    { id: 'entremeses', name: 'Entremeses' }
                ]},
                { id: 'japonesa', name: 'üéå Comida Japonesa', subcategories: [
                    { id: 'yakimeshi', name: 'Yakimeshi' },
                    { id: 'yakisoba', name: 'Yakisoba' },
                    { id: 'pasta-udon', name: 'Pasta Udon' },
                    { id: 'churrasco', name: 'Churrasco' }
                ]},
                { id: 'ninos', name: 'üë∂ Para Ni√±os', subcategories: [] },
                { id: 'ejecutivo', name: 'üíº Combo Ejecutivo', subcategories: [] }
            ];

            const container = document.getElementById('sidebarContent');
            container.innerHTML = categories.map(cat => `
                <div class="category-item">
                    <button class="category-btn ${cat.subcategories.length > 0 ? 'has-sub' : ''}" 
                            onclick="${cat.subcategories.length > 0 ? `toggleSubcategories('${cat.id}')` : `selectCategory('${cat.id}')`}">
                        ${cat.name}
                        ${cat.subcategories.length > 0 ? '<i class="fas fa-chevron-down"></i>' : ''}
                    </button>
                    ${cat.subcategories.length > 0 ? `
                        <div class="subcategory-list" id="subcat-${cat.id}">
                            ${cat.subcategories.map(sub => `
                                <button class="subcategory-btn" onclick="selectSubcategory('${cat.id}', '${sub.id}')">
                                    ${sub.name}
                                </button>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function toggleSubcategories(catId) {
            const subcat = document.getElementById(`subcat-${catId}`);
            subcat.classList.toggle('open');
        }

        function selectCategory(catId) {
            currentCategory = catId;
            currentSubcategory = null;
            closeSidebar();
            renderMenu();
            updateActiveCategory();
        }

        function selectSubcategory(catId, subId) {
            currentCategory = catId;
            currentSubcategory = subId;
            closeSidebar();
            renderMenu();
        }

        function updateActiveCategory() {
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
        }

        // ==========================================
        // RENDERIZADO DEL MEN√ö
        // ==========================================
        function renderMenu() {
            const menuGrid = document.getElementById('menuGrid');
            
            let filteredItems = [...menuItems];
            
            if (currentCategory !== 'todos') {
                if (currentSubcategory) {
                    filteredItems = menuItems.filter(item => item.subcategory === currentSubcategory);
                } else {
                    filteredItems = menuItems.filter(item => {
                        if (currentCategory === 'sushi') {
                            return item.category === 'sushi' || item.subcategory?.includes('roll');
                        }
                        return item.category === currentCategory;
                    });
                }
            }
            
            if (filteredItems.length === 0) {
                menuGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 60px; color: #888;">
                        <i class="fas fa-utensils" style="font-size: 4em; margin-bottom: 20px; color: var(--primary);"></i>
                        <p style="font-size: 1.4em;">No hay platillos disponibles</p>
                    </div>
                `;
                return;
            }
            
            menuGrid.innerHTML = filteredItems.map(item => {
                const precioBs = formatearPrecioBs(item.basePrice);
                
                // Verificar si hay ingredientes principales disponibles
                const ingredientesPrincipales = verificarIngredientesPrincipales(item);
                const hayIngredientes = ingredientesPrincipales.disponible;
                const esAgotado = !hayIngredientes && item.instances.length === 0;
                
                // Si est√° agotado por falta de ingredientes principales
                const claseAgotado = esAgotado ? 'agotado' : '';
                const estaEnPedido = item.instances.length > 0;
                
                // Calcular stock disponible real (restando lo ya pedido)
                const stockReal = Math.max(0, item.stock - item.totalOrdered);
                const disponible = item.disponible && stockReal > 0 && hayIngredientes;
                
                return `
                    <div class="menu-item ${claseAgotado} ${!disponible && !estaEnPedido ? 'disabled' : ''}" data-id="${item.id}">
                        <div class="item-image ${item.imageClass}"></div>
                        <div class="item-header">
                            <div class="item-name">
                                <span>${item.name}</span>
                                <span class="item-price">${precioBs}</span>
                            </div>
                            <div class="item-description">${item.description}</div>
                            ${!hayIngredientes ? '<div style="color: #ff6b6b; font-size: 0.9em; margin-top: 5px;"><i class="fas fa-exclamation-circle"></i> Sin ingredientes principales</div>' : ''}
                        </div>
                        <div class="item-content">
                            ${!hayIngredientes ? `
                                <div class="stock-warning show">
                                    <i class="fas fa-exclamation-triangle"></i> 
                                    Ingredientes principales agotados: ${ingredientesPrincipales.faltantes.join(', ')}
                                </div>
                            ` : ''}
                            
                            <div class="quantity-section">
                                <div class="quantity-controls">
                                    <button class="qty-btn" onclick="changeQuantity('${item.id}', -1)" ${item.quantity === 0 ? 'disabled' : ''}>
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <div class="item-quantity" id="qty-${item.id}">${item.quantity}</div>
                                    <button class="qty-btn" onclick="changeQuantity('${item.id}', 1)" 
                                            ${!disponible ? 'disabled' : ''}>
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <div class="item-stock ${getStockClass(stockReal, hayIngredientes)}">
                                    <i class="fas fa-box"></i> 
                                    ${!hayIngredientes ? 'Agotado' : `Disponibles: ${stockReal} de ${item.stockMaximo}`}
                                </div>
                            </div>
                            
                            ${Object.keys(item.ingredients).length > 0 && hayIngredientes && (disponible || estaEnPedido) ? `
                            <div class="ingredients-section ${item.quantity === 0 ? 'hidden' : ''}" id="ingredients-${item.id}">
                                <div class="ingredients-title">
                                    <i class="fas fa-utensils"></i>
                                    <h3>Personaliza tu pedido</h3>
                                </div>
                                <div class="ingredient-options" id="options-${item.id}"></div>
                                <div class="joke-notice" id="joke-${item.id}">
                                    <i class="fas fa-laugh-beam"></i> 
                                    ¬°Quieres un platillo sin nada! ¬øPrefieres el plato vac√≠o con aire condimentado? üòÑ
                                </div>
                                <div class="ingredient-actions">
                                    <button class="confirm-btn" onclick="confirmCustomization('${item.id}')" id="confirm-${item.id}">
                                        <i class="fas fa-check"></i> Confirmar Selecci√≥n
                                    </button>
                                </div>
                                <div class="price-adjustment" id="price-adj-${item.id}"></div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Inicializar opciones de ingredientes
            filteredItems.forEach(item => {
                if (Object.keys(item.ingredients).length > 0 && 
                    verificarIngredientesPrincipales(item).disponible && 
                    (item.disponible || item.instances.length > 0)) {
                    generateIngredientOptions(item.id);
                }
            });
        }

        // Verificar si hay ingredientes principales disponibles
        function verificarIngredientesPrincipales(item) {
            if (!item.ingredients || Object.keys(item.ingredients).length === 0) {
                return { disponible: true, faltantes: [] };
            }
            
            const faltantes = [];
            let disponible = true;
            
            Object.entries(item.ingredients).forEach(([key, ingData]) => {
                // Solo verificar ingredientes no obligatorios (los principales son removibles)
                if (!ingData.obligatorio) {
                    const stockIng = sistemaData.inventario[key]?.stock || 0;
                    // Considerar tambi√©n lo ya reservado en el pedido actual
                    const reservado = calcularReservado(key);
                    const stockReal = stockIng - reservado;
                    
                    if (stockReal <= 0) {
                        faltantes.push(sistemaData.inventario[key]?.nombre || key);
                        disponible = false;
                    }
                }
            });
            
            return { disponible, faltantes };
        }

        // Calcular cu√°nto de un ingrediente est√° reservado en el pedido actual
        function calcularReservado(ingredienteId) {
            let total = 0;
            menuItems.forEach(item => {
                if (item.instances && item.ingredients && item.ingredients[ingredienteId]) {
                    item.instances.forEach(inst => {
                        // Solo contar si el ingrediente NO fue removido
                        if (!inst.removedIngredients.includes(ingredienteId)) {
                            total += item.ingredients[ingredienteId].cantidad;
                        }
                    });
                }
            });
            return total;
        }

        function generateIngredientOptions(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            const optionsDiv = document.getElementById(`options-${itemId}`);
            if (!optionsDiv) return;
            
            const restricciones = checkIngredientRestrictions(item);
            
            optionsDiv.innerHTML = '';
            
            // Opci√≥n "Completo" - seleccionada por defecto
            const completeOption = document.createElement('div');
            completeOption.className = `ingredient-option complete-option ${item.currentSelections.size === 0 ? 'selected' : ''}`;
            completeOption.onclick = () => selectComplete(itemId);
            
            completeOption.innerHTML = `
                <div class="ingredient-checkbox ${item.currentSelections.size === 0 ? 'checked' : ''}"></div>
                <div class="ingredient-icon">‚úÖ</div>
                <div class="ingredient-name">Platillo completo (con todos los ingredientes)</div>
            `;
            optionsDiv.appendChild(completeOption);
            
            // Opciones de ingredientes individuales
            Object.keys(item.ingredients).forEach(ingKey => {
                const ingrediente = item.ingredients[ingKey];
                if (!ingrediente.obligatorio) {
                    const stockIng = sistemaData.inventario[ingKey]?.stock || 0;
                    const reservado = calcularReservado(ingKey);
                    const stockReal = stockIng - reservado;
                    const disabled = stockReal <= 0;
                    
                    const ingOption = document.createElement('div');
                    ingOption.className = `ingredient-option ${disabled ? 'disabled' : ''}`;
                    if (!disabled) {
                        ingOption.onclick = () => toggleIngredient(itemId, ingKey);
                    }
                    
                    const isSelected = item.currentSelections.has(ingKey);
                    
                    ingOption.innerHTML = `
                        <div class="ingredient-checkbox ${isSelected ? 'checked' : ''} ${disabled ? 'disabled' : ''}"></div>
                        <div class="ingredient-icon">ü•ó</div>
                        <div class="ingredient-name">
                            Sin ${ingKey.replace(/_/g, ' ')}
                            ${disabled ? ' (No disponible)' : ''}
                        </div>
                    `;
                    optionsDiv.appendChild(ingOption);
                }
            });
            
            updateConfirmButton(itemId);
        }

        // ==========================================
        // INTERACCI√ìN
        // ==========================================
        function selectComplete(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            item.selectionType = "completo";
            item.currentSelections.clear();
            
            generateIngredientOptions(itemId);
        }

        function toggleIngredient(itemId, ingredientKey) {
            const item = menuItems.find(i => i.id === itemId);
            item.selectionType = "personalizado";
            
            if (item.currentSelections.has(ingredientKey)) {
                item.currentSelections.delete(ingredientKey);
            } else {
                item.currentSelections.add(ingredientKey);
            }
            
            generateIngredientOptions(itemId);
        }

        function changeQuantity(itemId, change) {
            const item = menuItems.find(i => i.id === itemId);
            const newQty = item.quantity + change;
            
            if (newQty < 0) return;
            
            // Calcular stock real disponible
            const stockReal = item.stock - item.totalOrdered;
            
            if (change > 0) {
                // Verificar ingredientes principales
                const ingCheck = verificarIngredientesPrincipales(item);
                if (!ingCheck.disponible) {
                    showToast('No hay ingredientes principales disponibles', 'error');
                    return;
                }
                
                if (stockReal <= 0) {
                    showToast('No hay stock disponible', 'error');
                    return;
                }
                
                if (newQty > stockReal) {
                    item.quantity = stockReal;
                    showToast(`Solo quedan ${stockReal} unidades disponibles`, 'error');
                } else {
                    item.quantity = newQty;
                }
            } else {
                item.quantity = newQty;
            }
            
            const qtyEl = document.getElementById(`qty-${itemId}`);
            if (qtyEl) qtyEl.textContent = item.quantity;
            
            const ingredientsSection = document.getElementById(`ingredients-${itemId}`);
            if (ingredientsSection) {
                if (item.quantity > 0) {
                    setTimeout(() => ingredientsSection.classList.remove('hidden'), 10);
                    
                    if (change > 0) {
                        // Pre-seleccionar "Completo" por defecto
                        item.selectionType = "completo";
                        item.currentSelections.clear();
                        generateIngredientOptions(itemId);
                        
                        // No agregamos a instancias todav√≠a, esperamos confirmaci√≥n
                    } else if (change < 0 && item.instances.length > 0) {
                        // Si reduce cantidad, remover la √∫ltima instancia no confirmada
                        // o la √∫ltima instancia si no hay pendientes
                        const instanciaPendiente = item.instances.findIndex(inst => !inst.confirmada);
                        if (instanciaPendiente >= 0) {
                            // Restaurar stock de ingredientes
                            restaurarStockIngredientes(item, item.instances[instanciaPendiente].removedIngredients);
                            item.instances.splice(instanciaPendiente, 1);
                            item.totalOrdered--;
                        } else if (item.instances.length > 0) {
                            // Remover la √∫ltima
                            const lastInst = item.instances[item.instances.length - 1];
                            restaurarStockIngredientes(item, lastInst.removedIngredients);
                            item.instances.pop();
                            item.totalOrdered--;
                        }
                    }
                } else {
                    ingredientsSection.classList.add('hidden');
                    // No limpiamos instancias aqu√≠, solo si se elimina manualmente del pedido
                }
            }
            
            updateOrderSummary();
        }

        function updateConfirmButton(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            const confirmBtn = document.getElementById(`confirm-${itemId}`);
            const priceAdjDiv = document.getElementById(`price-adj-${itemId}`);
            const jokeDiv = document.getElementById(`joke-${itemId}`);
            
            if (!confirmBtn) return;
            
            const allNonRequired = Object.keys(item.ingredients).filter(key => !item.ingredients[key]?.obligatorio);
            const availableNonRequired = allNonRequired.filter(key => {
                const stock = sistemaData.inventario[key]?.stock || 0;
                const reservado = calcularReservado(key);
                return (stock - reservado) > 0;
            });
            
            // Verificar si seleccion√≥ todos los ingredientes disponibles
            const selectedAllAvailable = availableNonRequired.length > 0 && 
                availableNonRequired.every(key => item.currentSelections.has(key));
            
            if (selectedAllAvailable) {
                confirmBtn.disabled = true;
                if (priceAdjDiv) priceAdjDiv.classList.remove('show');
                if (jokeDiv) jokeDiv.classList.add('show');
            } else {
                confirmBtn.disabled = false;
                if (jokeDiv) jokeDiv.classList.remove('show');
                
                if (item.currentSelections.size > 0) {
                    const newPrice = convertirABs(item.basePrice) * 0.9;
                    if (priceAdjDiv) {
                        priceAdjDiv.innerHTML = `<i class="fas fa-tag"></i> Precio ajustado: <strong>Bs. ${newPrice.toFixed(2).replace('.', ',')}</strong>`;
                        priceAdjDiv.classList.add('show');
                    }
                } else {
                    if (priceAdjDiv) {
                        priceAdjDiv.innerHTML = `<i class="fas fa-tag"></i> Precio completo: <strong>${formatearPrecioBs(item.basePrice)}</strong>`;
                        priceAdjDiv.classList.add('show');
                    }
                }
            }
        }

        function confirmCustomization(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            
            if (item.quantity === 0) return;
            
            const allNonRequired = Object.keys(item.ingredients).filter(key => !item.ingredients[key]?.obligatorio);
            const availableNonRequired = allNonRequired.filter(key => {
                const stock = sistemaData.inventario[key]?.stock || 0;
                const reservado = calcularReservado(key);
                return (stock - reservado) > 0;
            });
            
            // Verificar si quiere quitar todos los ingredientes disponibles
            if (item.currentSelections.size === availableNonRequired.length && availableNonRequired.length > 0) {
                showToast('¬°No puedes quitar todos los ingredientes disponibles!', 'error');
                return;
            }
            
            // Crear nueva instancia confirmada
            const nuevaInstancia = {
                id: item.instances.length + 1,
                removedIngredients: Array.from(item.currentSelections),
                isComplete: item.currentSelections.size === 0,
                selectionType: item.selectionType,
                price: item.currentSelections.size > 0 ? convertirABs(item.basePrice) * 0.9 : convertirABs(item.basePrice),
                confirmada: true
            };
            
            // Reducir stock de ingredientes
            reducirStockIngredientes(item, nuevaInstancia.removedIngredients);
            
            item.instances.push(nuevaInstancia);
            item.totalOrdered += item.quantity;
            item.quantity = 0;
            item.currentSelections.clear();
            item.selectionType = "completo";
            
            const ingredientsSection = document.getElementById(`ingredients-${itemId}`);
            if (ingredientsSection) ingredientsSection.classList.add('hidden');
            
            const qtyEl = document.getElementById(`qty-${itemId}`);
            if (qtyEl) qtyEl.textContent = '0';
            
            updateOrderSummary();
            renderMenu(); // Re-renderizar para actualizar stock mostrado
            showToast('Platillo a√±adido al pedido', 'success');
        }

        function reducirStockIngredientes(item, removedIngredients) {
            if (!sistemaData.inventario) return;
            
            Object.entries(item.ingredients).forEach(([ingKey, ingData]) => {
                if (!removedIngredients.includes(ingKey)) {
                    // Solo reducir si el ingrediente no fue removido
                    if (sistemaData.inventario[ingKey]) {
                        sistemaData.inventario[ingKey].stock -= ingData.cantidad;
                        if (sistemaData.inventario[ingKey].stock < 0) {
                            sistemaData.inventario[ingKey].stock = 0;
                        }
                    }
                }
            });
        }

        function restaurarStockIngredientes(item, removedIngredients) {
            if (!sistemaData.inventario) return;
            
            Object.entries(item.ingredients).forEach(([ingKey, ingData]) => {
                if (!removedIngredients.includes(ingKey)) {
                    if (sistemaData.inventario[ingKey]) {
                        sistemaData.inventario[ingKey].stock += ingData.cantidad;
                    }
                }
            });
        }

        // ==========================================
        // RESUMEN DEL PEDIDO
        // ==========================================
        function updateOrderSummary() {
            const orderSummaryContent = document.getElementById('orderSummaryContent');
            const orderBtn = document.getElementById('orderBtn');
            const onlineOptions = document.getElementById('onlineOrderOptions');
            const restaurantSection = document.getElementById('restaurantOrderSection');
            
            // Filtrar items que tienen instancias confirmadas
            const validItems = menuItems.filter(item => 
                item.instances.some(instance => instance.confirmada)
            );
            
            if (validItems.length === 0) {
                orderSummaryContent.innerHTML = `
                    <div class="empty-summary" style="text-align: center; padding: 40px; color: #888; font-style: italic;">
                        <i class="fas fa-utensils" style="font-size: 3em; margin-bottom: 20px; color: var(--primary);"></i>
                        <p style="font-size: 1.2em;">A√∫n no has seleccionado ning√∫n platillo</p>
                        <p style="margin-top: 10px;">Usa los botones + para comenzar tu pedido</p>
                    </div>
                `;
                if (orderBtn) orderBtn.disabled = true;
                if (onlineOptions) onlineOptions.classList.remove('show');
                if (restaurantSection) restaurantSection.classList.remove('show');
                return;
            }
            
            let html = '<div class="order-grid">';
            let total = 0;
            let totalItems = 0;
            
            validItems.forEach(item => {
                const validInstances = item.instances.filter(instance => instance.confirmada);
                
                if (validInstances.length === 0) return;
                
                html += `<div class="order-item-card">`;
                html += `<button class="delete-item" onclick="deleteItem('${item.id}', ${validInstances[0].id})"><i class="fas fa-times"></i></button>`;
                html += `<div class="instance-number">${validInstances.length}</div>`;
                
                validInstances.forEach((instance, index) => {
                    total += instance.price;
                    totalItems++;
                    
                    let modifiers = '';
                    if (instance.removedIngredients.length > 0) {
                        modifiers = 'Personalizado (sin: ' + 
                            instance.removedIngredients.map(ing => ing.replace(/_/g, ' ')).join(', ') + 
                            ')';
                    } else {
                        modifiers = 'Completo';
                    }
                    
                    html += `
                        <div class="item-instance">
                            <div class="order-item-info">
                                <div class="order-item-details">
                                    <div class="order-item-name">
                                        <i class="fas fa-utensils"></i>
                                        ${item.name} #${index + 1}
                                    </div>
                                    <div class="order-item-modifiers">${modifiers}</div>
                                </div>
                                <div class="order-item-price">Bs. ${instance.price.toFixed(2).replace('.', ',')}</div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            html += '</div>';
            
            html += `
                <div class="summary-total-items">
                    <div><i class="fas fa-receipt"></i> ${totalItems} platillo${totalItems !== 1 ? 's' : ''}</div>
                    <div class="items-total">Total: Bs. ${total.toFixed(2).replace('.', ',')}</div>
                </div>
            `;
            
            orderSummaryContent.innerHTML = html;
            
            // Mostrar botones correspondientes
            if (isInRestaurant) {
                restaurantSection.classList.add('show');
                onlineOptions.classList.remove('show');
                if (orderBtn) orderBtn.disabled = false;
            } else {
                restaurantSection.classList.remove('show');
                onlineOptions.classList.add('show');
            }
            
            // Actualizar montos en modales
            document.getElementById('deliveryMonto').textContent = `Bs. ${total.toFixed(2).replace('.', ',')}`;
            document.getElementById('reservaMonto').textContent = `Bs. ${total.toFixed(2).replace('.', ',')}`;
        }

        function deleteItem(itemId, instanceId) {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) return;
            
            const instanceIndex = item.instances.findIndex(i => i.id === instanceId);
            if (instanceIndex === -1) return;
            
            const instance = item.instances[instanceIndex];
            
            // Restaurar stock de ingredientes
            restaurarStockIngredientes(item, instance.removedIngredients);
            
            // Restaurar stock del platillo
            item.totalOrdered--;
            
            // Eliminar instancia
            item.instances.splice(instanceIndex, 1);
            
            updateOrderSummary();
            renderMenu(); // Re-renderizar para actualizar stock mostrado
            showToast('Platillo eliminado del pedido', 'success');
        }

        // ==========================================
        // MODALES Y CONFIRMACI√ìN
        // ==========================================
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function showConfirmationModal() {
            const modal = document.getElementById('confirmationModal');
            const reviewDiv = document.getElementById('orderReview');
            
            let html = '';
            let total = 0;
            
            menuItems.forEach(item => {
                item.instances.filter(inst => inst.confirmada).forEach(instance => {
                    total += instance.price;
                    
                    let modifiers = '';
                    if (instance.removedIngredients.length > 0) {
                        modifiers = ' (sin: ' + instance.removedIngredients.map(ing => ing.replace(/_/g, ' ')).join(', ') + ')';
                    } else {
                        modifiers = ' (completo)';
                    }
                    
                    html += `
                        <div class="review-item">
                            <span>${item.name}${modifiers}</span>
                            <strong>Bs. ${instance.price.toFixed(2).replace('.', ',')}</strong>
                        </div>
                    `;
                });
            });
            
            html += `
                <div class="review-total">
                    <span>TOTAL</span>
                    <span>Bs. ${total.toFixed(2).replace('.', ',')}</span>
                </div>
            `;
            
            reviewDiv.innerHTML = html;
            modal.classList.add('show');
        }

        async function finalConfirmOrder() {
            closeModal('confirmationModal');
            showLoading();
            
            const pedido = crearPedidoBase();
            pedido.tipo = 'mesa';
            pedido.mesa = tableNumber;
            pedido.clienteNombre = document.getElementById('customerName').value || null;
            
            const exito = await guardarPedido(pedido);
            
            hideLoading();
            
            if (exito) {
                // Agregar a pedidos del cliente para seguimiento
                pedidosCliente.push({
                    id: pedido.id,
                    estado: 'pendiente',
                    timestamp: pedido.timestamp
                });
                
                // Mostrar mensaje de √©xito con timer
                document.getElementById('thankYouMessage').classList.add('show');
                document.getElementById('restaurantOrderSection').classList.remove('show');
                
                // Iniciar timer de 20 minutos
                let minutes = 20;
                let seconds = 0;
                paymentTimer = setInterval(() => {
                    if (seconds === 0) {
                        if (minutes === 0) {
                            clearInterval(paymentTimer);
                            return;
                        }
                        minutes--;
                        seconds = 59;
                    } else {
                        seconds--;
                    }
                    document.getElementById('paymentTimer').textContent = 
                        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);
                
                // Limpiar pedido
                limpiarPedido();
                
                // Agregar notificaci√≥n inicial
                agregarNotificacion(pedido.id, 'pending', 'Pedido enviado', 'Tu pedido est√° pendiente de confirmaci√≥n por el cajero.');
            }
        }

        // ==========================================
        // DELIVERY
        // ==========================================
        function showDeliveryModal() {
            document.getElementById('deliveryModal').classList.add('show');
            validateDeliveryForm();
        }

        function validateDeliveryForm() {
            const direccion = document.getElementById('deliveryDireccion').value.trim();
            const telefono = document.getElementById('deliveryTelefono').value.trim();
            const referencia = document.getElementById('deliveryReferencia').value.trim();
            const comprobante = document.getElementById('deliveryComprobante').files.length > 0;
            
            const direccionValid = direccion.length >= 20;
            const telefonoValid = telefono.length >= 11 && telefono.length <= 14;
            const referenciaValid = referencia.length >= 4 && referencia.length <= 12;
            
            document.getElementById('direccionError').classList.toggle('show', direccion.length > 0 && !direccionValid);
            document.getElementById('telefonoError').classList.toggle('show', telefono.length > 0 && !telefonoValid);
            document.getElementById('referenciaError').classList.toggle('show', referencia.length > 0 && !referenciaValid);
            
            document.getElementById('btnConfirmDelivery').disabled = !(direccionValid && telefonoValid && referenciaValid && comprobante);
        }

        function handleFileSelect(input, labelId) {
            const label = document.getElementById(labelId);
            if (input.files && input.files[0]) {
                label.innerHTML = `<i class="fas fa-check-circle" style="color: var(--success); font-size: 2rem; margin-bottom: 10px; display: block;"></i> ${input.files[0].name}`;
                label.classList.add('has-file');
            }
            validateDeliveryForm();
            validateReservaForm();
        }

        async function confirmDelivery() {
            const pedido = crearPedidoBase();
            pedido.tipo = 'delivery';
            pedido.direccion = document.getElementById('deliveryDireccion').value.trim();
            pedido.telefono = document.getElementById('deliveryTelefono').value.trim();
            pedido.referencia = document.getElementById('deliveryReferencia').value.trim();
            pedido.comprobante = 'comprobante_delivery_' + Date.now();
            
            closeModal('deliveryModal');
            showLoading();
            
            const exito = await guardarPedido(pedido);
            
            hideLoading();
            
            if (exito) {
                // Limpiar campos
                document.getElementById('deliveryDireccion').value = '';
                document.getElementById('deliveryTelefono').value = '';
                document.getElementById('deliveryReferencia').value = '';
                document.getElementById('deliveryComprobante').value = '';
                document.getElementById('deliveryFileLabel').innerHTML = `
                    <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: var(--primary); margin-bottom: 10px; display: block;"></i>
                    Haz clic para subir el comprobante de pago
                `;
                document.getElementById('deliveryFileLabel').classList.remove('has-file');
                
                // Agregar a pedidos del cliente
                pedidosCliente.push({
                    id: pedido.id,
                    estado: 'pendiente',
                    timestamp: pedido.timestamp
                });
                
                limpiarPedido();
                agregarNotificacion(pedido.id, 'pending', 'Pedido enviado', 'Tu pedido de delivery est√° pendiente de confirmaci√≥n. Tienes 25 minutos para completar el pago.');
            }
        }

        // ==========================================
        // RESERVA
        // ==========================================
        function showReservaModal() {
            document.getElementById('reservaModal').classList.add('show');
            validateReservaForm();
        }

        function initCalendar() {
            const container = document.getElementById('calendarContainer');
            const today = new Date();
            let currentMonth = today.getMonth();
            let currentYear = today.getFullYear();
            
            renderCalendar(currentMonth, currentYear);
        }

        function renderCalendar(month, year) {
            const container = document.getElementById('calendarContainer');
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                              'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            
            let html = `
                <div class="calendar-header">
                    <button onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                    <h3>${monthNames[month]} ${year}</h3>
                    <button onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="calendar-grid">
                    <div class="calendar-day-header">Dom</div>
                    <div class="calendar-day-header">Lun</div>
                    <div class="calendar-day-header">Mar</div>
                    <div class="calendar-day-header">Mi√©</div>
                    <div class="calendar-day-header">Jue</div>
                    <div class="calendar-day-header">Vie</div>
                    <div class="calendar-day-header">S√°b</div>
            `;
            
            // Espacios vac√≠os antes del primer d√≠a
            for (let i = 0; i < firstDay; i++) {
                html += '<div></div>';
            }
            
            // D√≠as del mes
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const isToday = date.toDateString() === today.toDateString();
                const isPast = date < today && !isToday;
                const isSelected = selectedDate && date.toDateString() === selectedDate.toDateString();
                
                html += `
                    <div class="calendar-day ${isToday ? 'today' : ''} ${isPast ? 'disabled' : ''} ${isSelected ? 'selected' : ''}"
                         ${!isPast ? `onclick="selectDate(${year}, ${month}, ${day})"` : ''}>
                        ${day}
                    </div>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function changeMonth(delta) {
            // Implementar cambio de mes (simplificado para este ejemplo)
        }

        function selectDate(year, month, day) {
            selectedDate = new Date(year, month, day);
            initCalendar(); // Re-render para mostrar selecci√≥n
            validateReservaForm();
        }

        function validateReservaForm() {
            const nombre = document.getElementById('reservaNombre').value.trim();
            const referencia = document.getElementById('reservaReferencia').value.trim();
            const comprobante = document.getElementById('reservaComprobante').files.length > 0;
            
            const referenciaValid = referencia.length >= 4 && referencia.length <= 12;
            
            document.getElementById('referenciaReservaError').classList.toggle('show', referencia.length > 0 && !referenciaValid);
            
            document.getElementById('btnConfirmReserva').disabled = !(nombre.length > 0 && selectedDate && referenciaValid && comprobante);
        }

        async function confirmReserva() {
            const pedido = crearPedidoBase();
            pedido.tipo = 'reserva';
            pedido.fechaReserva = selectedDate.toISOString();
            pedido.clienteNombre = document.getElementById('reservaNombre').value.trim();
            pedido.referencia = document.getElementById('reservaReferencia').value.trim();
            pedido.comprobante = 'comprobante_reserva_' + Date.now();
            
            closeModal('reservaModal');
            showLoading();
            
            const exito = await guardarPedido(pedido);
            
            hideLoading();
            
            if (exito) {
                // Limpiar campos
                document.getElementById('reservaNombre').value = '';
                document.getElementById('reservaReferencia').value = '';
                document.getElementById('reservaComprobante').value = '';
                document.getElementById('reservaFileLabel').innerHTML = `
                    <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: var(--primary); margin-bottom: 10px; display: block;"></i>
                    Haz clic para subir el comprobante de pago
                `;
                document.getElementById('reservaFileLabel').classList.remove('has-file');
                selectedDate = null;
                
                // Agregar a pedidos del cliente
                pedidosCliente.push({
                    id: pedido.id,
                    estado: 'pendiente',
                    timestamp: pedido.timestamp
                });
                
                limpiarPedido();
                agregarNotificacion(pedido.id, 'pending', 'Reserva enviada', 'Tu reserva est√° pendiente de confirmaci√≥n.');
            }
        }

        // ==========================================
        // UTILIDADES
        // ==========================================
        function crearPedidoBase() {
            const pedido = {
                id: 'PED-' + Date.now(),
                timestamp: new Date().toISOString(),
                estado: 'pendiente',
                items: [],
                total: 0,
                metodoPago: 'pago_movil',
                cajero: null,
                tiempoPreparacion: null,
                origen: 'cliente_web'
            };
            
            menuItems.forEach(item => {
                item.instances.filter(inst => inst.confirmada).forEach(instance => {
                    pedido.items.push({
                        platilloId: item.id,
                        nombre: item.name,
                        cantidad: 1,
                        personalizacion: instance.removedIngredients,
                        precioUnitario: item.basePrice,
                        subtotal: instance.price / (sistemaData?.config?.tasaCambio || 400)
                    });
                    pedido.total += instance.price / (sistemaData?.config?.tasaCambio || 400);
                });
            });
            
            return pedido;
        }

        async function guardarPedido(pedido) {
            try {
                sistemaData.pedidos.push(pedido);
                
                const response = await fetch(`${JSONBIN_CONFIG.BASE_URL}/${JSONBIN_CONFIG.BIN_ID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': JSONBIN_CONFIG.API_KEY
                    },
                    body: JSON.stringify(sistemaData)
                });
                
                if (!response.ok) throw new Error('Error al guardar');
                
                return true;
            } catch (error) {
                console.error('Error:', error);
                showToast('Error al procesar el pedido', 'error');
                return false;
            }
        }

        function limpiarPedido() {
            menuItems.forEach(item => {
                // Restaurar stock de ingredientes de todas las instancias
                item.instances.forEach(inst => {
                    restaurarStockIngredientes(item, inst.removedIngredients);
                });
                
                item.instances = [];
                item.quantity = 0;
                item.currentSelections.clear();
                item.selectionType = "completo";
                item.totalOrdered = 0;
            });
            updateOrderSummary();
            renderMenu();
        }

        function convertirABs(dolares) {
            return dolares * (sistemaData?.config?.tasaCambio || 400);
        }

        function formatearPrecioBs(dolares) {
            const precioBs = convertirABs(dolares);
            return `Bs. ${precioBs.toFixed(2).replace('.', ',')}`;
        }

        function getStockClass(stock, hayIngredientes) {
            if (!hayIngredientes) return 'sold-out';
            if (stock === 0) return 'sold-out';
            if (stock <= 2) return 'low';
            return 'available';
        }

        function actualizarEstadoSync(estado) {
            const statusEl = document.getElementById('syncStatus');
            const iconEl = statusEl.querySelector('i');
            const textEl = statusEl.querySelector('span');
            
            statusEl.className = `sync-status ${estado}`;
            
            switch(estado) {
                case 'online':
                    iconEl.className = 'fas fa-check-circle';
                    textEl.textContent = 'Sincronizado';
                    break;
                case 'syncing':
                    iconEl.className = 'fas fa-sync-alt fa-spin';
                    textEl.textContent = 'Sincronizando...';
                    break;
                case 'offline':
                    iconEl.className = 'fas fa-exclamation-triangle';
                    textEl.textContent = 'Modo offline';
                    break;
            }
        }

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ==========================================
        // EVENT LISTENERS
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            // La app se inicializa despu√©s de verificar ubicaci√≥n
            checkLocation();
        });

        window.addEventListener('beforeunload', () => {
            if (syncInterval) clearInterval(syncInterval);
            if (paymentTimer) clearInterval(paymentTimer);
            if (notificacionesInterval) clearInterval(notificacionesInterval);
        });
    </script>
</body>
</html>
