<!-- ========================================== -->
<!-- PANEL CLIENTE - Saki Sushi -->
<!-- ========================================== -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saki Sushi - Men√∫</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Lato', sans-serif; background: #0f0f0f; color: #e5e5e5; }
        h1, h2, h3 { font-family: 'Playfair Display', serif; }
        .glass-panel { background: rgba(30, 30, 30, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .sushi-card { transition: all 0.3s ease; border: 1px solid #333; }
        .sushi-card:hover { transform: translateY(-5px); border-color: #dc2626; box-shadow: 0 10px 30px rgba(220, 38, 38, 0.3); }
        .badge-notification { position: relative; }
        .badge-notification::after { content: attr(data-count); position: absolute; top: -8px; right: -8px; background: #dc2626; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .notification-panel { max-height: 400px; overflow-y: auto; }
        .notification-item { border-left: 3px solid transparent; transition: all 0.3s; }
        .notification-item.unread { border-left-color: #dc2626; background: rgba(220, 38, 38, 0.1); }
        .notification-item.approved { border-left-color: #22c55e; }
        .notification-item.rejected { border-left-color: #dc2626; }
        .modal-overlay { background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); }
        .location-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .ingredient-tag { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; background: #333; border-radius: 12px; font-size: 12px; margin: 2px; }
        .ingredient-tag button { color: #dc2626; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body class="min-h-screen">
    <!-- Header -->
    <header class="fixed top-0 w-full z-40 glass-panel border-b border-gray-800">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-red-600 to-red-800 rounded-full flex items-center justify-center">
                    <span class="text-xl">üç£</span>
                </div>
                <h1 class="text-2xl font-bold text-white">Saki Sushi</h1>
            </div>
            
            <!-- Badge Notificaciones -->
            <div class="flex items-center gap-4">
                <button id="notificationBtn" class="badge-notification relative p-2 rounded-full hover:bg-gray-800 transition-colors" data-count="0">
                    <svg class="w-6 h-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                    </svg>
                </button>
                <div id="cartBtn" class="flex items-center gap-2 bg-red-600 hover:bg-red-700 px-4 py-2 rounded-full cursor-pointer transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <span id="cartCount" class="font-bold">0</span>
                    <span id="cartTotal" class="text-sm">$0.00</span>
                </div>
            </div>
        </div>
        
        <!-- Panel de Notificaciones Desplegable -->
        <div id="notificationPanel" class="hidden absolute right-4 top-16 w-96 glass-panel rounded-xl shadow-2xl border border-gray-700">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="font-bold text-lg">Notificaciones</h3>
                <button id="markAllRead" class="text-xs text-red-400 hover:text-red-300">Marcar todo le√≠do</button>
            </div>
            <div id="notificationList" class="notification-panel p-2 space-y-2">
                <p class="text-gray-500 text-center py-8">No hay notificaciones</p>
            </div>
        </div>
    </header>

    <!-- Location Modal -->
    <div id="locationModal" class="fixed inset-0 z-50 modal-overlay hidden flex items-center justify-center p-4">
        <div class="glass-panel rounded-2xl p-8 max-w-md w-full text-center">
            <div class="w-20 h-20 bg-red-600/20 rounded-full flex items-center justify-center mx-auto mb-4 location-pulse">
                <svg class="w-10 h-10 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            </div>
            <h2 class="text-2xl font-bold mb-2">¬øD√≥nde est√°s?</h2>
            <p class="text-gray-400 mb-6">Necesitamos tu ubicaci√≥n para verificar que podemos entregarte o reservar tu mesa.</p>
            <button id="enableLocation" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-xl transition-colors mb-3">
                Activar Ubicaci√≥n
            </button>
            <p class="text-xs text-gray-500">Tu ubicaci√≥n solo se usa para verificar disponibilidad de delivery</p>
        </div>
    </div>

    <!-- Main Content -->
    <main class="pt-24 pb-32 px-4 max-w-7xl mx-auto">
        <!-- Hero -->
        <section class="text-center py-12 mb-8">
            <h2 class="text-5xl md:text-6xl font-bold mb-4 bg-gradient-to-r from-red-500 to-orange-400 bg-clip-text text-transparent">
                Sabor Aut√©ntico
            </h2>
            <p class="text-xl text-gray-400">Sushi artesanal preparado con pasi√≥n</p>
        </section>

        <!-- Categor√≠as -->
        <div class="flex gap-4 overflow-x-auto pb-4 mb-8 scrollbar-hide">
            <button class="category-btn active px-6 py-2 rounded-full bg-red-600 text-white whitespace-nowrap" data-category="todos">Todos</button>
            <button class="category-btn px-6 py-2 rounded-full bg-gray-800 text-gray-300 hover:bg-gray-700 whitespace-nowrap" data-category="entradas">Entradas</button>
            <button class="category-btn px-6 py-2 rounded-full bg-gray-800 text-gray-300 hover:bg-gray-700 whitespace-nowrap" data-category="rolls">Rolls</button>
            <button class="category-btn px-6 py-2 rounded-full bg-gray-800 text-gray-300 hover:bg-gray-700 whitespace-nowrap" data-category="especiales">Especiales</button>
            <button class="category-btn px-6 py-2 rounded-full bg-gray-800 text-gray-300 hover:bg-gray-700 whitespace-nowrap" data-category="bebidas">Bebidas</button>
        </div>

        <!-- Men√∫ Grid -->
        <div id="menuGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Items se cargan din√°micamente -->
        </div>
    </main>

    <!-- Cart Modal -->
    <div id="cartModal" class="fixed inset-0 z-50 modal-overlay hidden flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div class="glass-panel w-full sm:rounded-2xl sm:max-w-lg sm:w-full max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-2xl font-bold">Tu Pedido</h3>
                <button id="closeCart" class="text-gray-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div id="cartItems" class="flex-1 overflow-y-auto p-6 space-y-4">
                <!-- Items del carrito -->
            </div>

            <!-- Opciones de Entrega -->
            <div class="p-6 border-t border-gray-700 space-y-4 bg-gray-900/50">
                <div class="flex gap-4 mb-4">
                    <button class="delivery-option flex-1 py-3 px-4 rounded-xl border-2 border-gray-700 hover:border-red-600 transition-colors text-center" data-type="delivery">
                        <div class="text-2xl mb-1">üöö</div>
                        <div class="font-bold">Delivery</div>
                    </button>
                    <button class="delivery-option flex-1 py-3 px-4 rounded-xl border-2 border-gray-700 hover:border-red-600 transition-colors text-center" data-type="reserva">
                        <div class="text-2xl mb-1">ü™ë</div>
                        <div class="font-bold">Reservar</div>
                    </button>
                </div>

                <!-- Campos Delivery -->
                <div id="deliveryFields" class="hidden space-y-3">
                    <input type="text" id="deliveryAddress" placeholder="Direcci√≥n completa" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:border-red-600 focus:outline-none">
                    <input type="tel" id="deliveryPhone" placeholder="Tel√©fono de contacto" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:border-red-600 focus:outline-none">
                    <input type="text" id="deliveryReference" placeholder="Referencia de pago (4-12 caracteres)" minlength="4" maxlength="12" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:border-red-600 focus:outline-none" required>
                    <p class="text-xs text-gray-500">* Campo obligatorio</p>
                </div>

                <!-- Campos Reserva -->
                <div id="reservaFields" class="hidden space-y-3">
                    <input type="text" id="reservaName" placeholder="Nombre para la reserva" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:border-red-600 focus:outline-none">
                    <input type="datetime-local" id="reservaDate" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white focus:border-red-600 focus:outline-none">
                    <input type="number" id="reservaPeople" placeholder="N√∫mero de personas" min="1" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:border-red-600 focus:outline-none">
                    <input type="text" id="reservaReference" placeholder="Referencia de pago (4-12 caracteres)" minlength="4" maxlength="12" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:border-red-600 focus:outline-none" required>
                    <p class="text-xs text-gray-500">* Campo obligatorio</p>
                </div>

                <div class="flex justify-between items-center text-xl font-bold pt-4 border-t border-gray-700">
                    <span>Total:</span>
                    <span id="cartTotalModal">$0.00</span>
                </div>
                <button id="confirmOrder" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-xl transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    Confirmar Pedido
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Personalizaci√≥n -->
    <div id="customizeModal" class="fixed inset-0 z-50 modal-overlay hidden flex items-center justify-center p-4">
        <div class="glass-panel rounded-2xl p-6 max-w-md w-full max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Personalizar</h3>
                <button id="closeCustomize" class="text-gray-400 hover:text-white">‚úï</button>
            </div>
            <div id="customizeContent" class="space-y-4">
                <!-- Contenido din√°mico -->
            </div>
            <div class="mt-6 pt-4 border-t border-gray-700 flex gap-3">
                <button id="cancelCustomize" class="flex-1 py-3 border border-gray-600 rounded-xl hover:bg-gray-800 transition-colors">Cancelar</button>
                <button id="saveCustomize" class="flex-1 py-3 bg-red-600 hover:bg-red-700 rounded-xl font-bold transition-colors">Agregar</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURACI√ìN
        // ==========================================
        const JSONBIN_API_KEY = '$2a$10$.klBAMlOBlE9CoVh5iUFf.x3LEYKWiP6hhvvPETK9e8pyIuNB2F4K';
        const JSONBIN_BIN_ID = '69879d6e43b1c97be96d2b13';
        const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`;
        
        // ==========================================
        // ESTADO GLOBAL
        // ==========================================
        let state = {
            cart: [],
            menu: [],
            inventory: {},
            tasaCambio: 400,
            currentCategory: 'todos',
            deliveryType: null,
            notifications: [],
            unreadCount: 0,
            sessionStart: null,
            currentOrderId: null,
            lastCheck: 0
        };

        // ==========================================
        // SESI√ìN Y UBICACI√ìN (30 MINUTOS)
        // ==========================================
        function checkSession() {
            const sessionData = localStorage.getItem('sakiSession');
            const now = Date.now();
            
            if (sessionData) {
                const session = JSON.parse(sessionData);
                const thirtyMinutes = 30 * 60 * 1000;
                
                if (now - session.timestamp < thirtyMinutes) {
                    // Sesi√≥n v√°lida
                    state.sessionStart = session.timestamp;
                    return true;
                }
            }
            
            return false;
        }

        function startSession() {
            const session = {
                timestamp: Date.now(),
                locationEnabled: true
            };
            localStorage.setItem('sakiSession', JSON.stringify(session));
            state.sessionStart = session.timestamp;
        }

        // ==========================================
        // NOTIFICACIONES
        // ==========================================
        function loadNotifications() {
            const saved = localStorage.getItem('sakiNotifications');
            if (saved) {
                state.notifications = JSON.parse(saved);
                updateNotificationBadge();
            }
        }

        function saveNotifications() {
            localStorage.setItem('sakiNotifications', JSON.stringify(state.notifications));
        }

        function addNotification(type, title, message, orderId = null) {
            const notification = {
                id: Date.now(),
                type: type, // 'approved', 'rejected', 'info'
                title: title,
                message: message,
                orderId: orderId,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            state.notifications.unshift(notification);
            state.unreadCount++;
            saveNotifications();
            updateNotificationBadge();
            renderNotifications();
            
            // Sonido opcional
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, { body: message });
            }
        }

        function updateNotificationBadge() {
            const btn = document.getElementById('notificationBtn');
            btn.setAttribute('data-count', state.unreadCount);
            btn.style.display = state.unreadCount > 0 ? 'block' : 'block'; // Siempre visible
        }

        function renderNotifications() {
            const list = document.getElementById('notificationList');
            
            if (state.notifications.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-8">No hay notificaciones</p>';
                return;
            }
            
            list.innerHTML = state.notifications.map(n => `
                <div class="notification-item ${n.read ? '' : 'unread'} ${n.type} p-3 rounded-lg cursor-pointer hover:bg-gray-800" data-id="${n.id}">
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-bold text-sm ${n.type === 'approved' ? 'text-green-400' : n.type === 'rejected' ? 'text-red-400' : 'text-blue-400'}">
                            ${n.type === 'approved' ? '‚úì Aprobado' : n.type === 'rejected' ? '‚úï Rechazado' : '‚Ñπ Info'}
                        </span>
                        <span class="text-xs text-gray-500">${new Date(n.timestamp).toLocaleTimeString()}</span>
                    </div>
                    <p class="font-semibold text-sm mb-1">${n.title}</p>
                    <p class="text-xs text-gray-400">${n.message}</p>
                    ${n.orderId ? `<p class="text-xs text-gray-500 mt-1">Pedido: ${n.orderId}</p>` : ''}
                </div>
            `).join('');
        }

        function markAsRead(id) {
            const notification = state.notifications.find(n => n.id === id);
            if (notification && !notification.read) {
                notification.read = true;
                state.unreadCount = Math.max(0, state.unreadCount - 1);
                saveNotifications();
                updateNotificationBadge();
                renderNotifications();
            }
        }

        function markAllAsRead() {
            state.notifications.forEach(n => n.read = true);
            state.unreadCount = 0;
            saveNotifications();
            updateNotificationBadge();
            renderNotifications();
        }

        // ==========================================
        // CARGA DE DATOS
        // ==========================================
        async function loadData() {
            try {
                const response = await fetch(JSONBIN_URL, {
                    headers: { 'X-Master-Key': JSONBIN_API_KEY }
                });
                const data = await response.json();
                const record = data.record;
                
                state.menu = record.menu || [];
                state.inventory = record.inventario || {};
                state.tasaCambio = record.config?.tasaCambio || 400;
                
                renderMenu();
                loadNotifications();
                
                // Si hay pedido activo, verificar estado
                const activeOrder = localStorage.getItem('sakiActiveOrder');
                if (activeOrder) {
                    state.currentOrderId = activeOrder;
                    checkOrderStatus();
                }
            } catch (error) {
                console.error('Error cargando datos:', error);
                showToast('Error al cargar el men√∫', 'error');
            }
        }

        // ==========================================
        // RENDERIZADO
        // ==========================================
        function renderMenu() {
            const grid = document.getElementById('menuGrid');
            const filtered = state.currentCategory === 'todos' 
                ? state.menu 
                : state.menu.filter(item => item.categoria === state.currentCategory);
            
            grid.innerHTML = filtered.map(item => {
                const priceBs = (item.precio * state.tasaCambio).toFixed(2);
                const available = calculateStock(item);
                
                return `
                <div class="sushi-card bg-gray-900 rounded-2xl overflow-hidden ${!item.disponible || available <= 0 ? 'opacity-50' : ''}">
                    <div class="h-48 bg-gradient-to-br from-gray-800 to-gray-900 flex items-center justify-center text-6xl">
                        ${getEmoji(item.categoria)}
                    </div>
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-xl font-bold">${item.nombre}</h3>
                            <span class="text-red-400 font-bold">$${item.precio.toFixed(2)}</span>
                        </div>
                        <p class="text-gray-400 text-sm mb-3">${item.descripcion}</p>
                        <p class="text-xs text-gray-500 mb-4">Bs. ${priceBs}</p>
                        
                        ${item.ingredientes ? `
                        <div class="mb-4">
                            <p class="text-xs text-gray-500 mb-1">Ingredientes:</p>
                            <div class="flex flex-wrap gap-1">
                                ${Object.keys(item.ingredientes).map(ing => `
                                    <span class="text-xs bg-gray-800 px-2 py-1 rounded">${normalizeIngredientName(ing)}</span>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="flex items-center justify-between">
                            <span class="text-xs ${available > 5 ? 'text-green-400' : available > 0 ? 'text-yellow-400' : 'text-red-400'}">
                                ${available > 0 ? `${available} disponibles` : 'Agotado'}
                            </span>
                            <button onclick="openCustomize('${item.id}')" 
                                class="bg-red-600 hover:bg-red-700 disabled:bg-gray-700 text-white px-4 py-2 rounded-lg font-bold transition-colors"
                                ${!item.disponible || available <= 0 ? 'disabled' : ''}>
                                Agregar
                            </button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function getEmoji(category) {
            const emojis = { entradas: 'ü•¢', rolls: 'üç±', especiales: 'üç£', bebidas: 'üç∂', default: 'üçô' };
            return emojis[category] || emojis.default;
        }

        function normalizeIngredientName(name) {
            return name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function calculateStock(item) {
            if (!item.ingredientes) return item.stockMaximo || 999;
            
            let minStock = Infinity;
            for (const [ingredient, config] of Object.entries(item.ingredientes)) {
                const invStock = state.inventory[ingredient]?.stock || 0;
                const possible = Math.floor(invStock / config.cantidad);
                minStock = Math.min(minStock, possible);
            }
            return minStock === Infinity ? 0 : Math.min(minStock, item.stockMaximo || 999);
        }

        // ==========================================
        // PERSONALIZACI√ìN
        // ==========================================
        let currentCustomizeItem = null;
        let excludedIngredients = [];

        function openCustomize(itemId) {
            const item = state.menu.find(m => m.id === itemId);
            if (!item) return;
            
            currentCustomizeItem = item;
            excludedIngredients = [];
            
            const content = document.getElementById('customizeContent');
            content.innerHTML = `
                <div class="text-center mb-4">
                    <div class="text-4xl mb-2">${getEmoji(item.categoria)}</div>
                    <h4 class="text-lg font-bold">${item.nombre}</h4>
                    <p class="text-red-400 font-bold">$${item.precio.toFixed(2)}</p>
                </div>
                
                ${item.ingredientes ? `
                <div class="space-y-3">
                    <p class="font-semibold text-sm text-gray-300">Excluir ingredientes (opcional):</p>
                    <div class="space-y-2">
                        ${Object.keys(item.ingredientes).map(ing => `
                            <label class="flex items-center gap-3 p-3 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors">
                                <input type="checkbox" value="${ing}" class="ingredient-checkbox w-4 h-4 rounded border-gray-600 text-red-600 focus:ring-red-600 bg-gray-700">
                                <span class="flex-1">${normalizeIngredientName(ing)}</span>
                                ${!item.ingredientes[ing].obligatorio ? '<span class="text-xs text-gray-500">Opcional</span>' : '<span class="text-xs text-red-400">Obligatorio</span>'}
                            </label>
                        `).join('')}
                    </div>
                </div>
                ` : '<p class="text-gray-500 text-center">Este item no tiene ingredientes para personalizar</p>'}
                
                <div class="mt-4">
                    <label class="block text-sm font-semibold mb-2">Cantidad</label>
                    <div class="flex items-center gap-3">
                        <button onclick="adjustQuantity(-1)" class="w-10 h-10 rounded-full bg-gray-800 hover:bg-gray-700 flex items-center justify-center text-xl font-bold">-</button>
                        <span id="customizeQty" class="text-xl font-bold w-12 text-center">1</span>
                        <button onclick="adjustQuantity(1)" class="w-10 h-10 rounded-full bg-gray-800 hover:bg-gray-700 flex items-center justify-center text-xl font-bold">+</button>
                    </div>
                </div>
            `;
            
            document.getElementById('customizeModal').classList.remove('hidden');
        }

        function adjustQuantity(delta) {
            const qtyEl = document.getElementById('customizeQty');
            let qty = parseInt(qtyEl.textContent) + delta;
            qty = Math.max(1, Math.min(qty, 10));
            qtyEl.textContent = qty;
        }

        // ==========================================
        // CARRITO
        // ==========================================
        function addToCart(item, quantity, excluded) {
            const existingIndex = state.cart.findIndex(c => 
                c.id === item.id && 
                JSON.stringify(c.excluded.sort()) === JSON.stringify(excluded.sort())
            );
            
            if (existingIndex >= 0) {
                state.cart[existingIndex].quantity += quantity;
            } else {
                state.cart.push({
                    id: item.id,
                    name: item.nombre,
                    price: item.precio,
                    quantity: quantity,
                    excluded: excluded,
                    category: item.categoria
                });
            }
            
            updateCartUI();
            document.getElementById('customizeModal').classList.add('hidden');
            showToast('Agregado al carrito');
        }

        function updateCartUI() {
            const count = state.cart.reduce((sum, item) => sum + item.quantity, 0);
            const total = state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            document.getElementById('cartCount').textContent = count;
            document.getElementById('cartTotal').textContent = `$${total.toFixed(2)}`;
            document.getElementById('cartTotalModal').textContent = `$${total.toFixed(2)} (Bs. ${(total * state.tasaCambio).toFixed(2)})`;
            
            const cartItems = document.getElementById('cartItems');
            if (state.cart.length === 0) {
                cartItems.innerHTML = '<p class="text-center text-gray-500 py-8">Tu carrito est√° vac√≠o</p>';
            } else {
                cartItems.innerHTML = state.cart.map((item, index) => `
                    <div class="flex gap-4 bg-gray-800/50 p-4 rounded-xl">
                        <div class="text-3xl">${getEmoji(item.category)}</div>
                        <div class="flex-1">
                            <div class="flex justify-between items-start">
                                <h4 class="font-bold">${item.name}</h4>
                                <button onclick="removeFromCart(${index})" class="text-red-400 hover:text-red-300">‚úï</button>
                            </div>
                            ${item.excluded.length > 0 ? `
                                <p class="text-xs text-gray-400 mt-1">Sin: ${item.excluded.map(e => normalizeIngredientName(e)).join(', ')}</p>
                            ` : ''}
                            <div class="flex justify-between items-center mt-2">
                                <div class="flex items-center gap-2">
                                    <button onclick="updateQuantity(${index}, -1)" class="w-6 h-6 rounded bg-gray-700 hover:bg-gray-600 flex items-center justify-center text-sm">-</button>
                                    <span class="font-bold">${item.quantity}</span>
                                    <button onclick="updateQuantity(${index}, 1)" class="w-6 h-6 rounded bg-gray-700 hover:bg-gray-600 flex items-center justify-center text-sm">+</button>
                                </div>
                                <span class="font-bold text-red-400">$${(item.price * item.quantity).toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            document.getElementById('confirmOrder').disabled = state.cart.length === 0 || !state.deliveryType;
        }

        function removeFromCart(index) {
            state.cart.splice(index, 1);
            updateCartUI();
        }

        function updateQuantity(index, delta) {
            state.cart[index].quantity += delta;
            if (state.cart[index].quantity <= 0) {
                state.cart.splice(index, 1);
            }
            updateCartUI();
        }

        // ==========================================
        // PEDIDO Y VALIDACI√ìN
        // ==========================================
        function validateOrder() {
            const refField = state.deliveryType === 'delivery' 
                ? document.getElementById('deliveryReference')
                : document.getElementById('reservaReference');
            
            const reference = refField.value.trim();
            
            if (!reference || reference.length < 4 || reference.length > 12) {
                showToast('La referencia de pago debe tener entre 4 y 12 caracteres', 'error');
                refField.focus();
                return false;
            }
            
            if (state.deliveryType === 'delivery') {
                const address = document.getElementById('deliveryAddress').value.trim();
                const phone = document.getElementById('deliveryPhone').value.trim();
                if (!address || !phone) {
                    showToast('Completa todos los campos obligatorios', 'error');
                    return false;
                }
            } else {
                const name = document.getElementById('reservaName').value.trim();
                const date = document.getElementById('reservaDate').value;
                if (!name || !date) {
                    showToast('Completa todos los campos obligatorios', 'error');
                    return false;
                }
            }
            
            return true;
        }

        async function submitOrder() {
            if (!validateOrder()) return;
            
            const orderId = 'PED-' + Date.now();
            const total = state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            const orderData = {
                id: orderId,
                timestamp: new Date().toISOString(),
                estado: 'pendiente',
                tipo: state.deliveryType,
                items: state.cart.map(item => ({
                    platilloId: item.id,
                    nombre: item.name,
                    cantidad: item.quantity,
                    personalizacion: item.excluded.map(e => `sin_${e}`),
                    precioUnitario: item.price,
                    subtotal: item.price * item.quantity
                })),
                total: total,
                cliente: state.deliveryType === 'delivery' ? {
                    direccion: document.getElementById('deliveryAddress').value,
                    telefono: document.getElementById('deliveryPhone').value,
                    referenciaPago: document.getElementById('deliveryReference').value
                } : {
                    nombre: document.getElementById('reservaName').value,
                    fecha: document.getElementById('reservaDate').value,
                    personas: parseInt(document.getElementById('reservaPeople').value) || 1,
                    referenciaPago: document.getElementById('reservaReference').value
                },
                metodoPago: null,
                cajero: null,
                origen: 'cliente_web'
            };
            
            try {
                // Obtener pedidos actuales
                const response = await fetch(JSONBIN_URL, {
                    headers: { 'X-Master-Key': JSONBIN_API_KEY }
                });
                const data = await response.json();
                const record = data.record;
                
                // Agregar nuevo pedido
                record.pedidos = record.pedidos || [];
                record.pedidos.push(orderData);
                
                // Guardar
                await fetch(JSONBIN_URL, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': JSONBIN_API_KEY
                    },
                    body: JSON.stringify(record)
                });
                
                // Guardar referencia local
                localStorage.setItem('sakiActiveOrder', orderId);
                state.currentOrderId = orderId;
                
                // Limpiar campos
                clearFields();
                
                // Limpiar carrito
                state.cart = [];
                updateCartUI();
                
                // Cerrar modal
                document.getElementById('cartModal').classList.add('hidden');
                
                // Agregar notificaci√≥n
                addNotification('info', 'Pedido Enviado', `Tu pedido ${orderId} est√° pendiente de confirmaci√≥n. Te notificaremos cuando el cajero lo procese.`, orderId);
                
                showToast('Pedido enviado correctamente');
                
                // Iniciar polling de estado
                startStatusCheck();
                
            } catch (error) {
                console.error('Error:', error);
                showToast('Error al enviar pedido', 'error');
            }
        }

        function clearFields() {
            // Limpiar campos delivery
            document.getElementById('deliveryAddress').value = '';
            document.getElementById('deliveryPhone').value = '';
            document.getElementById('deliveryReference').value = '';
            
            // Limpiar campos reserva
            document.getElementById('reservaName').value = '';
            document.getElementById('reservaDate').value = '';
            document.getElementById('reservaPeople').value = '';
            document.getElementById('reservaReference').value = '';
            
            // Reset tipo
            state.deliveryType = null;
            document.querySelectorAll('.delivery-option').forEach(btn => {
                btn.classList.remove('border-red-600', 'bg-red-600/20');
                btn.classList.add('border-gray-700');
            });
            document.getElementById('deliveryFields').classList.add('hidden');
            document.getElementById('reservaFields').classList.add('hidden');
        }

        // ==========================================
        // VERIFICACI√ìN DE ESTADO
        // ==========================================
        async function checkOrderStatus() {
            if (!state.currentOrderId) return;
            
            try {
                const response = await fetch(JSONBIN_URL, {
                    headers: { 'X-Master-Key': JSONBIN_API_KEY }
                });
                const data = await response.json();
                const pedidos = data.record.pedidos || [];
                const pedido = pedidos.find(p => p.id === state.currentOrderId);
                
                if (!pedido) return;
                
                // Verificar si hay cambio de estado
                const lastStatus = localStorage.getItem('sakiLastStatus');
                if (lastStatus !== pedido.estado) {
                    localStorage.setItem('sakiLastStatus', pedido.estado);
                    
                    if (pedido.estado === 'cobrado') {
                        addNotification('approved', '¬°Pedido Aprobado!', `Tu pedido ${pedido.id} ha sido confirmado y est√° siendo preparado.`, pedido.id);
                        localStorage.removeItem('sakiActiveOrder');
                        state.currentOrderId = null;
                    } else if (pedido.estado === 'rechazado') {
                        const motivo = pedido.motivoRechazo || 'No especificado';
                        addNotification('rejected', 'Pedido Rechazado', `Tu pedido fue rechazado. Motivo: ${motivo}`, pedido.id);
                        localStorage.removeItem('sakiActiveOrder');
                        state.currentOrderId = null;
                    }
                }
            } catch (error) {
                console.error('Error verificando estado:', error);
            }
        }

        function startStatusCheck() {
            // Verificar cada 10 segundos
            setInterval(checkOrderStatus, 10000);
        }

        // ==========================================
        // UTILIDADES
        // ==========================================
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full font-bold z-50 transition-all ${type === 'success' ? 'bg-green-600' : 'bg-red-600'} text-white`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ==========================================
        // EVENT LISTENERS
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            // Verificar sesi√≥n
            if (!checkSession()) {
                document.getElementById('locationModal').classList.remove('hidden');
            }
            
            // Activar ubicaci√≥n
            document.getElementById('enableLocation').addEventListener('click', () => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        () => {
                            startSession();
                            document.getElementById('locationModal').classList.add('hidden');
                            showToast('Ubicaci√≥n activada');
                        },
                        () => {
                            showToast('No se pudo obtener ubicaci√≥n, pero puedes continuar', 'error');
                            startSession();
                            document.getElementById('locationModal').classList.add('hidden');
                        }
                    );
                } else {
                    startSession();
                    document.getElementById('locationModal').classList.add('hidden');
                }
            });
            
            // Cargar datos
            loadData();
            
            // Categor√≠as
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.category-btn').forEach(b => {
                        b.classList.remove('bg-red-600', 'text-white');
                        b.classList.add('bg-gray-800', 'text-gray-300');
                    });
                    e.target.classList.remove('bg-gray-800', 'text-gray-300');
                    e.target.classList.add('bg-red-600', 'text-white');
                    state.currentCategory = e.target.dataset.category;
                    renderMenu();
                });
            });
            
            // Carrito
            document.getElementById('cartBtn').addEventListener('click', () => {
                document.getElementById('cartModal').classList.remove('hidden');
                updateCartUI();
            });
            
            document.getElementById('closeCart').addEventListener('click', () => {
                document.getElementById('cartModal').classList.add('hidden');
            });
            
            // Personalizaci√≥n
            document.getElementById('closeCustomize').addEventListener('click', () => {
                document.getElementById('customizeModal').classList.add('hidden');
            });
            
            document.getElementById('cancelCustomize').addEventListener('click', () => {
                document.getElementById('customizeModal').classList.add('hidden');
            });
            
            document.getElementById('saveCustomize').addEventListener('click', () => {
                const qty = parseInt(document.getElementById('customizeQty').textContent);
                const checkboxes = document.querySelectorAll('.ingredient-checkbox:checked');
                const excluded = Array.from(checkboxes).map(cb => cb.value);
                addToCart(currentCustomizeItem, qty, excluded);
            });
            
            // Tipo de entrega
            document.querySelectorAll('.delivery-option').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const type = e.currentTarget.dataset.type;
                    state.deliveryType = type;
                    
                    document.querySelectorAll('.delivery-option').forEach(b => {
                        b.classList.remove('border-red-600', 'bg-red-600/20');
                        b.classList.add('border-gray-700');
                    });
                    e.currentTarget.classList.remove('border-gray-700');
                    e.currentTarget.classList.add('border-red-600', 'bg-red-600/20');
                    
                    document.getElementById('deliveryFields').classList.toggle('hidden', type !== 'delivery');
                    document.getElementById('reservaFields').classList.toggle('hidden', type !== 'reserva');
                    
                    updateCartUI();
                });
            });
            
            // Confirmar pedido
            document.getElementById('confirmOrder').addEventListener('click', submitOrder);
            
            // Notificaciones
            document.getElementById('notificationBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                const panel = document.getElementById('notificationPanel');
                panel.classList.toggle('hidden');
                renderNotifications();
            });
            
            document.getElementById('markAllRead').addEventListener('click', markAllAsRead);
            
            document.addEventListener('click', (e) => {
                const panel = document.getElementById('notificationPanel');
                const btn = document.getElementById('notificationBtn');
                if (!panel.contains(e.target) && !btn.contains(e.target)) {
                    panel.classList.add('hidden');
                }
            });
            
            document.getElementById('notificationList').addEventListener('click', (e) => {
                const item = e.target.closest('.notification-item');
                if (item) {
                    markAsRead(parseInt(item.dataset.id));
                }
            });
            
            // Validaci√≥n referencia de pago
            ['deliveryReference', 'reservaReference'].forEach(id => {
                const field = document.getElementById(id);
                if (field) {
                    field.addEventListener('input', (e) => {
                        e.target.value = e.target.value.replace(/[^a-zA-Z0-9]/g, '').slice(0, 12);
                    });
                }
            });
        });
    </script>
</body>
</html>
