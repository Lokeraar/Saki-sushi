<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üç£ Saki Sushi - Men√∫</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        /* [MANTENER TODOS LOS ESTILOS ORIGINALES - SIN CAMBIOS] */
        :root {
            --primary: #D32F2F;
            --secondary: #212121;
            --accent: #FF9800;
            --light: #F5F5F5;
            --dark: #121212;
            --warm: #FFC107;
            --success: #388E3C;
            --info: #1976D2;
            --warning: #F57C00;
            --danger: #ef4444;
            --shadow: rgba(0, 0, 0, 0.15);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.8)), 
                        url('https://images.unsplash.com/photo-1565299624946-b28f40a0ca4b?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
            min-height: 100vh;
            color: var(--secondary);
        }

        /* Header con men√∫ hamburguesa, sincronizaci√≥n y notificaciones */
        .main-header {
            background: linear-gradient(135deg, var(--primary), #B71C1C);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        .menu-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            padding: 0.5rem;
            transition: var(--transition);
        }

        .menu-toggle:hover {
            transform: scale(1.1);
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-logo img {
            height: 50px;
            border-radius: 10px;
        }

        .header-title {
            color: white;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5rem;
            font-weight: 800;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sync-badge {
            position: relative;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: var(--transition);
            color: white;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .sync-badge:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }
        .sync-badge.syncing {
            animation: pulse 1.5s infinite;
        }

        .notification-badge {
            position: relative;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: var(--transition);
            color: white;
            font-size: 1.5rem;
        }

        .notification-badge:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }

        .notification-badge.has-unread {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .badge-count {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--accent);
            color: var(--secondary);
            font-size: 0.75rem;
            font-weight: 700;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .table-badge {
            background: var(--accent);
            color: var(--secondary);
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-weight: 700;
            font-family: 'Montserrat', sans-serif;
        }

        /* Sidebar Menu */
        .sidebar {
            position: fixed;
            top: 0;
            left: -350px;
            width: 350px;
            height: 100vh;
            background: var(--secondary);
            z-index: 2000;
            transition: left 0.3s ease;
            overflow-y: auto;
            box-shadow: 5px 0 30px rgba(0,0,0,0.5);
        }

        .sidebar.open {
            left: 0;
        }

        .sidebar-header {
            background: linear-gradient(135deg, var(--primary), #B71C1C);
            padding: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h2 {
            color: white;
            font-family: 'Montserrat', sans-serif;
        }

        .close-sidebar {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .sidebar-content {
            padding: 1rem;
        }

        .category-item {
            margin-bottom: 0.5rem;
        }

        .category-btn {
            width: 100%;
            padding: 1rem;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            text-align: left;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-btn:hover, .category-btn.active {
            background: var(--accent);
            color: var(--secondary);
        }

        .subcategory-list {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            padding-left: 1rem;
        }

        .subcategory-list.open {
            max-height: 500px;
        }

        .subcategory-btn {
            width: 100%;
            padding: 0.75rem;
            background: rgba(255,255,255,0.05);
            border: none;
            color: #ccc;
            text-align: left;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 0.5rem;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        .subcategory-btn:hover {
            background: rgba(255,255,255,0.15);
            color: white;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1500;
            display: none;
            backdrop-filter: blur(5px);
        }

        .overlay.show {
            display: block;
        }

        /* Notifications Panel */
        .notifications-panel {
            position: fixed;
            top: 70px;
            right: 20px;
            width: 350px;
            max-height: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 2500;
            display: none;
            overflow: hidden;
            border: 2px solid var(--primary);
        }

        .notifications-panel.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .notifications-header {
            background: linear-gradient(135deg, var(--primary), #B71C1C);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notifications-header h3 {
            font-family: 'Montserrat', sans-serif;
            margin: 0;
        }

        .notifications-list {
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem;
        }

        .notification-item {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: var(--transition);
        }

        .notification-item:hover {
            background: #f5f5f5;
        }

        .notification-item.approved {
            border-left: 4px solid var(--success);
            background: #E8F5E9;
        }

        .notification-item.rejected {
            border-left: 4px solid var(--danger);
            background: #FFEBEE;
        }

        .notification-item.pending {
            border-left: 4px solid var(--warning);
            background: #FFF8E1;
        }

        .notification-time {
            font-size: 0.75rem;
            color: #666;
            margin-top: 0.25rem;
        }

        .notification-status {
            font-weight: 700;
            font-size: 0.875rem;
        }

        .notification-status.approved { color: var(--success); }
        .notification-status.rejected { color: var(--danger); }
        .notification-status.pending { color: var(--warning); }

        .empty-notifications {
            text-align: center;
            padding: 2rem;
            color: #888;
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--light);
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
            overflow: hidden;
            margin-top: 2rem;
            margin-bottom: 2rem;
        }

        .header {
            background: linear-gradient(135deg, var(--primary), #B71C1C);
            color: white;
            padding: 25px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('https://images.unsplash.com/photo-1579584425555-c3ce17fd4351?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80');
            background-size: cover;
            opacity: 0.2;
        }

        .logo-container {
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .logo {
            max-width: 180px;
            height: auto;
            filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.4));
            border-radius: 10px;
        }

        h1 {
            font-size: 3.2em;
            margin-bottom: 5px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.4);
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            position: relative;
            z-index: 1;
            color: white;
            letter-spacing: 1px;
        }

        .subtitle {
            font-size: 1.4em;
            opacity: 0.95;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
            color: var(--warm);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-family: 'Montserrat', sans-serif;
        }

        .tagline {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            position: relative;
            z-index: 1;
            flex-wrap: wrap;
        }

        .tagline-item {
            background: rgba(255, 255, 255, 0.25);
            padding: 8px 15px;
            border-radius: 50px;
            font-size: 0.85em;
            backdrop-filter: blur(5px);
            font-family: 'Montserrat', sans-serif;
            font-weight: 500;
        }

        /* Buscador */
        .search-container {
            position: relative;
            z-index: 1;
            margin-top: 20px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .search-box {
            width: 100%;
            padding: 15px 25px;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            transition: var(--transition);
        }

        .search-box:focus {
            outline: none;
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
            transform: translateY(-2px);
        }

        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary);
            font-size: 1.2rem;
        }

        .sync-status {
            position: fixed;
            top: 80px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9em;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Montserrat', sans-serif;
        }

        .sync-status.online { border: 2px solid var(--success); }
        .sync-status.offline { border: 2px solid var(--primary); }
        .sync-status.syncing { border: 2px solid var(--accent); }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
            padding: 40px 30px;
        }

        @media (max-width: 992px) {
            .menu-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .menu-grid {
                grid-template-columns: 1fr;
            }
            .sidebar {
                width: 100%;
                left: -100%;
            }
            .notifications-panel {
                width: 90%;
                right: 5%;
            }
        }

        .menu-item {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 40px var(--shadow);
            transition: var(--transition);
            border: 2px solid transparent;
            position: relative;
        }

        .menu-item:hover {
            transform: translateY(-10px);
            border-color: var(--accent);
            box-shadow: 0 20px 50px rgba(255, 152, 0, 0.2);
        }

        /* ESTADO AGOTADO */
        .menu-item.agotado {
            opacity: 0.6;
            pointer-events: none;
        }

        .menu-item.agotado .item-image-container {
            filter: grayscale(100%) brightness(0.5);
        }

        .menu-item.agotado::after {
            content: 'AGOTADO';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--secondary);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-weight: bold;
            font-family: 'Montserrat', sans-serif;
            z-index: 10;
            font-size: 1.2rem;
            letter-spacing: 2px;
        }

        .menu-item.disabled {
            opacity: 0.6;
            pointer-events: none;
            filter: grayscale(0.8);
        }

        .menu-item.disabled::after {
            content: 'NO DISPONIBLE';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--primary);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-weight: bold;
            font-family: 'Montserrat', sans-serif;
            z-index: 10;
        }

        /* Imagen del platillo - AHORA CON <img> EN LUGAR DE background-image */
        .item-image-container {
            height: 250px;
            width: 100%;
            position: relative;
            overflow: hidden;
            transition: var(--transition);
            background-color: #f0f0f0;
        }

        .item-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: var(--transition);
        }

        .item-image:hover {
            transform: scale(1.05);
        }

        .item-image-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #e0e0e0, #bdbdbd);
            color: #757575;
            font-size: 3rem;
        }

        .item-image::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(transparent, rgba(0,0,0,0.5));
            pointer-events: none;
        }

        .item-header {
            padding: 25px;
            background: linear-gradient(to right, var(--secondary), #424242);
            color: white;
        }

        .item-name {
            font-size: 1.8em;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Montserrat', sans-serif;
        }

        .item-price {
            font-size: 1.8em;
            color: var(--warm);
            font-weight: 700;
        }

        .item-description {
            color: #E0E0E0;
            font-size: 0.95em;
            line-height: 1.5;
            opacity: 0.9;
            font-family: 'Roboto', sans-serif;
        }

        .item-content {
            padding: 25px;
        }

        .quantity-section {
            background: #F8F8F8;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #E0E0E0;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
        }

        .qty-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, var(--primary), #B71C1C);
            color: white;
            font-size: 1.8em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            box-shadow: 0 5px 15px rgba(211, 47, 47, 0.3);
        }

        .qty-btn:hover:not(:disabled) {
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(211, 47, 47, 0.4);
        }

        .qty-btn:disabled {
            background: #BDBDBD;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .item-quantity {
            font-size: 2.5em;
            font-weight: 700;
            color: var(--secondary);
            min-width: 70px;
            text-align: center;
            font-family: 'Montserrat', sans-serif;
        }

        .item-stock {
            text-align: center;
            font-size: 0.95em;
            padding: 12px;
            border-radius: 10px;
            background: white;
            border: 2px solid;
            font-weight: 600;
            font-family: 'Roboto', sans-serif;
        }

        .available { border-color: var(--success); color: var(--success); }
        .low { border-color: var(--accent); color: var(--accent); }
        .sold-out { border-color: var(--primary); color: var(--primary); }

        .ingredients-section {
            background: #F8F8F8;
            border-radius: 12px;
            padding: 25px;
            margin-top: 15px;
            border: 2px solid #E0E0E0;
            max-height: 800px;
            overflow: hidden;
            transition: max-height 0.5s ease, opacity 0.3s ease, padding 0.3s ease, margin 0.3s ease;
        }

        .ingredients-section.hidden {
            max-height: 0;
            opacity: 0;
            padding: 0;
            margin-top: 0;
            border-width: 0;
        }

        .ingredients-title {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--accent);
        }

        .ingredients-title i {
            color: var(--primary);
            font-size: 1.5em;
        }

        .ingredients-title h3 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            color: var(--secondary);
        }

        .ingredient-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .ingredient-options::-webkit-scrollbar {
            width: 8px;
        }

        .ingredient-options::-webkit-scrollbar-track {
            background: #F0F0F0;
            border-radius: 4px;
        }

        .ingredient-options::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        .ingredient-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            background: white;
            border: 2px solid #E0E0E0;
        }

        .ingredient-option:hover {
            border-color: var(--primary);
            transform: translateX(5px);
        }

        .ingredient-option.complete-option {
            background: linear-gradient(135deg, #E8F5E9, #C8E6C9);
            border: 2px solid var(--success);
        }

        .ingredient-option.complete-option:hover {
            background: linear-gradient(135deg, #C8E6C9, #A5D6A7);
        }

        .ingredient-option.complete-option.selected {
            background: linear-gradient(135deg, var(--success), #2E7D32);
            color: white;
        }

        .ingredient-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid var(--primary);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: var(--transition);
            cursor: pointer;
            position: relative;
        }

        .ingredient-checkbox.checked {
            background: var(--primary);
            border-color: var(--primary);
        }

        .ingredient-checkbox.checked::after {
            content: '‚úì';
            color: white;
            font-size: 14px;
            font-weight: bold;
            position: absolute;
        }

        .ingredient-icon {
            font-size: 1.3em;
            width: 30px;
            text-align: center;
        }

        .ingredient-name {
            font-weight: 500;
            color: var(--secondary);
            font-family: 'Roboto', sans-serif;
        }

        .joke-notice {
            background: linear-gradient(135deg, #FFF3E0, #FFE0B2);
            border: 2px solid var(--warm);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            text-align: center;
            display: none;
            animation: fadeIn 0.5s ease;
            font-family: 'Roboto', sans-serif;
            font-size: 0.9rem;
            color: var(--secondary);
        }

        .joke-notice.show {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .ingredient-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid #E0E0E0;
        }

        .confirm-btn {
            flex: 1;
            padding: 18px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: var(--transition);
            background: linear-gradient(135deg, var(--primary), #B71C1C);
            color: white;
            box-shadow: 0 5px 15px rgba(211, 47, 47, 0.3);
            font-family: 'Montserrat', sans-serif;
        }

        .confirm-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(211, 47, 47, 0.4);
        }

        .confirm-btn:disabled {
            background: #BDBDBD;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .price-adjustment {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #FFF8E1, #FFECB3);
            border-radius: 10px;
            text-align: center;
            border: 2px solid var(--warm);
            display: none;
            animation: pulse 2s infinite;
            font-family: 'Roboto', sans-serif;
        }

        .price-adjustment.show {
            display: block;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.3); }
            50% { box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); }
        }

        .stock-warning {
            background: linear-gradient(135deg, #FFF3E0, #FFE0B2);
            border: 2px solid var(--warning);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            display: none;
            font-family: 'Roboto', sans-serif;
            font-size: 0.9rem;
        }

        .stock-warning.show {
            display: block;
        }

        /* Order Summary - Centered and half width on desktop */
        .order-summary-section {
            background: #F8F8F8;
            padding: 40px 30px;
            margin: 30px auto;
            border-radius: 15px;
            box-shadow: 0 10px 40px var(--shadow);
            border: 3px solid var(--primary);
            max-width: 700px;
            width: 90%;
        }

        .summary-title {
            font-size: 2em;
            color: var(--secondary);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            padding-bottom: 20px;
            border-bottom: 4px solid var(--accent);
            justify-content: center;
        }

        .order-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .order-item-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 5px solid var(--primary);
            transition: var(--transition);
        }

        .order-item-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .delete-item {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--primary);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .delete-item:hover {
            background: #B71C1C;
            transform: scale(1.1);
        }

        .instance-number {
            position: absolute;
            top: 10px;
            left: 10px;
            background: var(--accent);
            color: var(--secondary);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .item-instance {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px dashed #E0E0E0;
        }

        .item-instance:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .order-item-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding-left: 40px;
        }

        .order-item-name {
            font-size: 1.2em;
            color: var(--secondary);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Montserrat', sans-serif;
        }

        .order-item-modifiers {
            font-size: 0.85em;
            color: #616161;
            margin-top: 5px;
            padding: 8px;
            background: #F5F5F5;
            border-radius: 8px;
            border-left: 3px solid var(--accent);
            font-family: 'Roboto', sans-serif;
        }

        .order-item-price {
            font-size: 1.3em;
            font-weight: 700;
            color: var(--primary);
            min-width: 80px;
            text-align: right;
            font-family: 'Montserrat', sans-serif;
        }

        .summary-total-items {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            padding-top: 25px;
            border-top: 4px solid var(--accent);
            font-size: 1.1em;
            font-weight: 600;
            font-family: 'Montserrat', sans-serif;
        }

        .items-total {
            color: var(--primary);
            font-size: 1.5em;
            font-weight: 700;
        }

        /* Order Options for Online Orders */
        .order-options {
            display: none;
            gap: 20px;
            justify-content: center;
            margin: 30px;
            flex-wrap: wrap;
        }

        .order-options.show {
            display: flex;
        }

        .order-option-btn {
            padding: 20px 40px;
            border: none;
            border-radius: 15px;
            font-size: 1.2em;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 15px;
            font-family: 'Montserrat', sans-serif;
            min-width: 250px;
            justify-content: center;
        }

        .order-option-btn.delivery {
            background: linear-gradient(135deg, var(--info), #1565C0);
            color: white;
        }

        .order-option-btn.reserva {
            background: linear-gradient(135deg, var(--success), #2E7D32);
            color: white;
        }

        .order-option-btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        /* Standard Order Button */
        .order-section {
            padding: 40px;
            text-align: center;
            background: linear-gradient(135deg, var(--secondary), #424242);
            margin: 30px;
            border-radius: 15px;
            display: none;
        }

        .order-section.show {
            display: block;
        }

        .order-btn {
            background: linear-gradient(135deg, var(--primary), #B71C1C);
            color: white;
            border: none;
            padding: 25px 80px;
            font-size: 1.6em;
            font-weight: 700;
            border-radius: 50px;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 10px 30px rgba(211, 47, 47, 0.4);
            font-family: 'Montserrat', sans-serif;
        }

        .order-btn:hover:not(:disabled) {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 40px rgba(211, 47, 47, 0.5);
        }

        .order-btn:disabled {
            background: #BDBDBD;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Thank You Message */
        .thank-you {
            background: linear-gradient(135deg, var(--success), #2E7D32);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-top: 30px;
            text-align: center;
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .thank-you.show {
            display: block;
        }

        .thank-you h3 {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .thank-you p {
            font-size: 1.2rem;
            margin-bottom: 15px;
        }

        .thank-you .japanese {
            font-size: 1.5rem;
            color: var(--warm);
            font-weight: 700;
        }

        .thank-you .payment-info-text {
            font-size: 1rem;
            margin-top: 10px;
            padding: 15px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
        }

        /* Footer - 3 columns */
        .footer {
            background: var(--secondary);
            color: white;
            padding: 40px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .footer {
                grid-template-columns: 1fr;
            }
        }

        .footer-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .footer-logo {
            max-width: 120px;
            height: auto;
            margin-bottom: 10px;
            filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.4));
            border-radius: 10px;
        }

        .footer-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            color: var(--warm);
            font-size: 1.2rem;
        }

        .footer-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            font-size: 0.95em;
        }

        .footer-item strong {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            color: var(--accent);
        }

        .footer-item a {
            color: white;
            text-decoration: none;
            transition: var(--transition);
        }

        .footer-item a:hover {
            color: var(--accent);
            text-decoration: underline;
        }

        .social-media {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }

        .social-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: white;
            transition: var(--transition);
            text-decoration: none;
        }

        .social-icon:hover {
            background: var(--accent);
            transform: translateY(-5px) scale(1.1);
            color: var(--secondary);
        }

        .whatsapp-link {
            color: #25D366;
            font-weight: 600;
            font-size: 1.1em;
            font-family: 'Montserrat', sans-serif;
        }

        .whatsapp-link:hover {
            color: #1da851;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary), #B71C1C);
            color: white;
            padding: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--secondary);
            font-family: 'Montserrat', sans-serif;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #E0E0E0;
            border-radius: 10px;
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-group select {
            background: white;
            cursor: pointer;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-group .error {
            color: var(--primary);
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
        }

        .form-group .error.show {
            display: block;
        }

        .payment-info {
            background: #F5F5F5;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid var(--accent);
        }

        .payment-info h3 {
            font-family: 'Montserrat', sans-serif;
            margin-bottom: 15px;
            color: var(--secondary);
        }

        .payment-detail {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #ccc;
        }

        .payment-detail:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--primary);
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: block;
            padding: 15px;
            background: #F5F5F5;
            border: 2px dashed var(--primary);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .file-input-label:hover {
            background: #FFEBEE;
        }

        .file-input-label.has-file {
            background: #E8F5E9;
            border-color: var(--success);
        }

        .modal-footer {
            padding: 25px;
            border-top: 2px solid #F0F0F0;
            display: flex;
            gap: 15px;
        }

        .btn-modal {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            font-family: 'Montserrat', sans-serif;
        }

        .btn-modal.secondary {
            background: #F5F5F5;
            color: var(--secondary);
        }

        .btn-modal.primary {
            background: linear-gradient(135deg, var(--primary), #B71C1C);
            color: white;
        }

        .btn-modal:disabled {
            background: #BDBDBD;
            cursor: not-allowed;
        }

        .btn-modal:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* Estilos para el campo de fecha */
        .date-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #E0E0E0;
            border-radius: 10px;
            font-size: 1rem;
            transition: var(--transition);
        }

        .date-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Estilos para el c√≥digo de referencia */
        .reference-code-container {
            display: flex;
            gap: 8px;
            justify-content: space-between;
        }

        .reference-digit {
            width: 60px;
            height: 60px;
            text-align: center;
            font-size: 1.8rem;
            font-weight: 700;
            border: 2px solid #E0E0E0;
            border-radius: 10px;
            transition: var(--transition);
        }

        .reference-digit:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(211, 47, 47, 0.2);
        }

        /* Confirmation Modal */
        .confirmation-modal .order-review {
            background: #F8F8F8;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .review-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #E0E0E0;
        }

        .review-item:last-child {
            border-bottom: none;
        }

        .review-total {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            background: var(--secondary);
            color: white;
            border-radius: 10px;
            margin-top: 15px;
            font-weight: 700;
            font-size: 1.2rem;
        }

        /* Timer */
        .payment-timer {
            background: linear-gradient(135deg, var(--warning), #F57C00);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            font-family: 'Montserrat', sans-serif;
        }

        .timer-display {
            font-size: 2rem;
            font-weight: 700;
            margin-top: 10px;
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 4000;
            color: white;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--secondary);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 5000;
            display: none;
            animation: slideUp 0.3s ease;
            font-family: 'Montserrat', sans-serif;
        }

        .toast.show {
            display: block;
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--primary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            h1 { font-size: 2rem; }
            .menu-grid { padding: 20px; grid-template-columns: 1fr; }
            .item-name { font-size: 1.3em; flex-direction: column; align-items: flex-start; }
            .order-summary-section { width: 95%; padding: 20px; }
            .order-option-btn { min-width: 100%; }
            .modal-content { margin: 10px; }
            .search-container { margin: 20px 15px; }
            .reference-digit { width: 45px; height: 45px; font-size: 1.4rem; }
        }

        /* Warning text for payment timeout */
        .payment-warning-text {
            background: linear-gradient(135deg, #FFF3E0, #FFE0B2);
            border: 2px solid var(--warning);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            color: var(--secondary);
        }

        .payment-warning-text i {
            color: var(--warning);
            margin-right: 8px;
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Sidebar Overlay -->
    <div class="overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <!-- Sidebar Menu -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>üç£ Categor√≠as</h2>
            <button class="close-sidebar" onclick="closeSidebar()"><i class="fas fa-times"></i></button>
        </div>
        <div class="sidebar-content" id="sidebarContent">
            <!-- Categories loaded dynamically -->
        </div>
    </div>

    <!-- Notifications Panel -->
    <div class="notifications-panel" id="notificationsPanel">
        <div class="notifications-header">
            <h3><i class="fas fa-bell"></i> Mis Pedidos</h3>
            <button class="close-sidebar" onclick="toggleNotifications()" style="background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="notifications-list" id="notificationsList">
            <div class="empty-notifications">
                <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                <p>No tienes pedidos pendientes</p>
            </div>
        </div>
    </div>

    <!-- Main Header -->
    <header class="main-header">
        <button class="menu-toggle" onclick="openSidebar()"><i class="fas fa-bars"></i></button>
        <div class="header-logo">
            <img src="https://lh3.googleusercontent.com/pw/AP1GczPrZAoWxmsOGRD9xl1hO5Q65JXuwUZzoR6gUk-cw5lVmarxQe_-lwqpA60tTKLlXfpvIjAJlKC6jFls-xETJOPkebLIIPhbGlUkknmhrRbdhMUll2UViGSUj3WmHKg2YEsZlAfxBPPTjIHhScjD0jfe=w1439-h1439-s-no-gm" alt="Saki Sushi">
            <span class="header-title">Saki Sushi</span>
        </div>
        <div class="header-actions">
            <!-- Bot√≥n de sincronizaci√≥n manual -->
            <div class="sync-badge" onclick="sincronizarManual()" title="Sincronizar con servidor">
                <i class="fas fa-sync-alt" id="manualSyncIcon"></i>
                <span style="font-size: 0.7rem; background: var(--accent); color: black; padding: 2px 5px; border-radius: 12px;">JSONbin</span>
            </div>
            <div class="notification-badge" id="notificationBadge" onclick="toggleNotifications()">
                <i class="fas fa-bell"></i>
                <span class="badge-count" id="badgeCount" style="display: none;">0</span>
            </div>
            <div class="table-badge" id="tableBadge" style="display: none;">Mesa #<span id="tableNumber">--</span></div>
        </div>
    </header>

    <!-- Sync Status -->
    <div class="sync-status offline" id="syncStatus">
        <i class="fas fa-sync-alt"></i>
        <span>Sincronizando...</span>
    </div>

    <!-- Main Container -->
    <div class="container" id="mainContainer">
        <div class="header">
            <div class="logo-container">
                <img src="https://lh3.googleusercontent.com/pw/AP1GczPrZAoWxmsOGRD9xl1hO5Q65JXuwUZzoR6gUk-cw5lVmarxQe_-lwqpA60tTKLlXfpvIjAJlKC6jFls-xETJOPkebLIIPhbGlUkknmhrRbdhMUll2UViGSUj3WmHKg2YEsZlAfxBPPTjIHhScjD0jfe=w1439-h1439-s-no-gm" alt="Saki Sushi Logo" class="logo">
            </div>
            <h1>Saki Sushi</h1>
            <p class="subtitle">Adictos al universo saki</p>
            <div class="tagline">
                <div class="tagline-item">üêü Fresco del d√≠a</div>
                <div class="tagline-item">üéå Tradicional</div>
                <div class="tagline-item">üë®‚Äçüç≥ Chef experto</div>
            </div>
            
            <!-- Buscador -->
            <div class="search-container">
                <input type="text" class="search-box" id="searchInput" placeholder="Buscar platillo por nombre..." oninput="buscarPlatillos()">
                <i class="fas fa-search search-icon"></i>
            </div>
        </div>

        <div class="menu-grid" id="menuGrid">
        </div>

        <div class="order-summary-section">
            <div class="summary-title">
                <i class="fas fa-shopping-cart"></i>
                Tu pedido
            </div>
            
            <div id="orderSummaryContent">
                <div class="empty-summary" style="text-align: center; padding: 40px; color: #888; font-style: italic;">
                    <i class="fas fa-utensils" style="font-size: 3em; margin-bottom: 20px; color: var(--primary);"></i>
                    <p style="font-size: 1.2em;">A√∫n no has seleccionado ning√∫n platillo</p>
                    <p style="margin-top: 10px;">Usa los botones + para comenzar tu pedido</p>
                </div>
            </div>
        </div>

        <!-- Online Order Options -->
        <div class="order-options" id="onlineOrderOptions">
            <button class="order-option-btn delivery" onclick="showDeliveryModal()">
                <i class="fas fa-motorcycle"></i>
                Pedir Delivery
            </button>
            <button class="order-option-btn reserva" onclick="showReservaModal()">
                <i class="fas fa-calendar-check"></i>
                Pedir Reserva
            </button>
        </div>

        <!-- In-Restaurant Order Button -->
        <div class="order-section" id="restaurantOrderSection">
            <button class="order-btn" id="orderBtn" onclick="showConfirmationModal()" disabled>
                <i class="fas fa-check-circle"></i>
                CONFIRMAR PEDIDO
            </button>
        </div>

        <div class="thank-you" id="thankYouMessage">
            <h3><i class="fas fa-check-circle"></i> ¬°Pedido Confirmado!</h3>
            <p id="thankYouText">Tu pedido ha sido procesado, estar√° listo lo antes posible</p>
            <p class="japanese">Gok≈çny≈´ arigat≈ç gozaimasu</p>
            <div id="thankYouExtraContent"></div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <div class="footer-column">
                <h3 class="footer-title">Horario</h3>
                <div class="footer-item">
                    <i class="fas fa-clock" style="font-size: 1.5rem; color: var(--accent); margin-bottom: 10px;"></i>
                    <strong>Abierto:</strong>
                    <span>11:30am a 10:00pm</span>
                </div>
            </div>
            
            <div class="footer-column">
                <h3 class="footer-title">Av Universidad</h3>
                <div class="footer-item">
                    <i class="fas fa-map-marker-alt" style="font-size: 1.5rem; color: var(--accent); margin-bottom: 10px;"></i>
                    <strong>Caracas</strong>
                    <a href="https://wa.me/5804242884773" class="whatsapp-link" target="_blank">+58 0424-2884773</a>
                    <a href="https://wa.me/5804242884772" class="whatsapp-link" target="_blank">+58 0424-2884772</a>
                </div>
            </div>
            
            <div class="footer-column">
                <h3 class="footer-title">San Bernardino</h3>
                <div class="footer-item">
                    <i class="fas fa-map-marker-alt" style="font-size: 1.5rem; color: var(--accent); margin-bottom: 10px;"></i>
                    <strong>Caracas</strong>
                    <a href="https://wa.me/5804241722322" class="whatsapp-link" target="_blank">+58 0424-1722322</a>
                    <a href="https://wa.me/5804241722339" class="whatsapp-link" target="_blank">+58 0424-1722339</a>
                </div>
            </div>
        </div>

        <div class="footer" style="background: #1a1a1a; padding: 20px;">
            <div class="social-media" style="grid-column: 1 / -1; justify-content: center;">
                <a href="https://www.tiktok.com/@sakisushiccs" class="social-icon" target="_blank">
                    <i class="fab fa-tiktok"></i>
                </a>
                <a href="https://www.instagram.com/sakisushiccs" class="social-icon" target="_blank">
                    <i class="fab fa-instagram"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Delivery Modal -->
    <div class="modal-overlay" id="deliveryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-motorcycle"></i> Pedir Delivery</h2>
                <button class="modal-close" onclick="closeModal('deliveryModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <!-- Advertencia de tiempo de pago -->
                <div class="payment-warning-text">
                    <i class="fas fa-clock"></i>
                    Tienes 20 minutos para realizar el pago, de lo contrario tu pedido ser√° cancelado
                </div>
                
                <div class="payment-info">
                    <h3>Datos de Pago - Pago M√≥vil</h3>
                    <div class="payment-detail"><span>Banco:</span> <strong>Banco de Venezuela</strong></div>
                    <div class="payment-detail"><span>Tel√©fono:</span> <strong>0424-1232703</strong></div>
                    <div class="payment-detail"><span>C√©dula:</span> <strong>V-24203422</strong></div>
                    <div class="payment-detail"><span>Monto:</span> <strong id="deliveryMonto">Bs. 0,00</strong></div>
                </div>
                
                <p style="color: var(--primary); font-weight: 600; margin-bottom: 20px; text-align: center;">
                    <i class="fas fa-exclamation-circle"></i> Solo se aceptan pagos por Pago M√≥vil
                </p>
                
                <p style="color: #666; font-size: 0.9rem; margin-bottom: 20px; font-style: italic;">
                    <i class="fas fa-info-circle"></i> Si introduce mal la direcci√≥n y/o el n√∫mero de contacto, la empresa no se hace responsable de que su pedido no llegue.
                </p>

                <div class="form-group">
                    <label>Direcci√≥n completa *</label>
                    <textarea id="deliveryDireccion" rows="3" placeholder="Introduce tu direcci√≥n completa (m√≠nimo 20 caracteres)" oninput="validateDeliveryForm()"></textarea>
                    <div class="error" id="direccionError">La direcci√≥n debe tener al menos 20 caracteres</div>
                </div>

                <div class="form-group">
                    <label>N√∫mero de contacto *</label>
                    <input type="tel" id="deliveryTelefono" placeholder="Ej: 0412-1234567" oninput="validateDeliveryForm()">
                    <div class="error" id="telefonoError">El n√∫mero debe tener entre 11 y 14 caracteres</div>
                </div>

                <div class="form-group">
                    <label>C√≥digo de referencia *</label>
                    <div class="reference-code-container" id="deliveryReferenceContainer">
                        <input type="text" class="reference-digit" maxlength="1" oninput="moveToNextRef(this, 'delivery', 0)" onkeydown="handleRefKeypress(event, 'delivery', 0)">
                        <input type="text" class="reference-digit" maxlength="1" oninput="moveToNextRef(this, 'delivery', 1)" onkeydown="handleRefKeypress(event, 'delivery', 1)">
                        <input type="text" class="reference-digit" maxlength="1" oninput="moveToNextRef(this, 'delivery', 2)" onkeydown="handleRefKeypress(event, 'delivery', 2)">
                        <input type="text" class="reference-digit" maxlength="1" oninput="moveToNextRef(this, 'delivery', 3)" onkeydown="handleRefKeypress(event, 'delivery', 3)">
                        <input type="text" class="reference-digit" maxlength="1" oninput="moveToNextRef(this, 'delivery', 4)" onkeydown="handleRefKeypress(event, 'delivery', 4)">
                        <input type="text" class="reference-digit" maxlength="1" oninput="moveToNextRef(this, 'delivery', 5)" onkeydown="handleRefKeypress(event, 'delivery', 5)">
                    </div>
                    <div class="error" id="referenciaErrorDelivery">Debe ingresar un c√≥digo de 6 d√≠gitos</div>
                </div>

                <div class="form-group">
                    <label>Comprobante de pago *</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="deliveryComprobante" accept="image/*" onchange="handleFileSelect(this, 'deliveryFileLabel')">
                        <label for="deliveryComprobante" class="file-input-label" id="deliveryFileLabel">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: var(--primary); margin-bottom: 10px; display: block;"></i>
                            Haz clic para subir el comprobante de pago
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal secondary" onclick="closeModal('deliveryModal')">Cancelar</button>
                <button class="btn-modal primary" id="btnConfirmDelivery" onclick="confirmDelivery()" disabled>
                    Confirmar Pedido
                </button>
            </div>
        </div>
    </div>

    <!-- Reserva Modal -->
    <div class="modal-overlay" id="reservaModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-calendar-check"></i> Pedir Reserva</h2>
                <button class="modal-close" onclick="closeModal('reservaModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <!-- Advertencia de tiempo de pago -->
                <div class="payment-warning-text">
                    <i class="fas fa-clock"></i>
                    Tienes 20 minutos para realizar el pago, de lo contrario tu reserva ser√° cancelada
                </div>
                
                <div class="payment-info">
                    <h3>Datos de Pago - Pago M√≥vil</h3>
                    <div class="payment-detail"><span>Banco:</span> <strong>Banco de Venezuela</strong></div>
                    <div class="payment-detail"><span>Tel√©fono:</span> <strong>0424-1232703</strong></div>
                    <div class="payment-detail"><span>C√©dula:</span> <strong>V-24203422</strong></div>
                    <div class="payment-detail"><span>Monto:</span> <strong id="reservaMonto">Bs. 0,00</strong></div>
                </div>
                
                <p style="color: var(--primary); font-weight: 600; margin-bottom: 20px; text-align: center;">
                    <i class="fas fa-exclamation-circle"></i> Solo se aceptan pagos por Pago M√≥vil
                </p>

                <div class="form-group">
                    <label>Selecciona la fecha de reserva *</label>
                    <input type="date" class="date-input" id="reservaFecha" min="" onchange="validateReservaForm()">
                </div>

                <div class="form-group">
                    <label>Nombre y apellido *</label>
                    <input type="text" id="reservaNombre" placeholder="Tu nombre completo" oninput="validateReservaForm()">
                </div>

                <div class="form-group">
                    <label>C√≥digo de referencia *</label>
                    <div class="reference-code-container" id="reservaReferenceContainer">
                        <input type="text" class="reference-digit" maxlength="1" oninput="moveToNextRef(this, 'reserva', 0)" onkeydown="handleRefKeypress(event, 'reserva', 0)">
                        <input type="text" class="reference-digit" maxlength="1" oninput="moveToNextRef(this, 'reserva', 1)" onkeydown="handleRefKeypress(event, 'reserva', 1)">
                        <input type="text" class="reference-digit" maxlength="1" oninput="moveToNextRef(this, 'reserva', 2)" onkeydown="handleRefKeypress(event, 'reserva', 2)">
                        <input type="text" class="reference-digit" maxlength="1" oninput="moveToNextRef(this, 'reserva', 3)" onkeydown="handleRefKeypress(event, 'reserva', 3)">
                        <input type="text" class="reference-digit" maxlength="1" oninput="moveToNextRef(this, 'reserva', 4)" onkeydown="handleRefKeypress(event, 'reserva', 4)">
                        <input type="text" class="reference-digit" maxlength="1" oninput="moveToNextRef(this, 'reserva', 5)" onkeydown="handleRefKeypress(event, 'reserva', 5)">
                    </div>
                    <div class="error" id="referenciaErrorReserva">Debe ingresar un c√≥digo de 6 d√≠gitos</div>
                </div>

                <div class="form-group">
                    <label>Comprobante de pago *</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="reservaComprobante" accept="image/*" onchange="handleFileSelect(this, 'reservaFileLabel')">
                        <label for="reservaComprobante" class="file-input-label" id="reservaFileLabel">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: var(--primary); margin-bottom: 10px; display: block;"></i>
                            Haz clic para subir el comprobante de pago
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal secondary" onclick="closeModal('reservaModal')">Cancelar</button>
                <button class="btn-modal primary" id="btnConfirmReserva" onclick="confirmReserva()" disabled>
                    Confirmar Reserva
                </button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal-overlay confirmation-modal" id="confirmationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-clipboard-check"></i> Confirmar Pedido</h2>
                <button class="modal-close" onclick="closeModal('confirmationModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; color: #666;">Por favor, revisa tu pedido antes de confirmar:</p>
                
                <div class="order-review" id="orderReview">
                    <!-- Order items loaded dynamically -->
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <label>Tu nombre (opcional)</label>
                    <input type="text" id="customerName" placeholder="¬øC√≥mo te llamas?">
                </div>

                <p style="color: var(--primary); font-weight: 600; margin-top: 20px; text-align: center;">
                    <i class="fas fa-info-circle"></i> El pedido ser√° llevado a la <span id="confirmTableNumber">Mesa #--</span>
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn-modal secondary" onclick="closeModal('confirmationModal')">Volver</button>
                <button class="btn-modal primary" onclick="finalConfirmOrder()">
                    Confirmar Pedido
                </button>
            </div>
        </div>
    </div>

    <script>
        // =========================================
        // CONFIGURACI√ìN JSONBin.io
        // =========================================
        const JSONBIN_CONFIG = {
            BIN_ID: '69879d6e43b1c97be96d2b13',
            API_KEY: '$2a$10$.klBAMlOBlE9CoVh5iUFf.x3LEYKWiP6hhvvPETK9e8pyIuNB2F4K',
            BASE_URL: 'https://api.jsonbin.io/v3/b'
        };

        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let sistemaData = null;
        let menuItems = [];
        let currentCategory = 'todos';
        let currentSubcategory = null;
        let pedidoActual = [];
        let isInRestaurant = false;
        let tableNumber = null;
        let selectedDate = null;
        let sessionId = null;
        let pedidosCliente = [];
        let searchTerm = '';
        let isInitialized = false;
        
        // Control de sincronizaci√≥n
        let lastSyncTime = 0;
        const SYNC_COOLDOWN = 60000;
        let syncIntervalId = null;
        let isManualSyncing = false;
        
        // Cach√© de stock
        let stockCache = {};
        let lastStockUpdate = 0;
        const STOCK_CACHE_DURATION = 5000;

        // Timers para pedidos online (delivery/reserva)
        let pedidosConTimer = {};

        // ==========================================
        // INICIALIZACI√ìN SIN VERIFICACI√ìN DE UBICACI√ìN
        // ==========================================
        function initApp() {
            if (isInitialized) return;
            isInitialized = true;
            
            showLoading();
            
            // Verificar si hay mesa en URL
            const urlParams = new URLSearchParams(window.location.search);
            const mesaUrl = urlParams.get('mesa');
            
            if (mesaUrl) {
                isInRestaurant = true;
                tableNumber = mesaUrl;
                
                document.getElementById('tableNumber').textContent = mesaUrl;
                document.getElementById('tableBadge').style.display = 'block';
                document.getElementById('confirmTableNumber').textContent = `Mesa #${mesaUrl}`;
                document.getElementById('onlineOrderOptions').classList.remove('show');
                document.getElementById('restaurantOrderSection').classList.add('show');
            } else {
                // Modo online (delivery/reserva)
                document.getElementById('onlineOrderOptions').classList.add('show');
            }
            
            cargarDatosDesdeCache();
            
            try {
                sincronizarUnaVez().then(() => {
                    renderSidebar();
                    renderMenu();
                    updateOrderSummary();
                    actualizarEstadoSync('online');
                    
                    iniciarVerificacionPedidos();
                    
                    // Sincronizaci√≥n autom√°tica cada 3 minutos
                    if (syncIntervalId) clearInterval(syncIntervalId);
                    syncIntervalId = setInterval(() => {
                        sincronizarAutomatica();
                    }, 180000);
                    
                    hideLoading();
                }).catch(() => {
                    renderSidebar();
                    renderMenu();
                    updateOrderSummary();
                    actualizarEstadoSync('offline');
                    hideLoading();
                });
            } catch (error) {
                console.error('Error inicializando app:', error);
                showToast('Error al cargar. Verifica tu conexi√≥n.', 'error');
                actualizarEstadoSync('offline');
                hideLoading();
            }
        }

        function cargarDatosDesdeCache() {
            const cachedData = localStorage.getItem('sakiMenuCache');
            if (cachedData) {
                try {
                    sistemaData = JSON.parse(cachedData);
                    sincronizarMenuLocal();
                    renderSidebar();
                    renderMenu();
                } catch (e) {
                    console.error('Error parsing cached data:', e);
                }
            }
        }

        // ==========================================
        // SISTEMA DE SINCRONIZACI√ìN NO BLOQUEANTE
        // ==========================================
        async function sincronizarUnaVez(skipCooldown = false) {
            const ahora = Date.now();
            if (!skipCooldown && (ahora - lastSyncTime < SYNC_COOLDOWN)) {
                console.log('Sincronizaci√≥n omitida - en cooldown');
                return false;
            }
            
            actualizarEstadoSync('syncing');
            
            try {
                const response = await fetch(`${JSONBIN_CONFIG.BASE_URL}/${JSONBIN_CONFIG.BIN_ID}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': JSONBIN_CONFIG.API_KEY,
                        'X-Bin-Meta': 'false'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data || typeof data !== 'object') {
                    throw new Error('Datos inv√°lidos recibidos');
                }
                
                // PRESERVAR EL ESTADO LOCAL
                const pedidoGuardado = menuItems.map(item => ({
                    id: item.id,
                    quantity: item.quantity,
                    instances: item.instances ? [...item.instances] : [],
                    totalOrdered: item.totalOrdered,
                    currentSelections: item.currentSelections ? new Set(item.currentSelections) : new Set(),
                    selectionType: item.selectionType
                }));
                
                if (!data.menu) data.menu = [];
                if (!data.inventario) data.inventario = {};
                if (!data.pedidos) data.pedidos = [];
                if (!data.config) data.config = { tasaCambio: 400 };
                
                sistemaData = data;
                localStorage.setItem('sakiMenuCache', JSON.stringify(data));
                
                sincronizarMenuLocal();
                
                // RESTAURAR estado local del pedido
                menuItems.forEach(item => {
                    const guardado = pedidoGuardado.find(p => p.id === item.id);
                    if (guardado) {
                        item.quantity = guardado.quantity || 0;
                        item.instances = guardado.instances || [];
                        item.totalOrdered = guardado.totalOrdered || 0;
                        item.currentSelections = guardado.currentSelections || new Set();
                        item.selectionType = guardado.selectionType || "completo";
                    }
                });
                
                actualizarEstadoSync('online');
                lastSyncTime = ahora;
                return true;
                
            } catch (error) {
                console.error('Error sincronizando:', error);
                actualizarEstadoSync('offline');
                return false;
            }
        }

        async function sincronizarAutomatica() {
            if (isManualSyncing) return;
            const sincronizado = await sincronizarUnaVez(true);
            if (sincronizado) {
                renderMenu();
            }
        }

        async function sincronizarManual() {
            if (isManualSyncing) {
                showToast('Ya hay una sincronizaci√≥n en curso...', 'info');
                return;
            }
            
            isManualSyncing = true;
            const syncIcon = document.getElementById('manualSyncIcon');
            const originalClass = syncIcon.className;
            syncIcon.className = 'fas fa-sync-alt fa-spin';
            
            showToast('Sincronizando con servidor...', 'success');
            
            const sincronizado = await sincronizarUnaVez(true);
            
            if (sincronizado) {
                renderMenu();
                updateOrderSummary();
                showToast('¬°Men√∫ sincronizado!', 'success');
            } else {
                showToast('Error al sincronizar. Modo offline.', 'error');
            }
            
            syncIcon.className = originalClass;
            isManualSyncing = false;
        }

        function sincronizarMenuLocal() {
            if (!sistemaData.menu) sistemaData.menu = [];
            
            const pedidoGuardado = menuItems.map(item => ({
                id: item.id,
                quantity: item.quantity,
                instances: item.instances ? [...item.instances] : [],
                totalOrdered: item.totalOrdered,
                currentSelections: item.currentSelections ? new Set(item.currentSelections) : new Set(),
                selectionType: item.selectionType
            }));
            
            menuItems = sistemaData.menu.map(item => {
                const itemEnPedido = pedidoGuardado.find(p => p.id === item.id);
                
                return {
                    id: item.id,
                    name: item.nombre,
                    category: item.categoria,
                    subcategory: item.subcategoria,
                    basePrice: item.precio,
                    description: item.descripcion,
                    ingredients: item.ingredientes || {},
                    stock: item.stock || 0,
                    stockMaximo: item.stockMaximo || item.stock || 0,
                    disponible: item.disponible === true,
                    imagen: item.imagen || null,
                    quantity: itemEnPedido ? itemEnPedido.quantity : 0,
                    instances: itemEnPedido ? itemEnPedido.instances : [],
                    totalOrdered: itemEnPedido ? itemEnPedido.totalOrdered : 0,
                    currentSelections: itemEnPedido ? new Set(itemEnPedido.currentSelections) : new Set(),
                    selectionType: itemEnPedido ? itemEnPedido.selectionType : "completo"
                };
            });
            
            stockCache = {};
            lastStockUpdate = 0;
        }

        // ==========================================
        // FUNCIONES CORREGIDAS PARA RESERVAR STOCK
        // ==========================================
        function calcularReservadoConCache(ingredienteId) {
            const ahora = Date.now();
            
            if (ahora - lastStockUpdate > STOCK_CACHE_DURATION) {
                stockCache = {};
                lastStockUpdate = ahora;
            }
            
            if (stockCache[ingredienteId] !== undefined) {
                return stockCache[ingredienteId];
            }
            
            let total = 0;
            
            if (sistemaData && sistemaData.pedidos) {
                sistemaData.pedidos.forEach(pedido => {
                    if (pedido.estado === 'pendiente' || 
                        pedido.estado === 'cobrado' || 
                        pedido.estado === 'en_cocina' || 
                        pedido.estado === 'en_camino' || 
                        pedido.estado === 'reserva_pendiente' || 
                        pedido.estado === 'reserva_atendida') {
                        
                        pedido.items?.forEach(item => {
                            if (item.personalizacion && !item.personalizacion.includes(ingredienteId)) {
                                const platillo = sistemaData.menu.find(p => p.id === item.platilloId);
                                if (platillo && platillo.ingredientes && platillo.ingredientes[ingredienteId]) {
                                    const cantidadIngrediente = platillo.ingredientes[ingredienteId].cantidad || 0;
                                    total += cantidadIngrediente * (item.cantidad || 1);
                                }
                            }
                        });
                    }
                });
            }
            
            menuItems.forEach(item => {
                if (item.instances && item.ingredients && item.ingredients[ingredienteId]) {
                    item.instances.forEach(inst => {
                        if (!inst.removedIngredients.includes(ingredienteId) && inst.confirmada === true) {
                            total += item.ingredients[ingredienteId].cantidad || 0;
                        }
                    });
                }
            });
            
            stockCache[ingredienteId] = total;
            return total;
        }

        function verificarIngredientesPrincipales(item) {
            if (!item.ingredients || Object.keys(item.ingredients).length === 0) {
                return { disponible: true, faltantes: [] };
            }
            
            const faltantes = [];
            let disponible = true;
            
            Object.entries(item.ingredients).forEach(([key, ingData]) => {
                if (!ingData.obligatorio) {
                    const stockIng = sistemaData?.inventario?.[key]?.stock || 0;
                    const reservado = calcularReservadoConCache(key);
                    const stockReal = stockIng - reservado;
                    
                    if (stockReal <= 0) {
                        faltantes.push(sistemaData?.inventario?.[key]?.nombre || key);
                        disponible = false;
                    }
                }
            });
            
            return { disponible, faltantes };
        }

        // ==========================================
        // CREACI√ìN DE PEDIDO
        // ==========================================
        function crearPedidoBase() {
            const pedido = {
                id: 'PED-' + Date.now() + '-' + Math.random().toString(36).substring(2, 8),
                timestamp: new Date().toISOString(),
                estado: 'pendiente',
                items: [],
                total: 0,
                metodoPago: 'pago_movil',
                cajero: null,
                tiempoPreparacion: null,
                origen: 'cliente_web'
            };
            
            const tasaActual = obtenerTasaEfectiva();
            
            menuItems.forEach(item => {
                if (item.instances) {
                    item.instances.filter(inst => inst.confirmada).forEach(instance => {
                        const precioEnBs = instance.price || 0;
                        
                        pedido.items.push({
                            platilloId: item.id,
                            nombre: item.name,
                            cantidad: 1,
                            personalizacion: instance.removedIngredients || [],
                            precioUnitarioUSD: item.basePrice || 0,
                            precioEnBs: Number(precioEnBs.toFixed(2)),
                            subtotal: Number(precioEnBs.toFixed(2)),
                            descuentoPorIngredientes: Number((instance.descuentoPorIngredientes || 0).toFixed(2)),
                            tasaCambioAplicada: tasaActual
                        });
                        
                        pedido.total += precioEnBs;
                    });
                }
            });
            
            pedido.total = Number(pedido.total.toFixed(2));
            return pedido;
        }

        async function guardarPedido(pedido) {
            try {
                const comprobanteBase64 = pedido.comprobanteBase64;
                const comprobanteNombre = pedido.comprobanteNombre;
                
                const pedidoParaJSONbin = {
                    id: pedido.id,
                    timestamp: pedido.timestamp,
                    estado: pedido.estado,
                    tipo: pedido.tipo,
                    items: pedido.items.map(item => ({
                        platilloId: item.platilloId,
                        nombre: item.nombre,
                        cantidad: item.cantidad,
                        personalizacion: item.personalizacion,
                        precioUnitarioUSD: Number(item.precioUnitarioUSD.toFixed(2)),
                        precioEnBs: Number(item.precioEnBs.toFixed(2)),
                        subtotal: Number(item.subtotal.toFixed(2)),
                        descuentoPorIngredientes: Number((item.descuentoPorIngredientes || 0).toFixed(2)),
                        tasaCambioAplicada: item.tasaCambioAplicada
                    })),
                    total: Number(pedido.total.toFixed(2)),
                    metodoPago: pedido.metodoPago || 'pago_movil',
                    cajero: pedido.cajero || null,
                    tiempoPreparacion: pedido.tiempoPreparacion || null,
                    origen: pedido.origen || 'cliente_web',
                    mesa: pedido.mesa || null,
                    direccion: pedido.direccion || null,
                    telefono: pedido.telefono || null,
                    referencia: pedido.referencia || null,
                    fechaReserva: pedido.fechaReserva || null,
                    clienteNombre: pedido.clienteNombre || null,
                    tieneComprobante: !!comprobanteBase64,
                    comprobanteNombre: comprobanteNombre || null
                };

                let dataActual;
                try {
                    const getResponse = await fetch(`${JSONBIN_CONFIG.BASE_URL}/${JSONBIN_CONFIG.BIN_ID}/latest`, {
                        method: 'GET',
                        headers: {
                            'X-Master-Key': JSONBIN_CONFIG.API_KEY,
                            'X-Bin-Meta': 'false'
                        }
                    });
                    
                    if (getResponse.ok) {
                        dataActual = await getResponse.json();
                    } else {
                        dataActual = sistemaData || { menu: [], inventario: {}, pedidos: [], config: { tasaCambio: 400 } };
                    }
                } catch (e) {
                    dataActual = sistemaData || { menu: [], inventario: {}, pedidos: [], config: { tasaCambio: 400 } };
                }

                const dataToSave = {
                    menu: dataActual.menu || [],
                    inventario: dataActual.inventario || {},
                    pedidos: [...(dataActual.pedidos || []), pedidoParaJSONbin],
                    config: dataActual.config || { tasaCambio: 400, aumentoDiario: 0, aumentoActivo: false }
                };

                const payloadSize = JSON.stringify(dataToSave).length;
                if (payloadSize > 900000) {
                    throw new Error('PAYLOAD_TOO_LARGE');
                }

                const response = await fetch(`${JSONBIN_CONFIG.BASE_URL}/${JSONBIN_CONFIG.BIN_ID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': JSONBIN_CONFIG.API_KEY
                    },
                    body: JSON.stringify(dataToSave)
                });

                if (!response.ok) throw new Error('Error al guardar');

                if (comprobanteBase64 && pedidoParaJSONbin.tieneComprobante) {
                    try {
                        const comprobantes = JSON.parse(localStorage.getItem('sakiComprobantes') || '{}');
                        const comprobanteSize = comprobanteBase64.length;
                        
                        if (comprobanteSize > 5000000) {
                            comprobantes[pedido.id] = {
                                nombre: comprobanteNombre,
                                timestamp: new Date().toISOString(),
                                error: 'Archivo muy grande (>5MB)',
                                disponible: false
                            };
                        } else {
                            comprobantes[pedido.id] = {
                                base64: comprobanteBase64,
                                nombre: comprobanteNombre,
                                timestamp: new Date().toISOString(),
                                disponible: true
                            };
                        }
                        
                        localStorage.setItem('sakiComprobantes', JSON.stringify(comprobantes));
                    } catch (e) {
                        console.error('Error guardando comprobante:', e);
                    }
                }
                
                sistemaData = dataToSave;
                localStorage.setItem('sakiMenuCache', JSON.stringify(dataToSave));
                lastSyncTime = Date.now();
                
                return true;
                
            } catch (error) {
                console.error('Error en guardarPedido:', error);
                let mensajeError = 'Error al procesar el pedido. ';
                
                if (error.message.includes('PAYLOAD_TOO_LARGE')) {
                    mensajeError = '‚ö†Ô∏è La imagen es muy grande. Intenta con una foto m√°s peque√±a (m√°x 500KB) o sin comprobante.';
                } else {
                    mensajeError += error.message || 'Error desconocido.';
                }
                
                showToast(mensajeError, 'error');
                return false;
            }
        }

        // ==========================================
        // CANCELACI√ìN DE PEDIDO
        // ==========================================
        async function cancelarPedidoPorTimeout(pedidoId) {
            console.log(`Cancelando pedido ${pedidoId} por timeout`);
            
            try {
                await sincronizarUnaVez();
                
                const pedido = sistemaData.pedidos?.find(p => p.id === pedidoId);
                if (!pedido) return;
                
                if (pedido.estado !== 'pendiente') return;
                
                pedido.estado = 'cancelado_timeout';
                pedido.fechaCancelacion = new Date().toISOString();
                pedido.motivoCancelacion = 'Tiempo de pago excedido (20 minutos)';
                
                await guardarCambiosSistema();
                
                agregarNotificacion(pedidoId, 'rejected', 'Pedido cancelado', 'Se agot√≥ el tiempo de pago (20 minutos). Los ingredientes han sido liberados.');
                
                pedidosCliente = pedidosCliente.filter(p => p.id !== pedidoId);
                
                showToast('Tu pedido fue cancelado por exceder el tiempo de pago', 'error');
                
            } catch (error) {
                console.error('Error cancelando pedido por timeout:', error);
            }
        }

        async function guardarCambiosSistema() {
            try {
                const response = await fetch(`${JSONBIN_CONFIG.BASE_URL}/${JSONBIN_CONFIG.BIN_ID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': JSONBIN_CONFIG.API_KEY
                    },
                    body: JSON.stringify(sistemaData)
                });
                
                if (!response.ok) throw new Error('Error al guardar');
                
                localStorage.setItem('sakiMenuCache', JSON.stringify(sistemaData));
                lastSyncTime = Date.now();
                
            } catch (error) {
                console.error('Error guardando cambios:', error);
                throw error;
            }
        }

        // ==========================================
        // SISTEMA DE NOTIFICACIONES
        // ==========================================
        function iniciarVerificacionPedidos() {
            setInterval(verificarNotificacionesManual, 10000);
            verificarNotificacionesManual();
        }
        
        async function verificarNotificacionesManual() {
            if (!sessionId || pedidosCliente.length === 0) return;
            
            try {
                await sincronizarUnaVez();
                
                let hayCambios = false;
                
                pedidosCliente.forEach(pedidoCliente => {
                    const pedidoActualizado = sistemaData.pedidos?.find(p => p.id === pedidoCliente.id);
                    
                    if (pedidoActualizado && pedidoActualizado.estado !== pedidoCliente.estado) {
                        const estadoAnterior = pedidoCliente.estado;
                        pedidoCliente.estado = pedidoActualizado.estado;
                        pedidoCliente.razonRechazo = pedidoActualizado.razonRechazo;
                        pedidoCliente.metodoPago = pedidoActualizado.metodoPago;
                        
                        const mensaje = generarMensajeNotificacion(estadoAnterior, pedidoActualizado.estado, pedidoActualizado.tipo);
                        
                        if (pedidoActualizado.estado === 'rechazado') {
                            const razon = pedidoActualizado.razonRechazo || 'Sin especificar';
                            agregarNotificacion(pedidoCliente.id, 'rejected', 'Pedido rechazado', `Motivo: ${traducirRazon(razon)}`);
                            cancelarTimerPedido(pedidoCliente.id);
                        } else if (mensaje) {
                            const tipo = pedidoActualizado.estado === 'cobrado' || 
                                         pedidoActualizado.estado === 'en_cocina' || 
                                         pedidoActualizado.estado === 'en_camino' || 
                                         pedidoActualizado.estado === 'reserva_pendiente' ? 'approved' : 'pending';
                            agregarNotificacion(pedidoCliente.id, tipo, mensaje.titulo, mensaje.texto);
                        }
                        
                        if (isInRestaurant && pedidoActualizado.estado === 'en_cocina') {
                            actualizarVistaPedidoCobrado();
                        }
                        
                        hayCambios = true;
                    }
                });
                
                if (hayCambios) {
                    actualizarBadgeNotificaciones();
                    renderizarNotificaciones();
                }
                
            } catch (error) {
                console.error('Error verificando notificaciones:', error);
            }
        }
        
        function generarMensajeNotificacion(estadoAnterior, estadoNuevo, tipo) {
            const mensajes = {
                'pendiente': {
                    'cobrado': {
                        titulo: '¬°Pago confirmado! üéâ',
                        texto: tipo === 'delivery' ? 'Tu pedido ha sido cobrado y pronto saldr√° en camino.' : 
                               tipo === 'reserva' ? 'Tu reserva ha sido confirmada. ¬°Te esperamos!' : 
                               'Tu pedido ha sido cobrado y est√° en preparaci√≥n.'
                    },
                    'en_cocina': {
                        titulo: '¬°En preparaci√≥n! üë®‚Äçüç≥',
                        texto: 'Tu pedido est√° siendo preparado por nuestros chefs. ¬°Estar√° listo pronto!'
                    },
                    'en_camino': {
                        titulo: '¬°En camino! ü§§',
                        texto: 'Tu pedido fue confirmado. ¬°Prepara tu paladar!'
                    },
                    'reserva_pendiente': {
                        titulo: '¬°Reserva confirmada! üìÖ',
                        texto: 'Tu reserva ha sido confirmada. ¬°Te esperamos en la fecha acordada!'
                    },
                    'reserva_atendida': {
                        titulo: '¬°Cliente confirmado! ‚úÖ',
                        texto: 'Has llegado y est√°s siendo atendido. ¬°Buen provecho!'
                    }
                },
                'cobrado': {
                    'en_cocina': {
                        titulo: '¬°En preparaci√≥n! üë®‚Äçüç≥',
                        texto: 'Tu pedido est√° siendo preparado por nuestros chefs. ¬°Estar√° listo pronto!'
                    },
                    'en_camino': {
                        titulo: '¬°En camino! üõµ',
                        texto: 'Tu delivery va en camino. ¬°Prepara tu paladar!'
                    },
                    'reserva_pendiente': {
                        titulo: '¬°Reserva confirmada! üìÖ',
                        texto: 'Tu reserva ha sido confirmada. ¬°Te esperamos en la fecha acordada!'
                    }
                },
                'en_cocina': {
                    'entregado': {
                        titulo: '¬°Pedido entregado! üçΩÔ∏è',
                        texto: 'Tu pedido ha sido entregado. ¬°Esperamos que disfrutes cada bocado!'
                    }
                },
                'en_camino': {
                    'enviado': {
                        titulo: '¬°Pedido entregado! üçΩÔ∏è',
                        texto: 'Tu delivery ha sido entregado. ¬°Esperamos que disfrutes cada bocado!'
                    }
                },
                'reserva_pendiente': {
                    'reserva_atendida': {
                        titulo: '¬°Cliente confirmado! ‚úÖ',
                        texto: 'Has llegado y est√°s siendo atendido. ¬°Buen provecho!'
                    }
                },
                'reserva_atendida': {
                    'reserva_completada': {
                        titulo: '¬°Pedido completado! üéâ',
                        texto: 'Tu pedido de reserva ha sido servido. ¬°Esperamos que vuelvas pronto!'
                    }
                }
            };
            
            if (mensajes[estadoAnterior] && mensajes[estadoAnterior][estadoNuevo]) {
                return mensajes[estadoAnterior][estadoNuevo];
            }
            
            if (estadoNuevo === 'entregado' || estadoNuevo === 'enviado' || estadoNuevo === 'reserva_completada') {
                return {
                    titulo: '¬°Pedido completado! üéâ',
                    texto: 'Tu pedido ha sido confirmado y se encuentra en preparaci√≥n, el delivery se comunicar√° pronto con usted ¬°Gracias por elegir Saki Sushi!'
                };
            }
            
            return null;
        }

        function traducirRazon(razon) {
            const razones = {
                'referencia_invalida': 'Referencia de pago inv√°lida',
                'monto_insuficiente': 'Monto insuficiente',
                'datos_incorrectos': 'Datos de contacto/direcci√≥n incorrectos',
                'no_disponible': 'Producto no disponible',
                'fuera_horario': 'Fuera de horario de delivery'
            };
            return razones[razon] || razon;
        }

        function agregarNotificacion(pedidoId, tipo, titulo, mensaje) {
            const notificacion = {
                id: Date.now(),
                pedidoId: pedidoId,
                tipo: tipo,
                titulo: titulo,
                mensaje: mensaje,
                timestamp: new Date().toISOString(),
                leida: false
            };
            
            let notificaciones = JSON.parse(localStorage.getItem('sakiNotificaciones') || '[]');
            notificaciones.unshift(notificacion);
            localStorage.setItem('sakiNotificaciones', JSON.stringify(notificaciones));
            
            actualizarBadgeNotificaciones();
            renderizarNotificaciones();
            
            showToast(`${titulo}: ${mensaje}`, tipo === 'approved' ? 'success' : 'error');
        }

        function actualizarBadgeNotificaciones() {
            const notificaciones = JSON.parse(localStorage.getItem('sakiNotificaciones') || '[]');
            const noLeidas = notificaciones.filter(n => !n.leida).length;
            
            const badge = document.getElementById('badgeCount');
            const badgeElement = document.getElementById('notificationBadge');
            
            if (noLeidas > 0) {
                badge.textContent = noLeidas;
                badge.style.display = 'flex';
                badgeElement.classList.add('has-unread');
            } else {
                badge.style.display = 'none';
                badgeElement.classList.remove('has-unread');
            }
        }

        function renderizarNotificaciones() {
            const container = document.getElementById('notificationsList');
            const notificaciones = JSON.parse(localStorage.getItem('sakiNotificaciones') || '[]');
            
            if (notificaciones.length === 0) {
                container.innerHTML = `
                    <div class="empty-notifications">
                        <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                        <p>No tienes notificaciones</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = notificaciones.map(notif => `
                <div class="notification-item ${notif.tipo}" onclick="marcarNotificacionLeida(${notif.id})">
                    <div>
                        <div class="notification-status ${notif.tipo}">
                            <i class="fas fa-${notif.tipo === 'approved' ? 'check-circle' : notif.tipo === 'rejected' ? 'times-circle' : 'clock'}"></i>
                            ${notif.titulo}
                        </div>
                        <div style="font-size: 0.875rem; margin-top: 4px;">${notif.mensaje}</div>
                        <div class="notification-time">
                            ${new Date(notif.timestamp).toLocaleString()}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function marcarNotificacionLeida(id) {
            let notificaciones = JSON.parse(localStorage.getItem('sakiNotificaciones') || '[]');
            notificaciones = notificaciones.map(n => {
                if (n.id === id) n.leida = true;
                return n;
            });
            localStorage.setItem('sakiNotificaciones', JSON.stringify(notificaciones));
            actualizarBadgeNotificaciones();
            renderizarNotificaciones();
        }

        function toggleNotifications() {
            const panel = document.getElementById('notificationsPanel');
            panel.classList.toggle('show');
            
            if (panel.classList.contains('show')) {
                verificarNotificacionesManual();
                renderizarNotificaciones();
            }
        }
        
        function iniciarTimerPedido(pedidoId, tipo) {
            cancelarTimerPedido(pedidoId);
            
            const startTime = Date.now();
            const timerId = setTimeout(() => {
                cancelarPedidoPorTimeout(pedidoId);
            }, 20 * 60 * 1000);
            
            pedidosConTimer[pedidoId] = {
                timerId: timerId,
                startTime: startTime,
                tipo: tipo
            };
        }
        
        function cancelarTimerPedido(pedidoId) {
            if (pedidosConTimer[pedidoId]) {
                clearTimeout(pedidosConTimer[pedidoId].timerId);
                delete pedidosConTimer[pedidoId];
            }
        }

        // ==========================================
        // SIDEBAR Y NAVEGACI√ìN
        // ==========================================
        function openSidebar() {
            document.getElementById('sidebar').classList.add('open');
            document.getElementById('sidebarOverlay').classList.add('show');
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.remove('show');
        }

        function renderSidebar() {
            const categories = [
                { id: 'todos', name: 'üçΩÔ∏è Todos', subcategories: [] },
                { id: 'entradas', name: 'ü•¢ Entradas', subcategories: [] },
                { id: 'sushi', name: 'üç£ Sushi', subcategories: [] },
                { id: 'rolls', name: 'üç± Rolls', subcategories: [
                    { id: 'rolls-frios', name: 'Rolls Fr√≠os (10 pzas)' },
                    { id: 'rolls-tempura', name: 'Rolls Tempura (12 pzas)' }
                ]},
                { id: 'tragos', name: 'üçπ Tragos y bebidas', subcategories: [] },
                { id: 'pokes', name: 'ü•ó Pokes', subcategories: [] },
                { id: 'ensaladas', name: 'ü•¨ Ensaladas', subcategories: [] },
                { id: 'china', name: 'ü•° Comida China', subcategories: [
                    { id: 'arroz-chino', name: 'Arroz Chino' },
                    { id: 'arroz-cantones', name: 'Arroz Cantones' },
                    { id: 'chopsuey', name: 'Chopsuey' },
                    { id: 'lomey', name: 'Lomey' },
                    { id: 'chow-mein', name: 'Chow Mein' },
                    { id: 'fideos-arroz', name: 'Fideos de Arroz' },
                    { id: 'tallarines-cantones', name: 'Tallarines Cantones' },
                    { id: 'mariscos', name: 'Mariscos' },
                    { id: 'foo-yung', name: 'Foo Yong' },
                    { id: 'sopas', name: 'Sopas' },
                    { id: 'entremeses', name: 'Entremeses' }
                ]},
                { id: 'japonesa', name: 'üéå Comida Japonesa', subcategories: [
                    { id: 'yakimeshi', name: 'Yakimeshi' },
                    { id: 'yakisoba', name: 'Yakisoba' },
                    { id: 'pasta-udon', name: 'Pasta Udon' },
                    { id: 'churrasco', name: 'Churrasco' }
                ]},
                { id: 'ninos', name: 'üë∂ Para Ni√±os', subcategories: [] },
                { id: 'ejecutivo', name: 'üíº Combo Ejecutivo', subcategories: [] }
            ];

            const container = document.getElementById('sidebarContent');
            container.innerHTML = categories.map(cat => `
                <div class="category-item">
                    <button class="category-btn ${cat.subcategories.length > 0 ? 'has-sub' : ''}" 
                            onclick="${cat.subcategories.length > 0 ? `toggleSubcategories('${cat.id}')` : `selectCategory('${cat.id}')`}">
                        ${cat.name}
                        ${cat.subcategories.length > 0 ? '<i class="fas fa-chevron-down"></i>' : ''}
                    </button>
                    ${cat.subcategories.length > 0 ? `
                        <div class="subcategory-list" id="subcat-${cat.id}">
                            ${cat.subcategories.map(sub => `
                                <button class="subcategory-btn" onclick="selectSubcategory('${cat.id}', '${sub.id}')">
                                    ${sub.name}
                                </button>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function toggleSubcategories(catId) {
            const subcat = document.getElementById(`subcat-${catId}`);
            subcat.classList.toggle('open');
        }

        function selectCategory(catId) {
            currentCategory = catId;
            currentSubcategory = null;
            closeSidebar();
            renderMenu();
            updateActiveCategory();
        }

        function selectSubcategory(catId, subId) {
            currentCategory = catId;
            currentSubcategory = subId;
            closeSidebar();
            renderMenu();
        }

        function updateActiveCategory() {
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
        }

        // ==========================================
        // B√öSQUEDA DE PLATILLOS
        // ==========================================
        function buscarPlatillos() {
            searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            renderMenu();
        }

        // ==========================================
        // RENDERIZADO DEL MEN√ö
        // ==========================================
        function renderMenu() {
            const menuGrid = document.getElementById('menuGrid');
            
            if (!menuItems || menuItems.length === 0) {
                menuGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 60px; color: #888;">
                        <i class="fas fa-utensils" style="font-size: 4em; margin-bottom: 20px; color: var(--primary);"></i>
                        <p style="font-size: 1.4em;">Cargando men√∫...</p>
                    </div>
                `;
                return;
            }
            
            let filteredItems = [...menuItems];
            
            if (currentCategory !== 'todos') {
                if (currentSubcategory) {
                    filteredItems = menuItems.filter(item => item.subcategory === currentSubcategory);
                } else {
                    filteredItems = menuItems.filter(item => {
                        if (currentCategory === 'sushi') {
                            return item.category === 'sushi' || item.subcategory?.includes('roll');
                        }
                        return item.category === currentCategory;
                    });
                }
            }
            
            if (searchTerm) {
                filteredItems = filteredItems.filter(item => {
                    const nombre = item.name.toLowerCase();
                    const palabras = nombre.split(/\s+/);
                    return palabras.some(palabra => palabra.includes(searchTerm)) || 
                           nombre.includes(searchTerm);
                });
            }
            
            if (filteredItems.length === 0) {
                menuGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 60px; color: #888;">
                        <i class="fas fa-utensils" style="font-size: 4em; margin-bottom: 20px; color: var(--primary);"></i>
                        <p style="font-size: 1.4em;">No hay platillos disponibles</p>
                        ${searchTerm ? '<p style="margin-top: 10px;">Intenta con otra b√∫squeda</p>' : ''}
                    </div>
                `;
                return;
            }
            
            menuGrid.innerHTML = filteredItems.map(item => {
                const precioBs = formatearPrecioBs(item.basePrice);
                
                const ingredientesPrincipales = verificarIngredientesPrincipales(item);
                const hayIngredientes = ingredientesPrincipales.disponible;
                const esAgotado = !hayIngredientes && item.instances.length === 0;
                const claseAgotado = esAgotado ? 'agotado' : '';
                const estaEnPedido = item.instances.length > 0;
                
                const stockReal = Math.max(0, item.stock - item.totalOrdered);
                const disponible = item.disponible && stockReal > 0 && hayIngredientes;
                
                let imagenHtml = '';
                if (item.imagen && item.imagen.trim() !== '') {
                    imagenHtml = `<img src="${item.imagen}" class="item-image" alt="${item.name}" onerror="this.style.display='none'; this.parentNode.classList.add('image-error'); this.parentNode.innerHTML += '<div class=\\'item-image-placeholder\\'><i class=\\'fas fa-image\\'></i><span style=\\'font-size: 0.8rem; margin-top: 10px;\\'>Sin imagen</span></div>';">`;
                } else {
                    imagenHtml = `<div class="item-image-placeholder"><i class="fas fa-image"></i><span style="font-size: 0.8rem; margin-top: 10px;">Sin imagen</span></div>`;
                }
                
                return `
                    <div class="menu-item ${claseAgotado} ${!disponible && !estaEnPedido ? 'disabled' : ''}" data-id="${item.id}">
                        <div class="item-image-container">
                            ${imagenHtml}
                        </div>
                        <div class="item-header">
                            <div class="item-name">
                                <span>${item.name}</span>
                                <span class="item-price">${precioBs}</span>
                            </div>
                            <div class="item-description">${item.description || ''}</div>
                            ${!hayIngredientes ? '<div style="color: #ff6b6b; font-size: 0.9em; margin-top: 5px;"><i class="fas fa-exclamation-circle"></i> Sin ingredientes principales</div>' : ''}
                        </div>
                        <div class="item-content">
                            ${!hayIngredientes ? `
                                <div class="stock-warning show">
                                    <i class="fas fa-exclamation-triangle"></i> 
                                    Ingredientes principales agotados: ${ingredientesPrincipales.faltantes.join(', ')}
                                </div>
                            ` : ''}
                            
                            <div class="quantity-section">
                                <div class="quantity-controls">
                                    <button class="qty-btn" onclick="changeQuantity('${item.id}', -1)" id="btn-minus-${item.id}">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <div class="item-quantity" id="qty-${item.id}">${item.quantity || 0}</div>
                                    <button class="qty-btn" onclick="changeQuantity('${item.id}', 1)" 
                                            ${!disponible ? 'disabled' : ''}>
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <div class="item-stock ${getStockClass(stockReal, hayIngredientes)}">
                                    <i class="fas fa-box"></i> 
                                    ${!hayIngredientes ? 'Agotado' : `Disponibles: ${stockReal} de ${item.stockMaximo || 0}`}
                                </div>
                            </div>
                            
                            ${Object.keys(item.ingredients).length > 0 && hayIngredientes && (disponible || estaEnPedido) ? `
                            <div class="ingredients-section ${item.quantity === 0 ? 'hidden' : ''}" id="ingredients-${item.id}">
                                <div class="ingredients-title">
                                    <i class="fas fa-utensils"></i>
                                    <h3>Personaliza tu pedido</h3>
                                </div>
                                <div class="ingredient-options" id="options-${item.id}"></div>
                                <div class="joke-notice" id="joke-${item.id}">
                                    <i class="fas fa-laugh-beam"></i> 
                                    ¬°Quieres un platillo sin nada! ¬øPrefieres el plato vac√≠o con aire condimentado? üòÑ
                                </div>
                                <div class="ingredient-actions">
                                    <button class="confirm-btn" onclick="confirmCustomization('${item.id}')" id="confirm-${item.id}">
                                        <i class="fas fa-check"></i> Confirmar Selecci√≥n
                                    </button>
                                </div>
                                <div class="price-adjustment" id="price-adj-${item.id}"></div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            filteredItems.forEach(item => {
                if (Object.keys(item.ingredients).length > 0 && 
                    verificarIngredientesPrincipales(item).disponible && 
                    (item.disponible || item.instances.length > 0)) {
                    generateIngredientOptions(item.id);
                }
            });
            
            filteredItems.forEach(item => {
                actualizarBotonMinus(item.id, item.quantity);
            });
        }

        function generateIngredientOptions(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            const optionsDiv = document.getElementById(`options-${itemId}`);
            if (!optionsDiv || !item) return;
            
            optionsDiv.innerHTML = '';
            
            const completeOption = document.createElement('div');
            completeOption.className = `ingredient-option complete-option ${item.currentSelections.size === 0 ? 'selected' : ''}`;
            completeOption.onclick = () => selectComplete(itemId);
            
            completeOption.innerHTML = `
                <div class="ingredient-checkbox ${item.currentSelections.size === 0 ? 'checked' : ''}"></div>
                <div class="ingredient-icon">‚úÖ</div>
                <div class="ingredient-name">Platillo completo (con todos los ingredientes)</div>
            `;
            optionsDiv.appendChild(completeOption);
            
            Object.keys(item.ingredients).forEach(ingKey => {
                const ingrediente = item.ingredients[ingKey];
                if (!ingrediente.obligatorio) {
                    const stockIng = sistemaData?.inventario?.[ingKey]?.stock || 0;
                    const reservado = calcularReservadoConCache(ingKey);
                    const stockReal = stockIng - reservado;
                    const disabled = stockReal <= 0;
                    
                    const ingOption = document.createElement('div');
                    ingOption.className = `ingredient-option ${disabled ? 'disabled' : ''}`;
                    if (!disabled) {
                        ingOption.onclick = () => toggleIngredient(itemId, ingKey);
                    }
                    
                    const isSelected = item.currentSelections.has(ingKey);
                    
                    ingOption.innerHTML = `
                        <div class="ingredient-checkbox ${isSelected ? 'checked' : ''} ${disabled ? 'disabled' : ''}"></div>
                        <div class="ingredient-icon">ü•ó</div>
                        <div class="ingredient-name">
                            Sin ${ingKey.replace(/_/g, ' ')}
                            ${disabled ? ' (No disponible)' : ''}
                        </div>
                    `;
                    optionsDiv.appendChild(ingOption);
                }
            });
            
            updateConfirmButton(itemId);
        }

        function selectComplete(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) return;
            item.selectionType = "completo";
            item.currentSelections.clear();
            
            generateIngredientOptions(itemId);
        }

        function toggleIngredient(itemId, ingredientKey) {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) return;
            item.selectionType = "personalizado";
            
            if (item.currentSelections.has(ingredientKey)) {
                item.currentSelections.delete(ingredientKey);
            } else {
                item.currentSelections.add(ingredientKey);
            }
            
            generateIngredientOptions(itemId);
        }

        function actualizarBotonMinus(itemId, cantidad) {
            const btnMinus = document.getElementById(`btn-minus-${itemId}`);
            if (btnMinus) {
                btnMinus.disabled = cantidad === 0;
            }
        }

        function changeQuantity(itemId, change) {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) return;
            
            const newQty = (item.quantity || 0) + change;
            
            if (newQty < 0) return;
            
            const stockReal = (item.stock || 0) - (item.totalOrdered || 0);
            
            if (change > 0) {
                const ingCheck = verificarIngredientesPrincipales(item);
                if (!ingCheck.disponible) {
                    showToast('No hay ingredientes principales disponibles', 'error');
                    return;
                }
                
                if (stockReal <= 0) {
                    showToast('No hay stock disponible', 'error');
                    return;
                }
                
                if (newQty > stockReal) {
                    item.quantity = stockReal;
                    showToast(`Solo quedan ${stockReal} unidades disponibles`, 'error');
                } else {
                    item.quantity = newQty;
                }
            } else {
                item.quantity = newQty;
            }
            
            const qtyEl = document.getElementById(`qty-${itemId}`);
            if (qtyEl) qtyEl.textContent = item.quantity || 0;
            
            actualizarBotonMinus(itemId, item.quantity);
            
            const ingredientsSection = document.getElementById(`ingredients-${itemId}`);
            if (ingredientsSection) {
                if (item.quantity > 0) {
                    ingredientsSection.classList.remove('hidden');
                    
                    if (change > 0) {
                        item.selectionType = "completo";
                        item.currentSelections.clear();
                        generateIngredientOptions(itemId);
                    } else if (change < 0 && item.instances.length > 0) {
                        const instanciaPendiente = item.instances.findIndex(inst => !inst.confirmada);
                        if (instanciaPendiente >= 0) {
                            item.instances.splice(instanciaPendiente, 1);
                            item.totalOrdered = (item.totalOrdered || 0) - 1;
                        } else if (item.instances.length > 0) {
                            item.instances.pop();
                            item.totalOrdered = (item.totalOrdered || 0) - 1;
                        }
                    }
                } else {
                    ingredientsSection.classList.add('hidden');
                }
            }
            
            updateOrderSummary();
        }

        function updateConfirmButton(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            const confirmBtn = document.getElementById(`confirm-${itemId}`);
            const priceAdjDiv = document.getElementById(`price-adj-${itemId}`);
            const jokeDiv = document.getElementById(`joke-${itemId}`);
            
            if (!confirmBtn || !item) return;
            
            const allNonRequired = Object.keys(item.ingredients).filter(key => !item.ingredients[key]?.obligatorio);
            const availableNonRequired = allNonRequired.filter(key => {
                const stock = sistemaData?.inventario?.[key]?.stock || 0;
                const reservado = calcularReservadoConCache(key);
                return (stock - reservado) > 0;
            });
            
            const selectedAllAvailable = availableNonRequired.length > 0 && 
                availableNonRequired.every(key => item.currentSelections.has(key));
            
            if (selectedAllAvailable) {
                confirmBtn.disabled = true;
                if (priceAdjDiv) priceAdjDiv.classList.remove('show');
                if (jokeDiv) jokeDiv.classList.add('show');
            } else {
                confirmBtn.disabled = false;
                if (jokeDiv) jokeDiv.classList.remove('show');
                
                if (item.currentSelections.size > 0) {
                    const precioAjustado = calcularPrecioAjustado(item);
                    if (priceAdjDiv) {
                        priceAdjDiv.innerHTML = `<i class="fas fa-tag"></i> Precio ajustado: <strong>Bs. ${precioAjustado.toFixed(2).replace('.', ',')}</strong>`;
                        priceAdjDiv.classList.add('show');
                    }
                } else {
                    if (priceAdjDiv) {
                        priceAdjDiv.innerHTML = `<i class="fas fa-tag"></i> Precio completo: <strong>${formatearPrecioBs(item.basePrice)}</strong>`;
                        priceAdjDiv.classList.add('show');
                    }
                }
            }
        }

        function calcularPrecioAjustado(item) {
            const tasaActual = obtenerTasaEfectiva();
            const precioBase = (item.basePrice || 0) * tasaActual;
            
            let descuentoTotal = 0;
            item.currentSelections.forEach(ingKey => {
                const ingData = sistemaData?.inventario?.[ingKey];
                if (ingData && ingData.precioUnitario) {
                    const precioIngredienteBs = ingData.precioUnitario * tasaActual;
                    descuentoTotal += precioIngredienteBs * (item.ingredients[ingKey]?.cantidad || 0);
                }
            });
            
            return Math.max(0, precioBase - descuentoTotal);
        }

        function confirmCustomization(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) return;
            
            if (item.quantity === 0) return;
            
            const allNonRequired = Object.keys(item.ingredients).filter(key => !item.ingredients[key]?.obligatorio);
            const availableNonRequired = allNonRequired.filter(key => {
                const stock = sistemaData?.inventario?.[key]?.stock || 0;
                const reservado = calcularReservadoConCache(key);
                return (stock - reservado) > 0;
            });
            
            if (item.currentSelections.size === availableNonRequired.length && availableNonRequired.length > 0) {
                showToast('¬°No puedes quitar todos los ingredientes disponibles!', 'error');
                return;
            }
            
            const cantidad = item.quantity;
            
            for (let i = 0; i < cantidad; i++) {
                const precioFinal = calcularPrecioAjustado(item);
                
                let descuentoTotal = 0;
                const tasaActual = obtenerTasaEfectiva();
                item.currentSelections.forEach(ingKey => {
                    const ingData = sistemaData?.inventario?.[ingKey];
                    if (ingData && ingData.precioUnitario) {
                        const precioIngredienteBs = ingData.precioUnitario * tasaActual;
                        descuentoTotal += precioIngredienteBs * (item.ingredients[ingKey]?.cantidad || 0);
                    }
                });
                
                const nuevaInstancia = {
                    id: (item.instances.length + 1) || 1,
                    removedIngredients: Array.from(item.currentSelections),
                    isComplete: item.currentSelections.size === 0,
                    selectionType: item.selectionType,
                    price: precioFinal,
                    descuentoPorIngredientes: descuentoTotal,
                    precioBase: (item.basePrice || 0) * tasaActual,
                    confirmada: true
                };
                
                if (!item.instances) item.instances = [];
                item.instances.push(nuevaInstancia);
                item.totalOrdered = (item.totalOrdered || 0) + 1;
            }
            
            item.quantity = 0;
            item.currentSelections.clear();
            item.selectionType = "completo";
            
            stockCache = {};
            
            actualizarBotonMinus(itemId, 0);
            
            const ingredientsSection = document.getElementById(`ingredients-${itemId}`);
            if (ingredientsSection) ingredientsSection.classList.add('hidden');
            
            const qtyEl = document.getElementById(`qty-${itemId}`);
            if (qtyEl) qtyEl.textContent = '0';
            
            updateOrderSummary();
            renderMenu();
            showToast(`${cantidad} platillo(s) a√±adido(s) al pedido`, 'success');
        }

        function obtenerTasaEfectiva() {
            if (!sistemaData || !sistemaData.config) return 400;
            
            const tasaBase = sistemaData.config.tasaCambio || 400;
            const aumentoDiario = sistemaData.config.aumentoDiario || 0;
            const aumentoActivo = sistemaData.config.aumentoActivo || false;
            const fechaInicio = sistemaData.config.fechaInicioAumento;
            
            if (aumentoActivo && aumentoDiario > 0 && fechaInicio) {
                const inicio = new Date(fechaInicio);
                const hoy = new Date();
                const diffTime = Math.abs(hoy - inicio);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                const porcentajeTotal = aumentoDiario * diffDays;
                return tasaBase * (1 + (porcentajeTotal / 100));
            }
            
            return tasaBase;
        }

        // ==========================================
        // RESUMEN DEL PEDIDO
        // ==========================================
        function updateOrderSummary() {
            const orderSummaryContent = document.getElementById('orderSummaryContent');
            const orderBtn = document.getElementById('orderBtn');
            const onlineOptions = document.getElementById('onlineOrderOptions');
            const restaurantSection = document.getElementById('restaurantOrderSection');
            
            const validItems = menuItems.filter(item => 
                item.instances && item.instances.some(instance => instance.confirmada)
            );
            
            if (validItems.length === 0) {
                orderSummaryContent.innerHTML = `
                    <div class="empty-summary" style="text-align: center; padding: 40px; color: #888; font-style: italic;">
                        <i class="fas fa-utensils" style="font-size: 3em; margin-bottom: 20px; color: var(--primary);"></i>
                        <p style="font-size: 1.2em;">A√∫n no has seleccionado ning√∫n platillo</p>
                        <p style="margin-top: 10px;">Usa los botones + para comenzar tu pedido</p>
                    </div>
                `;
                if (orderBtn) orderBtn.disabled = true;
                return;
            }
            
            let html = '<div class="order-grid">';
            let total = 0;
            let totalItems = 0;
            
            validItems.forEach(item => {
                const validInstances = item.instances.filter(instance => instance.confirmada);
                
                if (validInstances.length === 0) return;
                
                html += `<div class="order-item-card">`;
                html += `<button class="delete-item" onclick="deleteItem('${item.id}', ${validInstances[0].id})"><i class="fas fa-times"></i></button>`;
                html += `<div class="instance-number">${validInstances.length}</div>`;
                
                validInstances.forEach((instance, index) => {
                    total += instance.price || 0;
                    totalItems++;
                    
                    let modifiers = '';
                    if (instance.removedIngredients && instance.removedIngredients.length > 0) {
                        modifiers = 'Personalizado (sin: ' + 
                            instance.removedIngredients.map(ing => ing.replace(/_/g, ' ')).join(', ') + 
                            ')';
                        if (instance.descuentoPorIngredientes > 0) {
                            modifiers += `<br><small style="color: var(--success);">Descuento: -Bs. ${instance.descuentoPorIngredientes.toFixed(2)}</small>`;
                        }
                    } else {
                        modifiers = 'Completo';
                    }
                    
                    html += `
                        <div class="item-instance">
                            <div class="order-item-info">
                                <div class="order-item-details">
                                    <div class="order-item-name">
                                        <i class="fas fa-utensils"></i>
                                        ${item.name} #${index + 1}
                                    </div>
                                    <div class="order-item-modifiers">${modifiers}</div>
                                </div>
                                <div class="order-item-price">Bs. ${(instance.price || 0).toFixed(2).replace('.', ',')}</div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            html += '</div>';
            
            html += `
                <div class="summary-total-items">
                    <div><i class="fas fa-receipt"></i> ${totalItems} platillo${totalItems !== 1 ? 's' : ''}</div>
                    <div class="items-total">Total: Bs. ${total.toFixed(2).replace('.', ',')}</div>
                </div>
            `;
            
            orderSummaryContent.innerHTML = html;
            
            if (isInRestaurant) {
                restaurantSection.classList.add('show');
                if (orderBtn) orderBtn.disabled = false;
            } else {
                onlineOptions.classList.add('show');
            }
            
            document.getElementById('deliveryMonto').textContent = `Bs. ${total.toFixed(2).replace('.', ',')}`;
            document.getElementById('reservaMonto').textContent = `Bs. ${total.toFixed(2).replace('.', ',')}`;
        }

        function deleteItem(itemId, instanceId) {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) return;
            
            const instanceIndex = item.instances.findIndex(i => i.id === instanceId);
            if (instanceIndex === -1) return;
            
            item.instances.splice(instanceIndex, 1);
            item.totalOrdered = (item.totalOrdered || 0) - 1;
            
            stockCache = {};
            
            updateOrderSummary();
            renderMenu();
            showToast('Platillo eliminado del pedido', 'success');
        }

        // ==========================================
        // MODALES Y CONFIRMACI√ìN
        // ==========================================
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function showConfirmationModal() {
            const modal = document.getElementById('confirmationModal');
            const reviewDiv = document.getElementById('orderReview');
            
            let html = '';
            let total = 0;
            
            menuItems.forEach(item => {
                if (item.instances) {
                    item.instances.filter(inst => inst.confirmada).forEach(instance => {
                        total += instance.price || 0;
                        
                        let modifiers = '';
                        if (instance.removedIngredients && instance.removedIngredients.length > 0) {
                            modifiers = ' (sin: ' + instance.removedIngredients.map(ing => ing.replace(/_/g, ' ')).join(', ') + ')';
                            if (instance.descuentoPorIngredientes > 0) {
                                modifiers += `<br><small style="color: var(--success);">Descuento por ingredientes: -Bs. ${instance.descuentoPorIngredientes.toFixed(2)}</small>`;
                            }
                        } else {
                            modifiers = ' (completo)';
                        }
                        
                        html += `
                            <div class="review-item">
                                <span>${item.name}${modifiers}</span>
                                <strong>Bs. ${(instance.price || 0).toFixed(2).replace('.', ',')}</strong>
                            </div>
                        `;
                    });
                }
            });
            
            html += `
                <div class="review-total">
                    <span>TOTAL</span>
                    <span>Bs. ${total.toFixed(2).replace('.', ',')}</span>
                </div>
            `;
            
            reviewDiv.innerHTML = html;
            modal.classList.add('show');
        }

        async function finalConfirmOrder() {
            closeModal('confirmationModal');
            showLoading();
            
            const pedido = crearPedidoBase();
            pedido.tipo = 'mesa';
            pedido.mesa = tableNumber;
            pedido.clienteNombre = document.getElementById('customerName').value || null;
            
            const exito = await guardarPedido(pedido);
            
            hideLoading();
            
            if (exito) {
                pedidosCliente.push({
                    id: pedido.id,
                    estado: 'pendiente',
                    timestamp: pedido.timestamp,
                    tipo: 'mesa'
                });
                
                const thankYouDiv = document.getElementById('thankYouMessage');
                const thankYouText = document.getElementById('thankYouText');
                const extraContent = document.getElementById('thankYouExtraContent');
                
                thankYouText.textContent = 'Tu pedido ha sido enviado a cocina';
                extraContent.innerHTML = `
                    <div class="payment-info-text">
                        <i class="fas fa-info-circle"></i> 
                        Por favor, espera en tu mesa. El mesero te traer√° tu pedido cuando est√© listo.
                    </div>
                `;
                
                thankYouDiv.classList.add('show');
                document.getElementById('restaurantOrderSection').classList.remove('show');
                
                limpiarPedido();
                agregarNotificacion(pedido.id, 'pending', 'Pedido enviado', 'Tu pedido est√° pendiente de confirmaci√≥n por el cajero.');
                showToast('¬°Pedido enviado exitosamente!', 'success');
            } else {
                showToast('Error al procesar el pedido. Intenta nuevamente.', 'error');
            }
        }
        
        function actualizarVistaPedidoCobrado() {
            const thankYouDiv = document.getElementById('thankYouMessage');
            if (thankYouDiv.classList.contains('show')) {
                const thankYouText = document.getElementById('thankYouText');
                const extraContent = document.getElementById('thankYouExtraContent');
                
                thankYouText.textContent = '¬°Tu pedido est√° en preparaci√≥n!';
                extraContent.innerHTML = `
                    <div class="payment-info-text" style="background: rgba(56, 142, 60, 0.3);">
                        <i class="fas fa-fire"></i> 
                        El cajero ha confirmado tu pedido. Nuestros chefs est√°n preparando tu comida.
                    </div>
                `;
            }
        }

        // ==========================================
        // DELIVERY
        // ==========================================
        function showDeliveryModal() {
            document.getElementById('deliveryModal').classList.add('show');
            validateDeliveryForm();
        }

        function moveToNextRef(input, type, index) {
            if (input.value.length === 1) {
                const container = document.getElementById(`${type}ReferenceContainer`);
                if (container) {
                    const inputs = container.querySelectorAll('.reference-digit');
                    if (index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    }
                }
            }
            validateDeliveryForm();
            if (type === 'reserva') validateReservaForm();
        }

        function handleRefKeypress(e, type, index) {
            if (e.key === 'Backspace' && e.target.value === '' && index > 0) {
                const container = document.getElementById(`${type}ReferenceContainer`);
                if (container) {
                    const inputs = container.querySelectorAll('.reference-digit');
                    inputs[index - 1].focus();
                }
            }
            if (e.key === 'Enter') {
                if (type === 'delivery') {
                    if (document.getElementById('btnConfirmDelivery').disabled) {
                        validateDeliveryForm();
                    } else {
                        confirmDelivery();
                    }
                } else if (type === 'reserva') {
                    if (document.getElementById('btnConfirmReserva').disabled) {
                        validateReservaForm();
                    } else {
                        confirmReserva();
                    }
                }
            }
        }

        function getReferenceCode(type) {
            const container = document.getElementById(`${type}ReferenceContainer`);
            if (!container) return '';
            const inputs = container.querySelectorAll('.reference-digit');
            return Array.from(inputs).map(i => i.value).join('');
        }

        function validateDeliveryForm() {
            const direccion = document.getElementById('deliveryDireccion')?.value.trim() || '';
            const telefono = document.getElementById('deliveryTelefono')?.value.trim() || '';
            const referencia = getReferenceCode('delivery');
            const comprobante = document.getElementById('deliveryComprobante')?.files.length > 0;
            
            const direccionValid = direccion.length >= 20;
            const telefonoValid = telefono.length >= 11 && telefono.length <= 14;
            const referenciaValid = referencia.length === 6;
            
            const direccionError = document.getElementById('direccionError');
            if (direccionError) direccionError.classList.toggle('show', direccion.length > 0 && !direccionValid);
            
            const telefonoError = document.getElementById('telefonoError');
            if (telefonoError) telefonoError.classList.toggle('show', telefono.length > 0 && !telefonoValid);
            
            const referenciaError = document.getElementById('referenciaErrorDelivery');
            if (referenciaError) referenciaError.classList.toggle('show', referencia.length > 0 && !referenciaValid);
            
            const btnConfirm = document.getElementById('btnConfirmDelivery');
            if (btnConfirm) btnConfirm.disabled = !(direccionValid && telefonoValid && referenciaValid && comprobante);
        }

        function handleFileSelect(input, labelId) {
            const label = document.getElementById(labelId);
            if (input.files && input.files[0] && label) {
                label.innerHTML = `<i class="fas fa-check-circle" style="color: var(--success); font-size: 2rem; margin-bottom: 10px; display: block;"></i> ${input.files[0].name}`;
                label.classList.add('has-file');
            }
            validateDeliveryForm();
            validateReservaForm();
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        async function confirmDelivery() {
            const pedido = crearPedidoBase();
            pedido.tipo = 'delivery';
            pedido.direccion = document.getElementById('deliveryDireccion')?.value.trim() || '';
            pedido.telefono = document.getElementById('deliveryTelefono')?.value.trim() || '';
            pedido.referencia = getReferenceCode('delivery');
            
            const comprobanteFile = document.getElementById('deliveryComprobante')?.files[0];
            if (comprobanteFile) {
                pedido.comprobanteNombre = comprobanteFile.name;
                try {
                    pedido.comprobanteBase64 = await fileToBase64(comprobanteFile);
                } catch (error) {
                    console.error('Error al convertir comprobante:', error);
                }
            }
            
            closeModal('deliveryModal');
            showLoading();
            
            const exito = await guardarPedido(pedido);
            
            hideLoading();
            
            if (exito) {
                const deliveryDireccion = document.getElementById('deliveryDireccion');
                if (deliveryDireccion) deliveryDireccion.value = '';
                
                const deliveryTelefono = document.getElementById('deliveryTelefono');
                if (deliveryTelefono) deliveryTelefono.value = '';
                
                const deliveryRefContainer = document.getElementById('deliveryReferenceContainer');
                if (deliveryRefContainer) {
                    deliveryRefContainer.querySelectorAll('.reference-digit').forEach(input => input.value = '');
                }
                
                const deliveryComprobante = document.getElementById('deliveryComprobante');
                if (deliveryComprobante) deliveryComprobante.value = '';
                
                const deliveryFileLabel = document.getElementById('deliveryFileLabel');
                if (deliveryFileLabel) {
                    deliveryFileLabel.innerHTML = `
                        <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: var(--primary); margin-bottom: 10px; display: block;"></i>
                        Haz clic para subir el comprobante de pago
                    `;
                    deliveryFileLabel.classList.remove('has-file');
                }
                
                pedidosCliente.push({
                    id: pedido.id,
                    estado: 'pendiente',
                    timestamp: pedido.timestamp,
                    tipo: 'delivery'
                });
                
                iniciarTimerPedido(pedido.id, 'delivery');
                
                limpiarPedido();
                
                const thankYouDiv = document.getElementById('thankYouMessage');
                const thankYouText = document.getElementById('thankYouText');
                const extraContent = document.getElementById('thankYouExtraContent');
                
                thankYouText.textContent = 'Tu pedido de delivery ha sido recibido';
                extraContent.innerHTML = `
                    <div class="payment-info-text">
                        <i class="fas fa-clock"></i> 
                        Estamos verificando tu pago. Te notificaremos cuando tu pedido est√© en camino.
                    </div>
                `;
                
                thankYouDiv.classList.add('show');
                document.getElementById('onlineOrderOptions').classList.remove('show');
                
                agregarNotificacion(pedido.id, 'pending', 'Pedido enviado', 'Tu pedido de delivery est√° pendiente de confirmaci√≥n. Tienes 20 minutos para que se verifique el pago.');
                showToast('¬°Pedido de delivery enviado exitosamente!', 'success');
            } else {
                showToast('Error al procesar el pedido. Intenta nuevamente.', 'error');
            }
        }

        // ==========================================
        // RESERVA
        // ==========================================
        function showReservaModal() {
            const hoy = new Date();
            const yyyy = hoy.getFullYear();
            const mm = String(hoy.getMonth() + 1).padStart(2, '0');
            const dd = String(hoy.getDate()).padStart(2, '0');
            const fechaMinima = `${yyyy}-${mm}-${dd}`;
            
            const fechaInput = document.getElementById('reservaFecha');
            if (fechaInput) {
                fechaInput.min = fechaMinima;
                fechaInput.value = fechaMinima;
                selectedDate = new Date(fechaMinima);
            }
            
            document.getElementById('reservaModal').classList.add('show');
            validateReservaForm();
        }

        function validateReservaForm() {
            const nombre = document.getElementById('reservaNombre')?.value.trim() || '';
            const fecha = document.getElementById('reservaFecha')?.value || '';
            const referencia = getReferenceCode('reserva');
            const comprobante = document.getElementById('reservaComprobante')?.files.length > 0;
            
            const nombreValid = nombre.length > 0;
            const fechaValid = fecha !== '';
            const referenciaValid = referencia.length === 6;
            
            const referenciaError = document.getElementById('referenciaErrorReserva');
            if (referenciaError) referenciaError.classList.toggle('show', referencia.length > 0 && !referenciaValid);
            
            const btnConfirm = document.getElementById('btnConfirmReserva');
            if (btnConfirm) btnConfirm.disabled = !(nombreValid && fechaValid && referenciaValid && comprobante);
        }

        async function confirmReserva() {
            const pedido = crearPedidoBase();
            pedido.tipo = 'reserva';
            pedido.fechaReserva = document.getElementById('reservaFecha')?.value || '';
            pedido.clienteNombre = document.getElementById('reservaNombre')?.value.trim() || '';
            pedido.referencia = getReferenceCode('reserva');
            
            const comprobanteFile = document.getElementById('reservaComprobante')?.files[0];
            if (comprobanteFile) {
                pedido.comprobanteNombre = comprobanteFile.name;
                try {
                    pedido.comprobanteBase64 = await fileToBase64(comprobanteFile);
                } catch (error) {
                    console.error('Error al convertir comprobante:', error);
                }
            }
            
            closeModal('reservaModal');
            showLoading();
            
            const exito = await guardarPedido(pedido);
            
            hideLoading();
            
            if (exito) {
                const reservaNombre = document.getElementById('reservaNombre');
                if (reservaNombre) reservaNombre.value = '';
                
                const reservaFecha = document.getElementById('reservaFecha');
                if (reservaFecha) reservaFecha.value = '';
                
                const reservaRefContainer = document.getElementById('reservaReferenceContainer');
                if (reservaRefContainer) {
                    reservaRefContainer.querySelectorAll('.reference-digit').forEach(input => input.value = '');
                }
                
                const reservaComprobante = document.getElementById('reservaComprobante');
                if (reservaComprobante) reservaComprobante.value = '';
                
                const reservaFileLabel = document.getElementById('reservaFileLabel');
                if (reservaFileLabel) {
                    reservaFileLabel.innerHTML = `
                        <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: var(--primary); margin-bottom: 10px; display: block;"></i>
                        Haz clic para subir el comprobante de pago
                    `;
                    reservaFileLabel.classList.remove('has-file');
                }
                selectedDate = null;
                
                pedidosCliente.push({
                    id: pedido.id,
                    estado: 'pendiente',
                    timestamp: pedido.timestamp,
                    tipo: 'reserva'
                });
                
                iniciarTimerPedido(pedido.id, 'reserva');
                
                limpiarPedido();
                
                const thankYouDiv = document.getElementById('thankYouMessage');
                const thankYouText = document.getElementById('thankYouText');
                const extraContent = document.getElementById('thankYouExtraContent');
                
                thankYouText.textContent = 'Tu reserva ha sido recibida';
                extraContent.innerHTML = `
                    <div class="payment-info-text">
                        <i class="fas fa-clock"></i> 
                        Estamos verificando tu pago. Te notificaremos cuando tu reserva sea confirmada.
                    </div>
                `;
                
                thankYouDiv.classList.add('show');
                document.getElementById('onlineOrderOptions').classList.remove('show');
                
                agregarNotificacion(pedido.id, 'pending', 'Reserva enviada', 'Tu reserva est√° pendiente de confirmaci√≥n. Tienes 20 minutos para que se verifique el pago.');
                showToast('¬°Reserva enviada exitosamente!', 'success');
            } else {
                showToast('Error al procesar la reserva. Intenta nuevamente.', 'error');
            }
        }

        // ==========================================
        // UTILIDADES
        // ==========================================
        function limpiarPedido() {
            menuItems.forEach(item => {
                if (item.instances) item.instances = [];
                item.quantity = 0;
                if (item.currentSelections) item.currentSelections.clear();
                item.selectionType = "completo";
                item.totalOrdered = 0;
            });
            stockCache = {};
            updateOrderSummary();
            renderMenu();
        }

        function formatearPrecioBs(dolares) {
            const precioBs = (dolares || 0) * obtenerTasaEfectiva();
            return `Bs. ${precioBs.toFixed(2).replace('.', ',')}`;
        }

        function getStockClass(stock, hayIngredientes) {
            if (!hayIngredientes) return 'sold-out';
            if (stock <= 0) return 'sold-out';
            if (stock <= 2) return 'low';
            return 'available';
        }

        function actualizarEstadoSync(estado) {
            const statusEl = document.getElementById('syncStatus');
            if (!statusEl) return;
            
            const iconEl = statusEl.querySelector('i');
            const textEl = statusEl.querySelector('span');
            
            statusEl.className = `sync-status ${estado}`;
            
            switch(estado) {
                case 'online':
                    if (iconEl) iconEl.className = 'fas fa-check-circle';
                    if (textEl) textEl.textContent = 'Sincronizado';
                    break;
                case 'syncing':
                    if (iconEl) iconEl.className = 'fas fa-sync-alt fa-spin';
                    if (textEl) textEl.textContent = 'Sincronizando...';
                    break;
                case 'offline':
                    if (iconEl) iconEl.className = 'fas fa-exclamation-triangle';
                    if (textEl) textEl.textContent = 'Modo offline';
                    break;
            }
        }

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            if (!toast) return;
            
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ==========================================
        // EVENT LISTENERS
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            initApp();
        });

        window.addEventListener('beforeunload', () => {
            Object.values(pedidosConTimer).forEach(timerData => {
                if (timerData.timerId) clearTimeout(timerData.timerId);
            });
            if (syncIntervalId) clearInterval(syncIntervalId);
        });
    </script>
</body>
</html>
